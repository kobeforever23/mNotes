<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Workforce Dashboard v1 | Displacement & Optimization Command Center</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Space+Mono:wght@400;700&family=Sora:wght@600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <style>
    :root {
      --bg: #0a1628;
      --bg-2: #0f1e35;
      --panel: #1a2332;
      --panel-2: #202b3f;
      --border: #ffffff16;
      --text: #e0e8f0;
      --muted: #9bb0c4;
      --accent: #27a7ff;
      --good: #00c896;
      --warn: #f5a623;
      --bad: #e74c3c;
      --shadow: 0 10px 28px rgba(0, 0, 0, 0.34);
      --radius: 14px;
      --topbar-height: 95px;
      --sidebar-width: 290px;
      --sidebar-collapsed: 78px;
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      width: 100%;
      min-height: 100%;
      height: 100%;
      background:
        radial-gradient(900px 500px at 90% -10%, rgba(39, 167, 255, 0.12), transparent 50%),
        radial-gradient(900px 500px at -10% 110%, rgba(0, 200, 150, 0.12), transparent 50%),
        var(--bg);
      color: var(--text);
      font-family: "DM Sans", sans-serif;
    }

    body {
      overflow: hidden;
    }

    a {
      color: #8acbff;
      text-decoration: none;
      border-bottom: 1px dotted rgba(138, 203, 255, 0.45);
    }

    a:hover {
      color: #b7e1ff;
      border-bottom-color: rgba(183, 225, 255, 0.7);
    }

    .app {
      display: grid;
      grid-template-columns: var(--sidebar-width) 1fr;
      min-height: 100vh;
      height: 100vh;
      overflow: hidden;
      transition: grid-template-columns 160ms ease;
    }

    .app.sidebar-collapsed {
      grid-template-columns: var(--sidebar-collapsed) 1fr;
    }

    .sidebar {
      position: sticky;
      top: 0;
      max-height: 100vh;
      padding: 18px 12px;
      border-right: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(26, 35, 50, 0.96), rgba(13, 24, 42, 0.96));
      backdrop-filter: blur(8px);
      z-index: 8;
      display: grid;
      grid-template-rows: auto auto 1fr auto;
      gap: 12px;
    }

    .brand {
      display: grid;
      gap: 3px;
      padding: 6px 8px;
    }

    .brand h1 {
      margin: 0;
      font-family: "Sora", sans-serif;
      font-size: 1rem;
      letter-spacing: 0.2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .brand small {
      color: var(--muted);
      font-size: 0.77rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .sidebar button,
    .sidebar select,
    .sidebar input,
    .main button,
    .main select,
    .main input,
    .main textarea {
      font-family: inherit;
    }

    .collapse-btn {
      border: 1px solid var(--border);
      color: var(--text);
      background: #ffffff08;
      border-radius: 10px;
      padding: 8px;
      cursor: pointer;
      text-align: left;
    }

    .nav {
      display: grid;
      gap: 6px;
      align-content: start;
    }

    .nav-btn {
      border: 1px solid transparent;
      color: var(--text);
      background: transparent;
      padding: 10px 10px;
      border-radius: 10px;
      text-align: left;
      cursor: pointer;
      display: grid;
      grid-template-columns: 24px 1fr;
      gap: 10px;
      align-items: center;
      font-size: 0.92rem;
      transition: background 140ms ease, border-color 140ms ease;
    }

    .nav-btn:hover,
    .nav-btn.active {
      background: linear-gradient(90deg, #ffffff15, #ffffff08);
      border-color: var(--border);
    }

    .nav-icon {
      font-size: 0.95rem;
      width: 24px;
      text-align: center;
      color: #9ac2ff;
      font-family: "Space Mono", monospace;
    }

    .sidebar.collapsed .brand h1,
    .sidebar.collapsed .brand small,
    .sidebar.collapsed .nav-btn span:not(.nav-icon),
    .sidebar.collapsed .quick-actions,
    .sidebar.collapsed .collapse-btn span {
      display: none;
    }

    .sidebar.collapsed .nav-btn {
      grid-template-columns: 1fr;
      justify-items: center;
      padding: 10px 6px;
    }

    .sidebar .quick-actions {
      border-top: 1px solid var(--border);
      padding-top: 10px;
      display: grid;
      gap: 8px;
    }

    .btn {
      border: 1px solid var(--border);
      background: #ffffff0a;
      color: var(--text);
      border-radius: 10px;
      padding: 8px 10px;
      cursor: pointer;
      font-size: 0.86rem;
      transition: background 140ms ease;
    }

    .btn:hover {
      background: #ffffff13;
    }

    .btn.primary {
      background: linear-gradient(120deg, rgba(39, 167, 255, 0.36), rgba(39, 167, 255, 0.18));
      border-color: rgba(39, 167, 255, 0.5);
    }

    .btn.good {
      background: linear-gradient(120deg, rgba(0, 200, 150, 0.26), rgba(0, 200, 150, 0.12));
      border-color: rgba(0, 200, 150, 0.45);
    }

    .btn.warn {
      background: linear-gradient(120deg, rgba(245, 166, 35, 0.22), rgba(245, 166, 35, 0.1));
      border-color: rgba(245, 166, 35, 0.46);
    }

    .main {
      min-width: 0;
      display: grid;
      grid-template-rows: auto 1fr auto;
      height: 100vh;
      overflow: hidden;
    }

    .top-stats {
      position: sticky;
      top: 0;
      z-index: 6;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(10, 22, 40, 0.96), rgba(10, 22, 40, 0.92));
      backdrop-filter: blur(8px);
      padding: 10px 14px;
      display: grid;
      gap: 8px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(6, minmax(0, 1fr));
      gap: 8px;
    }

    .stat {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px 10px;
      background: #ffffff08;
      min-height: 68px;
      display: grid;
      gap: 2px;
      align-content: center;
    }

    .stat label {
      color: var(--muted);
      font-size: 0.73rem;
      letter-spacing: 0.12px;
      text-transform: uppercase;
    }

    .stat strong {
      font-size: 1.03rem;
      font-family: "Space Mono", monospace;
      letter-spacing: 0.1px;
    }

    .top-controls {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      align-items: center;
    }

    .weight-box {
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #ffffff07;
      padding: 8px 10px;
      display: grid;
      gap: 6px;
    }

    .weight-box label {
      display: flex;
      justify-content: space-between;
      font-size: 0.79rem;
      color: var(--muted);
    }

    .weight-box input[type="range"] {
      width: 100%;
      accent-color: #8cc7ff;
    }

    .content {
      padding: 14px;
      display: grid;
      gap: 12px;
      align-content: start;
      overflow-y: auto;
      overflow-x: hidden;
      min-height: 0;
      max-height: calc(100vh - 170px);
      scroll-behavior: smooth;
    }

    .tab {
      display: none;
      gap: 12px;
      animation: fadeIn 180ms ease;
    }

    .tab.active {
      display: grid;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(4px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .panel {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(32, 43, 63, 0.88), rgba(20, 30, 46, 0.88));
      box-shadow: var(--shadow);
      padding: 12px;
      min-width: 0;
    }

    .panel h2,
    .panel h3 {
      margin: 0;
      font-family: "Sora", sans-serif;
      letter-spacing: 0.2px;
    }

    .panel-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .panel-head p {
      margin: 2px 0 0;
      color: var(--muted);
      font-size: 0.82rem;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      min-width: 0;
    }

    .grid-3 {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
      min-width: 0;
    }

    .grid-4 {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
      min-width: 0;
    }

    .controls-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .controls-row > * {
      min-width: 0;
    }

    select,
    input[type="text"],
    input[type="number"],
    input[type="search"],
    textarea {
      border: 1px solid var(--border);
      background: #0f1b2f;
      color: var(--text);
      border-radius: 9px;
      padding: 7px 9px;
      font-size: 0.87rem;
      outline: none;
      width: 100%;
    }

    textarea {
      min-height: 86px;
      resize: vertical;
    }

    input[type="range"] {
      width: 100%;
      accent-color: #7fc3ff;
    }

    .chart {
      width: 100%;
      min-height: 320px;
      height: min(46vh, 460px);
      max-height: 500px;
      overflow: hidden;
    }

    .chart.small {
      min-height: 260px;
      height: min(38vh, 360px);
      max-height: 380px;
    }

    .chart.tall {
      min-height: 420px;
      height: min(56vh, 600px);
      max-height: 620px;
    }

    .exec-guide {
      border: 1px solid var(--border);
      border-radius: 10px;
      background: linear-gradient(90deg, rgba(39, 167, 255, 0.18), rgba(0, 200, 150, 0.12));
      padding: 8px 10px;
      display: grid;
      gap: 3px;
    }

    .exec-guide .title {
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.09em;
      color: #d9e9fb;
      font-weight: 700;
    }

    .exec-guide .flow {
      font-size: 0.8rem;
      line-height: 1.32;
      color: #c7daee;
    }

    .hint {
      color: var(--muted);
      font-size: 0.78rem;
    }

    .mono {
      font-family: "Space Mono", monospace;
    }

    .table-wrap {
      overflow: auto;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #0f1b2f;
      max-width: 100%;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      min-width: 760px;
      font-size: 0.82rem;
    }

    th,
    td {
      border-bottom: 1px solid var(--border);
      padding: 7px 8px;
      vertical-align: top;
      text-align: left;
    }

    th {
      position: sticky;
      top: 0;
      background: #13233b;
      color: #d0e0f5;
      z-index: 1;
      font-weight: 600;
      cursor: default;
      user-select: none;
    }

    tbody tr:hover {
      background: #ffffff09;
    }

    td input,
    td select {
      padding: 5px 6px;
      font-size: 0.8rem;
      min-width: 70px;
    }

    .risk-pill,
    .action-pill,
    .priority-pill {
      display: inline-block;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 0.74rem;
      border: 1px solid transparent;
      white-space: nowrap;
    }

    .risk-pill.resistant {
      background: rgba(0, 200, 150, 0.18);
      border-color: rgba(0, 200, 150, 0.45);
      color: #5de8c0;
    }

    .risk-pill.augment {
      background: rgba(39, 167, 255, 0.18);
      border-color: rgba(39, 167, 255, 0.44);
      color: #85ccff;
    }

    .risk-pill.high {
      background: rgba(245, 166, 35, 0.18);
      border-color: rgba(245, 166, 35, 0.44);
      color: #ffcc7a;
    }

    .risk-pill.critical {
      background: rgba(231, 76, 60, 0.18);
      border-color: rgba(231, 76, 60, 0.45);
      color: #ff9f93;
    }

    .action-pill.eliminate { background: rgba(231, 76, 60, 0.18); color: #ff968b; border-color: rgba(231, 76, 60, 0.44); }
    .action-pill.augment { background: rgba(39, 167, 255, 0.18); color: #8cd2ff; border-color: rgba(39, 167, 255, 0.44); }
    .action-pill.reskill { background: rgba(245, 166, 35, 0.18); color: #f8cf8f; border-color: rgba(245, 166, 35, 0.44); }
    .action-pill.protect { background: rgba(0, 200, 150, 0.18); color: #7ae2c6; border-color: rgba(0, 200, 150, 0.44); }

    .priority-pill.p1 { background: rgba(231, 76, 60, 0.15); color: #ff9f93; border: 1px solid rgba(231, 76, 60, 0.34); }
    .priority-pill.p2 { background: rgba(245, 166, 35, 0.15); color: #ffd596; border: 1px solid rgba(245, 166, 35, 0.34); }
    .priority-pill.p3 { background: rgba(39, 167, 255, 0.15); color: #9ad4ff; border: 1px solid rgba(39, 167, 255, 0.34); }

    .cards-4 {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
    }

    .summary-card {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px;
      background: #ffffff08;
      display: grid;
      gap: 6px;
    }

    .summary-card h4 {
      margin: 0;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.1px;
    }

    .summary-card strong {
      font-family: "Space Mono", monospace;
      font-size: 1.06rem;
    }

    .detail-block {
      border-top: 1px dashed var(--border);
      background: #0e1b2d;
    }

    .detail-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      padding: 10px;
      font-size: 0.8rem;
    }

    .detail-grid strong {
      display: block;
      color: #b9d0e7;
      font-size: 0.75rem;
      margin-bottom: 3px;
      text-transform: uppercase;
    }

    .gantt {
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
      background: #0f1b2f;
    }

    .gantt-header,
    .gantt-row {
      display: grid;
      grid-template-columns: 200px 1fr 110px;
      align-items: center;
      gap: 8px;
      padding: 7px 8px;
      border-bottom: 1px solid var(--border);
      font-size: 0.8rem;
    }

    .gantt-header {
      background: #13233b;
      font-weight: 600;
    }

    .gantt-track {
      height: 24px;
      border-radius: 999px;
      background: #ffffff0a;
      position: relative;
      overflow: hidden;
    }

    .gantt-bar {
      position: absolute;
      top: 0;
      height: 100%;
      border-radius: inherit;
      background: linear-gradient(90deg, rgba(39, 167, 255, 0.55), rgba(0, 200, 150, 0.45));
      border: 1px solid rgba(39, 167, 255, 0.56);
      cursor: grab;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #f2f8ff;
      font-size: 0.72rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      padding: 0 6px;
    }

    .gantt-bar:active {
      cursor: grabbing;
    }

    .gantt-dep {
      font-size: 0.72rem;
      color: var(--muted);
    }

    .scenario-cards {
      display: grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 8px;
    }

    .scenario-card {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px;
      background: #ffffff08;
      font-size: 0.78rem;
    }

    .scenario-card strong {
      display: block;
      margin-top: 3px;
      font-family: "Space Mono", monospace;
      font-size: 1rem;
    }

    .score-badge {
      display: inline-block;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 4px 9px;
      font-size: 0.78rem;
      background: #ffffff07;
    }

    .status-good { border-color: rgba(0, 200, 150, 0.6); color: #8cf2d7; }
    .status-med { border-color: rgba(245, 166, 35, 0.62); color: #ffd294; }
    .status-bad { border-color: rgba(231, 76, 60, 0.62); color: #ffb2a9; }

    .question-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }

    .question-box {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px;
      background: #ffffff07;
      display: grid;
      gap: 5px;
      font-size: 0.8rem;
    }

    .question-box label {
      color: #c7d9eb;
      min-height: 34px;
      line-height: 1.3;
    }

    .benchmark-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
    }

    .benchmark {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 9px;
      background: #ffffff07;
      display: grid;
      gap: 6px;
    }

    .benchmark strong {
      font-family: "Space Mono", monospace;
      font-size: 1.05rem;
    }

    .board-output {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      background: #0f1b2f;
      min-height: 300px;
      white-space: pre-wrap;
      line-height: 1.38;
      font-size: 0.86rem;
      overflow: auto;
    }

    .talking-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }

    .talk-card {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px;
      background: #ffffff07;
      font-size: 0.83rem;
      line-height: 1.35;
    }

    .talk-card h4 {
      margin: 0 0 6px;
      font-size: 0.86rem;
      color: #d3e4f6;
    }

    .ethical-footer {
      border-top: 1px solid var(--border);
      padding: 10px 14px;
      background: rgba(10, 22, 40, 0.88);
      font-size: 0.77rem;
      color: #b6cbdf;
      line-height: 1.35;
      display: grid;
      gap: 4px;
    }

    .ethical-footer strong {
      color: #e4f0fb;
    }

    .onboarding {
      position: fixed;
      inset: 0;
      background: rgba(6, 12, 22, 0.82);
      backdrop-filter: blur(4px);
      z-index: 20;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
    }

    .onboarding.active {
      display: flex;
    }

    .onboarding-card {
      width: min(760px, 96vw);
      border: 1px solid var(--border);
      border-radius: 16px;
      background: linear-gradient(180deg, #1f2b40, #141f31);
      box-shadow: var(--shadow);
      padding: 16px;
      display: grid;
      gap: 12px;
    }

    .step-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.9rem;
      color: var(--muted);
    }

    .step-title {
      font-family: "Sora", sans-serif;
      font-size: 1.2rem;
      margin: 0;
    }

    .onboard-grid {
      display: grid;
      gap: 10px;
      grid-template-columns: 1fr 1fr;
    }

    .onboard-option {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px;
      background: #ffffff08;
      cursor: pointer;
      transition: border-color 140ms ease, background 140ms ease;
    }

    .onboard-option.active,
    .onboard-option:hover {
      border-color: rgba(39, 167, 255, 0.6);
      background: rgba(39, 167, 255, 0.14);
    }

    .onboard-option strong {
      display: block;
      font-size: 0.9rem;
      margin-bottom: 4px;
    }

    .onboard-option small {
      color: var(--muted);
      font-size: 0.78rem;
      line-height: 1.3;
    }

    .onboard-actions {
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }

    .toast {
      position: fixed;
      right: 12px;
      bottom: 12px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(17, 29, 48, 0.95);
      color: var(--text);
      font-size: 0.82rem;
      z-index: 30;
      opacity: 0;
      transform: translateY(8px);
      pointer-events: none;
      transition: opacity 180ms ease, transform 180ms ease;
    }

    .toast.active {
      opacity: 1;
      transform: translateY(0);
    }

    .context-menu {
      position: fixed;
      z-index: 25;
      min-width: 180px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #0e1b2d;
      box-shadow: var(--shadow);
      padding: 6px;
      display: none;
    }

    .context-menu button {
      width: 100%;
      text-align: left;
      border: 0;
      background: transparent;
      color: var(--text);
      padding: 7px 8px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.82rem;
    }

    .context-menu button:hover {
      background: #ffffff12;
    }

    .mini-kpis {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 0.76rem;
      color: var(--muted);
    }

    .mini-kpis span {
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 3px 8px;
      background: #ffffff08;
    }

    .size-presets {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }

    .size-presets button {
      border: 1px solid var(--border);
      background: #ffffff09;
      color: var(--text);
      border-radius: 999px;
      padding: 4px 8px;
      font-size: 0.76rem;
      cursor: pointer;
    }

    .size-presets button:hover {
      background: #ffffff16;
    }

    .quality-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 8px;
      margin-bottom: 10px;
    }

    .quality-card {
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #ffffff07;
      padding: 8px;
      display: grid;
      gap: 4px;
      font-size: 0.78rem;
    }

    .quality-card strong {
      font-family: "Space Mono", monospace;
      font-size: 0.95rem;
    }

    .quality-badge {
      display: inline-block;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 0.72rem;
      padding: 2px 7px;
      line-height: 1.2;
      white-space: nowrap;
    }

    .quality-badge.high {
      color: #9af3dc;
      border-color: rgba(0, 200, 150, 0.62);
      background: rgba(0, 200, 150, 0.18);
    }

    .quality-badge.medium {
      color: #ffd89f;
      border-color: rgba(245, 166, 35, 0.62);
      background: rgba(245, 166, 35, 0.18);
    }

    .quality-badge.low {
      color: #ffb5ad;
      border-color: rgba(231, 76, 60, 0.62);
      background: rgba(231, 76, 60, 0.18);
    }

    .hidden {
      display: none !important;
    }

    @media (max-width: 1250px) {
      .stats-grid {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }

      .top-controls {
        grid-template-columns: 1fr;
      }

      .grid-3,
      .grid-4,
      .cards-4,
      .quality-grid,
      .benchmark-grid,
      .scenario-cards,
      .question-grid,
      .talking-grid,
      .onboard-grid,
      .grid-2 {
        grid-template-columns: 1fr;
      }

      .app {
        grid-template-columns: var(--sidebar-collapsed) 1fr;
      }

      .sidebar .brand h1,
      .sidebar .brand small,
      .sidebar .nav-btn span:not(.nav-icon),
      .sidebar .quick-actions,
      .sidebar .collapse-btn span {
        display: none;
      }

      .sidebar .nav-btn {
        grid-template-columns: 1fr;
        justify-items: center;
      }

      .gantt-header,
      .gantt-row {
        grid-template-columns: 1fr;
        gap: 4px;
      }
    }

    @media print {
      html,
      body {
        height: auto !important;
        overflow: visible !important;
        background: #ffffff !important;
        color: #111111 !important;
      }

      .sidebar,
      .top-controls,
      .quick-actions,
      .controls-row,
      .ethical-footer,
      .onboarding,
      .context-menu {
        display: none !important;
      }

      .app,
      .main,
      .content,
      .tab,
      .panel {
        display: block !important;
        overflow: visible !important;
        height: auto !important;
        max-height: none !important;
      }

      .panel {
        break-inside: avoid;
        margin-bottom: 10px;
        background: #ffffff;
        color: #111;
      }
    }
  </style>
</head>
<body>
  <div class="app" id="appShell">
    <aside class="sidebar" id="sidebar">
      <div class="brand">
        <h1>AI Workforce Dashboard v1</h1>
        <small id="orgLabel">No Organization Loaded</small>
      </div>

      <button id="collapseSidebar" class="collapse-btn" type="button"><span>Collapse Navigation</span></button>

      <nav class="nav" id="sidebarNav">
        <button class="nav-btn active" data-tab="tab-warboard" type="button"><span class="nav-icon">01</span><span>Org Workforce Map</span></button>
        <button class="nav-btn" data-tab="tab-financial" type="button"><span class="nav-icon">02</span><span>Financial Impact</span></button>
        <button class="nav-btn" data-tab="tab-actions" type="button"><span class="nav-icon">03</span><span>Role Action Planner</span></button>
        <button class="nav-btn" data-tab="tab-scenarios" type="button"><span class="nav-icon">04</span><span>Scenario Simulator</span></button>
        <button class="nav-btn" data-tab="tab-readiness" type="button"><span class="nav-icon">05</span><span>AI Readiness</span></button>
        <button class="nav-btn" data-tab="tab-competitive" type="button"><span class="nav-icon">06</span><span>Competitive Intel</span></button>
        <button class="nav-btn" data-tab="tab-board" type="button"><span class="nav-icon">07</span><span>Board Deck Generator</span></button>
      </nav>

      <div class="quick-actions">
        <button class="btn primary" id="saveConfigBtn" type="button">Save Configuration</button>
        <button class="btn" id="loadConfigBtn" type="button">Load Saved Configuration</button>
        <button class="btn" id="resetConfigBtn" type="button">Reset to Template</button>
        <button class="btn warn" id="exportStateBtn" type="button">Export Scenario JSON</button>
      </div>
    </aside>

    <main class="main">
      <section class="top-stats">
        <div class="stats-grid">
          <div class="stat"><label>Total Headcount</label><strong id="kpiHeadcount">0</strong></div>
          <div class="stat"><label>Total Compensation Cost</label><strong id="kpiComp">$0</strong></div>
          <div class="stat"><label>Critical Risk (76-100)</label><strong id="kpiCritical">0 (0%)</strong></div>
          <div class="stat"><label>Addressable Savings</label><strong id="kpiAddressable">$0</strong></div>
          <div class="stat"><label>Weighted Avg Risk</label><strong id="kpiRisk">0.0</strong></div>
          <div class="stat"><label>AI Readiness Index</label><strong id="kpiReadiness">0.0</strong></div>
        </div>

        <div class="exec-guide">
          <div class="title">Executive Quick Path</div>
          <div class="flow">1) Set organization template and scale. 2) Review war board risk map. 3) Validate financial waterfall and ROI timeline. 4) Finalize role actions and scenario comparisons. 5) Generate board summary and export.</div>
        </div>

        <div class="top-controls">
          <div class="weight-box">
            <label><span>Automation Maturity</span><span id="automationMaturityValue">45%</span></label>
            <input id="automationMaturity" type="range" min="0" max="100" value="45" />
          </div>
          <div class="weight-box">
            <label><span>Data Infrastructure Maturity</span><span id="dataMaturityValue">40%</span></label>
            <input id="dataMaturity" type="range" min="0" max="100" value="40" />
          </div>
          <div class="weight-box">
            <label><span>Readiness Weighting</span><span id="weightSummary">Risk 50% / Automation 25% / Data 25%</span></label>
            <div class="controls-row">
              <input id="riskWeight" type="range" min="0" max="100" value="50" style="flex:1;" />
              <input id="automationWeight" type="range" min="0" max="100" value="25" style="flex:1;" />
              <input id="dataWeight" type="range" min="0" max="100" value="25" style="flex:1;" />
            </div>
          </div>
        </div>
      </section>

      <section class="content">
        <section class="tab active" id="tab-warboard">
          <article class="panel">
            <div class="panel-head">
              <div>
                <h2>The War Board</h2>
                <p>Company to role-level displacement risk mapping with editable template controls and drill-down analytics.</p>
              </div>
              <div class="mini-kpis" id="warboardMiniKpis"></div>
            </div>

            <div class="controls-row" style="margin-bottom: 10px;">
              <select id="templateSelect" style="max-width: 340px;"></select>
              <button class="btn good" id="applyTemplateBtn" type="button">Apply Template</button>
              <input id="organizationNameInput" type="text" placeholder="Organization name" style="max-width: 220px;" />
              <input id="revenueInput" type="number" min="0" step="1000000" placeholder="Annual revenue (USD)" style="max-width: 220px;" />
              <input id="targetHeadcountInput" type="number" min="500" max="250000" step="100" placeholder="Target headcount (up to 250,000)" style="max-width: 260px;" />
              <button class="btn" id="applyTargetHeadcountBtn" type="button">Scale Headcount</button>
              <input id="csvUpload" type="file" accept=".csv" style="max-width: 280px;" />
              <button class="btn" id="importCsvBtn" type="button">Import CSV</button>
            </div>

            <div class="grid-2">
              <div class="panel" style="padding: 10px;">
                <h3 style="margin-bottom:8px;">Org Heatmap Treemap</h3>
                <div id="orgTreemap" class="chart tall"></div>
              </div>

              <div class="panel" style="padding: 10px;">
                <h3 style="margin-bottom:8px;">Selected Node Detail</h3>
                <div id="nodeDetail" class="board-output" style="min-height: 420px; max-height: 420px;"></div>
              </div>
            </div>
          </article>

          <article class="panel">
            <div class="panel-head">
              <div>
                <h3>Template Function Editor</h3>
                <p>Edit function-level defaults before role-level planning. Changes flow to all downstream financials.</p>
              </div>
              <div class="controls-row">
                <button class="btn" id="addFunctionBtn" type="button">Add Function</button>
                <button class="btn" id="normalizeHeadcountBtn" type="button">Normalize to Target Size</button>
              </div>
            </div>

            <div class="table-wrap" style="max-height: 400px;">
              <table id="functionTable">
                <thead>
                  <tr>
                    <th>Department</th>
                    <th>Function</th>
                    <th>Headcount</th>
                    <th>Avg Salary</th>
                    <th>Base Risk</th>
                    <th>Automation Level</th>
                    <th>Rationale</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="functionTableBody"></tbody>
              </table>
            </div>

            <div class="hint" style="margin-top:8px;">CSV import columns: Department, Function, Role Title, Headcount, Average Salary, Location. Existing org roles can be fully replaced by upload.</div>
          </article>
        </section>

        <section class="tab" id="tab-financial">
          <article class="panel">
            <div class="panel-head">
              <div>
                <h2>The Money Machine</h2>
                <p>Waterfall, NPV timeline, ROI ranking, and sensitivity stress testing with real-time assumption controls.</p>
              </div>
            </div>

            <div class="grid-3">
              <div class="panel" style="padding: 10px;">
                <h3>Assumption Sliders</h3>
                <div class="question-grid" id="assumptionControls"></div>
              </div>

              <div class="panel" style="padding: 10px; grid-column: span 2;">
                <h3>Cost Savings Waterfall</h3>
                <div id="waterfallChart" class="chart"></div>
                <div id="waterfallDetail" class="hint">Click a waterfall bar to see role-level detail.</div>
              </div>
            </div>
          </article>

          <article class="grid-2">
            <div class="panel">
              <div class="panel-head"><h3>ROI Timeline Projection</h3></div>
              <div id="roiTimelineChart" class="chart"></div>
              <div class="table-wrap" style="max-height: 220px; margin-top: 8px;">
                <table>
                  <thead>
                    <tr>
                      <th>Year</th>
                      <th>Investment</th>
                      <th>Savings</th>
                      <th>Net Impact</th>
                      <th>Cumulative Net</th>
                    </tr>
                  </thead>
                  <tbody id="roiYearTableBody"></tbody>
                </table>
              </div>
            </div>

            <div class="panel">
              <div class="panel-head">
                <h3>Department-Level ROI</h3>
                <select id="deptSortSelect" style="max-width: 210px;">
                  <option value="savings">Sort by Savings</option>
                  <option value="roi">Sort by ROI</option>
                  <option value="speed">Sort by Speed to Value</option>
                  <option value="complexity">Sort by Complexity</option>
                </select>
              </div>
              <div id="deptRoiChart" class="chart"></div>
              <div class="table-wrap" style="max-height: 220px; margin-top: 8px;">
                <table>
                  <thead>
                    <tr>
                      <th>Department</th>
                      <th>Addressable Savings</th>
                      <th>ROI Ratio</th>
                      <th>Break-even (Months)</th>
                      <th>Complexity (1-10)</th>
                    </tr>
                  </thead>
                  <tbody id="deptRoiTableBody"></tbody>
                </table>
              </div>
            </div>
          </article>

          <article class="panel">
            <div class="panel-head"><h3>Sensitivity Analysis (Tornado)</h3></div>
            <div id="sensitivityChart" class="chart"></div>
          </article>
        </section>

        <section class="tab" id="tab-actions">
          <article class="panel">
            <div class="panel-head">
              <div>
                <h2>The Hit List</h2>
                <p>Role-by-role actions with detailed decomposition, legal constraints, tooling guidance, and phased implementation planning.</p>
              </div>
            </div>

            <div class="cards-4" id="actionSummaryCards"></div>
          </article>

          <article class="panel">
            <div class="panel-head">
              <h3>Role Action Table</h3>
              <div class="controls-row">
                <button class="btn" id="selectAllFilteredBtn" type="button">Select Filtered</button>
                <button class="btn" id="clearSelectionBtn" type="button">Clear Selection</button>
                <button class="btn" id="bulkEliminateBtn" type="button">Bulk: Eliminate</button>
                <button class="btn" id="bulkAugmentBtn" type="button">Bulk: Augment</button>
                <button class="btn" id="bulkReskillBtn" type="button">Bulk: Reskill</button>
                <button class="btn warn" id="deleteSelectedRolesBtn" type="button">Delete Selected</button>
              </div>
            </div>

            <div class="grid-4" style="margin-bottom: 8px;">
              <input id="filterSearch" type="search" placeholder="Search role title" />
              <select id="filterDepartment"></select>
              <select id="filterAction">
                <option value="all">All Actions</option>
                <option value="eliminate">Eliminate</option>
                <option value="augment">Augment</option>
                <option value="reskill">Reskill</option>
                <option value="protect">Protect</option>
              </select>
              <select id="filterPriority">
                <option value="all">All Priority</option>
                <option value="P1">P1</option>
                <option value="P2">P2</option>
                <option value="P3">P3</option>
              </select>
              <input id="filterRiskMin" type="number" min="0" max="100" placeholder="Min Risk" />
              <input id="filterRiskMax" type="number" min="0" max="100" placeholder="Max Risk" />
              <input id="filterSavingsMin" type="number" min="0" step="100000" placeholder="Min Savings (USD)" />
              <input id="filterImplMax" type="number" min="0" max="60" placeholder="Max Implementation Months" />
            </div>

            <div class="table-wrap" style="max-height: 520px;">
              <table>
                <thead>
                  <tr>
                    <th></th>
                    <th>Role Title</th>
                    <th>Department</th>
                    <th>Headcount</th>
                    <th>Avg Salary</th>
                    <th>Total Cost</th>
                    <th>Risk</th>
                    <th>Action</th>
                    <th>AI Tool/Solution</th>
                    <th>Savings (Annual)</th>
                    <th>Impl. Time</th>
                    <th>Priority</th>
                    <th>Expand</th>
                  </tr>
                </thead>
                <tbody id="roleTableBody"></tbody>
              </table>
            </div>
          </article>

          <article class="panel">
            <div class="panel-head"><h3>Implementation Gantt</h3></div>
            <div class="gantt" id="ganttContainer"></div>
            <div class="hint" style="margin-top:8px;">Drag bars horizontally to adjust start month. Dependencies are shown at right. Phases: Quick Wins (0-6), Phase 1 (6-12), Phase 2 (12-24), Phase 3 (24-36), Full (36-60).</div>
          </article>
        </section>

        <section class="tab" id="tab-scenarios">
          <article class="panel">
            <div class="panel-head">
              <div>
                <h2>War Games</h2>
                <p>Stress-test transformation ambition against financial outcomes, risk profile, and competitive position.</p>
              </div>
              <div class="controls-row">
                <select id="scenarioSelect" style="max-width: 320px;"></select>
                <button class="btn" id="applyScenarioBtn" type="button">Apply Scenario</button>
              </div>
            </div>

            <div class="grid-3">
              <div class="panel" style="padding:10px;">
                <h3>Scenario Controls</h3>
                <div class="question-grid" id="scenarioControls"></div>
              </div>

              <div class="panel" style="padding:10px; grid-column: span 2;">
                <h3>Selected Scenario Output</h3>
                <div class="scenario-cards" id="scenarioMetricCards"></div>
                <div id="scenarioTrajectoryChart" class="chart"></div>
              </div>
            </div>
          </article>

          <article class="grid-2">
            <div class="panel">
              <div class="panel-head">
                <h3>Side-by-Side Comparison</h3>
                <div class="controls-row">
                  <select id="compareA"></select>
                  <select id="compareB"></select>
                  <select id="compareC"></select>
                </div>
              </div>
              <div id="scenarioComparisonBars" class="chart small"></div>
              <div class="table-wrap" style="max-height:220px; margin-top:8px;">
                <table>
                  <thead>
                    <tr>
                      <th>Scenario</th>
                      <th>Year 1 Net</th>
                      <th>Year 3 Net</th>
                      <th>Year 5 Net</th>
                      <th>Execution Risk</th>
                      <th>Regulatory Risk</th>
                    </tr>
                  </thead>
                  <tbody id="scenarioDecisionTable"></tbody>
                </table>
              </div>
            </div>

            <div class="panel">
              <div class="panel-head"><h3>Risk Radar + Monte Carlo (1,000 Runs)</h3></div>
              <div id="scenarioRiskRadar" class="chart small"></div>
              <div id="monteCarloChart" class="chart small"></div>
              <div class="hint" id="monteCarloSummary"></div>
            </div>
          </article>
        </section>

        <section class="tab" id="tab-readiness">
          <article class="panel">
            <div class="panel-head">
              <div>
                <h2>Are You Ready?</h2>
                <p>Readiness scorecard aligned to data, culture, operations, and leadership prerequisites for AI-led workforce transformation.</p>
              </div>
              <div>
                <span class="score-badge" id="readinessBadge">Readiness Score: 0</span>
              </div>
            </div>

            <div class="grid-2">
              <div class="panel" style="padding:10px;">
                <h3>Self-Assessment Questionnaire</h3>
                <div id="readinessQuestions"></div>
              </div>

              <div class="panel" style="padding:10px;">
                <h3>Gap Analysis Radar</h3>
                <div id="readinessRadar" class="chart"></div>
                <div id="readinessRecommendations" class="board-output" style="min-height:140px;"></div>
              </div>
            </div>
          </article>

          <article class="panel">
            <div class="panel-head"><h3>Readiness Roadmap</h3></div>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Gap Area</th>
                    <th>Current Score</th>
                    <th>Target</th>
                    <th>Actions</th>
                    <th>Timeline</th>
                    <th>Estimated Investment</th>
                  </tr>
                </thead>
                <tbody id="readinessRoadmapBody"></tbody>
              </table>
            </div>
          </article>
        </section>

        <section class="tab" id="tab-competitive">
          <article class="panel">
            <div class="panel-head">
              <div>
                <h2>Competitive Intelligence</h2>
                <p>Benchmark your plan versus peer AI investments, workforce moves, and timeline aggressiveness across industries.</p>
              </div>
            </div>

            <div class="quality-grid" id="competitiveQualitySummary"></div>
            <div class="hint" id="modelReferenceSummary" style="margin-bottom: 8px;"></div>

            <div class="table-wrap" style="max-height: 360px;">
              <table>
                <thead>
                  <tr>
                    <th>Company</th>
                    <th>Industry</th>
                    <th>AI Investment</th>
                    <th>Headcount Reduction</th>
                    <th>Key Initiatives</th>
                    <th>Timeline</th>
                    <th>As-of</th>
                    <th>Confidence</th>
                    <th>Source</th>
                  </tr>
                </thead>
                <tbody id="competitiveTableBody"></tbody>
              </table>
            </div>
          </article>

          <article class="grid-2">
            <div class="panel">
              <div class="panel-head"><h3>Where Do You Stand?</h3></div>
              <div id="positioningChart" class="chart"></div>
            </div>

            <div class="panel">
              <div class="panel-head"><h3>Peer Benchmarking</h3></div>
              <div class="benchmark-grid" id="benchmarkControls"></div>
              <div class="benchmark-grid" id="benchmarkResults" style="margin-top: 8px;"></div>
            </div>
          </article>
        </section>

        <section class="tab" id="tab-board">
          <article class="panel">
            <div class="panel-head">
              <div>
                <h2>Ship It</h2>
                <p>Generate board-ready narratives, talking points, and export artifacts for board, investors, and regulator discussions.</p>
              </div>
              <div class="controls-row">
                <button class="btn primary" id="generateBoardSummaryBtn" type="button">Generate Executive Summary</button>
                <button class="btn" id="copyBoardSummaryBtn" type="button">Copy Summary</button>
              </div>
            </div>

            <div id="boardSummaryOutput" class="board-output"></div>
          </article>

          <article class="panel">
            <div class="panel-head"><h3>Talking Points Generator</h3></div>
            <div class="talking-grid" id="talkingPointsGrid"></div>
          </article>

          <article class="panel">
            <div class="panel-head"><h3>Export Options</h3></div>
            <div class="controls-row">
              <button class="btn" id="exportPdfBtn" type="button">Export Current Tab PDF</button>
              <button class="btn" id="exportPngBtn" type="button">Export Current Tab PNG</button>
              <button class="btn" id="exportCsvBtn" type="button">Export Roles CSV</button>
              <button class="btn" id="exportExcelBtn" type="button">Export Excel Workbook</button>
              <button class="btn good" id="printViewBtn" type="button">Print View</button>
            </div>
            <div class="hint" id="exportStatus">Exports are client-side only. Files are generated locally in your browser session.</div>
          </article>
        </section>
      </section>

      <footer class="ethical-footer">
        <div><strong>Responsible Transition:</strong> Pair workforce reductions with measurable reskilling and redeployment pathways. Track transition outcomes quarterly.</div>
        <div><strong>Regulatory + Legal:</strong> Model WARN Act thresholds, jurisdiction-specific notice periods, labor relations obligations, and required human sign-off controls.</div>
        <div><strong>DEI + Community Impact:</strong> Run impact checks for concentrated displacement risk by geography, demographic mix, and critical community dependencies.</div>
        <div><strong>Reputational Risk:</strong> Board communication should explicitly address customer impact, service continuity, safety, and ethical AI governance boundaries.</div>
      </footer>
    </main>
  </div>

  <div class="onboarding" id="onboardingModal">
    <div class="onboarding-card">
      <div class="step-head">
        <span id="onboardStepText">Step 1 / 3</span>
        <span class="hint">Five-minute setup to first-pass transformation plan</span>
      </div>
      <h3 class="step-title" id="onboardTitle">Select your industry template</h3>
      <div id="onboardBody"></div>
      <div class="onboard-actions">
        <button class="btn" id="onboardBackBtn" type="button">Back</button>
        <div class="controls-row">
          <button class="btn" id="onboardSkipBtn" type="button">Skip Setup</button>
          <button class="btn primary" id="onboardNextBtn" type="button">Next</button>
        </div>
      </div>
    </div>
  </div>

  <div class="context-menu" id="roleContextMenu"></div>
  <div class="toast" id="toast"></div>

  <script>
    (function () {
      "use strict";

      const STORAGE_KEY = "ai_workforce_dashboard_v1_2026_02";
      const LEGACY_STORAGE_KEYS = [
        "ai_workforce_dashboard_fresh_start_v2026_02",
        "ai_workforce_dashboard_v2026_02"
      ];
      const HISTORY_LIMIT = 120;
      const MAX_MONTE_CARLO_RUNS = 1000;
      const DATA_CALIBRATION_DATE = "2026-02-12";

      const DEFAULT_ASSUMPTIONS = {
        severanceMonths: 6,
        aiCostPerEmployee: 5000,
        reskillCostPerEmployee: 10000,
        productivityGainDefault: 30,
        implementationTimelineMonths: 24,
        discountRate: 8,
        benefitsLoadPercent: 30,
        changeManagementPercent: 8,
        attritionOffsetPercent: 12,
        salaryInflationPercent: 3,
        implementationRiskBufferPercent: 10
      };

      const SCENARIO_LIBRARY = {
        status_quo: {
          id: "status_quo",
          name: "Status Quo",
          thresholdRisk: 101,
          realizationRate: 0,
          timelineMonths: 60,
          workforceReductionTarget: 0,
          investmentMultiplier: 0.1,
          costOfInactionPenalty: 0.2,
          riskProfile: { execution: 2, legal: 2, culture: 3, competitive: 9, regulatory: 4 },
          summary: "No AI-led workforce transformation; cost of inaction compounds through margin compression and talent flight."
        },
        conservative: {
          id: "conservative",
          name: "Conservative / Surgical",
          thresholdRisk: 80,
          realizationRate: 0.22,
          timelineMonths: 24,
          workforceReductionTarget: 12,
          investmentMultiplier: 0.65,
          costOfInactionPenalty: 0.08,
          riskProfile: { execution: 3, legal: 3, culture: 3, competitive: 6, regulatory: 4 },
          summary: "Targets only critical-risk roles to minimize disruption while harvesting quick operational savings."
        },
        balanced: {
          id: "balanced",
          name: "Balanced Transformation",
          thresholdRisk: 60,
          realizationRate: 0.52,
          timelineMonths: 30,
          workforceReductionTarget: 24,
          investmentMultiplier: 0.9,
          costOfInactionPenalty: 0.03,
          riskProfile: { execution: 5, legal: 4, culture: 5, competitive: 4, regulatory: 5 },
          summary: "Moderate-risk strategy balancing savings capture with significant reskilling and governance controls."
        },
        aggressive: {
          id: "aggressive",
          name: "Aggressive Optimization",
          thresholdRisk: 40,
          realizationRate: 0.78,
          timelineMonths: 20,
          workforceReductionTarget: 37,
          investmentMultiplier: 1.15,
          costOfInactionPenalty: 0,
          riskProfile: { execution: 7, legal: 6, culture: 8, competitive: 2, regulatory: 6 },
          summary: "Accelerated redesign to capture most addressable savings with elevated execution and cultural risk."
        },
        mercury: {
          id: "mercury",
          name: "Project Mercury",
          thresholdRisk: 0,
          realizationRate: 1,
          timelineMonths: 14,
          workforceReductionTarget: 58,
          investmentMultiplier: 1.45,
          costOfInactionPenalty: 0,
          riskProfile: { execution: 9, legal: 8, culture: 10, competitive: 1, regulatory: 8 },
          summary: "AI-first redesign from scratch targeting maximum workforce optimization and operating leverage."
        },
        custom: {
          id: "custom",
          name: "Custom",
          thresholdRisk: 60,
          realizationRate: 0.5,
          timelineMonths: 24,
          workforceReductionTarget: 25,
          investmentMultiplier: 1,
          costOfInactionPenalty: 0,
          riskProfile: { execution: 5, legal: 5, culture: 5, competitive: 5, regulatory: 5 },
          summary: "User-defined transformation envelope tuned to firm-specific risk appetite and constraints."
        }
      };

      const READINESS_DIMENSIONS = [
        {
          id: "data",
          label: "Data & Infrastructure",
          weight: 0.25,
          questions: [
            "Is your data centralized and accessible?",
            "Do you have clean, labeled datasets for AI training?",
            "Is your cloud and compute stack AI-ready?",
            "Do your core systems support API integration?",
            "Are data governance and security controls robust?"
          ]
        },
        {
          id: "talent",
          label: "Talent & Culture",
          weight: 0.25,
          questions: [
            "Does leadership understand AI capabilities and limits?",
            "Do you have internal AI/ML technical talent?",
            "Is the workforce open to AI adoption?",
            "Do you run formal reskilling/upskilling programs?",
            "Is there a culture of experimentation and iteration?"
          ]
        },
        {
          id: "operations",
          label: "Process & Operations",
          weight: 0.25,
          questions: [
            "Are core processes documented and standardized?",
            "Have high-value AI use cases been prioritized?",
            "Do you operate an AI governance framework?",
            "Are workflows measurable with clear KPIs and SLAs?",
            "Do you have strong change-management capability?"
          ]
        },
        {
          id: "strategy",
          label: "Strategy & Leadership",
          weight: 0.25,
          questions: [
            "Is AI transformation a board-level priority?",
            "Is there an executive sponsor with budget authority?",
            "Is AI strategy aligned to business strategy?",
            "Have you benchmarked peer AI adoption?",
            "Is accountability for AI outcomes explicit?"
          ]
        }
      ];

      const INDUSTRY_TEMPLATES = {
        banking: {
          id: "banking",
          name: "Large Bank / Financial Institution",
          description: "Global universal bank with operations, risk, technology, customer support, and corporate functions.",
          functions: [
            { department: "Back Office Operations", function: "Trade Settlement & Reconciliation", headcount: 800, avgSalary: 82000, baseRisk: 88, automationLevel: 68, rationale: "Straight-through processing and exception triage are highly automatable.", roles: ["Trade Settlement Analyst", "Reconciliation Specialist", "Confirmations Associate", "Corporate Actions Associate", "Exception Queue Handler"] },
            { department: "Compliance & Regulatory", function: "KYC/AML Monitoring", headcount: 600, avgSalary: 90000, baseRisk: 72, automationLevel: 57, rationale: "AI excels at document triage, anomaly detection, and surveillance with human review layers.", roles: ["KYC Analyst", "AML Surveillance Analyst", "Transaction Monitoring Specialist", "Regulatory Reporting Associate", "Enhanced Due Diligence Analyst"] },
            { department: "Risk Management", function: "Market/Credit Stress Analytics", headcount: 400, avgSalary: 130000, baseRisk: 65, automationLevel: 51, rationale: "Modeling and reporting automate well, while governance decisions stay human-led.", roles: ["Market Risk Analyst", "Credit Risk Modeler", "Stress Testing Analyst", "Model Validation Associate", "Risk Reporting Manager"] },
            { department: "Middle Office", function: "Trade Support & P&L Attribution", headcount: 350, avgSalary: 98000, baseRisk: 82, automationLevel: 63, rationale: "Highly procedural workflows with standardized controls and repetitive interventions.", roles: ["Trade Support Analyst", "P&L Attribution Analyst", "Margin Operations Specialist", "Collateral Associate", "Fails Management Analyst"] },
            { department: "IT / Technology", function: "Engineering, QA, DevOps", headcount: 1200, avgSalary: 165000, baseRisk: 55, automationLevel: 48, rationale: "AI copilots materially increase coding throughput and reduce testing effort.", roles: ["Software Engineer", "SRE Engineer", "QA Automation Engineer", "DevOps Engineer", "Platform Architect"] },
            { department: "Finance / Accounting", function: "Close, AP/AR, Reporting", headcount: 500, avgSalary: 110000, baseRisk: 70, automationLevel: 59, rationale: "Close processes and reconciliations are rule-based and suitable for automation.", roles: ["Financial Analyst", "Accounting Operations Analyst", "AP Specialist", "Regulatory Reporting Analyst", "Controller Associate"] },
            { department: "HR / People Ops", function: "Recruiting, Benefits, Payroll", headcount: 400, avgSalary: 95000, baseRisk: 62, automationLevel: 46, rationale: "Administrative flows are automatable while workforce strategy remains human.", roles: ["Recruiting Coordinator", "Benefits Administrator", "Payroll Specialist", "Learning Program Manager", "HR Operations Analyst"] },
            { department: "Legal", function: "Contract & Litigation Support", headcount: 300, avgSalary: 185000, baseRisk: 58, automationLevel: 42, rationale: "Contract review and e-discovery scale with AI while legal judgment remains essential.", roles: ["Contract Review Attorney", "Litigation Support Analyst", "Regulatory Counsel", "Legal Operations Manager", "Policy Drafting Associate"] },
            { department: "Sales & Relationship", function: "Client Coverage", headcount: 600, avgSalary: 170000, baseRisk: 35, automationLevel: 36, rationale: "Relationship roles remain human-centric but can be augmented with intelligence tools.", roles: ["Relationship Manager", "Business Development Director", "Client Success Banker", "Treasury Sales Officer", "Coverage Associate"] },
            { department: "Research / Strategy", function: "Research & Planning", headcount: 250, avgSalary: 175000, baseRisk: 60, automationLevel: 44, rationale: "Drafting and synthesis accelerate with AI; differentiated insight still human.", roles: ["Equity Research Analyst", "Macro Research Strategist", "Corporate Strategy Analyst", "Competitive Intelligence Lead", "Portfolio Insights Manager"] },
            { department: "Trading Desks", function: "Trading & Structuring", headcount: 500, avgSalary: 240000, baseRisk: 45, automationLevel: 52, rationale: "Execution automation is high; client and structuring complexity retains human edge.", roles: ["Trader", "Structurer", "Quant Developer", "Execution Specialist", "Voice Trading Associate"] },
            { department: "Customer Service", function: "Contact Center", headcount: 700, avgSalary: 65000, baseRisk: 90, automationLevel: 62, rationale: "Conversational AI handles most repeat inquiries and triage.", roles: ["Call Center Agent", "Chat Support Specialist", "Email Service Analyst", "Complaint Resolution Specialist", "Service Quality Reviewer"] },
            { department: "Executive Leadership", function: "C-Suite and Senior Management", headcount: 150, avgSalary: 420000, baseRisk: 15, automationLevel: 18, rationale: "Enterprise decision authority, stakeholder management, and regulator interaction are AI-resistant.", roles: ["Chief Officer", "Division Head", "Managing Director", "Strategic Program Lead", "Board Liaison"] },
            { department: "Facilities / Physical Ops", function: "Physical Operations", headcount: 200, avgSalary: 62000, baseRisk: 20, automationLevel: 22, rationale: "Requires physical presence and safety oversight.", roles: ["Facilities Manager", "Physical Security Officer", "Mailroom Specialist", "Branch Operations Coordinator", "Building Services Technician"] }
          ]
        },
        tech: {
          id: "tech",
          name: "Tech Company (SaaS / Platform)",
          description: "Product-led SaaS organization with engineering-heavy workforce and growth functions.",
          functions: [
            { department: "Engineering", function: "Application Engineering", headcount: 800, avgSalary: 185000, baseRisk: 50, automationLevel: 52, rationale: "Copilot-led workflows reduce low-complexity coding effort significantly.", roles: ["Backend Engineer", "Frontend Engineer", "Full-Stack Engineer", "QA Engineer", "SRE Engineer"] },
            { department: "Product Management", function: "Product Strategy & Delivery", headcount: 200, avgSalary: 190000, baseRisk: 45, automationLevel: 41, rationale: "AI supports specs, analytics, and backlog management; prioritization remains human.", roles: ["Product Manager", "Technical Program Manager", "Product Analyst", "Roadmap Operations Lead", "Growth PM"] },
            { department: "Design", function: "UX/UI and Research", headcount: 150, avgSalary: 165000, baseRisk: 55, automationLevel: 48, rationale: "Prototype and content generation accelerate while design judgment stays critical.", roles: ["Product Designer", "UX Researcher", "Design Systems Lead", "Visual Designer", "Content Designer"] },
            { department: "Data Science / ML", function: "Analytics and ML Ops", headcount: 300, avgSalary: 205000, baseRisk: 40, automationLevel: 55, rationale: "Modeling work is augmented by AutoML and AI coding workflows.", roles: ["Data Scientist", "ML Engineer", "Analytics Engineer", "Data Platform Engineer", "AI Research Engineer"] },
            { department: "Sales", function: "Pipeline and Enterprise Sales", headcount: 500, avgSalary: 155000, baseRisk: 55, automationLevel: 45, rationale: "Prospecting, qualification, and prep automate; enterprise relationships remain human.", roles: ["Account Executive", "SDR", "Solutions Engineer", "Sales Operations Analyst", "Renewals Manager"] },
            { department: "Marketing", function: "Demand Generation & Content", headcount: 350, avgSalary: 135000, baseRisk: 68, automationLevel: 51, rationale: "AI can generate content variants and optimize campaigns rapidly.", roles: ["Growth Marketer", "Content Strategist", "Lifecycle Marketing Manager", "Brand Marketing Manager", "Performance Analyst"] },
            { department: "Customer Success", function: "Support and Onboarding", headcount: 400, avgSalary: 115000, baseRisk: 72, automationLevel: 54, rationale: "Tier-1 support and onboarding documentation can be heavily automated.", roles: ["Customer Success Manager", "Implementation Specialist", "Support Engineer", "Technical Account Manager", "Customer Education Specialist"] },
            { department: "G&A", function: "Finance, Legal, HR, IT", headcount: 300, avgSalary: 145000, baseRisk: 65, automationLevel: 46, rationale: "Corporate shared services are strong automation candidates.", roles: ["FP&A Analyst", "Legal Ops Manager", "People Operations Partner", "IT Helpdesk Analyst", "Procurement Specialist"] },
            { department: "Security", function: "Security Operations", headcount: 120, avgSalary: 175000, baseRisk: 48, automationLevel: 57, rationale: "Security triage is partially automatable with human escalation.", roles: ["SOC Analyst", "Security Engineer", "Threat Intelligence Analyst", "GRC Specialist", "Incident Response Lead"] },
            { department: "Trust & Safety", function: "Moderation and Policy Enforcement", headcount: 100, avgSalary: 105000, baseRisk: 74, automationLevel: 58, rationale: "Policy triage and moderation can be mostly AI-assisted.", roles: ["Trust & Safety Analyst", "Content Moderation Specialist", "Policy Operations Analyst", "Escalation Reviewer", "Integrity Program Manager"] },
            { department: "Cloud Ops", function: "Infrastructure and Platform Reliability", headcount: 180, avgSalary: 185000, baseRisk: 53, automationLevel: 60, rationale: "AIOps and incident automation reduce repetitive toil.", roles: ["Cloud Platform Engineer", "Site Reliability Engineer", "Release Manager", "Capacity Planner", "Monitoring Engineer"] },
            { department: "Developer Relations", function: "Community and Developer Ecosystem", headcount: 70, avgSalary: 160000, baseRisk: 42, automationLevel: 37, rationale: "Technical storytelling remains human-led with AI drafting support.", roles: ["Developer Advocate", "Technical Writer", "Community Manager", "Partner Enablement Lead", "API Education Specialist"] }
          ]
        },
        consulting: {
          id: "consulting",
          name: "Consulting Firm (MBB / Big 4)",
          description: "Client delivery-heavy professional services firm with layered pyramid structure.",
          functions: [
            { department: "Analysts / Associates", function: "Research, Modeling, Deck Production", headcount: 2000, avgSalary: 125000, baseRisk: 75, automationLevel: 44, rationale: "High volume analytical and slide-generation tasks are AI-exposed.", roles: ["Business Analyst", "Associate Consultant", "Research Analyst", "Financial Modeling Analyst", "Presentation Specialist"] },
            { department: "Engagement Managers", function: "Project Delivery", headcount: 500, avgSalary: 235000, baseRisk: 40, automationLevel: 35, rationale: "Client management and synthesis remain human differentiators.", roles: ["Engagement Manager", "Project Leader", "Delivery Manager", "Workstream Lead", "Program Manager"] },
            { department: "Partners / Directors", function: "Client Relationships & Sales", headcount: 200, avgSalary: 560000, baseRisk: 15, automationLevel: 20, rationale: "Relationship capital and judgment are AI-resistant.", roles: ["Partner", "Managing Director", "Senior Partner", "Client Account Lead", "Practice Leader"] },
            { department: "Knowledge / Research", function: "Internal Knowledge Engine", headcount: 300, avgSalary: 145000, baseRisk: 82, automationLevel: 52, rationale: "Knowledge retrieval, synthesis, and taxonomy can be automated at scale.", roles: ["Knowledge Analyst", "Research Librarian", "Expert Network Coordinator", "Content Curation Manager", "KM Platform Specialist"] },
            { department: "Back Office", function: "Corporate Services", headcount: 400, avgSalary: 115000, baseRisk: 65, automationLevel: 47, rationale: "Shared-service functions are strong candidates for workflow automation.", roles: ["HR Operations Analyst", "Finance Operations Specialist", "IT Support Engineer", "Facilities Coordinator", "Procurement Analyst"] },
            { department: "Digital / Analytics", function: "Advanced Analytics Delivery", headcount: 450, avgSalary: 210000, baseRisk: 46, automationLevel: 55, rationale: "AI coding and model templates accelerate delivery but domain context still matters.", roles: ["Data Scientist", "Analytics Consultant", "ML Engineer", "Visualization Specialist", "AI Transformation Lead"] },
            { department: "Implementation", function: "Transformation Execution", headcount: 380, avgSalary: 195000, baseRisk: 50, automationLevel: 40, rationale: "Execution and change enablement remain partly human-dependent.", roles: ["Implementation Consultant", "PMO Lead", "Change Manager", "Process Engineer", "Adoption Specialist"] },
            { department: "Risk Advisory", function: "Controls and Compliance Consulting", headcount: 310, avgSalary: 170000, baseRisk: 58, automationLevel: 43, rationale: "Testing and documentation tasks automate; regulatory interpretation remains human.", roles: ["Risk Consultant", "Control Testing Analyst", "Compliance Advisor", "Audit Analytics Specialist", "Regulatory Program Manager"] },
            { department: "Tax Advisory", function: "Tax Compliance and Planning", headcount: 290, avgSalary: 165000, baseRisk: 69, automationLevel: 49, rationale: "Tax preparation and scenario analysis automate extensively.", roles: ["Tax Associate", "Tax Manager", "Transfer Pricing Analyst", "Tax Technology Specialist", "Indirect Tax Advisor"] },
            { department: "Deal Advisory", function: "M&A and Due Diligence", headcount: 260, avgSalary: 220000, baseRisk: 61, automationLevel: 46, rationale: "Data-room review and baseline modeling automate, negotiations remain human.", roles: ["Transaction Services Analyst", "M&A Consultant", "Commercial Due Diligence Analyst", "Valuation Specialist", "Synergy Planning Manager"] },
            { department: "Learning & Talent", function: "Training and Development", headcount: 120, avgSalary: 125000, baseRisk: 52, automationLevel: 38, rationale: "Program administration automates while coaching remains human.", roles: ["Learning Program Manager", "Curriculum Designer", "Talent Development Partner", "Assessment Specialist", "Coaching Operations Lead"] },
            { department: "BD Operations", function: "Proposal and Pursuit Support", headcount: 140, avgSalary: 135000, baseRisk: 72, automationLevel: 55, rationale: "Proposal drafting and case synthesis are highly AI-exposed.", roles: ["Proposal Manager", "Pursuit Analyst", "Bid Coordinator", "Credential Library Specialist", "Sales Enablement Writer"] }
          ]
        },
        healthcare: {
          id: "healthcare",
          name: "Healthcare System",
          description: "Integrated provider network spanning hospitals, clinics, and shared administrative services.",
          functions: [
            { department: "Clinical Operations", function: "Nursing & Care Coordination", headcount: 1800, avgSalary: 92000, baseRisk: 30, automationLevel: 28, rationale: "Bedside care and patient interaction remain human-intensive.", roles: ["Registered Nurse", "Care Coordinator", "Case Manager", "Patient Navigator", "Charge Nurse"] },
            { department: "Physician Services", function: "Physician Practice", headcount: 650, avgSalary: 310000, baseRisk: 22, automationLevel: 20, rationale: "AI augments diagnosis and documentation but clinical accountability stays human.", roles: ["Attending Physician", "Hospitalist", "Specialist Physician", "Clinical Lead", "Primary Care Physician"] },
            { department: "Revenue Cycle", function: "Coding, Billing, Claims", headcount: 780, avgSalary: 76000, baseRisk: 84, automationLevel: 58, rationale: "Coding and claims workflows are highly automatable.", roles: ["Medical Coder", "Billing Specialist", "Claims Adjudication Analyst", "Denials Specialist", "Revenue Integrity Analyst"] },
            { department: "Patient Access", function: "Scheduling and Front Desk", headcount: 520, avgSalary: 52000, baseRisk: 81, automationLevel: 52, rationale: "Appointment triage, reminders, and intake are strongly automatable.", roles: ["Patient Access Representative", "Scheduling Specialist", "Front Desk Coordinator", "Contact Center Agent", "Referral Coordinator"] },
            { department: "Clinical Documentation", function: "Transcription and Chart Prep", headcount: 300, avgSalary: 64000, baseRisk: 86, automationLevel: 60, rationale: "Speech-to-text and AI summarization replace manual documentation tasks.", roles: ["Clinical Documentation Specialist", "Medical Transcriptionist", "Chart Abstractor", "Documentation Auditor", "Quality Documentation Analyst"] },
            { department: "Pharmacy", function: "Dispensing and Medication Ops", headcount: 260, avgSalary: 128000, baseRisk: 44, automationLevel: 47, rationale: "Automation supports dispensing and reconciliation with pharmacist oversight.", roles: ["Pharmacist", "Pharmacy Technician", "Medication Safety Analyst", "Inventory Specialist", "Clinical Pharmacy Specialist"] },
            { department: "Lab Services", function: "Diagnostics and Lab Processing", headcount: 420, avgSalary: 78000, baseRisk: 57, automationLevel: 49, rationale: "Sample processing is automatable; interpretation requires certified professionals.", roles: ["Lab Technician", "Pathology Assistant", "Specimen Processing Analyst", "Lab Operations Manager", "Clinical Scientist"] },
            { department: "IT / Digital Health", function: "EHR and Infrastructure", headcount: 360, avgSalary: 145000, baseRisk: 53, automationLevel: 43, rationale: "IT operations accelerate through AI coding and automation assistants.", roles: ["EHR Analyst", "Healthcare Integration Engineer", "Cybersecurity Analyst", "Clinical Systems Engineer", "Data Platform Engineer"] },
            { department: "Compliance & Quality", function: "Regulatory and Quality Programs", headcount: 250, avgSalary: 118000, baseRisk: 59, automationLevel: 41, rationale: "Audit preparation and surveillance are automatable with human accountability.", roles: ["Quality Improvement Analyst", "Regulatory Compliance Manager", "Patient Safety Officer", "Clinical Auditor", "Accreditation Specialist"] },
            { department: "Supply Chain", function: "Procurement and Logistics", headcount: 300, avgSalary: 82000, baseRisk: 66, automationLevel: 45, rationale: "Inventory planning and purchasing workflows automate effectively.", roles: ["Supply Chain Analyst", "Procurement Specialist", "Inventory Planner", "Warehouse Coordinator", "Vendor Manager"] },
            { department: "Corporate Services", function: "Finance, HR, Legal", headcount: 420, avgSalary: 102000, baseRisk: 64, automationLevel: 44, rationale: "Corporate operations exhibit typical automation potential.", roles: ["HR Specialist", "Finance Analyst", "Legal Operations Associate", "Payroll Administrator", "Benefits Analyst"] },
            { department: "Facilities", function: "Environmental and Security", headcount: 350, avgSalary: 54000, baseRisk: 24, automationLevel: 20, rationale: "Physical and safety-critical work remains human-centric.", roles: ["Facilities Technician", "Security Officer", "Environmental Services Lead", "Maintenance Coordinator", "Safety Inspector"] }
          ]
        },
        manufacturing: {
          id: "manufacturing",
          name: "Manufacturing / Industrial",
          description: "Multi-site industrial manufacturer with plant operations, engineering, supply chain, and sales.",
          functions: [
            { department: "Plant Operations", function: "Assembly Line Operations", headcount: 2400, avgSalary: 68000, baseRisk: 63, automationLevel: 45, rationale: "Computer vision and robotics can displace repeatable assembly tasks.", roles: ["Assembly Technician", "Line Operator", "Production Associate", "Workcell Coordinator", "Shift Lead"] },
            { department: "Maintenance", function: "Equipment Reliability", headcount: 700, avgSalary: 76000, baseRisk: 38, automationLevel: 36, rationale: "Predictive maintenance augments, but field maintenance remains physical.", roles: ["Maintenance Technician", "Reliability Engineer", "Field Service Technician", "Maintenance Planner", "Condition Monitoring Analyst"] },
            { department: "Quality", function: "Inspection and QA", headcount: 520, avgSalary: 84000, baseRisk: 70, automationLevel: 48, rationale: "Computer vision can automate inspection and anomaly detection.", roles: ["Quality Inspector", "QA Engineer", "Metrology Analyst", "Quality Systems Specialist", "Nonconformance Analyst"] },
            { department: "Supply Chain", function: "Planning and Procurement", headcount: 650, avgSalary: 98000, baseRisk: 68, automationLevel: 47, rationale: "Demand planning and procurement workflows automate with AI forecasting.", roles: ["Supply Planner", "Procurement Analyst", "Inventory Analyst", "Demand Forecast Manager", "Supplier Performance Manager"] },
            { department: "Logistics", function: "Warehouse and Distribution", headcount: 800, avgSalary: 62000, baseRisk: 71, automationLevel: 43, rationale: "Routing and picking optimization are highly automatable.", roles: ["Warehouse Associate", "Distribution Planner", "Route Analyst", "Fulfillment Supervisor", "Logistics Coordinator"] },
            { department: "Engineering", function: "Process and Product Engineering", headcount: 520, avgSalary: 145000, baseRisk: 49, automationLevel: 42, rationale: "Simulation and CAD assistance augment engineering throughput.", roles: ["Process Engineer", "Manufacturing Engineer", "Product Engineer", "CAD Specialist", "Continuous Improvement Lead"] },
            { department: "EHS", function: "Safety and Environmental Compliance", headcount: 180, avgSalary: 112000, baseRisk: 34, automationLevel: 28, rationale: "Monitoring automates, but site accountability remains human.", roles: ["EHS Specialist", "Safety Manager", "Environmental Analyst", "Compliance Auditor", "Incident Investigator"] },
            { department: "IT / OT", function: "Industrial IT and Automation", headcount: 260, avgSalary: 132000, baseRisk: 52, automationLevel: 49, rationale: "AI-augmented software and control systems reduce manual intervention.", roles: ["Industrial Automation Engineer", "OT Security Analyst", "MES Administrator", "Data Integration Engineer", "Controls Engineer"] },
            { department: "Finance & Admin", function: "Corporate Shared Services", headcount: 280, avgSalary: 98000, baseRisk: 66, automationLevel: 44, rationale: "Shared service tasks are repeatable and automatable.", roles: ["Cost Analyst", "Accounts Payable Specialist", "HR Generalist", "Payroll Specialist", "Legal Operations Analyst"] },
            { department: "Sales", function: "B2B Account Management", headcount: 240, avgSalary: 135000, baseRisk: 41, automationLevel: 34, rationale: "Sales intelligence augments; relationship selling remains human.", roles: ["Account Manager", "Sales Engineer", "Channel Manager", "Proposal Specialist", "Customer Solutions Consultant"] },
            { department: "R&D", function: "Innovation and Product Development", headcount: 210, avgSalary: 168000, baseRisk: 46, automationLevel: 39, rationale: "Generative design assists concepting while experimentation remains human.", roles: ["R&D Engineer", "Materials Scientist", "Prototype Engineer", "Test Engineer", "Innovation Program Lead"] },
            { department: "Facilities", function: "Plant Services", headcount: 190, avgSalary: 62000, baseRisk: 24, automationLevel: 22, rationale: "Physical maintenance and safety tasks are not fully automatable.", roles: ["Facilities Technician", "Utilities Operator", "Grounds Specialist", "Security Officer", "Plant Services Coordinator"] }
          ]
        },
        retail: {
          id: "retail",
          name: "Retail / E-Commerce",
          description: "Omni-channel retail enterprise with stores, digital commerce, supply chain, and customer operations.",
          functions: [
            { department: "Store Operations", function: "Frontline Retail", headcount: 3800, avgSalary: 42000, baseRisk: 44, automationLevel: 29, rationale: "In-store service remains human, but checkout and replenishment automate.", roles: ["Store Associate", "Cashier", "Shift Supervisor", "Department Lead", "Store Manager"] },
            { department: "Customer Support", function: "Contact Center", headcount: 950, avgSalary: 56000, baseRisk: 88, automationLevel: 55, rationale: "AI agents can resolve the majority of tier-1 interactions.", roles: ["Contact Center Agent", "Chat Support Specialist", "Escalation Specialist", "Returns Support Analyst", "Customer Experience Coach"] },
            { department: "Merchandising", function: "Assortment and Pricing", headcount: 480, avgSalary: 108000, baseRisk: 69, automationLevel: 41, rationale: "AI pricing and assortment optimization reduce manual planning burden.", roles: ["Merchandise Planner", "Pricing Analyst", "Category Manager", "Promotion Analyst", "Allocation Specialist"] },
            { department: "Supply Chain", function: "Planning and Inventory", headcount: 900, avgSalary: 76000, baseRisk: 73, automationLevel: 46, rationale: "Demand forecasting and replenishment can be largely automated.", roles: ["Inventory Planner", "Demand Analyst", "Supply Chain Coordinator", "Replenishment Specialist", "S&OP Analyst"] },
            { department: "Fulfillment", function: "Warehouse and Last-Mile", headcount: 1400, avgSalary: 52000, baseRisk: 70, automationLevel: 40, rationale: "Robotics and route optimization can remove repetitive workload.", roles: ["Fulfillment Associate", "Pick-Pack Operator", "Last-Mile Dispatcher", "Warehouse Supervisor", "Logistics Planner"] },
            { department: "E-Commerce", function: "Digital Experience", headcount: 420, avgSalary: 132000, baseRisk: 58, automationLevel: 50, rationale: "Content, testing, and campaign workflows are AI-accelerated.", roles: ["E-Commerce Manager", "Digital Merchandiser", "Web Analyst", "CRO Specialist", "Marketplace Specialist"] },
            { department: "Marketing", function: "Performance and Content", headcount: 370, avgSalary: 115000, baseRisk: 74, automationLevel: 52, rationale: "Creative variations and campaign optimization are AI-exposed.", roles: ["Performance Marketer", "Content Strategist", "CRM Manager", "Brand Manager", "Campaign Analyst"] },
            { department: "Finance & G&A", function: "Corporate Shared Services", headcount: 360, avgSalary: 94000, baseRisk: 67, automationLevel: 45, rationale: "Shared services with structured workflows automate effectively.", roles: ["Finance Analyst", "HR Specialist", "IT Support Analyst", "Legal Ops Coordinator", "Procurement Analyst"] },
            { department: "Loss Prevention", function: "Fraud and Security", headcount: 220, avgSalary: 79000, baseRisk: 52, automationLevel: 44, rationale: "Video analytics and anomaly models augment investigations.", roles: ["Loss Prevention Analyst", "Fraud Investigator", "Store Security Lead", "Case Manager", "Incident Analyst"] },
            { department: "Vendor Management", function: "Supplier Partnerships", headcount: 150, avgSalary: 118000, baseRisk: 47, automationLevel: 37, rationale: "Negotiation remains human; analysis and compliance reporting automate.", roles: ["Vendor Manager", "Contract Analyst", "Sourcing Specialist", "Supplier Performance Analyst", "Compliance Coordinator"] },
            { department: "Real Estate", function: "Store Development", headcount: 90, avgSalary: 138000, baseRisk: 35, automationLevel: 24, rationale: "Site strategy and negotiations remain human-heavy.", roles: ["Real Estate Manager", "Lease Analyst", "Site Selection Analyst", "Construction Program Lead", "Portfolio Planner"] },
            { department: "Corporate Leadership", function: "Executive & Governance", headcount: 70, avgSalary: 390000, baseRisk: 16, automationLevel: 16, rationale: "Strategic control and stakeholder management are AI-resistant.", roles: ["Executive Officer", "Regional VP", "Strategy Director", "Corporate Affairs Lead", "Board Relations Manager"] }
          ]
        },
        insurance: {
          id: "insurance",
          name: "Insurance Company",
          description: "Multi-line insurer with underwriting, claims, distribution, and operations footprint.",
          functions: [
            { department: "Claims", function: "Claims Intake and Adjudication", headcount: 1600, avgSalary: 82000, baseRisk: 83, automationLevel: 55, rationale: "Claims triage and document handling are prime AI targets.", roles: ["Claims Adjuster", "Claims Intake Specialist", "Desk Examiner", "Fraud Flag Analyst", "Subrogation Specialist"] },
            { department: "Underwriting", function: "Risk Assessment", headcount: 920, avgSalary: 125000, baseRisk: 64, automationLevel: 49, rationale: "Data-based underwriting automates baseline decisions; complex risks need experts.", roles: ["Underwriter", "Assistant Underwriter", "Risk Selection Analyst", "Pricing Analyst", "Portfolio Underwriting Manager"] },
            { department: "Policy Operations", function: "Policy Admin & Servicing", headcount: 780, avgSalary: 76000, baseRisk: 79, automationLevel: 53, rationale: "Policy issuance, endorsements, and servicing are highly process-driven.", roles: ["Policy Administrator", "Endorsement Specialist", "Servicing Agent", "Document Processing Analyst", "Renewals Coordinator"] },
            { department: "Actuarial", function: "Pricing and Reserving", headcount: 260, avgSalary: 165000, baseRisk: 52, automationLevel: 46, rationale: "Modeling workflows are augmented while governance and assumptions remain expert-led.", roles: ["Actuary", "Actuarial Analyst", "Reserving Specialist", "Cat Modeling Analyst", "Pricing Governance Lead"] },
            { department: "Distribution", function: "Broker and Agent Support", headcount: 520, avgSalary: 108000, baseRisk: 46, automationLevel: 38, rationale: "Producer relationships remain human; quoting and case prep automate.", roles: ["Broker Relationship Manager", "Agent Support Specialist", "Sales Consultant", "Quote Analyst", "Channel Operations Manager"] },
            { department: "Customer Service", function: "Policyholder Support", headcount: 680, avgSalary: 62000, baseRisk: 87, automationLevel: 57, rationale: "AI chat and voice agents can absorb standard service volume.", roles: ["Service Representative", "Call Center Agent", "Chat Specialist", "Retention Specialist", "Escalation Coordinator"] },
            { department: "Compliance", function: "Regulatory and Controls", headcount: 340, avgSalary: 118000, baseRisk: 66, automationLevel: 44, rationale: "Monitoring and reporting automate with human accountability.", roles: ["Compliance Analyst", "Regulatory Affairs Manager", "Control Testing Specialist", "Audit Coordinator", "Market Conduct Analyst"] },
            { department: "Fraud", function: "SIU and Investigations", headcount: 210, avgSalary: 102000, baseRisk: 60, automationLevel: 50, rationale: "Pattern detection is AI-suitable; legal escalation remains human.", roles: ["Fraud Investigator", "SIU Analyst", "Case Development Specialist", "Forensics Analyst", "Fraud Operations Lead"] },
            { department: "IT / Digital", function: "Core Systems and Engineering", headcount: 620, avgSalary: 152000, baseRisk: 56, automationLevel: 47, rationale: "Engineering productivity gains create meaningful efficiency potential.", roles: ["Software Engineer", "Platform Engineer", "QA Engineer", "DevOps Engineer", "Data Engineer"] },
            { department: "Finance & HR", function: "Corporate Shared Services", headcount: 300, avgSalary: 98000, baseRisk: 65, automationLevel: 43, rationale: "Standardizable shared services present high automation leverage.", roles: ["Finance Analyst", "HR Operations Specialist", "Payroll Analyst", "Procurement Associate", "Legal Ops Analyst"] },
            { department: "Reinsurance", function: "Treaty and Placement Ops", headcount: 160, avgSalary: 155000, baseRisk: 54, automationLevel: 41, rationale: "Analytics and placement support automate; negotiations remain human.", roles: ["Reinsurance Analyst", "Treaty Specialist", "Placement Manager", "Portfolio Analyst", "Reinsurance Operations Lead"] },
            { department: "Leadership", function: "Executive and Regional Management", headcount: 90, avgSalary: 360000, baseRisk: 18, automationLevel: 17, rationale: "Strategic decisions and regulator engagement remain human-responsible.", roles: ["Executive Officer", "Regional Leader", "Chief Underwriting Officer", "Transformation Sponsor", "Board Reporting Lead"] }
          ]
        },
        government: {
          id: "government",
          name: "Government / Public Sector Agency",
          description: "Large public agency with service delivery, program administration, policy, and enforcement functions.",
          functions: [
            { department: "Citizen Services", function: "Case Intake and Inquiry Support", headcount: 2100, avgSalary: 68000, baseRisk: 74, automationLevel: 43, rationale: "Routine inquiry handling and forms triage are AI-suitable.", roles: ["Citizen Services Representative", "Case Intake Specialist", "Call Center Agent", "Benefits Inquiry Analyst", "Escalation Specialist"] },
            { department: "Program Operations", function: "Eligibility and Processing", headcount: 2600, avgSalary: 72000, baseRisk: 78, automationLevel: 45, rationale: "Rule-based eligibility and document verification can be automated significantly.", roles: ["Program Analyst", "Eligibility Specialist", "Documentation Reviewer", "Case Processor", "Program Operations Lead"] },
            { department: "Policy", function: "Policy Development and Analysis", headcount: 420, avgSalary: 122000, baseRisk: 49, automationLevel: 33, rationale: "Research and drafting are AI-augmented; policy judgment remains human.", roles: ["Policy Analyst", "Legislative Specialist", "Research Officer", "Public Affairs Advisor", "Policy Program Manager"] },
            { department: "Compliance & Audit", function: "Regulatory Oversight", headcount: 560, avgSalary: 98000, baseRisk: 61, automationLevel: 39, rationale: "Audit analytics and anomaly detection can automate substantial prep work.", roles: ["Compliance Officer", "Audit Analyst", "Investigation Specialist", "Control Reviewer", "Regulatory Operations Lead"] },
            { department: "Procurement", function: "Contracting and Vendor Mgmt", headcount: 430, avgSalary: 96000, baseRisk: 69, automationLevel: 40, rationale: "Contract processing and vendor checks are highly automatable.", roles: ["Procurement Specialist", "Contract Analyst", "Vendor Coordinator", "Sourcing Analyst", "Acquisition Program Manager"] },
            { department: "IT", function: "Digital Services and Cyber", headcount: 720, avgSalary: 128000, baseRisk: 54, automationLevel: 44, rationale: "Modernization work accelerates with AI-assisted engineering and support.", roles: ["Systems Engineer", "Cybersecurity Analyst", "Application Developer", "IT Support Specialist", "Data Platform Engineer"] },
            { department: "Field Operations", function: "Inspections and On-site Services", headcount: 980, avgSalary: 76000, baseRisk: 33, automationLevel: 24, rationale: "Field inspections and community services require physical presence.", roles: ["Field Inspector", "Program Field Officer", "Safety Inspector", "Community Liaison", "Regional Services Coordinator"] },
            { department: "Finance", function: "Budget and Reporting", headcount: 320, avgSalary: 94000, baseRisk: 66, automationLevel: 42, rationale: "Budget reporting and reconciliations have significant automation exposure.", roles: ["Budget Analyst", "Financial Reporting Specialist", "Grant Accountant", "AP Specialist", "Performance Reporting Analyst"] },
            { department: "HR", function: "Talent and Workforce Admin", headcount: 280, avgSalary: 86000, baseRisk: 63, automationLevel: 37, rationale: "Recruitment workflow and records management are automation candidates.", roles: ["HR Specialist", "Recruitment Coordinator", "Benefits Officer", "Payroll Administrator", "Learning Coordinator"] },
            { department: "Legal", function: "General Counsel Support", headcount: 220, avgSalary: 148000, baseRisk: 52, automationLevel: 34, rationale: "Document review and discovery can be automated, legal sign-off remains human.", roles: ["Government Attorney", "Paralegal", "Legal Operations Analyst", "Policy Counsel", "Litigation Support Specialist"] },
            { department: "Comms", function: "Public Communications", headcount: 190, avgSalary: 92000, baseRisk: 55, automationLevel: 36, rationale: "Drafting and summarization automate while public trust messaging stays human.", roles: ["Communications Officer", "Public Affairs Specialist", "Content Producer", "Media Analyst", "Stakeholder Engagement Lead"] },
            { department: "Executive", function: "Agency Leadership", headcount: 85, avgSalary: 265000, baseRisk: 17, automationLevel: 16, rationale: "High-accountability public decision roles are AI-resistant.", roles: ["Agency Director", "Deputy Director", "Chief of Staff", "Program Executive", "Oversight Liaison"] }
          ]
        }
      };

      const MODEL_REFERENCE_SET = [
        { title: "WEF Future of Jobs Report 2025", url: "https://www.weforum.org/publications/the-future-of-jobs-report-2025/", asOf: "2025-01-07" },
        { title: "IMF: GenAI and the Labor Market", url: "https://www.imf.org/en/Publications/SDN/Issues/2024/01/14/GenAI-Artificial-Intelligence-and-the-Future-of-Work-542379", asOf: "2024-01-14" },
        { title: "OpenAI + OpenResearch (GPT Exposure)", url: "https://arxiv.org/abs/2303.10130", asOf: "2023-03-17" },
        { title: "McKinsey GenAI Economic Potential", url: "https://www.mckinsey.com/capabilities/mckinsey-digital/our-insights/the-economic-potential-of-generative-ai-the-next-productivity-frontier", asOf: "2023-06-14" },
        { title: "US BLS Occupational Outlook Handbook", url: "https://www.bls.gov/ooh/", asOf: "2025-09-04" }
      ];

      const COMPETITIVE_DATA = [
        { company: "JPMorgan Chase", industry: "Banking", aiInvestment: "AI spend not fully broken out; large multi-year program disclosed", reduction: "Targeted function-level optimization", initiatives: "LLM Suite internal rollout, COiN, AI risk and fraud analytics", timeline: "2024-2027", source: "JPMorgan investor materials", sourceUrl: "https://www.jpmorganchase.com/ir", asOf: "2025-12-31", confidence: "High", investLevel: 9.2, aggressiveness: 6.1 },
        { company: "Goldman Sachs", industry: "Banking", aiInvestment: "AI-specific spend not publicly itemized", reduction: "Selective productivity-led redesign", initiatives: "GS AI assistant and engineering productivity tooling", timeline: "2024-2027", source: "Goldman annual and investor reports", sourceUrl: "https://www.goldmansachs.com/investor-relations", asOf: "2025-12-31", confidence: "Medium", investLevel: 8.1, aggressiveness: 6.2 },
        { company: "Klarna", industry: "Fintech", aiInvestment: "Not publicly disclosed", reduction: "Attrition-led workforce compression reported", initiatives: "AI assistant handling majority of customer chats", timeline: "2024-2026", source: "Klarna press release", sourceUrl: "https://www.klarna.com/international/press/klarna-ai-assistant-handles-two-thirds-of-customer-service-chats-in-its-first-month/", asOf: "2025-11-15", confidence: "High", investLevel: 6.5, aggressiveness: 8.7 },
        { company: "Duolingo", industry: "EdTech", aiInvestment: "Not publicly disclosed", reduction: "Contractor mix shift reported", initiatives: "AI-generated content and language learning workflow automation", timeline: "2024-2026", source: "Company press and filings", sourceUrl: "https://investors.duolingo.com", asOf: "2025-09-30", confidence: "Medium", investLevel: 5.8, aggressiveness: 7.1 },
        { company: "UPS", industry: "Logistics", aiInvestment: "Not publicly disclosed", reduction: "12,000 role reduction announced in 2024", initiatives: "AI route optimization and network automation", timeline: "2024-2026", source: "UPS earnings disclosures", sourceUrl: "https://investors.ups.com/news-events/press-releases", asOf: "2025-12-31", confidence: "High", investLevel: 6.7, aggressiveness: 7.8 },
        { company: "IBM", industry: "Technology", aiInvestment: "AI investment disclosed directionally; exact split limited", reduction: "Back-office role mix shift reported", initiatives: "AI in HR, finance, and software delivery", timeline: "2023-2028", source: "IBM annual report and statements", sourceUrl: "https://www.ibm.com/investor", asOf: "2025-12-31", confidence: "Medium", investLevel: 7.9, aggressiveness: 6.1 },
        { company: "Meta", industry: "Technology", aiInvestment: "Large AI infrastructure spend disclosed", reduction: "Restructuring plans included ~21,000 roles (2022-2023)", initiatives: "Llama ecosystem and AI-first infra strategy", timeline: "2023-2026", source: "Meta SEC filing", sourceUrl: "https://www.sec.gov/ixviewer/ix.html?doc=/Archives/edgar/data/1326801/000132680125000014/meta-20241231.htm", asOf: "2025-01-30", confidence: "High", investLevel: 10, aggressiveness: 9.1 },
        { company: "BT Group", industry: "Telecom", aiInvestment: "Not publicly disclosed", reduction: "55,000 by 2030 target publicly stated", initiatives: "AI and digitization transformation program", timeline: "2023-2030", source: "CEO statements (public reporting)", sourceUrl: "https://www.cnbc.com/2023/05/18/bt-to-cut-up-to-55000-jobs-by-2030-including-contractors.html", asOf: "2025-05-18", confidence: "Medium", investLevel: 6.1, aggressiveness: 8.9 },
        { company: "Microsoft", industry: "Technology", aiInvestment: "Very high AI capex and partner investment", reduction: "Selective role rebalancing", initiatives: "Copilot platform and enterprise AI stack", timeline: "2023-2028", source: "Microsoft investor reports", sourceUrl: "https://www.microsoft.com/investor", asOf: "2025-12-31", confidence: "High", investLevel: 10, aggressiveness: 6.8 },
        { company: "Amazon", industry: "Retail/Cloud", aiInvestment: "High AI-related capex disclosed", reduction: "Role mix shifts and productivity-led redesign", initiatives: "GenAI across AWS, retail, and operations", timeline: "2024-2028", source: "Amazon SEC and investor reports", sourceUrl: "https://www.sec.gov/edgar/browse/?CIK=1018724", asOf: "2025-12-31", confidence: "High", investLevel: 9.7, aggressiveness: 7.1 },
        { company: "Walmart", industry: "Retail", aiInvestment: "Not fully itemized", reduction: "Operational redesign and automation", initiatives: "AI inventory and supply chain optimization", timeline: "2024-2027", source: "Walmart investor communications", sourceUrl: "https://stock.walmart.com", asOf: "2025-12-31", confidence: "Medium", investLevel: 7.1, aggressiveness: 6.0 },
        { company: "Target", industry: "Retail", aiInvestment: "Not disclosed", reduction: "Limited direct disclosure", initiatives: "Store and service assistant AI", timeline: "2024-2027", source: "Target investor updates", sourceUrl: "https://investors.target.com", asOf: "2025-12-31", confidence: "Low", investLevel: 5.7, aggressiveness: 5.4 },
        { company: "Accenture", industry: "Consulting", aiInvestment: "$3B announced for AI-led reinvention program", reduction: "Redeployment and skill shift focus", initiatives: "Enterprise GenAI service and delivery stack", timeline: "2023-2027", source: "Accenture announcements", sourceUrl: "https://newsroom.accenture.com", asOf: "2025-12-31", confidence: "High", investLevel: 8.5, aggressiveness: 5.3 },
        { company: "Deloitte", industry: "Consulting", aiInvestment: "Strategic AI alliance spend disclosed directionally", reduction: "Role redesign and augmentation model", initiatives: "AI factory approach and scaled copilots", timeline: "2024-2027", source: "Deloitte public statements", sourceUrl: "https://www2.deloitte.com/us/en.html", asOf: "2025-10-31", confidence: "Medium", investLevel: 7.6, aggressiveness: 5.6 },
        { company: "UnitedHealth", industry: "Healthcare", aiInvestment: "Not publicly itemized", reduction: "Administrative efficiency focus", initiatives: "AI prior authorization and operational analytics", timeline: "2024-2028", source: "Investor communications", sourceUrl: "https://www.unitedhealthgroup.com/investors.html", asOf: "2025-12-31", confidence: "Medium", investLevel: 7.0, aggressiveness: 5.8 },
        { company: "CVS Health", industry: "Healthcare", aiInvestment: "Not publicly itemized", reduction: "Back-office optimization", initiatives: "AI in service workflows and pharmacy operations", timeline: "2024-2027", source: "CVS investor communications", sourceUrl: "https://investors.cvshealth.com", asOf: "2025-12-31", confidence: "Medium", investLevel: 6.6, aggressiveness: 6.1 },
        { company: "Siemens", industry: "Industrial", aiInvestment: "Digital and AI spend disclosed directionally", reduction: "Process-efficiency-led changes", initiatives: "Industrial copilots and smart automation", timeline: "2024-2028", source: "Siemens investor relations", sourceUrl: "https://www.siemens.com/global/en/company/investor-relations.html", asOf: "2025-11-30", confidence: "Medium", investLevel: 7.8, aggressiveness: 5.8 },
        { company: "GE Aerospace", industry: "Industrial", aiInvestment: "Not publicly itemized", reduction: "Selective productivity-led redesign", initiatives: "AI-enabled engineering and maintenance analytics", timeline: "2024-2028", source: "GE Aerospace investor relations", sourceUrl: "https://www.geaerospace.com/investor-relations", asOf: "2025-11-30", confidence: "Low", investLevel: 6.4, aggressiveness: 5.2 },
        { company: "Allianz", industry: "Insurance", aiInvestment: "Not publicly itemized", reduction: "Claims and service automation focus", initiatives: "AI in underwriting, service, and claims triage", timeline: "2024-2027", source: "Allianz annual reports", sourceUrl: "https://www.allianz.com/en/investor_relations/reports-and-figures/annual-report.html", asOf: "2025-12-31", confidence: "Medium", investLevel: 6.8, aggressiveness: 6.4 },
        { company: "AXA", industry: "Insurance", aiInvestment: "Not publicly itemized", reduction: "Administrative role redesign", initiatives: "AI claims automation and digital service", timeline: "2024-2028", source: "AXA annual reports", sourceUrl: "https://www.axa.com/en/investor", asOf: "2025-12-31", confidence: "Medium", investLevel: 6.4, aggressiveness: 6.2 },
        { company: "USAA", industry: "Financial Services", aiInvestment: "Not publicly itemized", reduction: "Service model redesign", initiatives: "AI service and fraud analytics", timeline: "2024-2027", source: "USAA public statements", sourceUrl: "https://www.usaa.com/inet/wc/about_usaa", asOf: "2025-10-31", confidence: "Low", investLevel: 5.9, aggressiveness: 5.8 },
        { company: "ServiceNow", industry: "SaaS", aiInvestment: "Material AI investment and platform allocation disclosed", reduction: "Automation-led capacity expansion", initiatives: "Now Assist and enterprise agentic workflows", timeline: "2024-2027", source: "ServiceNow investor relations", sourceUrl: "https://www.servicenow.com/company/investor-relations.html", asOf: "2025-12-31", confidence: "Medium", investLevel: 8.6, aggressiveness: 6.6 },
        { company: "Salesforce", industry: "SaaS", aiInvestment: "Substantial AI investment disclosed directionally", reduction: "Selective role reductions and productivity reallocation", initiatives: "Agentforce and Einstein platform expansion", timeline: "2024-2028", source: "Salesforce investor relations", sourceUrl: "https://investor.salesforce.com", asOf: "2025-12-31", confidence: "Medium", investLevel: 8.7, aggressiveness: 6.8 }
      ];

      const BENCHMARK_DISTRIBUTIONS = {
        aiSpendPctRevenue: [0.5, 0.8, 1.1, 1.6, 2.2, 2.6, 3.1, 3.8, 4.5, 5.2],
        augmentedRolePct: [12, 18, 25, 30, 35, 42, 48, 55, 63, 72],
        annualReductionPct: [1, 2, 3, 4, 5, 7, 9, 12, 15, 20],
        productivityGainPct: [8, 12, 16, 20, 25, 30, 35, 40, 47, 55]
      };

      const STATE = {
        org: null,
        selectedTab: "tab-warboard",
        selectedNodeId: null,
        selectedRoleId: null,
        selectedScenarioId: "balanced",
        scenarios: JSON.parse(JSON.stringify(SCENARIO_LIBRARY)),
        readinessAnswers: {},
        assumptions: { ...DEFAULT_ASSUMPTIONS },
        ui: {
          collapsedSidebar: false,
          dirtyTabs: {
            "tab-warboard": true,
            "tab-financial": true,
            "tab-actions": true,
            "tab-scenarios": true,
            "tab-readiness": true,
            "tab-competitive": true,
            "tab-board": true
          },
          roleFilters: {
            search: "",
            department: "all",
            action: "all",
            priority: "all",
            riskMin: "",
            riskMax: "",
            savingsMin: "",
            implMax: ""
          },
          departmentSort: "savings",
          selectedRoleIds: new Set(),
          ganttDrag: null,
          onboarding: {
            active: false,
            step: 0,
            industry: "banking",
            orgSize: 3500,
            ambition: "balanced"
          },
          contextRoleId: null,
          benchmarkInputs: {
            aiSpendPctRevenue: 2.5,
            augmentedRolePct: 35,
            annualReductionPct: 6,
            productivityGainPct: 28
          },
          readinessMeta: {
            automationMaturity: 45,
            dataMaturity: 40,
            riskWeight: 50,
            automationWeight: 25,
            dataWeight: 25
          }
        },
        history: {
          undo: [],
          redo: []
        },
        calc: {}
      };

      const $ = (id) => document.getElementById(id);
      const currencyFmt = new Intl.NumberFormat("en-US", { style: "currency", currency: "USD", maximumFractionDigits: 0 });
      const numberFmt = new Intl.NumberFormat("en-US");
      const percentFmt = new Intl.NumberFormat("en-US", { maximumFractionDigits: 1 });

      function deepClone(obj) {
        return JSON.parse(JSON.stringify(obj));
      }

      function uid(prefix = "id") {
        return `${prefix}_${Math.random().toString(36).slice(2, 10)}`;
      }

      function normalizeWeights() {
        const m = STATE.ui.readinessMeta;
        let total = Number(m.riskWeight) + Number(m.automationWeight) + Number(m.dataWeight);
        if (total <= 0) {
          m.riskWeight = 50;
          m.automationWeight = 25;
          m.dataWeight = 25;
          total = 100;
        }
        m.riskWeight = Math.round((Number(m.riskWeight) / total) * 100);
        m.automationWeight = Math.round((Number(m.automationWeight) / total) * 100);
        m.dataWeight = 100 - m.riskWeight - m.automationWeight;
      }

      function riskBand(score) {
        if (score <= 25) {
          return { label: "AI-Resistant", cls: "resistant", color: "#00c896" };
        }
        if (score <= 50) {
          return { label: "Augmentation Zone", cls: "augment", color: "#27a7ff" };
        }
        if (score <= 75) {
          return { label: "High Displacement", cls: "high", color: "#f5a623" };
        }
        return { label: "Critical Displacement", cls: "critical", color: "#e74c3c" };
      }

      function actionForRisk(score) {
        if (score >= 80) return "eliminate";
        if (score >= 55) return "augment";
        if (score >= 35) return "reskill";
        return "protect";
      }

      function priorityForRisk(score) {
        if (score >= 75) return "P1";
        if (score >= 45) return "P2";
        return "P3";
      }

      function defaultEliminationPercent(score, action) {
        if (action === "eliminate") return Math.min(95, 55 + Math.round(score * 0.45));
        if (action === "augment") return Math.min(45, 10 + Math.round(score * 0.35));
        if (action === "reskill") return Math.min(25, 5 + Math.round(score * 0.15));
        return 0;
      }

      function defaultProductivityGain(score, action) {
        if (action === "augment") return Math.min(60, 18 + Math.round(score * 0.35));
        if (action === "reskill") return Math.min(35, 12 + Math.round(score * 0.2));
        if (action === "protect") return Math.min(22, 8 + Math.round(score * 0.08));
        return Math.min(30, 10 + Math.round(score * 0.2));
      }

      function implementationMonthsForRisk(score, action) {
        if (action === "eliminate") return score >= 85 ? 9 : 12;
        if (action === "augment") return score >= 65 ? 12 : 9;
        if (action === "reskill") return 18;
        return 24;
      }

      function taskDecomposition(action) {
        if (action === "eliminate") {
          return "AI can automate 75-95% of repetitive workflow tasks, including intake, validation, and standard case handling.";
        }
        if (action === "augment") {
          return "AI can automate 40-70% of routine analysis and drafting tasks while humans retain exception handling and decision rights.";
        }
        if (action === "reskill") {
          return "AI handles process-heavy workload while employees shift to oversight, exception management, and AI-adjacent support roles.";
        }
        return "Core value is relationship, physical presence, or strategic judgment. AI primarily provides decision support and prep assistance.";
      }

      function legalConstraintForRisk(score) {
        if (score >= 80) {
          return "WARN Act review required for large-scale reductions; regulator or policy sign-off for high-impact workflow changes.";
        }
        if (score >= 55) {
          return "Human-in-the-loop controls and auditability requirements apply for regulated or customer-impacting decisions.";
        }
        return "Maintain transparency and explainability standards; retain accountable human decision ownership.";
      }

      function reskillPathForAction(action, department) {
        if (action === "eliminate") return `Exception handling in ${department}, AI operations analyst, workflow quality assurance`;
        if (action === "augment") return `AI workflow supervisor, automation product owner, analytics translator in ${department}`;
        if (action === "reskill") return `AI governance analyst, process automation specialist, digital operations coordinator`;
        return `Advanced leadership, stakeholder management, and high-trust advisory specialization`;
      }

      function aiToolsForFunction(fnName, department, action) {
        const base = [];
        const text = `${fnName} ${department}`.toLowerCase();
        if (text.includes("kyc") || text.includes("aml") || text.includes("compliance")) base.push("Jumio", "Chainalysis", "LLM document review");
        if (text.includes("trade") || text.includes("settlement") || text.includes("recon")) base.push("STP automation", "AI reconciliation agent");
        if (text.includes("engineering") || text.includes("dev") || text.includes("software")) base.push("Cursor", "GitHub Copilot", "Claude Code");
        if (text.includes("customer") || text.includes("call") || text.includes("support")) base.push("Conversational AI stack", "Agent assist LLM", "Knowledge bot");
        if (text.includes("finance") || text.includes("account")) base.push("AI close assistant", "Automated variance analysis");
        if (text.includes("legal") || text.includes("contract")) base.push("Contract intelligence LLM", "Legal review AI");
        if (text.includes("hr") || text.includes("recruit")) base.push("Talent screening AI", "HR service bot");
        if (text.includes("marketing")) base.push("Campaign generation LLM", "AI media optimizer");
        if (text.includes("claims") || text.includes("underwriting")) base.push("Claims triage AI", "Underwriting decision support");
        if (text.includes("policy") || text.includes("government")) base.push("Case processing assistant", "Policy drafting copilot");
        if (text.includes("manufact") || text.includes("quality") || text.includes("inspection")) base.push("Computer vision QA", "Predictive maintenance model");
        if (text.includes("health") || text.includes("clinical")) base.push("Clinical documentation AI", "Patient service assistant");
        if (!base.length) {
          base.push("Enterprise LLM platform", "Workflow automation engine");
        }
        if (action === "protect") {
          base.push("Decision support analytics");
        }
        return Array.from(new Set(base)).slice(0, 4);
      }

      function generateRoleFromTemplateRow(row, roleTitle, roleHeadcount, seed) {
        const riskOffset = ((seed % 5) - 2) * 2;
        const riskScore = Math.max(0, Math.min(100, row.baseRisk + riskOffset));
        const action = actionForRisk(riskScore);
        const eliminationPercent = defaultEliminationPercent(riskScore, action);
        const productivityGainPercent = defaultProductivityGain(riskScore, action);
        const implementationMonths = implementationMonthsForRisk(riskScore, action);

        return {
          id: uid("role"),
          title: roleTitle,
          department: row.department,
          function: row.function,
          location: "US-Multi",
          headcount: Math.max(1, Math.round(roleHeadcount)),
          avgSalary: row.avgSalary,
          riskScore,
          currentAutomationLevel: row.automationLevel,
          recommendedAction: action,
          eliminationPercent,
          productivityGainPercent,
          aiTools: aiToolsForFunction(row.function, row.department, action),
          implementationMonths,
          priority: priorityForRisk(riskScore),
          reskillPathway: reskillPathForAction(action, row.department),
          legalConstraints: legalConstraintForRisk(riskScore),
          notes: row.rationale,
          taskDecomposition: taskDecomposition(action)
        };
      }

      function buildOrgFromTemplate(templateId, scaleHeadcount, ambitionId) {
        const template = INDUSTRY_TEMPLATES[templateId] || INDUSTRY_TEMPLATES.banking;
        const totalBase = template.functions.reduce((sum, f) => sum + f.headcount, 0);
        const scale = scaleHeadcount && totalBase > 0 ? scaleHeadcount / totalBase : 1;
        const ambition = SCENARIO_LIBRARY[ambitionId] || SCENARIO_LIBRARY.balanced;

        const roles = [];
        template.functions.forEach((row, fIdx) => {
          const scaledFunctionHeadcount = Math.max(5, Math.round(row.headcount * scale));
          const roleCount = row.roles.length;
          const weights = row.roles.map((_, idx) => (idx === 0 ? 1.3 : 1));
          const weightSum = weights.reduce((a, b) => a + b, 0);
          let assigned = 0;
          row.roles.forEach((roleTitle, rIdx) => {
            let roleHeadcount = (scaledFunctionHeadcount * weights[rIdx]) / weightSum;
            roleHeadcount = rIdx === roleCount - 1 ? scaledFunctionHeadcount - assigned : Math.round(roleHeadcount);
            assigned += roleHeadcount;
            const role = generateRoleFromTemplateRow(row, roleTitle, roleHeadcount, fIdx * 10 + rIdx);

            const ambitionAdj = ambition.id === "mercury" ? 1.15 : ambition.id === "aggressive" ? 1.08 : ambition.id === "conservative" ? 0.92 : 1;
            role.eliminationPercent = Math.max(0, Math.min(95, Math.round(role.eliminationPercent * ambitionAdj)));
            role.productivityGainPercent = Math.max(0, Math.min(70, Math.round(role.productivityGainPercent * ambitionAdj)));
            roles.push(role);
          });
        });

        const orgName = `${template.name} - Transformation Model`;
        return {
          id: uid("org"),
          name: orgName,
          industry: template.name,
          industryId: template.id,
          totalRevenue: Math.round((scaleHeadcount || totalBase) * 520000),
          generatedAt: new Date().toISOString(),
          roles,
          initiatives: buildInitiativesFromRoles(roles)
        };
      }

      function buildInitiativesFromRoles(roles) {
        const byDept = {};
        roles.forEach((role) => {
          if (!byDept[role.department]) {
            byDept[role.department] = {
              id: uid("init"),
              name: `${role.department} Transformation`,
              department: role.department,
              startMonth: 3,
              durationMonths: 10,
              dependency: "Core Data Platform",
              milestone: "Pilot Live"
            };
          }
          byDept[role.department].durationMonths = Math.max(byDept[role.department].durationMonths, Math.min(30, Math.round(role.implementationMonths * 1.2)));
          if (role.priority === "P1") {
            byDept[role.department].startMonth = Math.min(byDept[role.department].startMonth, 2);
          }
        });

        const initiatives = Object.values(byDept);
        initiatives.forEach((item, idx) => {
          item.startMonth = Math.min(48, idx * 2 + item.startMonth);
          if (idx === 0) {
            item.dependency = "AI Governance Office Setup";
          } else if (idx % 3 === 0) {
            item.dependency = "Enterprise Data Quality Controls";
          }
          item.milestone = item.startMonth <= 6 ? "Quick Wins" : item.startMonth <= 12 ? "Phase 1" : item.startMonth <= 24 ? "Phase 2" : item.startMonth <= 36 ? "Phase 3" : "Full Transformation";
        });

        return initiatives;
      }

      function flattenRoles() {
        return STATE.org ? STATE.org.roles : [];
      }

      function loadedComp(role) {
        const multiplier = 1 + (STATE.assumptions.benefitsLoadPercent / 100);
        return role.headcount * role.avgSalary * multiplier;
      }

      function roleAnnualSavings(role) {
        const loaded = loadedComp(role);
        const eliminationComponent = loaded * (role.riskScore / 100) * (role.eliminationPercent / 100);
        const augmentComponent = role.recommendedAction === "augment"
          ? loaded * (role.productivityGainPercent / 100) * Math.max(0.1, role.eliminationPercent / 100)
          : 0;
        return eliminationComponent + augmentComponent;
      }

      function roleInvestment(role) {
        const eliminatedHeadcount = role.headcount * (role.eliminationPercent / 100);
        const severance = (role.avgSalary / 12) * STATE.assumptions.severanceMonths * eliminatedHeadcount;
        const aiTools = role.headcount * STATE.assumptions.aiCostPerEmployee;
        const reskillShare = role.recommendedAction === "reskill" ? 0.9 : role.recommendedAction === "augment" ? 0.35 : role.recommendedAction === "eliminate" ? 0.2 : 0.25;
        const reskill = role.headcount * reskillShare * STATE.assumptions.reskillCostPerEmployee;
        const base = severance + aiTools + reskill;
        const change = base * (STATE.assumptions.changeManagementPercent / 100);
        const riskBuffer = base * (STATE.assumptions.implementationRiskBufferPercent / 100);
        return {
          severance,
          aiTools,
          reskill,
          change,
          riskBuffer,
          total: base + change + riskBuffer
        };
      }

      function calcReadinessComposite(weightedRisk) {
        normalizeWeights();
        const m = STATE.ui.readinessMeta;
        const riskComponent = 100 - weightedRisk;
        const composite = (riskComponent * m.riskWeight + m.automationMaturity * m.automationWeight + m.dataMaturity * m.dataWeight) / 100;
        return composite;
      }

      function calcCore() {
        const roles = flattenRoles();
        const totals = {
          headcount: 0,
          comp: 0,
          criticalRoleCount: 0,
          criticalHeadcount: 0,
          addressable: 0,
          weightedRiskNumerator: 0,
          weightedAutomation: 0,
          investment: {
            severance: 0,
            aiTools: 0,
            reskill: 0,
            change: 0,
            riskBuffer: 0,
            total: 0
          },
          savings: {
            gross: 0,
            annualNet: 0
          }
        };

        const departmentMap = {};

        roles.forEach((role) => {
          const loaded = loadedComp(role);
          const savings = roleAnnualSavings(role);
          const inv = roleInvestment(role);

          totals.headcount += role.headcount;
          totals.comp += loaded;
          totals.addressable += loaded * (role.riskScore / 100) * (role.eliminationPercent / 100);
          totals.weightedRiskNumerator += role.riskScore * role.headcount;
          totals.weightedAutomation += role.currentAutomationLevel * role.headcount;
          totals.savings.gross += savings;
          totals.investment.severance += inv.severance;
          totals.investment.aiTools += inv.aiTools;
          totals.investment.reskill += inv.reskill;
          totals.investment.change += inv.change;
          totals.investment.riskBuffer += inv.riskBuffer;
          totals.investment.total += inv.total;

          if (role.riskScore >= 76) {
            totals.criticalRoleCount += 1;
            totals.criticalHeadcount += role.headcount;
          }

          if (!departmentMap[role.department]) {
            departmentMap[role.department] = {
              department: role.department,
              headcount: 0,
              savings: 0,
              investment: 0,
              avgRiskNum: 0,
              roleCount: 0,
              legalWeight: 0
            };
          }
          const dep = departmentMap[role.department];
          dep.headcount += role.headcount;
          dep.savings += savings;
          dep.investment += inv.total;
          dep.avgRiskNum += role.riskScore;
          dep.roleCount += 1;
          dep.legalWeight += role.legalConstraints.toLowerCase().includes("warn") ? 2 : role.legalConstraints.toLowerCase().includes("human") ? 1 : 0;
        });

        totals.savings.annualNet = totals.savings.gross - (totals.investment.aiTools + totals.investment.change * 0.5);
        const weightedRisk = totals.headcount ? totals.weightedRiskNumerator / totals.headcount : 0;
        const readinessIndex = calcReadinessComposite(weightedRisk);

        const monthlySavingsRate = Math.max(1, totals.savings.annualNet / 12);
        const breakEvenMonths = totals.investment.total / monthlySavingsRate;
        const roi = totals.investment.total > 0 ? totals.savings.annualNet / totals.investment.total : 0;

        const npv = calcNpv(totals.investment.total, totals.savings.annualNet, STATE.assumptions.implementationTimelineMonths, STATE.assumptions.discountRate / 100);

        const departments = Object.values(departmentMap).map((dep) => {
          const avgRisk = dep.roleCount ? dep.avgRiskNum / dep.roleCount : 0;
          const roiRatio = dep.investment > 0 ? dep.savings / dep.investment : 0;
          const speed = dep.savings > 0 ? dep.investment / (dep.savings / 12) : 999;
          const complexity = Math.min(10, Math.max(1, Math.round((avgRisk / 15) + (dep.roleCount / 8) + dep.legalWeight)));
          return {
            ...dep,
            avgRisk,
            roiRatio,
            speed,
            complexity
          };
        });

        const timeline = calcRoiTimeline(totals);

        const sensitivity = calcSensitivity();

        const scenarios = calcAllScenarios(totals, roles);

        STATE.calc = {
          totals,
          weightedRisk,
          readinessIndex,
          breakEvenMonths,
          roi,
          npv,
          departments,
          timeline,
          sensitivity,
          scenarios
        };
      }

      function calcNpv(investmentTotal, annualSavings, timelineMonths, discountRate) {
        const years = 5;
        const annualRamp = Math.min(1, 12 / Math.max(6, timelineMonths));
        let npv = -investmentTotal;
        for (let year = 1; year <= years; year += 1) {
          const ramp = Math.min(1, year * annualRamp);
          const cashFlow = annualSavings * ramp;
          npv += cashFlow / Math.pow(1 + discountRate, year);
        }
        return npv;
      }

      function calcRoiTimeline(totals) {
        const timelineMonths = Math.max(6, STATE.assumptions.implementationTimelineMonths);
        const yearly = [];
        let cumulativeInv = 0;
        let cumulativeSav = 0;
        let cumulativeNet = 0;

        for (let y = 1; y <= 5; y += 1) {
          const ramp = Math.min(1, (y * 12) / timelineMonths);
          const inv = y <= 2 ? totals.investment.total * (y === 1 ? 0.62 : 0.3) : totals.investment.total * 0.04;
          const sav = totals.savings.gross * ramp * (1 - (STATE.assumptions.salaryInflationPercent / 100) * 0.1 * (5 - y));
          const net = sav - inv;
          cumulativeInv += inv;
          cumulativeSav += sav;
          cumulativeNet += net;
          yearly.push({
            year: y,
            investment: inv,
            savings: sav,
            net,
            cumulativeInv,
            cumulativeSav,
            cumulativeNet
          });
        }

        const breakEvenYear = yearly.find((row) => row.cumulativeNet >= 0)?.year || null;
        return { yearly, breakEvenYear };
      }

      function calcSensitivity() {
        const baseAssumptions = deepClone(STATE.assumptions);
        const baseNet = calcNetSavingsWithAssumptions(baseAssumptions);

        const variables = [
          { key: "severanceMonths", label: "Severance Costs" },
          { key: "aiCostPerEmployee", label: "AI Tool Costs" },
          { key: "productivityGainDefault", label: "Productivity Gain" },
          { key: "implementationTimelineMonths", label: "Implementation Delays" },
          { key: "benefitsLoadPercent", label: "Loaded Cost Factor" },
          { key: "attritionOffsetPercent", label: "Attrition Offset" },
          { key: "salaryInflationPercent", label: "Salary Inflation" }
        ];

        return variables.map((v) => {
          const low = deepClone(baseAssumptions);
          const high = deepClone(baseAssumptions);

          if (v.key === "implementationTimelineMonths") {
            low[v.key] = Math.max(6, Math.round(low[v.key] * 0.8));
            high[v.key] = Math.round(high[v.key] * 1.2);
          } else if (v.key === "productivityGainDefault") {
            low[v.key] = Math.round(low[v.key] * 0.8);
            high[v.key] = Math.round(high[v.key] * 1.2);
          } else {
            low[v.key] = Math.max(0, Math.round(low[v.key] * 0.8));
            high[v.key] = Math.round(high[v.key] * 1.2);
          }

          const lowNet = calcNetSavingsWithAssumptions(low);
          const highNet = calcNetSavingsWithAssumptions(high);

          return {
            label: v.label,
            downside: lowNet - baseNet,
            upside: highNet - baseNet
          };
        });
      }

      function calcNetSavingsWithAssumptions(assumptions) {
        const roles = flattenRoles();
        let gross = 0;
        let investment = 0;
        roles.forEach((role) => {
          const multiplier = 1 + assumptions.benefitsLoadPercent / 100;
          const loaded = role.headcount * role.avgSalary * multiplier;
          const savings = loaded * (role.riskScore / 100) * (role.eliminationPercent / 100)
            + (role.recommendedAction === "augment" ? loaded * (assumptions.productivityGainDefault / 100) * 0.3 : 0);
          gross += savings;
          const severance = (role.avgSalary / 12) * assumptions.severanceMonths * role.headcount * (role.eliminationPercent / 100);
          const ai = role.headcount * assumptions.aiCostPerEmployee;
          const reskill = role.headcount * assumptions.reskillCostPerEmployee * (role.recommendedAction === "reskill" ? 0.9 : 0.25);
          const change = (severance + ai + reskill) * (assumptions.changeManagementPercent / 100);
          investment += severance + ai + reskill + change;
        });

        const attritionBenefit = gross * (assumptions.attritionOffsetPercent / 100) * 0.2;
        const inflationDrag = gross * (assumptions.salaryInflationPercent / 100) * 0.1;
        return gross + attritionBenefit - investment - inflationDrag;
      }

      function calcScenarioProjection(scenario, totals, roles) {
        const quarters = 20;
        const labels = [];
        const headcount = [];
        const cumulativeInvest = [];
        const cumulativeSavings = [];
        const cumulativeNet = [];

        const targetRoles = roles.filter((r) => r.riskScore >= scenario.thresholdRisk);
        const targetHeadcount = targetRoles.reduce((sum, r) => sum + r.headcount, 0);
        const baselineHeadcount = totals.headcount;

        const addressable = targetRoles.reduce((sum, r) => sum + roleAnnualSavings(r), 0);
        const realizedAnnual = addressable * scenario.realizationRate;

        const baseInvestment = totals.investment.total * scenario.investmentMultiplier;
        const timelineQ = Math.max(2, Math.round(scenario.timelineMonths / 3));

        let cInv = 0;
        let cSav = 0;
        let cNet = 0;

        for (let q = 1; q <= quarters; q += 1) {
          labels.push(`Y${Math.ceil(q / 4)} Q${((q - 1) % 4) + 1}`);
          const ramp = Math.min(1, q / timelineQ);
          const invQ = q <= timelineQ ? baseInvestment / timelineQ : baseInvestment * 0.015;

          const inactionPenalty = scenario.id === "status_quo"
            ? totals.comp * scenario.costOfInactionPenalty * (q / quarters) * 0.03
            : 0;

          const savQ = (realizedAnnual / 4) * ramp - inactionPenalty;
          cInv += invQ;
          cSav += savQ;
          cNet += savQ - invQ;

          cumulativeInvest.push(cInv);
          cumulativeSavings.push(cSav);
          cumulativeNet.push(cNet);

          const reductionRamp = Math.min(1, q / timelineQ);
          const reduced = (targetHeadcount * scenario.workforceReductionTarget / 100) * reductionRamp;
          headcount.push(Math.max(0, baselineHeadcount - reduced));
        }

        const yearlyNet = [1, 3, 5].map((year) => {
          const idx = year * 4 - 1;
          return cumulativeNet[idx];
        });

        const discountRateQ = (STATE.assumptions.discountRate / 100) / 4;
        let npv = 0;
        cumulativeNet.forEach((val, idx) => {
          const prev = idx === 0 ? 0 : cumulativeNet[idx - 1];
          const qFlow = val - prev;
          npv += qFlow / Math.pow(1 + discountRateQ, idx + 1);
        });

        const pAndLRisk = scenario.riskProfile;
        const avgRisk = (pAndLRisk.execution + pAndLRisk.legal + pAndLRisk.culture + pAndLRisk.competitive + pAndLRisk.regulatory) / 5;

        return {
          scenarioId: scenario.id,
          name: scenario.name,
          labels,
          headcount,
          cumulativeInvest,
          cumulativeSavings,
          cumulativeNet,
          yearlyNet,
          npv,
          riskProfile: pAndLRisk,
          avgRisk,
          targetHeadcount,
          baselineHeadcount,
          breakEvenQuarter: cumulativeNet.findIndex((v) => v >= 0) + 1,
          summary: scenario.summary
        };
      }

      function calcAllScenarios(totals, roles) {
        const out = {};
        Object.values(STATE.scenarios).forEach((scenario) => {
          out[scenario.id] = calcScenarioProjection(scenario, totals, roles);
        });
        return out;
      }

      function monteCarloForScenario(scenarioId) {
        const base = STATE.calc.scenarios[scenarioId];
        const outcomes = [];
        for (let i = 0; i < MAX_MONTE_CARLO_RUNS; i += 1) {
          const savingsShock = 0.8 + Math.random() * 0.4;
          const investmentShock = 0.8 + Math.random() * 0.4;
          const delayShock = 0.85 + Math.random() * 0.5;
          const riskShock = 0.9 + Math.random() * 0.25;

          const adjNet = base.cumulativeNet[base.cumulativeNet.length - 1] * savingsShock * riskShock
            - base.cumulativeInvest[base.cumulativeInvest.length - 1] * (investmentShock - 1)
            - (base.breakEvenQuarter || 10) * 150000 * delayShock;
          outcomes.push(adjNet);
        }

        outcomes.sort((a, b) => a - b);
        const p10 = outcomes[Math.floor(outcomes.length * 0.1)];
        const p50 = outcomes[Math.floor(outcomes.length * 0.5)];
        const p90 = outcomes[Math.floor(outcomes.length * 0.9)];

        return { outcomes, p10, p50, p90 };
      }

      function createEmptyReadinessAnswers() {
        const answers = {};
        READINESS_DIMENSIONS.forEach((dim) => {
          answers[dim.id] = dim.questions.map(() => 3);
        });
        return answers;
      }

      function readinessScores() {
        const scores = {};
        let total = 0;
        READINESS_DIMENSIONS.forEach((dim) => {
          const arr = STATE.readinessAnswers[dim.id] || [];
          const avg = arr.length ? arr.reduce((a, b) => a + b, 0) / arr.length : 0;
          const pct = (avg / 5) * 100;
          scores[dim.id] = pct;
          total += pct * dim.weight;
        });
        return { dimensions: scores, overall: total };
      }

      function readinessBand(score) {
        if (score >= 80) return { label: "Transformation Ready", cls: "status-good", recommendation: "Execute aggressively with active governance." };
        if (score >= 60) return { label: "Partially Ready", cls: "status-med", recommendation: "Close key readiness gaps over 6-12 months before scaling." };
        if (score >= 40) return { label: "Foundational Work Needed", cls: "status-med", recommendation: "Run a 12-18 month foundations program pre-transformation." };
        return { label: "Not Ready", cls: "status-bad", recommendation: "Prioritize foundational capability build before displacement initiatives." };
      }

      function snapshotState() {
        return {
          org: deepClone(STATE.org),
          assumptions: deepClone(STATE.assumptions),
          scenarios: deepClone(STATE.scenarios),
          readinessAnswers: deepClone(STATE.readinessAnswers),
          readinessMeta: deepClone(STATE.ui.readinessMeta)
        };
      }

      function applySnapshot(snap) {
        STATE.org = deepClone(snap.org);
        STATE.assumptions = deepClone(snap.assumptions);
        STATE.scenarios = deepClone(snap.scenarios);
        STATE.readinessAnswers = deepClone(snap.readinessAnswers);
        STATE.ui.readinessMeta = deepClone(snap.readinessMeta);
        markAllTabsDirty();
        fullRefresh();
      }

      function recordHistory() {
        STATE.history.undo.push(snapshotState());
        if (STATE.history.undo.length > HISTORY_LIMIT) {
          STATE.history.undo.shift();
        }
        STATE.history.redo = [];
      }

      function undo() {
        const snap = STATE.history.undo.pop();
        if (!snap) return;
        STATE.history.redo.push(snapshotState());
        applySnapshot(snap);
        showToast("Undo applied");
      }

      function redo() {
        const snap = STATE.history.redo.pop();
        if (!snap) return;
        STATE.history.undo.push(snapshotState());
        applySnapshot(snap);
        showToast("Redo applied");
      }

      function markAllTabsDirty() {
        Object.keys(STATE.ui.dirtyTabs).forEach((k) => {
          STATE.ui.dirtyTabs[k] = true;
        });
      }

      function markTabDirty(tabId) {
        STATE.ui.dirtyTabs[tabId] = true;
      }

      function showToast(msg) {
        const toast = $("toast");
        toast.textContent = msg;
        toast.classList.add("active");
        clearTimeout(showToast.t);
        showToast.t = setTimeout(() => toast.classList.remove("active"), 1800);
      }

      function readStoredSnapshotRaw() {
        const keys = [STORAGE_KEY, ...LEGACY_STORAGE_KEYS];
        for (const key of keys) {
          const raw = localStorage.getItem(key);
          if (raw) return { key, raw };
        }
        return null;
      }

      function migrateLegacyStorageIfNeeded() {
        const found = readStoredSnapshotRaw();
        if (!found) return;
        if (found.key === STORAGE_KEY) return;
        localStorage.setItem(STORAGE_KEY, found.raw);
      }

      function storageSave() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(snapshotState()));
        showToast("Configuration saved locally");
      }

      function storageLoad() {
        const found = readStoredSnapshotRaw();
        if (!found?.raw) {
          showToast("No saved configuration found");
          return;
        }
        try {
          const data = JSON.parse(found.raw);
          applySnapshot(data);
          if (found.key !== STORAGE_KEY) {
            localStorage.setItem(STORAGE_KEY, found.raw);
          }
          showToast("Loaded saved configuration");
        } catch (err) {
          showToast("Failed to load saved configuration");
        }
      }

      function exportScenarioJson() {
        const blob = new Blob([JSON.stringify(snapshotState(), null, 2)], { type: "application/json" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `ai_workforce_scenario_${new Date().toISOString().slice(0, 10)}.json`;
        a.click();
        URL.revokeObjectURL(a.href);
        showToast("Scenario JSON exported");
      }

      function resetToTemplate() {
        recordHistory();
        STATE.org = buildOrgFromTemplate(STATE.org?.industryId || "banking", flattenRoles().reduce((s, r) => s + r.headcount, 0) || 3500, STATE.selectedScenarioId);
        markAllTabsDirty();
        fullRefresh();
        showToast("Template reset complete");
      }

      function applyTemplate(templateId) {
        const size = flattenRoles().reduce((s, r) => s + r.headcount, 0) || 3500;
        recordHistory();
        STATE.org = buildOrgFromTemplate(templateId, size, STATE.selectedScenarioId);
        markAllTabsDirty();
        fullRefresh();
        showToast(`Applied ${INDUSTRY_TEMPLATES[templateId].name} template`);
      }

      function normalizeHeadcountToTarget(target) {
        const roles = flattenRoles();
        const current = roles.reduce((sum, r) => sum + r.headcount, 0);
        if (!current || !target) return;
        recordHistory();
        const factor = target / current;
        let assigned = 0;
        roles.forEach((role, idx) => {
          if (idx === roles.length - 1) {
            role.headcount = Math.max(1, target - assigned);
          } else {
            role.headcount = Math.max(1, Math.round(role.headcount * factor));
            assigned += role.headcount;
          }
        });
        markAllTabsDirty();
        fullRefresh();
      }

      function importCsv() {
        const fileInput = $("csvUpload");
        const file = fileInput.files && fileInput.files[0];
        if (!file) {
          showToast("Select a CSV file first");
          return;
        }

        Papa.parse(file, {
          header: true,
          skipEmptyLines: true,
          complete: (results) => {
            const rows = results.data || [];
            if (!rows.length) {
              showToast("No rows parsed from CSV");
              return;
            }

            recordHistory();
            const roles = [];
            rows.forEach((row, idx) => {
              const department = row.Department || row.department || "General";
              const fn = row.Function || row.function || "General Operations";
              const title = row["Role Title"] || row.role || row.Role || `Role ${idx + 1}`;
              const headcount = Number(row.Headcount || row.headcount || 1);
              const avgSalary = Number(row["Average Salary"] || row.avgSalary || row.salary || 90000);
              const riskScore = Math.max(0, Math.min(100, Number(row.riskScore || row.Risk || 55)));
              const action = actionForRisk(riskScore);

              roles.push({
                id: uid("role"),
                title,
                department,
                function: fn,
                location: row.Location || row.location || "US",
                headcount: Math.max(1, headcount),
                avgSalary: Math.max(1, avgSalary),
                riskScore,
                currentAutomationLevel: Number(row.currentAutomationLevel || row.Automation || 40),
                recommendedAction: action,
                eliminationPercent: defaultEliminationPercent(riskScore, action),
                productivityGainPercent: defaultProductivityGain(riskScore, action),
                aiTools: aiToolsForFunction(fn, department, action),
                implementationMonths: implementationMonthsForRisk(riskScore, action),
                priority: priorityForRisk(riskScore),
                reskillPathway: reskillPathForAction(action, department),
                legalConstraints: legalConstraintForRisk(riskScore),
                notes: "Imported from CSV",
                taskDecomposition: taskDecomposition(action)
              });
            });

            STATE.org.roles = roles;
            STATE.org.initiatives = buildInitiativesFromRoles(roles);
            markAllTabsDirty();
            fullRefresh();
            showToast(`Imported ${roles.length} role rows from CSV`);
          }
        });
      }

      function tabSwitch(tabId) {
        STATE.selectedTab = tabId;
        document.querySelectorAll(".tab").forEach((el) => el.classList.toggle("active", el.id === tabId));
        document.querySelectorAll(".nav-btn").forEach((el) => el.classList.toggle("active", el.dataset.tab === tabId));
        renderTabIfDirty(tabId);
        const content = document.querySelector(".content");
        if (content) content.scrollTop = 0;
        requestAnimationFrame(() => resizePlotsForActiveTab());
      }

      function renderTabIfDirty(tabId) {
        if (!STATE.ui.dirtyTabs[tabId]) return;
        if (tabId === "tab-warboard") renderWarboard();
        if (tabId === "tab-financial") renderFinancial();
        if (tabId === "tab-actions") renderActions();
        if (tabId === "tab-scenarios") renderScenarios();
        if (tabId === "tab-readiness") renderReadiness();
        if (tabId === "tab-competitive") renderCompetitive();
        if (tabId === "tab-board") renderBoard();
        STATE.ui.dirtyTabs[tabId] = false;
      }

      function fullRefresh() {
        calcCore();
        renderGlobalStats();
        renderTabIfDirty(STATE.selectedTab);
        requestAnimationFrame(() => resizePlotsForActiveTab());
      }

      function renderGlobalStats() {
        const c = STATE.calc;
        if (!c.totals) return;

        $("orgLabel").textContent = `${STATE.org.name} | ${STATE.org.industry}`;
        $("kpiHeadcount").textContent = numberFmt.format(c.totals.headcount);
        $("kpiComp").textContent = currencyFmt.format(c.totals.comp);
        const criticalPct = c.totals.headcount ? (c.totals.criticalHeadcount / c.totals.headcount) * 100 : 0;
        $("kpiCritical").textContent = `${numberFmt.format(c.totals.criticalHeadcount)} (${percentFmt.format(criticalPct)}%)`;
        $("kpiAddressable").textContent = currencyFmt.format(c.totals.addressable);
        $("kpiRisk").textContent = percentFmt.format(c.weightedRisk);
        $("kpiReadiness").textContent = percentFmt.format(c.readinessIndex);

        $("automationMaturityValue").textContent = `${STATE.ui.readinessMeta.automationMaturity}%`;
        $("dataMaturityValue").textContent = `${STATE.ui.readinessMeta.dataMaturity}%`;
        $("weightSummary").textContent = `Risk ${STATE.ui.readinessMeta.riskWeight}% / Automation ${STATE.ui.readinessMeta.automationWeight}% / Data ${STATE.ui.readinessMeta.dataWeight}%`;
      }

      function renderWarboard() {
        renderTemplateControls();
        renderTreemap();
        renderFunctionEditor();
        renderNodeDetail();
      }

      function renderTemplateControls() {
        const templateSelect = $("templateSelect");
        if (!templateSelect.dataset.initialized) {
          templateSelect.innerHTML = Object.values(INDUSTRY_TEMPLATES)
            .map((t) => `<option value="${t.id}">${t.name}</option>`)
            .join("");
          templateSelect.dataset.initialized = "1";
        }
        templateSelect.value = STATE.org.industryId;
        $("organizationNameInput").value = STATE.org.name;
        $("revenueInput").value = STATE.org.totalRevenue;
        $("targetHeadcountInput").value = flattenRoles().reduce((s, r) => s + r.headcount, 0);

        const totals = STATE.calc.totals;
        $("warboardMiniKpis").innerHTML = [
          `Functions: ${numberFmt.format(new Set(flattenRoles().map((r) => `${r.department}|${r.function}`)).size)}`,
          `Roles: ${numberFmt.format(flattenRoles().length)}`,
          `Annual Net: ${currencyFmt.format(STATE.calc.totals.savings.annualNet)}`,
          `NPV(5Y): ${currencyFmt.format(STATE.calc.npv)}`,
          `Risk Model Basis: ${MODEL_REFERENCE_SET.length} sources`,
          `Calibration As-of: ${DATA_CALIBRATION_DATE}`
        ].map((txt) => `<span>${txt}</span>`).join("");
      }

      function roleToTreemapNodes() {
        const labels = [];
        const ids = [];
        const parents = [];
        const values = [];
        const colors = [];
        const custom = [];

        const rootId = "root";
        labels.push(STATE.org.name);
        ids.push(rootId);
        parents.push("");
        values.push(STATE.calc.totals.headcount || 1);
        colors.push(STATE.calc.weightedRisk || 0);
        custom.push([STATE.calc.totals.headcount, STATE.calc.totals.comp, STATE.calc.weightedRisk, "Organization", "Overall"]);

        const deptMap = {};
        const fnMap = {};

        flattenRoles().forEach((role) => {
          const depId = `dep|${role.department}`;
          const fnId = `fn|${role.department}|${role.function}`;
          const roleId = `role|${role.id}`;

          if (!deptMap[depId]) {
            deptMap[depId] = { headcount: 0, comp: 0, riskNum: 0 };
          }
          deptMap[depId].headcount += role.headcount;
          deptMap[depId].comp += loadedComp(role);
          deptMap[depId].riskNum += role.riskScore * role.headcount;

          if (!fnMap[fnId]) {
            fnMap[fnId] = { headcount: 0, comp: 0, riskNum: 0, department: role.department, fn: role.function };
          }
          fnMap[fnId].headcount += role.headcount;
          fnMap[fnId].comp += loadedComp(role);
          fnMap[fnId].riskNum += role.riskScore * role.headcount;

          labels.push(role.title);
          ids.push(roleId);
          parents.push(fnId);
          values.push(role.headcount);
          colors.push(role.riskScore);
          custom.push([role.headcount, loadedComp(role), role.riskScore, role.recommendedAction, `${role.implementationMonths} months`]);
        });

        Object.entries(fnMap).forEach(([id, fn]) => {
          const risk = fn.headcount ? fn.riskNum / fn.headcount : 0;
          labels.push(fn.fn);
          ids.push(id);
          parents.push(`dep|${fn.department}`);
          values.push(fn.headcount);
          colors.push(risk);
          custom.push([fn.headcount, fn.comp, risk, "Function", ""]);
        });

        Object.entries(deptMap).forEach(([id, dep]) => {
          const depName = id.split("|")[1];
          const risk = dep.headcount ? dep.riskNum / dep.headcount : 0;
          labels.push(depName);
          ids.push(id);
          parents.push(rootId);
          values.push(dep.headcount);
          colors.push(risk);
          custom.push([dep.headcount, dep.comp, risk, "Department", ""]);
        });

        return { labels, ids, parents, values, colors, custom };
      }

      function renderTreemap() {
        const data = roleToTreemapNodes();
        const trace = {
          type: "treemap",
          labels: data.labels,
          ids: data.ids,
          parents: data.parents,
          values: data.values,
          branchvalues: "total",
          customdata: data.custom,
          marker: {
            colors: data.colors,
            cmin: 0,
            cmax: 100,
            colorscale: [
              [0, "#00c896"],
              [0.25, "#00c896"],
              [0.5, "#27a7ff"],
              [0.75, "#f5a623"],
              [1, "#e74c3c"]
            ],
            line: { color: "#09111d", width: 1 }
          },
          hovertemplate:
            "<b>%{label}</b><br>Headcount: %{customdata[0]}<br>Total comp: %{customdata[1]:$,.0f}<br>Risk: %{customdata[2]:.1f}<br>Action: %{customdata[3]}<br>Timeline: %{customdata[4]}<extra></extra>",
          textfont: { color: "#ebf3fc", size: 12 }
        };

        const layout = {
          paper_bgcolor: "rgba(0,0,0,0)",
          plot_bgcolor: "rgba(0,0,0,0)",
          margin: { l: 4, r: 4, t: 8, b: 4 },
          height: chartHeightPreset("tall"),
          autosize: true,
          font: { color: "#d9e7f5", family: "DM Sans" },
          coloraxis: { cmin: 0, cmax: 100 }
        };

        Plotly.react("orgTreemap", [trace], layout, PLOT_CONFIG);

        const treemapDiv = $("orgTreemap");
        treemapDiv.on("plotly_click", (event) => {
          const id = event.points?.[0]?.id;
          if (!id) return;
          STATE.selectedNodeId = id;
          renderNodeDetail();

          if (id.startsWith("dep|")) {
            STATE.ui.roleFilters.department = id.split("|")[1];
            markTabDirty("tab-actions");
          } else if (id.startsWith("role|")) {
            STATE.selectedRoleId = id.split("|")[1];
            markTabDirty("tab-actions");
          }
        });
      }

      function summarizeNode(id) {
        const roles = flattenRoles();
        if (!id || id === "root") {
          const c = STATE.calc;
          return `Organization: ${STATE.org.name}\nIndustry: ${STATE.org.industry}\nHeadcount: ${numberFmt.format(c.totals.headcount)}\nTotal Compensation Cost: ${currencyFmt.format(c.totals.comp)}\nAddressable Savings: ${currencyFmt.format(c.totals.addressable)}\nWeighted Risk: ${percentFmt.format(c.weightedRisk)}\nRecommended Focus: Start with P1 functions where risk > 75 and break-even under 18 months.`;
        }

        if (id.startsWith("dep|")) {
          const depName = id.split("|")[1];
          const depRoles = roles.filter((r) => r.department === depName);
          const headcount = depRoles.reduce((s, r) => s + r.headcount, 0);
          const comp = depRoles.reduce((s, r) => s + loadedComp(r), 0);
          const risk = depRoles.reduce((s, r) => s + r.riskScore * r.headcount, 0) / Math.max(1, headcount);
          const savings = depRoles.reduce((s, r) => s + roleAnnualSavings(r), 0);
          const topRole = [...depRoles].sort((a, b) => b.riskScore - a.riskScore)[0];
          return `Department: ${depName}\nHeadcount: ${numberFmt.format(headcount)}\nTotal Compensation: ${currencyFmt.format(comp)}\nAvg Risk: ${percentFmt.format(risk)}\nAddressable Savings: ${currencyFmt.format(savings)}\nTop Role at Risk: ${topRole.title} (${topRole.riskScore})\nRecommended Action: ${topRole.recommendedAction.toUpperCase()} with ${topRole.implementationMonths}-month implementation window.`;
        }

        if (id.startsWith("fn|")) {
          const parts = id.split("|");
          const depName = parts[1];
          const fnName = parts[2];
          const fnRoles = roles.filter((r) => r.department === depName && r.function === fnName);
          const headcount = fnRoles.reduce((s, r) => s + r.headcount, 0);
          const comp = fnRoles.reduce((s, r) => s + loadedComp(r), 0);
          const risk = fnRoles.reduce((s, r) => s + r.riskScore * r.headcount, 0) / Math.max(1, headcount);
          const savings = fnRoles.reduce((s, r) => s + roleAnnualSavings(r), 0);
          const actionMix = fnRoles.reduce((acc, r) => {
            acc[r.recommendedAction] = (acc[r.recommendedAction] || 0) + r.headcount;
            return acc;
          }, {});
          return `Function: ${fnName}\nDepartment: ${depName}\nHeadcount: ${numberFmt.format(headcount)}\nTotal Compensation: ${currencyFmt.format(comp)}\nAvg Risk: ${percentFmt.format(risk)}\nAddressable Savings: ${currencyFmt.format(savings)}\nAction Mix: ${Object.entries(actionMix).map(([k, v]) => `${k} ${v}`).join(", ")}\nRecommended Sequence: Pilot AI workflow in 2 business units, then scale to enterprise within 12 months.`;
        }

        if (id.startsWith("role|")) {
          const roleId = id.split("|")[1];
          const role = roles.find((r) => r.id === roleId);
          if (!role) return "Role not found.";
          const rb = riskBand(role.riskScore);
          return `Role: ${role.title}\nDepartment: ${role.department}\nFunction: ${role.function}\nHeadcount: ${numberFmt.format(role.headcount)}\nAvg Salary: ${currencyFmt.format(role.avgSalary)}\nLoaded Total Cost: ${currencyFmt.format(loadedComp(role))}\nRisk Score: ${role.riskScore} (${rb.label})\nRecommended Action: ${role.recommendedAction.toUpperCase()}\nAnnual Savings Opportunity: ${currencyFmt.format(roleAnnualSavings(role))}\nImplementation Window: ${role.implementationMonths} months\nAI Tools: ${role.aiTools.join(", ")}\nLegal Constraints: ${role.legalConstraints}\nReskilling Pathway: ${role.reskillPathway}`;
        }

        return "Select a node to inspect detail.";
      }

      function renderNodeDetail() {
        $("nodeDetail").textContent = summarizeNode(STATE.selectedNodeId || "root");
      }

      function groupFunctionsFromRoles() {
        const map = {};
        flattenRoles().forEach((r) => {
          const key = `${r.department}|${r.function}`;
          if (!map[key]) {
            map[key] = {
              key,
              department: r.department,
              function: r.function,
              headcount: 0,
              salaryNum: 0,
              riskNum: 0,
              autoNum: 0,
              rationale: r.notes || ""
            };
          }
          map[key].headcount += r.headcount;
          map[key].salaryNum += r.avgSalary;
          map[key].riskNum += r.riskScore;
          map[key].autoNum += r.currentAutomationLevel;
        });
        return Object.values(map).map((f) => ({
          ...f,
          avgSalary: Math.round(f.salaryNum / 5),
          baseRisk: Math.round(f.riskNum / 5),
          automationLevel: Math.round(f.autoNum / 5)
        }));
      }

      function renderFunctionEditor() {
        const rows = groupFunctionsFromRoles();
        const body = $("functionTableBody");
        body.innerHTML = rows.map((row) => {
          return `<tr data-key="${row.key}">
            <td><input data-field="department" type="text" value="${escapeHtml(row.department)}" /></td>
            <td><input data-field="function" type="text" value="${escapeHtml(row.function)}" /></td>
            <td><input data-field="headcount" type="number" min="1" value="${row.headcount}" /></td>
            <td><input data-field="avgSalary" type="number" min="1" value="${row.avgSalary}" /></td>
            <td><input data-field="baseRisk" type="number" min="0" max="100" value="${row.baseRisk}" /></td>
            <td><input data-field="automationLevel" type="number" min="0" max="100" value="${row.automationLevel}" /></td>
            <td><input data-field="rationale" type="text" value="${escapeHtml(row.rationale || "")}" /></td>
            <td><button class="btn" data-action="apply">Apply</button> <button class="btn warn" data-action="remove">Remove</button></td>
          </tr>`;
        }).join("");

        body.querySelectorAll("button[data-action='apply']").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            const tr = e.target.closest("tr");
            const key = tr.dataset.key;
            const fields = {};
            tr.querySelectorAll("input[data-field]").forEach((inp) => {
              fields[inp.dataset.field] = inp.value;
            });
            applyFunctionEdits(key, fields);
          });
        });

        body.querySelectorAll("button[data-action='remove']").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            const tr = e.target.closest("tr");
            removeFunctionGroup(tr.dataset.key);
          });
        });
      }

      function applyFunctionEdits(key, fields) {
        recordHistory();
        const [oldDep, oldFn] = key.split("|");
        const targetRoles = flattenRoles().filter((r) => r.department === oldDep && r.function === oldFn);
        if (!targetRoles.length) return;

        const targetHeadcount = Math.max(1, Number(fields.headcount || targetRoles.reduce((s, r) => s + r.headcount, 0)));
        const perRole = Math.max(1, Math.round(targetHeadcount / targetRoles.length));
        let assigned = 0;

        targetRoles.forEach((r, idx) => {
          r.department = fields.department || oldDep;
          r.function = fields.function || oldFn;
          r.avgSalary = Math.max(1, Number(fields.avgSalary || r.avgSalary));
          r.riskScore = Math.max(0, Math.min(100, Number(fields.baseRisk || r.riskScore)));
          r.currentAutomationLevel = Math.max(0, Math.min(100, Number(fields.automationLevel || r.currentAutomationLevel)));
          r.notes = fields.rationale || r.notes;
          r.recommendedAction = actionForRisk(r.riskScore);
          r.eliminationPercent = defaultEliminationPercent(r.riskScore, r.recommendedAction);
          r.productivityGainPercent = defaultProductivityGain(r.riskScore, r.recommendedAction);
          r.priority = priorityForRisk(r.riskScore);
          if (idx === targetRoles.length - 1) {
            r.headcount = Math.max(1, targetHeadcount - assigned);
          } else {
            r.headcount = perRole;
            assigned += perRole;
          }
        });

        STATE.org.initiatives = buildInitiativesFromRoles(flattenRoles());
        markAllTabsDirty();
        fullRefresh();
        showToast("Function updates applied");
      }

      function removeFunctionGroup(key) {
        const [dep, fn] = key.split("|");
        recordHistory();
        STATE.org.roles = flattenRoles().filter((r) => !(r.department === dep && r.function === fn));
        STATE.org.initiatives = buildInitiativesFromRoles(flattenRoles());
        markAllTabsDirty();
        fullRefresh();
        showToast("Function removed");
      }

      function addFunctionGroup() {
        recordHistory();
        const newRows = [
          generateRoleFromTemplateRow(
            {
              department: "New Department",
              function: "New Function",
              baseRisk: 58,
              automationLevel: 40,
              avgSalary: 110000,
              rationale: "Custom function added by user"
            },
            "New Role A",
            15,
            1
          ),
          generateRoleFromTemplateRow(
            {
              department: "New Department",
              function: "New Function",
              baseRisk: 58,
              automationLevel: 40,
              avgSalary: 110000,
              rationale: "Custom function added by user"
            },
            "New Role B",
            10,
            2
          )
        ];

        STATE.org.roles.push(...newRows);
        STATE.org.initiatives = buildInitiativesFromRoles(flattenRoles());
        markAllTabsDirty();
        fullRefresh();
        showToast("Added new function group");
      }

      function renderFinancial() {
        renderAssumptionControls();
        renderWaterfall();
        renderRoiTimeline();
        renderDeptRoi();
        renderSensitivity();
      }

      function assumptionControlConfig() {
        return [
          { key: "severanceMonths", label: "Severance Multiplier (months)", min: 1, max: 18, step: 1, prefix: "" },
          { key: "aiCostPerEmployee", label: "AI Tool Cost per Employee (annual)", min: 500, max: 50000, step: 500, prefix: "$" },
          { key: "reskillCostPerEmployee", label: "Reskilling Cost per Employee", min: 2000, max: 50000, step: 500, prefix: "$" },
          { key: "productivityGainDefault", label: "Productivity Gain (Augmented)", min: 10, max: 60, step: 1, suffix: "%" },
          { key: "implementationTimelineMonths", label: "Implementation Timeline (months)", min: 6, max: 60, step: 1, prefix: "" },
          { key: "discountRate", label: "Discount Rate", min: 0, max: 15, step: 0.1, suffix: "%" },
          { key: "benefitsLoadPercent", label: "Benefits Load", min: 25, max: 35, step: 1, suffix: "%" },
          { key: "changeManagementPercent", label: "Change Management Cost", min: 2, max: 20, step: 1, suffix: "%" },
          { key: "attritionOffsetPercent", label: "Attrition Offset", min: 0, max: 30, step: 1, suffix: "%" },
          { key: "salaryInflationPercent", label: "Salary Inflation", min: 0, max: 10, step: 0.1, suffix: "%" }
        ];
      }

      function renderAssumptionControls() {
        const container = $("assumptionControls");
        container.innerHTML = assumptionControlConfig().map((cfg) => {
          const value = STATE.assumptions[cfg.key];
          const label = `${cfg.prefix || ""}${numberFmt.format(value)}${cfg.suffix || ""}`;
          return `<div class="question-box">
            <label>${cfg.label}<span class="mono">${label}</span></label>
            <input data-assumption="${cfg.key}" type="range" min="${cfg.min}" max="${cfg.max}" step="${cfg.step}" value="${value}" />
          </div>`;
        }).join("");

        container.querySelectorAll("input[data-assumption]").forEach((input) => {
          input.addEventListener("input", (e) => {
            const key = e.target.dataset.assumption;
            STATE.assumptions[key] = Number(e.target.value);
            markAllTabsDirty();
            fullRefresh();
          });
          input.addEventListener("change", () => recordHistory());
        });
      }

      function renderWaterfall() {
        const t = STATE.calc.totals;

        const eliminatedSavings = flattenRoles().reduce((sum, role) => {
          const loaded = loadedComp(role);
          return sum + loaded * (role.eliminationPercent / 100) * (role.riskScore / 100);
        }, 0);

        const augmentedSavings = flattenRoles().reduce((sum, role) => {
          if (role.recommendedAction !== "augment") return sum;
          const loaded = loadedComp(role);
          return sum + loaded * (role.productivityGainPercent / 100) * (role.eliminationPercent / 100);
        }, 0);

        const reskillCost = t.investment.reskill;
        const techInvestment = t.investment.aiTools;
        const changeCost = t.investment.change + t.investment.riskBuffer;
        const severanceCost = t.investment.severance;
        const net = eliminatedSavings + augmentedSavings - reskillCost - techInvestment - changeCost - severanceCost;

        const x = [
          "Current Comp Cost",
          "Roles Eliminated",
          "Roles Augmented",
          "Reskilling Cost",
          "Technology Investment",
          "Change Mgmt Cost",
          "Severance & Transition",
          "Projected Future Cost"
        ];

        const y = [
          t.comp,
          -eliminatedSavings,
          -augmentedSavings,
          reskillCost,
          techInvestment,
          changeCost,
          severanceCost,
          t.comp - net
        ];

        const measure = ["absolute", "relative", "relative", "relative", "relative", "relative", "relative", "total"];

        const colors = ["#d6e8ff", "#00c896", "#27a7ff", "#f5a623", "#f5a623", "#f5a623", "#e74c3c", "#e5edf8"];

        const trace = {
          type: "waterfall",
          x,
          y,
          measure,
          text: y.map((v) => currencyFmt.format(Math.abs(v))),
          textposition: "outside",
          connector: { line: { color: "#9fb8d6" } },
          increasing: { marker: { color: "#f5a623" } },
          decreasing: { marker: { color: "#00c896" } },
          totals: { marker: { color: "#4f5f77" } },
          marker: { color: colors },
          hovertemplate: "%{x}<br>%{y:$,.0f}<extra></extra>"
        };

        const layout = baseLayout("Financial Waterfall", { yaxis: { tickprefix: "$" } }, "default");
        Plotly.react("waterfallChart", [trace], layout, PLOT_CONFIG);

        const waterfallDiv = $("waterfallChart");
        waterfallDiv.on("plotly_click", (evt) => {
          const label = evt.points?.[0]?.x;
          if (!label) return;
          const detail = waterfallBreakdown(label);
          $("waterfallDetail").textContent = detail;
        });
      }

      function waterfallBreakdown(label) {
        const roles = flattenRoles();
        if (label === "Roles Eliminated") {
          const top = [...roles].sort((a, b) => {
            const av = loadedComp(a) * (a.eliminationPercent / 100) * (a.riskScore / 100);
            const bv = loadedComp(b) * (b.eliminationPercent / 100) * (b.riskScore / 100);
            return bv - av;
          }).slice(0, 8);
          return `Top elimination contributors:\n${top.map((r) => `- ${r.title} (${r.department}): ${currencyFmt.format(loadedComp(r) * (r.eliminationPercent / 100) * (r.riskScore / 100))}`).join("\n")}`;
        }
        if (label === "Roles Augmented") {
          const top = roles.filter((r) => r.recommendedAction === "augment").sort((a, b) => roleAnnualSavings(b) - roleAnnualSavings(a)).slice(0, 8);
          return `Top augmentation contributors:\n${top.map((r) => `- ${r.title} (${r.department}): ${currencyFmt.format(roleAnnualSavings(r))}`).join("\n")}`;
        }
        if (label === "Severance & Transition") {
          const top = roles.sort((a, b) => roleInvestment(b).severance - roleInvestment(a).severance).slice(0, 8);
          return `Largest severance cost centers:\n${top.map((r) => `- ${r.title}: ${currencyFmt.format(roleInvestment(r).severance)}`).join("\n")}`;
        }
        return `${label}: click another bar for role-level decomposition.`;
      }

      function renderRoiTimeline() {
        const yearly = STATE.calc.timeline.yearly;
        const years = yearly.map((r) => `Year ${r.year}`);
        const cumulativeInv = yearly.map((r) => r.cumulativeInv);
        const cumulativeSav = yearly.map((r) => r.cumulativeSav);
        const cumulativeNet = yearly.map((r) => r.cumulativeNet);

        const baseTrace = [
          {
            x: years,
            y: cumulativeInv,
            mode: "lines+markers",
            name: "Cumulative Investment",
            line: { color: "#f5a623", width: 3 }
          },
          {
            x: years,
            y: cumulativeSav,
            mode: "lines+markers",
            name: "Cumulative Savings",
            line: { color: "#00c896", width: 3 }
          },
          {
            x: years,
            y: cumulativeNet,
            mode: "lines+markers",
            name: "Net Cumulative Impact",
            line: { color: "#27a7ff", width: 3 }
          },
          {
            x: years,
            y: cumulativeNet.map((v) => v * 0.5),
            mode: "lines",
            name: "Conservative (50%)",
            line: { color: "#7ca8d6", dash: "dot" }
          },
          {
            x: years,
            y: cumulativeNet.map((v) => v * 0.75),
            mode: "lines",
            name: "Base Case (75%)",
            line: { color: "#8fd8c6", dash: "dash" }
          },
          {
            x: years,
            y: cumulativeNet,
            mode: "lines",
            name: "Aggressive (100%)",
            line: { color: "#5fe2b9", dash: "solid", width: 1 }
          }
        ];

        const breakEven = STATE.calc.timeline.breakEvenYear;
        const layout = baseLayout("ROI Timeline", {
          yaxis: { tickprefix: "$" },
          shapes: breakEven
            ? [
                {
                  type: "line",
                  x0: `Year ${breakEven}`,
                  x1: `Year ${breakEven}`,
                  y0: 0,
                  y1: Math.max(...cumulativeSav, ...cumulativeInv),
                  line: { color: "#e74c3c", width: 2, dash: "dot" }
                }
              ]
            : []
        }, "default");

        Plotly.react("roiTimelineChart", baseTrace, layout, PLOT_CONFIG);

        const body = $("roiYearTableBody");
        body.innerHTML = yearly.map((row) => `<tr>
          <td>Year ${row.year}</td>
          <td>${currencyFmt.format(row.investment)}</td>
          <td>${currencyFmt.format(row.savings)}</td>
          <td>${currencyFmt.format(row.net)}</td>
          <td>${currencyFmt.format(row.cumulativeNet)}</td>
        </tr>`).join("");
      }

      function renderDeptRoi() {
        const deps = [...STATE.calc.departments];
        const sort = STATE.ui.departmentSort;
        deps.sort((a, b) => {
          if (sort === "savings") return b.savings - a.savings;
          if (sort === "roi") return b.roiRatio - a.roiRatio;
          if (sort === "speed") return a.speed - b.speed;
          return a.complexity - b.complexity;
        });

        const trace = {
          type: "bar",
          orientation: "h",
          y: deps.map((d) => d.department),
          x: deps.map((d) => d.savings),
          marker: { color: deps.map((d) => d.roiRatio > 1 ? "#00c896" : d.roiRatio > 0.6 ? "#f5a623" : "#e74c3c") },
          hovertemplate: "%{y}<br>Savings: %{x:$,.0f}<extra></extra>"
        };

        const layout = baseLayout("Department ROI", {
          xaxis: { tickprefix: "$" },
          margin: { l: 180, r: 20, t: 20, b: 36 }
        }, "rows", deps.length);

        Plotly.react("deptRoiChart", [trace], layout, PLOT_CONFIG);

        $("deptRoiTableBody").innerHTML = deps.map((d) => `<tr>
          <td>${escapeHtml(d.department)}</td>
          <td>${currencyFmt.format(d.savings)}</td>
          <td>${d.roiRatio.toFixed(2)}x</td>
          <td>${d.speed.toFixed(1)}</td>
          <td>${d.complexity}</td>
        </tr>`).join("");
      }

      function renderSensitivity() {
        const sens = STATE.calc.sensitivity;
        const trace1 = {
          type: "bar",
          orientation: "h",
          y: sens.map((s) => s.label),
          x: sens.map((s) => s.downside),
          name: "-20% Shock",
          marker: { color: "#e74c3c" }
        };

        const trace2 = {
          type: "bar",
          orientation: "h",
          y: sens.map((s) => s.label),
          x: sens.map((s) => s.upside),
          name: "+20% Shock",
          marker: { color: "#00c896" }
        };

        const layout = baseLayout("Sensitivity Tornado", {
          barmode: "overlay",
          xaxis: { tickprefix: "$", zeroline: true, zerolinecolor: "#6a7f96" },
          margin: { l: 190, r: 20, t: 24, b: 32 }
        }, "rows", sens.length);

        Plotly.react("sensitivityChart", [trace1, trace2], layout, PLOT_CONFIG);
      }

      function renderActions() {
        renderActionSummaryCards();
        renderRoleFilters();
        renderRoleTable();
        renderGantt();
      }

      function rolesByAction() {
        const out = {
          eliminate: { roles: 0, headcount: 0, value: 0 },
          augment: { roles: 0, headcount: 0, value: 0 },
          reskill: { roles: 0, headcount: 0, value: 0 },
          protect: { roles: 0, headcount: 0, value: 0 }
        };

        flattenRoles().forEach((r) => {
          const bucket = out[r.recommendedAction];
          if (!bucket) return;
          bucket.roles += 1;
          bucket.headcount += r.headcount;
          if (r.recommendedAction === "reskill") {
            bucket.value += roleInvestment(r).reskill;
          } else {
            bucket.value += roleAnnualSavings(r);
          }
        });

        return out;
      }

      function renderActionSummaryCards() {
        const stats = rolesByAction();
        const config = [
          { key: "eliminate", title: "ELIMINATE", note: "Roles replaceable by AI within 6-18 months" },
          { key: "augment", title: "AUGMENT", note: "AI-driven productivity gains with selective headcount compression" },
          { key: "reskill", title: "RESKILL", note: "Transition into higher-value AI-adjacent roles" },
          { key: "protect", title: "PROTECT", note: "AI-resistant roles to retain and invest in" }
        ];

        $("actionSummaryCards").innerHTML = config.map((c) => {
          const v = stats[c.key];
          const label = c.key === "reskill" ? "investment" : "savings";
          return `<div class="summary-card">
            <h4>${c.title}</h4>
            <strong>${v.roles} roles | ${numberFmt.format(v.headcount)} HC</strong>
            <div>${currencyFmt.format(v.value)} ${label}</div>
            <div class="hint">${c.note}</div>
          </div>`;
        }).join("");
      }

      function renderRoleFilters() {
        const depSelect = $("filterDepartment");
        const deps = ["all", ...Array.from(new Set(flattenRoles().map((r) => r.department))).sort()];
        depSelect.innerHTML = deps.map((d) => `<option value="${escapeHtml(d)}">${d === "all" ? "All Departments" : escapeHtml(d)}</option>`).join("");
        depSelect.value = STATE.ui.roleFilters.department;

        $("filterSearch").value = STATE.ui.roleFilters.search;
        $("filterAction").value = STATE.ui.roleFilters.action;
        $("filterPriority").value = STATE.ui.roleFilters.priority;
        $("filterRiskMin").value = STATE.ui.roleFilters.riskMin;
        $("filterRiskMax").value = STATE.ui.roleFilters.riskMax;
        $("filterSavingsMin").value = STATE.ui.roleFilters.savingsMin;
        $("filterImplMax").value = STATE.ui.roleFilters.implMax;
      }

      function applyRoleFilters() {
        const f = STATE.ui.roleFilters;
        return flattenRoles().filter((r) => {
          if (f.search && !`${r.title} ${r.function} ${r.department}`.toLowerCase().includes(f.search.toLowerCase())) return false;
          if (f.department !== "all" && r.department !== f.department) return false;
          if (f.action !== "all" && r.recommendedAction !== f.action) return false;
          if (f.priority !== "all" && r.priority !== f.priority) return false;
          if (f.riskMin !== "" && r.riskScore < Number(f.riskMin)) return false;
          if (f.riskMax !== "" && r.riskScore > Number(f.riskMax)) return false;
          if (f.implMax !== "" && r.implementationMonths > Number(f.implMax)) return false;
          if (f.savingsMin !== "" && roleAnnualSavings(r) < Number(f.savingsMin)) return false;
          return true;
        });
      }

      function renderRoleTable() {
        const rows = applyRoleFilters();
        const body = $("roleTableBody");

        body.innerHTML = rows.map((role) => {
          const rb = riskBand(role.riskScore);
          const selected = STATE.ui.selectedRoleIds.has(role.id);
          return `<tr data-role-id="${role.id}" class="role-row">
            <td><input type="checkbox" class="role-select" ${selected ? "checked" : ""} /></td>
            <td>${escapeHtml(role.title)}</td>
            <td>${escapeHtml(role.department)}</td>
            <td><input class="editable" data-field="headcount" type="number" min="1" value="${role.headcount}" /></td>
            <td><input class="editable" data-field="avgSalary" type="number" min="1" value="${role.avgSalary}" /></td>
            <td>${currencyFmt.format(loadedComp(role))}</td>
            <td><input class="editable" data-field="riskScore" type="number" min="0" max="100" value="${role.riskScore}" /> <span class="risk-pill ${rb.cls}">${rb.label}</span></td>
            <td>
              <select class="editable" data-field="recommendedAction">
                <option value="eliminate" ${role.recommendedAction === "eliminate" ? "selected" : ""}>Eliminate</option>
                <option value="augment" ${role.recommendedAction === "augment" ? "selected" : ""}>Augment</option>
                <option value="reskill" ${role.recommendedAction === "reskill" ? "selected" : ""}>Reskill</option>
                <option value="protect" ${role.recommendedAction === "protect" ? "selected" : ""}>Protect</option>
              </select>
            </td>
            <td><input class="editable" data-field="aiTools" type="text" value="${escapeHtml(role.aiTools.join(", "))}" /></td>
            <td>${currencyFmt.format(roleAnnualSavings(role))}</td>
            <td><input class="editable" data-field="implementationMonths" type="number" min="1" max="60" value="${role.implementationMonths}" /></td>
            <td>
              <select class="editable" data-field="priority">
                <option value="P1" ${role.priority === "P1" ? "selected" : ""}>P1</option>
                <option value="P2" ${role.priority === "P2" ? "selected" : ""}>P2</option>
                <option value="P3" ${role.priority === "P3" ? "selected" : ""}>P3</option>
              </select>
            </td>
            <td><button class="btn expand-role" type="button">Details</button></td>
          </tr>
          <tr class="detail-block hidden" data-detail-for="${role.id}">
            <td colspan="13">
              <div class="detail-grid">
                <div><strong>Task Decomposition</strong>${escapeHtml(role.taskDecomposition)}</div>
                <div><strong>Recommended Tools</strong>${escapeHtml(role.aiTools.join(", "))}</div>
                <div><strong>Change Management</strong>Manager enablement, KPI redesign, and phased runbook adoption required before headcount actions.</div>
                <div><strong>Legal / Regulatory</strong>${escapeHtml(role.legalConstraints)}</div>
                <div><strong>Reskilling Pathway</strong>${escapeHtml(role.reskillPathway)}</div>
                <div><strong>Risk Factors</strong>${escapeHtml(role.notes || "Operational concentration, knowledge transfer, and labor risk need active mitigation.")}</div>
              </div>
            </td>
          </tr>`;
        }).join("");

        body.querySelectorAll(".editable").forEach((input) => {
          input.addEventListener("change", (e) => {
            const tr = e.target.closest("tr[data-role-id]");
            if (!tr) return;
            const role = flattenRoles().find((r) => r.id === tr.dataset.roleId);
            if (!role) return;
            const field = e.target.dataset.field;
            recordHistory();
            if (field === "aiTools") {
              role.aiTools = e.target.value.split(",").map((v) => v.trim()).filter(Boolean);
            } else if (field === "recommendedAction") {
              role.recommendedAction = e.target.value;
              role.eliminationPercent = defaultEliminationPercent(role.riskScore, role.recommendedAction);
              role.productivityGainPercent = defaultProductivityGain(role.riskScore, role.recommendedAction);
            } else if (field === "priority") {
              role.priority = e.target.value;
            } else {
              role[field] = Number(e.target.value);
            }
            if (field === "riskScore") {
              role.riskScore = Math.max(0, Math.min(100, role.riskScore));
              role.recommendedAction = actionForRisk(role.riskScore);
              role.priority = priorityForRisk(role.riskScore);
            }
            markAllTabsDirty();
            fullRefresh();
          });
        });

        body.querySelectorAll(".expand-role").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            const tr = e.target.closest("tr[data-role-id]");
            const roleId = tr.dataset.roleId;
            const detailRow = body.querySelector(`tr[data-detail-for='${roleId}']`);
            detailRow.classList.toggle("hidden");
          });
        });

        body.querySelectorAll(".role-select").forEach((cb) => {
          cb.addEventListener("change", (e) => {
            const tr = e.target.closest("tr[data-role-id]");
            const roleId = tr.dataset.roleId;
            if (e.target.checked) STATE.ui.selectedRoleIds.add(roleId);
            else STATE.ui.selectedRoleIds.delete(roleId);
          });
        });

        body.querySelectorAll("tr.role-row").forEach((tr) => {
          tr.addEventListener("contextmenu", (e) => {
            e.preventDefault();
            showRoleContextMenu(e.clientX, e.clientY, tr.dataset.roleId);
          });
        });
      }

      function showRoleContextMenu(x, y, roleId) {
        STATE.ui.contextRoleId = roleId;
        const menu = $("roleContextMenu");
        menu.innerHTML = `
          <button data-action="eliminate">Set Action: Eliminate</button>
          <button data-action="augment">Set Action: Augment</button>
          <button data-action="reskill">Set Action: Reskill</button>
          <button data-action="protect">Set Action: Protect</button>
          <button data-action="p1">Set Priority: P1</button>
          <button data-action="p2">Set Priority: P2</button>
          <button data-action="p3">Set Priority: P3</button>
        `;
        menu.style.left = `${x}px`;
        menu.style.top = `${y}px`;
        menu.style.display = "block";

        menu.querySelectorAll("button").forEach((btn) => {
          btn.addEventListener("click", () => {
            applyContextAction(btn.dataset.action);
            menu.style.display = "none";
          });
        });
      }

      function applyContextAction(action) {
        const role = flattenRoles().find((r) => r.id === STATE.ui.contextRoleId);
        if (!role) return;
        recordHistory();
        if (["eliminate", "augment", "reskill", "protect"].includes(action)) {
          role.recommendedAction = action;
          role.eliminationPercent = defaultEliminationPercent(role.riskScore, action);
          role.productivityGainPercent = defaultProductivityGain(role.riskScore, action);
        } else if (["p1", "p2", "p3"].includes(action)) {
          role.priority = action.toUpperCase();
        }
        markAllTabsDirty();
        fullRefresh();
      }

      function bulkUpdateAction(action) {
        const ids = Array.from(STATE.ui.selectedRoleIds);
        if (!ids.length) {
          showToast("No roles selected");
          return;
        }
        recordHistory();
        flattenRoles().forEach((r) => {
          if (STATE.ui.selectedRoleIds.has(r.id)) {
            r.recommendedAction = action;
            r.eliminationPercent = defaultEliminationPercent(r.riskScore, action);
            r.productivityGainPercent = defaultProductivityGain(r.riskScore, action);
            r.priority = action === "eliminate" ? "P1" : r.priority;
          }
        });
        markAllTabsDirty();
        fullRefresh();
        showToast(`Updated ${ids.length} selected roles`);
      }

      function deleteSelectedRoles() {
        const ids = STATE.ui.selectedRoleIds;
        if (!ids.size) {
          showToast("No roles selected");
          return;
        }
        recordHistory();
        STATE.org.roles = flattenRoles().filter((r) => !ids.has(r.id));
        STATE.ui.selectedRoleIds = new Set();
        STATE.org.initiatives = buildInitiativesFromRoles(flattenRoles());
        markAllTabsDirty();
        fullRefresh();
        showToast("Selected roles removed");
      }

      function renderGantt() {
        const container = $("ganttContainer");
        const items = STATE.org.initiatives || [];
        const header = `<div class="gantt-header"><div>Initiative</div><div>Timeline (0-60 months)</div><div>Dependency</div></div>`;
        const rows = items.map((it) => {
          const left = (it.startMonth / 60) * 100;
          const width = (it.durationMonths / 60) * 100;
          return `<div class="gantt-row" data-init-id="${it.id}">
            <div>${escapeHtml(it.name)}<div class="gantt-dep">${escapeHtml(it.milestone)}</div></div>
            <div class="gantt-track">
              <div class="gantt-bar" draggable="false" style="left:${left}%;width:${width}%;" data-init-id="${it.id}">
                ${it.startMonth} - ${it.startMonth + it.durationMonths}m
              </div>
            </div>
            <div class="gantt-dep">${escapeHtml(it.dependency)}</div>
          </div>`;
        }).join("");

        container.innerHTML = header + rows;

        container.querySelectorAll(".gantt-bar").forEach((bar) => {
          bar.addEventListener("mousedown", (e) => {
            const initId = e.target.dataset.initId;
            const init = items.find((i) => i.id === initId);
            if (!init) return;
            const track = e.target.closest(".gantt-track");
            const rect = track.getBoundingClientRect();
            STATE.ui.ganttDrag = {
              initId,
              startX: e.clientX,
              rect,
              originalStart: init.startMonth,
              duration: init.durationMonths
            };
          });
        });
      }

      function onGanttMouseMove(e) {
        const drag = STATE.ui.ganttDrag;
        if (!drag) return;
        const dx = e.clientX - drag.startX;
        const monthDelta = Math.round((dx / drag.rect.width) * 60);
        const init = STATE.org.initiatives.find((i) => i.id === drag.initId);
        if (!init) return;
        init.startMonth = Math.max(0, Math.min(60 - init.durationMonths, drag.originalStart + monthDelta));
        markTabDirty("tab-actions");
        renderTabIfDirty("tab-actions");
      }

      function onGanttMouseUp() {
        if (STATE.ui.ganttDrag) {
          recordHistory();
          STATE.ui.ganttDrag = null;
          markAllTabsDirty();
          fullRefresh();
        }
      }

      function renderScenarios() {
        renderScenarioControls();
        renderScenarioMain();
        renderScenarioComparisons();
      }

      function renderScenarioControls() {
        const sel = $("scenarioSelect");
        if (!sel.dataset.initialized) {
          sel.innerHTML = Object.values(STATE.scenarios).map((s) => `<option value="${s.id}">${s.name}</option>`).join("");
          sel.dataset.initialized = "1";
        }
        sel.value = STATE.selectedScenarioId;

        const scenario = STATE.scenarios[STATE.selectedScenarioId];
        const fields = [
          { key: "thresholdRisk", label: "Target Risk Threshold", min: 0, max: 100, step: 1 },
          { key: "realizationRate", label: "Savings Realization", min: 0, max: 1, step: 0.01, pct: true },
          { key: "timelineMonths", label: "Timeline (Months)", min: 6, max: 60, step: 1 },
          { key: "workforceReductionTarget", label: "Workforce Reduction Target", min: 0, max: 80, step: 1, pct: true },
          { key: "investmentMultiplier", label: "Investment Multiplier", min: 0.1, max: 2, step: 0.05 }
        ];

        $("scenarioControls").innerHTML = fields.map((f) => {
          const value = scenario[f.key];
          const shown = f.pct ? `${percentFmt.format(value * (f.key === "realizationRate" ? 100 : 1))}%` : value.toFixed ? value.toFixed(2) : value;
          return `<div class="question-box">
            <label>${f.label}<span class="mono">${shown}</span></label>
            <input data-scenario-field="${f.key}" type="range" min="${f.min}" max="${f.max}" step="${f.step}" value="${value}" />
          </div>`;
        }).join("");

        $("scenarioControls").querySelectorAll("input[data-scenario-field]").forEach((input) => {
          input.addEventListener("input", (e) => {
            const key = e.target.dataset.scenarioField;
            STATE.scenarios[STATE.selectedScenarioId][key] = Number(e.target.value);
            if (key === "timelineMonths") {
              STATE.scenarios[STATE.selectedScenarioId][key] = Math.round(Number(e.target.value));
            }
            markTabDirty("tab-scenarios");
            markTabDirty("tab-board");
            calcCore();
            renderScenarios();
          });
          input.addEventListener("change", () => recordHistory());
        });
      }

      function renderScenarioMain() {
        const sc = STATE.calc.scenarios[STATE.selectedScenarioId];

        const cards = [
          { label: "Headcount (Current -> Target)", value: `${numberFmt.format(sc.baselineHeadcount)} -> ${numberFmt.format(Math.round(sc.headcount[sc.headcount.length - 1]))}` },
          { label: "NPV (5Y)", value: currencyFmt.format(sc.npv) },
          { label: "Break-even", value: sc.breakEvenQuarter ? `${sc.breakEvenQuarter} quarters` : "Beyond horizon" },
          { label: "Year 1 Net", value: currencyFmt.format(sc.yearlyNet[0]) },
          { label: "Year 5 Net", value: currencyFmt.format(sc.yearlyNet[2]) }
        ];

        $("scenarioMetricCards").innerHTML = cards.map((c) => `<div class="scenario-card">${c.label}<strong>${c.value}</strong></div>`).join("");

        const trace = [
          { x: sc.labels, y: sc.headcount, name: "Headcount", mode: "lines", yaxis: "y2", line: { color: "#9fc8ff", width: 2 } },
          { x: sc.labels, y: sc.cumulativeInvest, name: "Cumulative Investment", mode: "lines", line: { color: "#f5a623", width: 3 } },
          { x: sc.labels, y: sc.cumulativeSavings, name: "Cumulative Savings", mode: "lines", line: { color: "#00c896", width: 3 } },
          { x: sc.labels, y: sc.cumulativeNet, name: "Net Impact", mode: "lines", line: { color: "#27a7ff", width: 3 } }
        ];

        const layout = baseLayout(sc.name, {
          yaxis: { tickprefix: "$" },
          yaxis2: { overlaying: "y", side: "right", showgrid: false, title: "Headcount", tickfont: { color: "#9fc8ff" } },
          margin: { l: 44, r: 48, t: 26, b: 56 }
        }, "default");

        Plotly.react("scenarioTrajectoryChart", trace, layout, PLOT_CONFIG);
      }

      function renderScenarioComparisons() {
        const options = Object.values(STATE.scenarios).map((s) => `<option value="${s.id}">${s.name}</option>`).join("");
        ["compareA", "compareB", "compareC"].forEach((id, idx) => {
          const el = $(id);
          if (!el.dataset.initialized) {
            el.innerHTML = `<option value="">None</option>${options}`;
            el.dataset.initialized = "1";
          }
          if (!el.value) {
            el.value = idx === 0 ? "conservative" : idx === 1 ? "balanced" : "aggressive";
          }
        });

        const selectedIds = [$("compareA").value, $("compareB").value, $("compareC").value].filter(Boolean);
        const selected = selectedIds.map((id) => STATE.calc.scenarios[id]);

        const bars = [
          {
            x: selected.map((s) => s.name),
            y: selected.map((s) => s.yearlyNet[0]),
            name: "Year 1",
            type: "bar"
          },
          {
            x: selected.map((s) => s.name),
            y: selected.map((s) => s.yearlyNet[1]),
            name: "Year 3",
            type: "bar"
          },
          {
            x: selected.map((s) => s.name),
            y: selected.map((s) => s.yearlyNet[2]),
            name: "Year 5",
            type: "bar"
          }
        ];

        Plotly.react("scenarioComparisonBars", bars, baseLayout("Scenario Net Savings Comparison", { barmode: "group", yaxis: { tickprefix: "$" } }, "small"), PLOT_CONFIG);

        const tbody = $("scenarioDecisionTable");
        tbody.innerHTML = selected.map((s) => `<tr>
          <td>${escapeHtml(s.name)}</td>
          <td>${currencyFmt.format(s.yearlyNet[0])}</td>
          <td>${currencyFmt.format(s.yearlyNet[1])}</td>
          <td>${currencyFmt.format(s.yearlyNet[2])}</td>
          <td>${s.riskProfile.execution}/10</td>
          <td>${s.riskProfile.regulatory}/10</td>
        </tr>`).join("");

        renderScenarioRadar(selected[0] || STATE.calc.scenarios[STATE.selectedScenarioId]);
        renderMonteCarlo();
      }

      function renderScenarioRadar(sc) {
        const categories = ["Execution", "Legal", "Culture", "Competitive", "Regulatory"];
        const trace = {
          type: "scatterpolar",
          r: [
            sc.riskProfile.execution,
            sc.riskProfile.legal,
            sc.riskProfile.culture,
            sc.riskProfile.competitive,
            sc.riskProfile.regulatory
          ],
          theta: categories,
          fill: "toself",
          name: sc.name,
          line: { color: "#27a7ff" }
        };

        const layout = {
          paper_bgcolor: "rgba(0,0,0,0)",
          plot_bgcolor: "rgba(0,0,0,0)",
          margin: { l: 24, r: 24, t: 20, b: 20 },
          height: chartHeightPreset("small"),
          autosize: true,
          font: { color: "#d9e7f5", family: "DM Sans" },
          polar: {
            radialaxis: {
              visible: true,
              range: [0, 10],
              gridcolor: "#3b4f66"
            },
            angularaxis: {
              gridcolor: "#3b4f66"
            },
            bgcolor: "rgba(0,0,0,0)"
          }
        };

        Plotly.react("scenarioRiskRadar", [trace], layout, PLOT_CONFIG);
      }

      function renderMonteCarlo() {
        const mc = monteCarloForScenario(STATE.selectedScenarioId);
        const trace = {
          type: "histogram",
          x: mc.outcomes,
          marker: { color: "rgba(39, 167, 255, 0.7)" },
          nbinsx: 40
        };

        Plotly.react("monteCarloChart", [trace], baseLayout("Net Savings Distribution", { xaxis: { tickprefix: "$" } }, "small"), PLOT_CONFIG);
        $("monteCarloSummary").textContent = `P10: ${currencyFmt.format(mc.p10)} | P50: ${currencyFmt.format(mc.p50)} | P90: ${currencyFmt.format(mc.p90)}. There is a 90% probability net impact is between ${currencyFmt.format(mc.p10)} and ${currencyFmt.format(mc.p90)}.`;
      }

      function renderReadiness() {
        renderReadinessQuestions();
        renderReadinessCharts();
        renderReadinessRoadmap();
      }

      function renderReadinessQuestions() {
        const wrap = $("readinessQuestions");
        wrap.innerHTML = READINESS_DIMENSIONS.map((dim) => {
          const questions = dim.questions.map((q, idx) => {
            const value = STATE.readinessAnswers[dim.id]?.[idx] || 3;
            return `<div class="question-box">
              <label>${escapeHtml(q)} <span class="mono">${value}/5</span></label>
              <input data-dim="${dim.id}" data-idx="${idx}" type="range" min="1" max="5" step="1" value="${value}" />
            </div>`;
          }).join("");
          return `<div class="panel" style="margin-bottom:10px; padding:10px;">
            <h3>${dim.label}</h3>
            <div class="question-grid" style="margin-top:8px;">${questions}</div>
          </div>`;
        }).join("");

        wrap.querySelectorAll("input[data-dim]").forEach((input) => {
          input.addEventListener("input", (e) => {
            const dim = e.target.dataset.dim;
            const idx = Number(e.target.dataset.idx);
            STATE.readinessAnswers[dim][idx] = Number(e.target.value);
            markTabDirty("tab-readiness");
            markTabDirty("tab-board");
            renderReadiness();
            renderGlobalStats();
          });
          input.addEventListener("change", () => recordHistory());
        });
      }

      function renderReadinessCharts() {
        const score = readinessScores();
        const band = readinessBand(score.overall);
        const selectedScenario = STATE.scenarios[STATE.selectedScenarioId];
        const minReq = {
          data: selectedScenario.id === "mercury" ? 80 : selectedScenario.id === "aggressive" ? 70 : 60,
          talent: selectedScenario.id === "mercury" ? 82 : selectedScenario.id === "aggressive" ? 72 : 62,
          operations: selectedScenario.id === "mercury" ? 80 : selectedScenario.id === "aggressive" ? 70 : 60,
          strategy: selectedScenario.id === "mercury" ? 84 : selectedScenario.id === "aggressive" ? 74 : 64
        };

        const traceA = {
          type: "scatterpolar",
          r: [score.dimensions.data, score.dimensions.talent, score.dimensions.operations, score.dimensions.strategy],
          theta: ["Data", "Talent", "Operations", "Strategy"],
          fill: "toself",
          name: "Current"
        };

        const traceB = {
          type: "scatterpolar",
          r: [minReq.data, minReq.talent, minReq.operations, minReq.strategy],
          theta: ["Data", "Talent", "Operations", "Strategy"],
          fill: "toself",
          opacity: 0.35,
          name: "Minimum Required"
        };

        const layout = {
          paper_bgcolor: "rgba(0,0,0,0)",
          plot_bgcolor: "rgba(0,0,0,0)",
          margin: { l: 24, r: 24, t: 20, b: 20 },
          height: chartHeightPreset("small"),
          autosize: true,
          font: { color: "#d9e7f5", family: "DM Sans" },
          polar: { radialaxis: { visible: true, range: [0, 100], gridcolor: "#3b4f66" }, bgcolor: "rgba(0,0,0,0)" }
        };

        Plotly.react("readinessRadar", [traceA, traceB], layout, PLOT_CONFIG);

        $("readinessBadge").className = `score-badge ${band.cls}`;
        $("readinessBadge").textContent = `Readiness Score: ${percentFmt.format(score.overall)} | ${band.label}`;

        const recLines = [];
        READINESS_DIMENSIONS.forEach((dim) => {
          const current = score.dimensions[dim.id];
          const target = minReq[dim.id];
          if (current < target) {
            recLines.push(`- ${dim.label}: Close ${percentFmt.format(target - current)} points. Prioritize governance controls, data quality, and leadership capability before ${STATE.scenarios[STATE.selectedScenarioId].name} rollout.`);
          } else {
            recLines.push(`- ${dim.label}: At or above minimum threshold for ${STATE.scenarios[STATE.selectedScenarioId].name}.`);
          }
        });
        recLines.push(`- Overall Recommendation: ${band.recommendation}`);
        $("readinessRecommendations").textContent = recLines.join("\n");
      }

      function renderReadinessRoadmap() {
        const score = readinessScores();
        const selectedScenario = STATE.scenarios[STATE.selectedScenarioId];
        const targetScore = selectedScenario.id === "mercury" ? 82 : selectedScenario.id === "aggressive" ? 72 : selectedScenario.id === "balanced" ? 65 : 58;

        const body = $("readinessRoadmapBody");
        body.innerHTML = READINESS_DIMENSIONS.map((dim) => {
          const current = score.dimensions[dim.id];
          const gap = Math.max(0, targetScore - current);
          const months = gap > 18 ? "12-18 months" : gap > 8 ? "6-12 months" : "0-6 months";
          const investment = gap * 180000;
          const actions = gap > 12
            ? "Launch enterprise readiness program; establish AI governance council; standardize data foundations"
            : gap > 4
              ? "Targeted capability uplift, role-based training, and process instrumentation"
              : "Sustain and monitor with quarterly scorecards";

          return `<tr>
            <td>${dim.label}</td>
            <td>${percentFmt.format(current)}</td>
            <td>${targetScore}</td>
            <td>${actions}</td>
            <td>${months}</td>
            <td>${currencyFmt.format(investment)}</td>
          </tr>`;
        }).join("");
      }

      function renderCompetitive() {
        renderCompetitiveQualitySummary();
        renderCompetitiveTable();
        renderPositioningChart();
        renderBenchmarkControls();
      }

      function confidenceClass(level) {
        const val = (level || "").toLowerCase();
        if (val === "high") return "high";
        if (val === "medium") return "medium";
        return "low";
      }

      function daysSince(dateStr) {
        const parsed = new Date(dateStr);
        if (Number.isNaN(parsed.getTime())) return Number.POSITIVE_INFINITY;
        const now = new Date();
        return Math.max(0, Math.floor((now.getTime() - parsed.getTime()) / (1000 * 60 * 60 * 24)));
      }

      function renderCompetitiveQualitySummary() {
        const staleThresholdDays = 365;
        const staleCount = COMPETITIVE_DATA.filter((row) => daysSince(row.asOf) > staleThresholdDays).length;
        const highConfidenceCount = COMPETITIVE_DATA.filter((row) => (row.confidence || "").toLowerCase() === "high").length;
        const lowConfidenceCount = COMPETITIVE_DATA.filter((row) => (row.confidence || "").toLowerCase() === "low").length;
        const newest = [...COMPETITIVE_DATA]
          .filter((row) => row.asOf)
          .sort((a, b) => new Date(b.asOf) - new Date(a.asOf))[0];

        $("competitiveQualitySummary").innerHTML = `
          <div class="quality-card">
            <div>Records</div>
            <strong>${COMPETITIVE_DATA.length}</strong>
            <div class="hint">Peer entries tracked</div>
          </div>
          <div class="quality-card">
            <div>Stale (>12 months)</div>
            <strong>${staleCount}</strong>
            <div class="hint">Refresh these first</div>
          </div>
          <div class="quality-card">
            <div>High Confidence</div>
            <strong>${highConfidenceCount}</strong>
            <div class="hint">Primary sources / filings</div>
          </div>
          <div class="quality-card">
            <div>Latest Source Date</div>
            <strong>${newest ? newest.asOf : "n/a"}</strong>
            <div class="hint">${newest ? newest.company : "No source date provided"} | Low confidence: ${lowConfidenceCount}</div>
          </div>
        `;
        $("modelReferenceSummary").innerHTML = `Risk model references: ${MODEL_REFERENCE_SET.map((ref) => `<a href="${escapeHtml(ref.url)}" target="_blank" rel="noopener noreferrer">${escapeHtml(ref.title)} (${ref.asOf})</a>`).join(" | ")}`;
      }

      function renderCompetitiveTable() {
        $("competitiveTableBody").innerHTML = COMPETITIVE_DATA.map((row) => `<tr>
          <td>${escapeHtml(row.company)}</td>
          <td>${escapeHtml(row.industry)}</td>
          <td>${escapeHtml(row.aiInvestment)}</td>
          <td>${escapeHtml(row.reduction)}</td>
          <td>${escapeHtml(row.initiatives)}</td>
          <td>${escapeHtml(row.timeline)}</td>
          <td>${escapeHtml(row.asOf || "n/a")}</td>
          <td><span class="quality-badge ${confidenceClass(row.confidence)}">${escapeHtml(row.confidence || "Low")}</span></td>
          <td><a href="${escapeHtml(row.sourceUrl || "#")}" target="_blank" rel="noopener noreferrer">${escapeHtml(row.source)}</a></td>
        </tr>`).join("");
      }

      function renderPositioningChart() {
        const peerTrace = {
          x: COMPETITIVE_DATA.map((c) => c.investLevel),
          y: COMPETITIVE_DATA.map((c) => c.aggressiveness),
          text: COMPETITIVE_DATA.map((c) => c.company),
          mode: "markers+text",
          type: "scatter",
          textposition: "top center",
          marker: {
            size: 10,
            color: "rgba(153, 196, 245, 0.65)",
            line: { color: "#9bc3ed", width: 1 }
          },
          name: "Peers"
        };

        const selectedScenario = STATE.scenarios[STATE.selectedScenarioId];
        const yourInvest = Math.min(10, 3 + selectedScenario.investmentMultiplier * 4);
        const yourAgg = Math.min(10, 2 + selectedScenario.workforceReductionTarget / 8);

        const yourTrace = {
          x: [yourInvest],
          y: [yourAgg],
          text: [STATE.org.name],
          mode: "markers+text",
          type: "scatter",
          textposition: "bottom center",
          marker: {
            size: 14,
            color: "#00c896",
            line: { color: "#a4f5dd", width: 2 }
          },
          name: "Your Plan"
        };

        const layout = baseLayout("AI Investment vs Workforce Aggressiveness", {
          xaxis: { title: "AI Investment Level", range: [0, 10], gridcolor: "#34455d" },
          yaxis: { title: "Transformation Aggressiveness", range: [0, 10], gridcolor: "#34455d" },
          shapes: [
            { type: "line", x0: 5, x1: 5, y0: 0, y1: 10, line: { color: "#456283", dash: "dot" } },
            { type: "line", x0: 0, x1: 10, y0: 5, y1: 5, line: { color: "#456283", dash: "dot" } }
          ],
          annotations: [
            { x: 7.8, y: 8.8, text: "Leading", showarrow: false, font: { color: "#9dd4ff", size: 11 } },
            { x: 2.2, y: 8.8, text: "Fast Follower", showarrow: false, font: { color: "#9dd4ff", size: 11 } },
            { x: 7.8, y: 1.2, text: "Cautious", showarrow: false, font: { color: "#9dd4ff", size: 11 } },
            { x: 2.2, y: 1.2, text: "At Risk", showarrow: false, font: { color: "#ffb0a6", size: 11 } }
          ]
        });

        Plotly.react("positioningChart", [peerTrace, yourTrace], layout, PLOT_CONFIG);
      }

      function percentileRank(value, arr) {
        const sorted = [...arr].sort((a, b) => a - b);
        let below = 0;
        sorted.forEach((v) => {
          if (value >= v) below += 1;
        });
        return (below / sorted.length) * 100;
      }

      function renderBenchmarkControls() {
        const config = [
          { key: "aiSpendPctRevenue", label: "AI Spend as % of Revenue", min: 0, max: 10, step: 0.1, suffix: "%" },
          { key: "augmentedRolePct", label: "% Workforce AI-Augmented", min: 0, max: 100, step: 1, suffix: "%" },
          { key: "annualReductionPct", label: "Headcount Reduction Rate", min: 0, max: 30, step: 0.5, suffix: "%" },
          { key: "productivityGainPct", label: "AI Productivity Gain", min: 0, max: 80, step: 1, suffix: "%" }
        ];

        $("benchmarkControls").innerHTML = config.map((c) => {
          const value = STATE.ui.benchmarkInputs[c.key];
          return `<div class="benchmark">
            <label>${c.label}</label>
            <strong>${value}${c.suffix}</strong>
            <input data-bench="${c.key}" type="range" min="${c.min}" max="${c.max}" step="${c.step}" value="${value}" />
          </div>`;
        }).join("");

        const results = config.map((c) => {
          const value = STATE.ui.benchmarkInputs[c.key];
          const pct = percentileRank(value, BENCHMARK_DISTRIBUTIONS[c.key]);
          return `<div class="benchmark"><label>${c.label} Percentile</label><strong>${percentFmt.format(pct)}th</strong></div>`;
        });
        $("benchmarkResults").innerHTML = results.join("");

        $("benchmarkControls").querySelectorAll("input[data-bench]").forEach((input) => {
          input.addEventListener("input", (e) => {
            const key = e.target.dataset.bench;
            STATE.ui.benchmarkInputs[key] = Number(e.target.value);
            markTabDirty("tab-competitive");
            renderCompetitive();
          });
          input.addEventListener("change", () => recordHistory());
        });
      }

      function renderBoard() {
        generateBoardSummary(false);
        renderTalkingPoints();
      }

      function topRisksForBoard() {
        const scenario = STATE.calc.scenarios[STATE.selectedScenarioId];
        const risks = [
          { name: "Execution risk", score: scenario.riskProfile.execution, mitigation: "Stage-gate rollout with measurable pilot exit criteria." },
          { name: "Legal/regulatory risk", score: scenario.riskProfile.legal, mitigation: "Pre-clearance by legal/compliance and explicit human oversight controls." },
          { name: "Culture and talent risk", score: scenario.riskProfile.culture, mitigation: "Transparent comms + funded reskilling pathways and retention plans." },
          { name: "Regulatory scrutiny risk", score: scenario.riskProfile.regulatory, mitigation: "Audit trail, explainability controls, and policy governance." },
          { name: "Knowledge drain risk", score: Math.min(10, Math.round((scenario.workforceReductionTarget / 8) + 2)), mitigation: "Critical process documentation and shadow-transition periods." }
        ];
        risks.sort((a, b) => b.score - a.score);
        return risks.slice(0, 5);
      }

      function generateBoardSummary(showToastAfter = true) {
        const c = STATE.calc;
        const scenario = STATE.calc.scenarios[STATE.selectedScenarioId];
        const readiness = readinessScores();
        const readinessBandInfo = readinessBand(readiness.overall);
        const topDeps = [...c.departments].sort((a, b) => b.savings - a.savings).slice(0, 3);
        const topRisks = topRisksForBoard();
        const staleCount = COMPETITIVE_DATA.filter((row) => daysSince(row.asOf) > 365).length;
        const lowConfidenceCount = COMPETITIVE_DATA.filter((row) => (row.confidence || "").toLowerCase() === "low").length;

        const text = [
          "EXECUTIVE AI WORKFORCE TRANSFORMATION BRIEF",
          `Organization: ${STATE.org.name}`,
          `Industry: ${STATE.org.industry}`,
          `Scenario: ${scenario.name}`,
          "",
          "1) SITUATION",
          `- Current workforce: ${numberFmt.format(c.totals.headcount)} employees across ${new Set(flattenRoles().map((r) => r.department)).size} departments and ${flattenRoles().length} tracked roles.`,
          `- Loaded compensation cost base: ${currencyFmt.format(c.totals.comp)} annually.`,
          `- Critical displacement exposure (risk 76-100): ${numberFmt.format(c.totals.criticalHeadcount)} employees (${percentFmt.format((c.totals.criticalHeadcount / Math.max(1, c.totals.headcount)) * 100)}%).`,
          "",
          "2) OPPORTUNITY",
          `- Addressable annual savings: ${currencyFmt.format(c.totals.addressable)}.`,
          `- Estimated annual net savings (post major recurring costs): ${currencyFmt.format(c.totals.savings.annualNet)}.`,
          `- Top opportunity departments: ${topDeps.map((d) => `${d.department} (${currencyFmt.format(d.savings)})`).join("; ")}.`,
          "",
          "3) RECOMMENDATION",
          `- Adopt ${scenario.name} with risk threshold ${scenario.thresholdRisk} and timeline ${scenario.timelineMonths} months.`,
          `- Workforce trajectory: ${numberFmt.format(scenario.baselineHeadcount)} -> ${numberFmt.format(Math.round(scenario.headcount[scenario.headcount.length - 1]))} by Year 5 endpoint.`,
          `- Break-even: ${scenario.breakEvenQuarter ? `~${scenario.breakEvenQuarter} quarters` : "beyond 5-year horizon under current assumptions"}.`,
          "",
          "4) FINANCIAL IMPACT",
          `- Year 1 net impact: ${currencyFmt.format(scenario.yearlyNet[0])}.`,
          `- Year 3 net impact: ${currencyFmt.format(scenario.yearlyNet[1])}.`,
          `- Year 5 net impact: ${currencyFmt.format(scenario.yearlyNet[2])}.`,
          `- Transformation NPV (5-year): ${currencyFmt.format(scenario.npv)} at ${STATE.assumptions.discountRate}% discount rate.`,
          "",
          "5) RISKS AND MITIGATIONS",
          ...topRisks.map((r, idx) => `- ${idx + 1}. ${r.name} (${r.score}/10): ${r.mitigation}`),
          "",
          "6) READINESS",
          `- Readiness score: ${percentFmt.format(readiness.overall)} (${readinessBandInfo.label}).`,
          `- Recommendation: ${readinessBandInfo.recommendation}`,
          "",
          "7) DATA QUALITY AND ASSURANCE",
          `- Competitive dataset coverage: ${COMPETITIVE_DATA.length} companies.`,
          `- Stale records (>12 months): ${staleCount}; low-confidence records: ${lowConfidenceCount}.`,
          "- Before board sign-off, refresh stale/low-confidence entries and archive source PDFs in deal room.",
          "",
          "8) NEXT 90 DAYS",
          "- Stand up AI transformation PMO and governance council with CHRO/CFO/CTO sponsorship.",
          "- Launch 2-3 P1 pilots in highest-savings functions with explicit value tracking.",
          "- Execute legal and labor impact review including WARN thresholds and jurisdictional obligations.",
          "- Finalize capability plan for reskilling and critical knowledge retention.",
          "- Prepare board checkpoint package with quarterly risk and value scorecard."
        ].join("\n");

        $("boardSummaryOutput").textContent = text;
        if (showToastAfter) showToast("Executive summary generated");
      }

      function renderTalkingPoints() {
        const c = STATE.calc;
        const scenario = STATE.calc.scenarios[STATE.selectedScenarioId];
        const cards = [
          {
            title: "Situation",
            bullets: [
              `Current cost base is ${currencyFmt.format(c.totals.comp)} with ${numberFmt.format(c.totals.criticalHeadcount)} critical-risk headcount.`,
              `Workforce risk concentration is highest in ${[...c.departments].sort((a, b) => b.avgRisk - a.avgRisk).slice(0, 2).map((d) => d.department).join(" and ")}.`,
              "Competitive pressure indicates a widening cost gap if transformation is deferred."
            ]
          },
          {
            title: "Recommendation",
            bullets: [
              `Execute ${scenario.name} with a ${scenario.timelineMonths}-month phased plan.`,
              "Prioritize P1 workflows where automation is already proven in peer deployments.",
              "Link every phase gate to realized economics and control maturity evidence."
            ]
          },
          {
            title: "Anticipated Board Questions",
            bullets: [
              "Q: What if savings underperform? A: Governance-linked stage gates and kill-switch thresholds limit downside exposure.",
              "Q: Are we exposing ourselves to legal risk? A: Human oversight, WARN screening, and regulator-ready audit trails are embedded.",
              "Q: How do we protect institutional knowledge? A: Retention plans, codified process transfer, and phased exits are included."
            ]
          },
          {
            title: "Peer Comparison",
            bullets: [
              "Top quartile peers are combining AI capex and targeted workforce redesign, not one without the other.",
              "Your current plan position is visualized on the investment-vs-aggressiveness matrix for board calibration.",
              "Benchmark percentile sliders provide direct peer context for spend, productivity, and transformation velocity."
            ]
          }
        ];

        $("talkingPointsGrid").innerHTML = cards.map((card) => `<div class="talk-card"><h4>${card.title}</h4>${card.bullets.map((b) => `<div>- ${escapeHtml(b)}</div>`).join("")}</div>`).join("");
      }

      function copyBoardSummary() {
        const text = $("boardSummaryOutput").textContent;
        navigator.clipboard.writeText(text).then(() => {
          showToast("Board summary copied");
        }).catch(() => {
          showToast("Clipboard access blocked");
        });
      }

      async function exportCurrentTabPng() {
        const tab = document.querySelector(`.tab.active`);
        const canvas = await html2canvas(tab, { scale: 2, backgroundColor: "#0a1628" });
        const link = document.createElement("a");
        link.href = canvas.toDataURL("image/png");
        link.download = `${STATE.selectedTab}_${new Date().toISOString().slice(0, 10)}.png`;
        link.click();
        $("exportStatus").textContent = "PNG export completed.";
      }

      async function exportCurrentTabPdf() {
        const tab = document.querySelector(`.tab.active`);
        const canvas = await html2canvas(tab, { scale: 2, backgroundColor: "#0a1628" });
        const imgData = canvas.toDataURL("image/png");
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF("p", "pt", "a4");
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();
        const ratio = Math.min(pageWidth / canvas.width, pageHeight / canvas.height);
        const w = canvas.width * ratio;
        const h = canvas.height * ratio;
        pdf.addImage(imgData, "PNG", 20, 20, w - 40, h - 40);
        pdf.save(`${STATE.selectedTab}_${new Date().toISOString().slice(0, 10)}.pdf`);
        $("exportStatus").textContent = "PDF export completed.";
      }

      function exportRolesCsv() {
        const rows = flattenRoles().map((r) => ({
          roleTitle: r.title,
          department: r.department,
          function: r.function,
          headcount: r.headcount,
          avgSalary: r.avgSalary,
          totalCostLoaded: Math.round(loadedComp(r)),
          riskScore: r.riskScore,
          recommendedAction: r.recommendedAction,
          annualSavings: Math.round(roleAnnualSavings(r)),
          implementationMonths: r.implementationMonths,
          priority: r.priority
        }));

        const csv = Papa.unparse(rows);
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `role_plan_${new Date().toISOString().slice(0, 10)}.csv`;
        link.click();
        URL.revokeObjectURL(link.href);
        $("exportStatus").textContent = "CSV export completed.";
      }

      function exportExcelWorkbook() {
        const wb = XLSX.utils.book_new();

        const rolesSheet = XLSX.utils.json_to_sheet(flattenRoles().map((r) => ({
          Role: r.title,
          Department: r.department,
          Function: r.function,
          Headcount: r.headcount,
          AvgSalary: r.avgSalary,
          RiskScore: r.riskScore,
          Action: r.recommendedAction,
          AnnualSavings: Math.round(roleAnnualSavings(r)),
          ImplementationMonths: r.implementationMonths,
          Priority: r.priority
        })));

        const deptSheet = XLSX.utils.json_to_sheet(STATE.calc.departments.map((d) => ({
          Department: d.department,
          Headcount: d.headcount,
          Savings: Math.round(d.savings),
          Investment: Math.round(d.investment),
          ROI: d.roiRatio,
          BreakEvenMonths: d.speed,
          Complexity: d.complexity
        })));

        const scenarioSheet = XLSX.utils.json_to_sheet(Object.values(STATE.calc.scenarios).map((s) => ({
          Scenario: s.name,
          Year1Net: Math.round(s.yearlyNet[0]),
          Year3Net: Math.round(s.yearlyNet[1]),
          Year5Net: Math.round(s.yearlyNet[2]),
          NPV: Math.round(s.npv),
          BreakEvenQuarter: s.breakEvenQuarter
        })));

        XLSX.utils.book_append_sheet(wb, rolesSheet, "Roles");
        XLSX.utils.book_append_sheet(wb, deptSheet, "Department ROI");
        XLSX.utils.book_append_sheet(wb, scenarioSheet, "Scenarios");
        XLSX.writeFile(wb, `ai_workforce_dashboard_${new Date().toISOString().slice(0, 10)}.xlsx`);
        $("exportStatus").textContent = "Excel workbook export completed.";
      }

      function escapeHtml(text) {
        return String(text ?? "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/\"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      const PLOT_CONFIG = { displayModeBar: false, responsive: true, scrollZoom: false };

      function chartHeightPreset(size = "default", rowCount = 0) {
        const vh = Math.max(740, window.innerHeight || 900);
        if (size === "small") {
          return Math.round(Math.max(260, Math.min(380, vh * 0.34)));
        }
        if (size === "tall") {
          return Math.round(Math.max(360, Math.min(620, vh * 0.56)));
        }
        if (size === "rows") {
          return Math.round(Math.max(320, Math.min(680, 180 + rowCount * 24)));
        }
        return Math.round(Math.max(300, Math.min(480, vh * 0.42)));
      }

      function baseLayout(title, overrides = {}, size = "default", rowCount = 0) {
        return {
          title: { text: title, font: { color: "#dceafb", size: 13 } },
          paper_bgcolor: "rgba(0,0,0,0)",
          plot_bgcolor: "rgba(0,0,0,0)",
          margin: { l: 40, r: 18, t: 28, b: 38 },
          height: chartHeightPreset(size, rowCount),
          autosize: true,
          font: { color: "#dceafb", family: "DM Sans", size: 11 },
          xaxis: { gridcolor: "#34455d", zerolinecolor: "#34455d" },
          yaxis: { gridcolor: "#34455d", zerolinecolor: "#34455d" },
          legend: { orientation: "h", y: -0.2, font: { size: 10 } },
          ...overrides
        };
      }

      function safePlotResize(id) {
        try {
          const el = $(id);
          if (el && window.Plotly) Plotly.Plots.resize(el);
        } catch {
          // Keep dashboard usable even if one chart resize fails.
        }
      }

      function resizePlotsForActiveTab() {
        const map = {
          "tab-warboard": ["orgTreemap"],
          "tab-financial": ["waterfallChart", "roiTimelineChart", "deptRoiChart", "sensitivityChart"],
          "tab-scenarios": ["scenarioTrajectoryChart", "scenarioComparisonBars", "scenarioRiskRadar", "monteCarloChart"],
          "tab-readiness": ["readinessRadar"],
          "tab-competitive": ["positioningChart"]
        };
        const ids = map[STATE.selectedTab] || [];
        ids.forEach((id) => safePlotResize(id));
      }

      function bindEvents() {
        $("collapseSidebar").addEventListener("click", () => {
          STATE.ui.collapsedSidebar = !STATE.ui.collapsedSidebar;
          $("sidebar").classList.toggle("collapsed", STATE.ui.collapsedSidebar);
          $("appShell").classList.toggle("sidebar-collapsed", STATE.ui.collapsedSidebar);
        });

        document.querySelectorAll(".nav-btn").forEach((btn) => {
          btn.addEventListener("click", () => tabSwitch(btn.dataset.tab));
        });

        $("saveConfigBtn").addEventListener("click", storageSave);
        $("loadConfigBtn").addEventListener("click", storageLoad);
        $("resetConfigBtn").addEventListener("click", resetToTemplate);
        $("exportStateBtn").addEventListener("click", exportScenarioJson);

        $("applyTemplateBtn").addEventListener("click", () => applyTemplate($("templateSelect").value));
        $("organizationNameInput").addEventListener("change", (e) => {
          recordHistory();
          STATE.org.name = e.target.value || STATE.org.name;
          markAllTabsDirty();
          fullRefresh();
        });
        $("revenueInput").addEventListener("change", (e) => {
          recordHistory();
          STATE.org.totalRevenue = Number(e.target.value || STATE.org.totalRevenue);
          markAllTabsDirty();
          fullRefresh();
        });
        $("applyTargetHeadcountBtn").addEventListener("click", () => {
          const target = Number($("targetHeadcountInput").value);
          if (!Number.isFinite(target) || target < 500 || target > 250000) {
            showToast("Enter a valid target between 500 and 250,000");
            return;
          }
          normalizeHeadcountToTarget(Math.round(target));
        });
        $("targetHeadcountInput").addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            $("applyTargetHeadcountBtn").click();
          }
        });

        $("importCsvBtn").addEventListener("click", importCsv);
        $("addFunctionBtn").addEventListener("click", addFunctionGroup);
        $("normalizeHeadcountBtn").addEventListener("click", () => {
          const target = Number(prompt("Enter target total headcount", flattenRoles().reduce((s, r) => s + r.headcount, 0)));
          if (!Number.isFinite(target) || target < 500 || target > 250000) {
            showToast("Target headcount must be between 500 and 250,000");
            return;
          }
          normalizeHeadcountToTarget(Math.round(target));
        });

        $("deptSortSelect").addEventListener("change", (e) => {
          STATE.ui.departmentSort = e.target.value;
          markTabDirty("tab-financial");
          renderTabIfDirty("tab-financial");
        });

        ["filterSearch", "filterDepartment", "filterAction", "filterPriority", "filterRiskMin", "filterRiskMax", "filterSavingsMin", "filterImplMax"].forEach((id) => {
          $(id).addEventListener("input", (e) => {
            const keyMap = {
              filterSearch: "search",
              filterDepartment: "department",
              filterAction: "action",
              filterPriority: "priority",
              filterRiskMin: "riskMin",
              filterRiskMax: "riskMax",
              filterSavingsMin: "savingsMin",
              filterImplMax: "implMax"
            };
            STATE.ui.roleFilters[keyMap[id]] = e.target.value;
            markTabDirty("tab-actions");
            renderTabIfDirty("tab-actions");
          });
        });

        $("selectAllFilteredBtn").addEventListener("click", () => {
          applyRoleFilters().forEach((r) => STATE.ui.selectedRoleIds.add(r.id));
          markTabDirty("tab-actions");
          renderTabIfDirty("tab-actions");
        });
        $("clearSelectionBtn").addEventListener("click", () => {
          STATE.ui.selectedRoleIds.clear();
          markTabDirty("tab-actions");
          renderTabIfDirty("tab-actions");
        });
        $("bulkEliminateBtn").addEventListener("click", () => bulkUpdateAction("eliminate"));
        $("bulkAugmentBtn").addEventListener("click", () => bulkUpdateAction("augment"));
        $("bulkReskillBtn").addEventListener("click", () => bulkUpdateAction("reskill"));
        $("deleteSelectedRolesBtn").addEventListener("click", deleteSelectedRoles);

        $("scenarioSelect").addEventListener("change", (e) => {
          STATE.selectedScenarioId = e.target.value;
          markTabDirty("tab-scenarios");
          markTabDirty("tab-readiness");
          markTabDirty("tab-board");
          calcCore();
          fullRefresh();
        });

        $("applyScenarioBtn").addEventListener("click", () => {
          recordHistory();
          const scenario = STATE.scenarios[STATE.selectedScenarioId];
          flattenRoles().forEach((r) => {
            if (r.riskScore >= scenario.thresholdRisk) {
              const action = scenario.id === "status_quo" ? r.recommendedAction : r.riskScore >= 80 ? "eliminate" : r.riskScore >= 55 ? "augment" : r.recommendedAction;
              r.recommendedAction = action;
              r.eliminationPercent = Math.max(0, Math.min(95, Math.round(defaultEliminationPercent(r.riskScore, action) * scenario.realizationRate * 1.3)));
              r.productivityGainPercent = Math.max(0, Math.min(70, Math.round(defaultProductivityGain(r.riskScore, action) * (0.7 + scenario.realizationRate))));
              r.implementationMonths = Math.max(3, Math.round((r.implementationMonths * scenario.timelineMonths) / 24));
              r.priority = r.riskScore >= scenario.thresholdRisk ? "P1" : r.priority;
            }
          });
          STATE.org.initiatives = buildInitiativesFromRoles(flattenRoles());
          markAllTabsDirty();
          fullRefresh();
          showToast(`Applied scenario: ${scenario.name}`);
        });

        ["compareA", "compareB", "compareC"].forEach((id) => {
          $(id).addEventListener("change", () => {
            markTabDirty("tab-scenarios");
            renderTabIfDirty("tab-scenarios");
          });
        });

        $("generateBoardSummaryBtn").addEventListener("click", () => generateBoardSummary(true));
        $("copyBoardSummaryBtn").addEventListener("click", copyBoardSummary);

        $("exportPdfBtn").addEventListener("click", () => {
          exportCurrentTabPdf().catch(() => showToast("PDF export failed"));
        });
        $("exportPngBtn").addEventListener("click", () => {
          exportCurrentTabPng().catch(() => showToast("PNG export failed"));
        });
        $("exportCsvBtn").addEventListener("click", exportRolesCsv);
        $("exportExcelBtn").addEventListener("click", exportExcelWorkbook);
        $("printViewBtn").addEventListener("click", () => window.print());

        [
          ["automationMaturity", "automationMaturity"],
          ["dataMaturity", "dataMaturity"],
          ["riskWeight", "riskWeight"],
          ["automationWeight", "automationWeight"],
          ["dataWeight", "dataWeight"]
        ].forEach(([id, key]) => {
          $(id).addEventListener("input", (e) => {
            STATE.ui.readinessMeta[key] = Number(e.target.value);
            normalizeWeights();
            markAllTabsDirty();
            fullRefresh();
          });
          $(id).addEventListener("change", () => recordHistory());
        });

        document.addEventListener("mousedown", (e) => {
          if (!e.target.closest("#roleContextMenu")) {
            $("roleContextMenu").style.display = "none";
          }
        });

        document.addEventListener("mousemove", onGanttMouseMove);
        document.addEventListener("mouseup", onGanttMouseUp);

        document.addEventListener("keydown", (e) => {
          if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "z") {
            e.preventDefault();
            undo();
          }
          if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "y") {
            e.preventDefault();
            redo();
          }
          if (e.key === "Escape") {
            $("roleContextMenu").style.display = "none";
            $("onboardingModal").classList.remove("active");
          }
          if (e.key === "Enter" && document.activeElement?.classList.contains("editable")) {
            document.activeElement.blur();
          }
        });

        window.addEventListener("resize", () => {
          resizePlotsForActiveTab();
        });
      }

      function setupOnboarding() {
        const modal = $("onboardingModal");
        const body = $("onboardBody");
        const title = $("onboardTitle");
        const stepText = $("onboardStepText");

        function renderStep() {
          const step = STATE.ui.onboarding.step;
          stepText.textContent = `Step ${step + 1} / 3`;

          if (step === 0) {
            title.textContent = "Select your industry";
            body.innerHTML = `<div class="onboard-grid">${Object.values(INDUSTRY_TEMPLATES).map((t) => `
              <div class="onboard-option ${STATE.ui.onboarding.industry === t.id ? "active" : ""}" data-industry="${t.id}">
                <strong>${t.name}</strong>
                <small>${t.description}</small>
              </div>`).join("")}</div>`;
            body.querySelectorAll("[data-industry]").forEach((el) => {
              el.addEventListener("click", () => {
                STATE.ui.onboarding.industry = el.dataset.industry;
                renderStep();
              });
            });
          }

          if (step === 1) {
            title.textContent = "Set your organization size";
            body.innerHTML = `<div class="panel" style="padding:12px;">
              <label>Target headcount: <span class="mono" id="onboardSizeLabel">${numberFmt.format(STATE.ui.onboarding.orgSize)}</span></label>
              <input id="onboardSizeInput" type="range" min="500" max="250000" step="500" value="${STATE.ui.onboarding.orgSize}" />
              <div class="hint">The selected template will be scaled proportionally to this size (up to 250,000 employees).</div>
              <div class="size-presets">
                <button type="button" data-size-preset="10000">10k</button>
                <button type="button" data-size-preset="25000">25k</button>
                <button type="button" data-size-preset="50000">50k</button>
                <button type="button" data-size-preset="100000">100k</button>
                <button type="button" data-size-preset="250000">250k</button>
              </div>
            </div>`;
            $("onboardSizeInput").addEventListener("input", (e) => {
              STATE.ui.onboarding.orgSize = Number(e.target.value);
              $("onboardSizeLabel").textContent = numberFmt.format(STATE.ui.onboarding.orgSize);
            });
            body.querySelectorAll("[data-size-preset]").forEach((btn) => {
              btn.addEventListener("click", () => {
                STATE.ui.onboarding.orgSize = Number(btn.dataset.sizePreset);
                $("onboardSizeInput").value = String(STATE.ui.onboarding.orgSize);
                $("onboardSizeLabel").textContent = numberFmt.format(STATE.ui.onboarding.orgSize);
              });
            });
          }

          if (step === 2) {
            title.textContent = "Choose transformation ambition";
            const options = ["conservative", "balanced", "aggressive", "mercury"];
            body.innerHTML = `<div class="onboard-grid">${options.map((id) => {
              const s = SCENARIO_LIBRARY[id];
              return `<div class="onboard-option ${STATE.ui.onboarding.ambition === id ? "active" : ""}" data-ambition="${id}">
                <strong>${s.name}</strong>
                <small>${s.summary}</small>
              </div>`;
            }).join("")}</div>`;
            body.querySelectorAll("[data-ambition]").forEach((el) => {
              el.addEventListener("click", () => {
                STATE.ui.onboarding.ambition = el.dataset.ambition;
                renderStep();
              });
            });
          }

          $("onboardBackBtn").disabled = step === 0;
          $("onboardNextBtn").textContent = step === 2 ? "Launch Dashboard" : "Next";
        }

        $("onboardBackBtn").addEventListener("click", () => {
          STATE.ui.onboarding.step = Math.max(0, STATE.ui.onboarding.step - 1);
          renderStep();
        });

        $("onboardNextBtn").addEventListener("click", () => {
          if (STATE.ui.onboarding.step < 2) {
            STATE.ui.onboarding.step += 1;
            renderStep();
          } else {
            recordHistory();
            STATE.selectedScenarioId = STATE.ui.onboarding.ambition;
            STATE.org = buildOrgFromTemplate(STATE.ui.onboarding.industry, STATE.ui.onboarding.orgSize, STATE.ui.onboarding.ambition);
            modal.classList.remove("active");
            markAllTabsDirty();
            fullRefresh();
            showToast("Dashboard initialized from onboarding");
          }
        });

        $("onboardSkipBtn").addEventListener("click", () => {
          modal.classList.remove("active");
          showToast("Onboarding skipped");
        });

        const hasSaved = Boolean(readStoredSnapshotRaw());
        if (!hasSaved) {
          STATE.ui.onboarding.active = true;
          modal.classList.add("active");
          renderStep();
        }
      }

      function initDefaults() {
        STATE.readinessAnswers = createEmptyReadinessAnswers();
        STATE.org = buildOrgFromTemplate("banking", 6950, "balanced");
        normalizeWeights();
      }

      function initialRender() {
        calcCore();
        renderGlobalStats();
        renderTabIfDirty("tab-warboard");
      }

      initDefaults();
      migrateLegacyStorageIfNeeded();
      bindEvents();
      initialRender();
      setupOnboarding();
    })();
  </script>
</body>
</html>
