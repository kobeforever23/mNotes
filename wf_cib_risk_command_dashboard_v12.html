<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wells-Style CIB Risk Command Dashboard | Executive Edition 2026</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/plotly.js-dist-min@2.35.2/plotly.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <style>
    :root {
      --bg: #0a1628;
      --bg-2: #0f1d33;
      --panel: #1a2332;
      --panel-2: #121b2b;
      --line: rgba(255, 255, 255, 0.08);
      --line-strong: rgba(255, 255, 255, 0.18);
      --text: #e0e8f0;
      --muted: #9fb0c4;
      --white: #ffffff;
      --good: #00c896;
      --good-soft: rgba(0, 200, 150, 0.2);
      --amber: #f5a623;
      --amber-soft: rgba(245, 166, 35, 0.2);
      --bad: #e74c3c;
      --bad-soft: rgba(231, 76, 60, 0.2);
      --blue: #55b4ff;
      --mono: "Space Mono", "SFMono-Regular", Menlo, Consolas, monospace;
      --body: "DM Sans", "Segoe UI", sans-serif;
      --shadow: 0 18px 50px rgba(2, 8, 18, 0.5);
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      background:
        radial-gradient(1100px 500px at 115% -15%, rgba(85, 180, 255, 0.18), transparent 60%),
        radial-gradient(900px 420px at -15% -20%, rgba(0, 200, 150, 0.14), transparent 55%),
        var(--bg);
      color: var(--text);
      font-family: var(--body);
      min-height: 100%;
      height: 100%;
      overflow: hidden;
    }

    .app {
      display: grid;
      grid-template-columns: 310px 1fr;
      min-height: 100vh;
      height: 100vh;
      overflow: hidden;
    }

    .sidebar {
      position: sticky;
      top: 0;
      height: 100vh;
      overflow-y: auto;
      background: linear-gradient(180deg, rgba(10, 22, 40, 0.98), rgba(15, 29, 51, 0.98));
      border-right: 1px solid var(--line);
      padding: 18px 16px 28px;
    }

    .brand {
      border: 1px solid var(--line);
      background: rgba(255, 255, 255, 0.03);
      border-radius: 12px;
      padding: 12px 12px 14px;
      box-shadow: var(--shadow);
      margin-bottom: 14px;
    }

    .brand .kicker {
      font-size: 11px;
      letter-spacing: 0.11em;
      text-transform: uppercase;
      color: var(--blue);
      font-weight: 700;
    }

    .brand h1 {
      margin: 8px 0 6px;
      font-size: 21px;
      line-height: 1.15;
      color: var(--white);
      letter-spacing: 0.01em;
    }

    .brand .sub {
      margin: 0;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.4;
    }

    .asof {
      margin-top: 10px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-family: var(--mono);
      font-size: 11px;
      color: #c7d6e6;
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 5px 9px;
      background: rgba(255, 255, 255, 0.03);
    }

    .nav {
      display: grid;
      gap: 8px;
      margin: 10px 0 14px;
    }

    .nav button {
      width: 100%;
      border: 1px solid var(--line);
      background: rgba(255, 255, 255, 0.02);
      color: #d6e1ed;
      border-radius: 10px;
      padding: 10px 11px;
      text-align: left;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: 0.2s ease;
    }

    .nav button:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: var(--line-strong);
    }

    .nav button.active {
      border-color: rgba(85, 180, 255, 0.7);
      background: linear-gradient(90deg, rgba(85, 180, 255, 0.16), rgba(85, 180, 255, 0.05));
      color: var(--white);
    }

    .controls {
      border: 1px solid var(--line);
      background: rgba(255, 255, 255, 0.03);
      border-radius: 12px;
      padding: 10px;
      margin-top: 10px;
    }

    .controls h3 {
      margin: 0 0 8px;
      font-size: 13px;
      color: #d6e1ed;
      letter-spacing: 0.02em;
    }

    .control {
      margin-bottom: 11px;
    }

    .control label {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 5px;
      gap: 8px;
    }

    .control .val {
      color: #d7ebff;
      font-family: var(--mono);
    }

    input[type="range"] {
      width: 100%;
      accent-color: var(--blue);
    }

    input[type="number"],
    input[type="text"],
    select,
    textarea {
      width: 100%;
      border: 1px solid var(--line);
      background: rgba(12, 23, 39, 0.85);
      color: var(--text);
      border-radius: 8px;
      padding: 8px 9px;
      font: inherit;
      font-size: 12px;
    }

    textarea {
      min-height: 88px;
      resize: vertical;
    }

    .check-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 6px;
      font-size: 11px;
      color: var(--muted);
    }

    .side-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 7px;
      margin-top: 10px;
    }

    .btn {
      border: 1px solid var(--line-strong);
      background: rgba(255, 255, 255, 0.05);
      color: var(--white);
      padding: 8px 9px;
      border-radius: 9px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: 0.2s ease;
      white-space: nowrap;
    }

    .btn:hover {
      transform: translateY(-1px);
      border-color: rgba(85, 180, 255, 0.65);
      background: rgba(85, 180, 255, 0.14);
    }

    .btn.wide {
      grid-column: 1 / -1;
    }

    .main {
      padding: 16px 18px 24px;
      height: 100vh;
      overflow-y: auto;
      overflow-x: hidden;
      scroll-behavior: smooth;
    }

    .topbar {
      position: sticky;
      top: 0;
      z-index: 20;
      background: linear-gradient(180deg, rgba(10, 22, 40, 0.96), rgba(10, 22, 40, 0.65));
      backdrop-filter: blur(8px);
      margin: -16px -18px 12px;
      padding: 16px 18px 13px;
      border-bottom: 1px solid var(--line);
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(8, minmax(140px, 1fr));
      gap: 8px;
    }

    .kpi {
      border: 1px solid var(--line);
      background: rgba(255, 255, 255, 0.03);
      border-radius: 10px;
      padding: 9px;
      min-height: 70px;
    }

    .kpi .name {
      color: var(--muted);
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 6px;
    }

    .kpi .value {
      font-family: var(--mono);
      font-size: 17px;
      font-weight: 700;
      color: var(--white);
      line-height: 1.1;
    }

    .kpi .delta {
      margin-top: 4px;
      font-size: 11px;
      color: #c5d4e3;
    }

    .delta.good {
      color: var(--good);
    }

    .delta.warn {
      color: var(--amber);
    }

    .delta.bad {
      color: var(--bad);
    }

    .tab {
      display: none;
      animation: fadeIn 0.28s ease;
    }

    .tab.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(6px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .section {
      border: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(26, 35, 50, 0.98), rgba(18, 27, 43, 0.97));
      border-radius: 14px;
      padding: 12px;
      margin-bottom: 12px;
      box-shadow: var(--shadow);
    }

    body.layout-edit .section {
      resize: both;
      overflow: auto;
      min-height: 220px;
      max-height: 82vh;
    }

    body.layout-edit .section-header {
      cursor: grab;
      user-select: none;
    }

    body.layout-edit .section-header:active {
      cursor: grabbing;
    }

    body.layout-edit .grid-2,
    body.layout-edit .split {
      display: flex;
      flex-wrap: wrap;
      align-items: flex-start;
      gap: 10px;
    }

    body.layout-edit .grid-2 > .section,
    body.layout-edit .split > .section {
      flex: 1 1 calc(50% - 10px);
      min-width: 420px;
    }

    .section.dragging {
      opacity: 0.62;
      border-color: rgba(85, 180, 255, 0.6);
      box-shadow: 0 0 0 1px rgba(85, 180, 255, 0.4), var(--shadow);
    }

    .section.drop-target {
      border-color: rgba(0, 200, 150, 0.7);
      box-shadow: 0 0 0 1px rgba(0, 200, 150, 0.45), var(--shadow);
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .section h2 {
      margin: 0;
      font-size: 16px;
      letter-spacing: 0.01em;
      color: var(--white);
    }

    .section .hint {
      margin: 0;
      color: var(--muted);
      font-size: 12px;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: 1.1fr 1fr;
      gap: 10px;
    }

    .grid-3 {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
    }

    .plot {
      width: 100%;
      min-height: 300px;
      height: 400px;
      max-height: 620px;
      overflow: hidden;
      position: relative;
      contain: layout paint style;
    }

    .plot.small {
      min-height: 250px;
      height: 320px;
      max-height: 360px;
    }

    .canvas-plot {
      width: 100%;
      min-height: 250px;
      height: 320px;
      max-height: 360px;
      position: relative;
      overflow: hidden;
      contain: layout paint style;
    }

    .canvas-plot canvas {
      width: 100% !important;
      height: 100% !important;
      display: block;
    }

    .exec-guide {
      border: 1px solid var(--line);
      border-radius: 12px;
      background: linear-gradient(90deg, rgba(85, 180, 255, 0.15), rgba(0, 200, 150, 0.1));
      padding: 9px 12px;
      margin-bottom: 10px;
      display: grid;
      gap: 4px;
    }

    .exec-guide .title {
      font-size: 12px;
      letter-spacing: 0.07em;
      text-transform: uppercase;
      color: #d7e9fb;
      font-weight: 700;
    }

    .exec-guide .flow {
      font-size: 12px;
      color: #c9dcf0;
      line-height: 1.35;
    }

    .metric-list {
      display: grid;
      gap: 8px;
    }

    .metric-row {
      border: 1px solid var(--line);
      border-radius: 9px;
      padding: 8px;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      background: rgba(255, 255, 255, 0.03);
    }

    .metric-row .label {
      color: var(--muted);
      font-size: 12px;
    }

    .metric-row .val {
      font-family: var(--mono);
      font-size: 13px;
      color: var(--white);
      font-weight: 700;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 3px 7px;
      border-radius: 999px;
      font-family: var(--mono);
      font-size: 10px;
      border: 1px solid var(--line);
      color: #cde0f4;
      background: rgba(255, 255, 255, 0.04);
      white-space: nowrap;
    }

    .pill.good {
      color: var(--good);
      border-color: rgba(0, 200, 150, 0.5);
      background: var(--good-soft);
    }

    .pill.warn {
      color: var(--amber);
      border-color: rgba(245, 166, 35, 0.5);
      background: var(--amber-soft);
    }

    .pill.bad {
      color: var(--bad);
      border-color: rgba(231, 76, 60, 0.5);
      background: var(--bad-soft);
    }

    .table-wrap {
      overflow: auto;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: rgba(8, 18, 32, 0.7);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      min-width: 1080px;
    }

    th,
    td {
      border-bottom: 1px solid var(--line);
      padding: 7px 7px;
      text-align: left;
      vertical-align: middle;
    }

    th {
      position: sticky;
      top: 0;
      z-index: 2;
      background: rgba(18, 27, 43, 0.98);
      color: #d7e5f5;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    tbody tr:hover {
      background: rgba(85, 180, 255, 0.09);
    }

    td input,
    td select {
      min-width: 90px;
      padding: 6px 6px;
      font-size: 11px;
    }

    .filters {
      display: grid;
      grid-template-columns: 2fr repeat(3, 1fr) auto;
      gap: 8px;
      margin-bottom: 8px;
    }

    .market-toolbar {
      display: grid;
      grid-template-columns: 1.6fr 1fr 1fr 1fr auto auto;
      gap: 8px;
      margin-bottom: 8px;
    }

    .market-summary {
      display: grid;
      grid-template-columns: repeat(6, minmax(120px, 1fr));
      gap: 8px;
      margin-bottom: 8px;
    }

    .market-stat {
      border: 1px solid var(--line);
      border-radius: 9px;
      background: rgba(255, 255, 255, 0.03);
      padding: 8px;
      display: grid;
      gap: 2px;
    }

    .market-stat .k {
      font-size: 10px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .market-stat .v {
      font-size: 13px;
      color: var(--white);
      font-family: var(--mono);
    }

    .market-status {
      margin-left: auto;
      font-size: 11px;
    }

    .assumption-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(180px, 1fr));
      gap: 8px;
      margin-bottom: 8px;
    }

    .assumption-card {
      border: 1px solid var(--line);
      border-radius: 9px;
      background: rgba(255, 255, 255, 0.03);
      padding: 8px;
      display: grid;
      gap: 5px;
    }

    .assumption-card label {
      font-size: 11px;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }

    .assumption-card .val {
      color: var(--white);
      font-family: var(--mono);
      font-size: 11px;
    }

    .alert {
      border-radius: 10px;
      border: 1px solid var(--line);
      padding: 9px 10px;
      font-size: 12px;
      line-height: 1.45;
      background: rgba(255, 255, 255, 0.03);
      color: #d3e0ef;
    }

    .alert.warn {
      border-color: rgba(245, 166, 35, 0.5);
      background: rgba(245, 166, 35, 0.12);
    }

    .alert.bad {
      border-color: rgba(231, 76, 60, 0.5);
      background: rgba(231, 76, 60, 0.12);
    }

    .alert.good {
      border-color: rgba(0, 200, 150, 0.5);
      background: rgba(0, 200, 150, 0.12);
    }

    .split {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .list {
      margin: 0;
      padding: 0;
      list-style: none;
      display: grid;
      gap: 7px;
    }

    .list li {
      border: 1px solid var(--line);
      padding: 8px;
      border-radius: 9px;
      background: rgba(255, 255, 255, 0.03);
      font-size: 12px;
      line-height: 1.4;
    }

    .list li .ttl {
      color: var(--white);
      font-weight: 700;
      margin-bottom: 3px;
    }

    .source-table table {
      min-width: 100%;
    }

    .source-table a {
      color: #87cbff;
      text-decoration: none;
      word-break: break-all;
    }

    .source-table a:hover {
      text-decoration: underline;
    }

    .footer-note {
      margin-top: 12px;
      font-size: 11px;
      color: var(--muted);
      line-height: 1.5;
      border-top: 1px solid var(--line);
      padding-top: 10px;
    }

    .hidden {
      display: none !important;
    }

    .context-menu {
      position: fixed;
      min-width: 180px;
      border: 1px solid var(--line-strong);
      background: rgba(14, 22, 35, 0.98);
      border-radius: 9px;
      box-shadow: var(--shadow);
      z-index: 200;
      overflow: hidden;
      display: none;
    }

    .context-menu button {
      width: 100%;
      text-align: left;
      border: 0;
      border-bottom: 1px solid var(--line);
      background: transparent;
      color: var(--text);
      padding: 8px 10px;
      font-size: 12px;
      cursor: pointer;
    }

    .context-menu button:hover {
      background: rgba(85, 180, 255, 0.18);
    }

    .mono {
      font-family: var(--mono);
    }

    @media (max-width: 1500px) {
      .kpi-grid {
        grid-template-columns: repeat(4, minmax(140px, 1fr));
      }
    }

    @media (max-width: 1200px) {
      .app {
        grid-template-columns: 1fr;
      }

      .sidebar {
        position: static;
        height: auto;
      }

      .grid-2,
      .split {
        grid-template-columns: 1fr;
      }

      .kpi-grid {
        grid-template-columns: repeat(2, minmax(120px, 1fr));
      }

      .filters {
        grid-template-columns: 1fr;
      }

      .market-toolbar,
      .market-summary,
      .assumption-grid {
        grid-template-columns: 1fr;
      }

      body.layout-edit .grid-2 > .section,
      body.layout-edit .split > .section {
        min-width: 280px;
        flex-basis: 100%;
      }
    }

    @media print {
      html,
      body {
        height: auto !important;
        overflow: visible !important;
        background: #ffffff !important;
        color: #111111 !important;
      }

      .app {
        display: block !important;
        height: auto !important;
        overflow: visible !important;
      }

      .sidebar {
        display: none !important;
      }

      .main {
        height: auto !important;
        overflow: visible !important;
        padding: 0 !important;
      }

      .topbar,
      .exec-guide {
        position: static !important;
        border: 1px solid #d0d0d0 !important;
        background: #ffffff !important;
        color: #111111 !important;
      }

      .section {
        box-shadow: none !important;
        background: #ffffff !important;
        color: #111111 !important;
      }
    }
  </style>
</head>
<body>
  <div class="app" id="appRoot">
    <aside class="sidebar">
      <div class="brand">
        <div class="kicker">Executive Risk Command Center</div>
        <h1>CIB Risk Dashboard</h1>
        <p class="sub">Built for Head of CIB Risk and Head of CIB Portfolio Risk. Seeded with latest public Wells-style CIB data and Fed stress assumptions.</p>
        <div class="asof" id="globalAsOf">Data snapshot: 2026-02-12</div>
      </div>

      <nav class="nav" id="navTabs">
        <button data-tab="overview" class="active">01 Command Overview</button>
        <button data-tab="portfolio">02 Portfolio Credit Risk</button>
        <button data-tab="market">03 Market + Counterparty</button>
        <button data-tab="stress">04 Stress + Capital Lab</button>
        <button data-tab="functions">05 Risk Function Map</button>
        <button data-tab="assumptions">06 Risk Assumptions</button>
        <button data-tab="aiworkforce">07 AI Workforce Mapping</button>
        <button data-tab="board">08 Board Pack Generator</button>
      </nav>

      <section class="controls">
        <h3>Scale + Scenario Controls</h3>

        <div class="control">
          <label for="scenarioSelect">Active scenario <span class="val" id="scenarioNameLabel">Severe Adverse</span></label>
          <select id="scenarioSelect"></select>
        </div>

        <div class="control">
          <label for="enterpriseFte">Enterprise FTE (supports 250k+) <span class="val" id="enterpriseFteVal">216,906</span></label>
          <input id="enterpriseFte" type="range" min="25000" max="300000" step="1000" />
        </div>

        <div class="control">
          <label for="cibSharePct">CIB share of enterprise FTE <span class="val" id="cibShareVal">8.7%</span></label>
          <input id="cibSharePct" type="range" min="3" max="25" step="0.1" />
        </div>

        <div class="control">
          <label for="pdMultiplier">PD stress multiplier <span class="val" id="pdMultiplierVal">2.40x</span></label>
          <input id="pdMultiplier" type="range" min="0.8" max="3.5" step="0.05" />
        </div>

        <div class="control">
          <label for="lgdAdd">LGD add-on (pp) <span class="val" id="lgdAddVal">18 pp</span></label>
          <input id="lgdAdd" type="range" min="0" max="35" step="1" />
        </div>

        <div class="control">
          <label for="varMult">Market loss multiplier <span class="val" id="varMultVal">2.80x</span></label>
          <input id="varMult" type="range" min="1" max="4.5" step="0.05" />
        </div>

        <div class="control">
          <label for="rwaInflation">Stress RWA inflation <span class="val" id="rwaInflationVal">16%</span></label>
          <input id="rwaInflation" type="range" min="0" max="35" step="1" />
        </div>

        <div class="control">
          <label for="discountRate">Discount rate for NPV <span class="val" id="discountRateVal">10%</span></label>
          <input id="discountRate" type="range" min="0" max="18" step="0.5" />
        </div>

        <label class="check-row"><input id="autoScale" type="checkbox" /> Auto-scale exposure and limits when FTE changes</label>
      </section>

      <div class="side-actions">
        <button class="btn" id="saveStateBtn">Save Local</button>
        <button class="btn" id="loadStateBtn">Load Local</button>
        <button class="btn" id="undoBtn">Undo</button>
        <button class="btn" id="redoBtn">Redo</button>
        <button class="btn" id="importPortfolioBtn">Import CSV</button>
        <button class="btn" id="exportPortfolioBtn">Export CSV</button>
        <button class="btn" id="exportPngBtn">Export PNG</button>
        <button class="btn" id="exportPdfBtn">Export PDF</button>
        <button class="btn wide" id="layoutEditBtn">Layout Edit: OFF</button>
        <button class="btn wide" id="resetLayoutBtn">Reset Custom Layout</button>
        <button class="btn wide" id="printBtn">Print Active View</button>
        <button class="btn wide" id="resetBtn">Reset to Baseline</button>
        <input id="csvFileInput" type="file" accept=".csv" class="hidden" />
      </div>

      <div class="footer-note">
        Responsible transition and governance note: This tool supports decision-grade planning, not automatic decisions. Major risk actions should be validated through formal governance, model risk review, legal review, and regulator-facing documentation.
      </div>
    </aside>

    <main class="main" id="mainContent">
      <header class="topbar">
        <div class="kpi-grid" id="kpiGrid"></div>
      </header>

      <div class="exec-guide">
        <div class="title">Executive Quick Path</div>
        <div class="flow">1) Select scenario and tune assumptions on the left. 2) Review portfolio, market, and counterparty concentrations. 3) Validate capital trajectory and Monte Carlo band. 4) Open `06 Risk Assumptions` for formula traceability and capital assumptions. 5) Open `07 AI Workforce Mapping` for role-level AI replacement/redeploy economics. 6) Generate board narrative and export package. Zoom controls: mouse wheel to zoom, drag to box-zoom, Shift+drag to pan, double-click to reset. Layout controls: toggle "Layout Edit" to drag/reorder and resize panels.</div>
      </div>

      <section class="tab active" id="tab-overview">
        <div class="section">
          <div class="section-header">
            <div>
              <h2>CIB War Board: Risk-Weighted Portfolio Map</h2>
              <p class="hint">Treemap sized by exposure and colored by composite risk intensity (credit + market + concentration + quality).</p>
            </div>
            <div class="pill" id="overviewScaleTag">Scale factor 1.00x</div>
          </div>
          <div id="treemapPlot" class="plot"></div>
        </div>

        <div class="grid-2">
          <div class="section">
            <div class="section-header">
              <h2>Market and Funding Tape (Public Data)</h2>
              <p class="hint">Latest available official observations, timestamped.</p>
            </div>
            <div class="table-wrap">
              <table id="marketTapeTable">
                <thead>
                  <tr>
                    <th>Indicator</th>
                    <th>Value</th>
                    <th>As Of</th>
                    <th>Signal</th>
                    <th>Source</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <div class="section">
            <div class="section-header">
              <h2>Immediate CRO Priorities (30 Days)</h2>
              <p class="hint">Auto-ranked actions based on current utilization and stress sensitivity.</p>
            </div>
            <ul class="list" id="priorityActions"></ul>
          </div>
        </div>

        <div class="grid-2">
          <div class="section">
            <div class="section-header">
              <h2>Revenue and Loss Context</h2>
              <p class="hint">CIB quarterly economics vs expected and stressed losses.</p>
            </div>
            <div class="canvas-plot"><canvas id="revLossChart"></canvas></div>
          </div>

          <div class="section">
            <div class="section-header">
              <h2>Risk Posture Summary</h2>
              <p class="hint">Key risk and capital diagnostics for Head of CIB Risk.</p>
            </div>
            <div class="metric-list" id="riskPostureList"></div>
          </div>
        </div>
      </section>

      <section class="tab" id="tab-portfolio">
        <div class="section">
          <div class="section-header">
            <div>
              <h2>Granular Portfolio Table (Editable)</h2>
              <p class="hint">Right-click a row for quick priority/watchlist actions. All edits recalculate in real time.</p>
            </div>
            <div class="pill" id="portfolioRowCount">0 desks</div>
          </div>

          <div class="filters">
            <input id="portfolioSearch" type="text" placeholder="Search desk / owner / action" />
            <select id="portfolioLobFilter">
              <option value="all">All LOBs</option>
            </select>
            <select id="portfolioPriorityFilter">
              <option value="all">All priorities</option>
              <option value="P1">P1</option>
              <option value="P2">P2</option>
              <option value="P3">P3</option>
            </select>
            <select id="portfolioRiskFilter">
              <option value="all">All risk levels</option>
              <option value="critical">Critical (80+)</option>
              <option value="high">High (65-79)</option>
              <option value="moderate">Moderate (50-64)</option>
              <option value="low">Low (&lt;50)</option>
            </select>
            <button class="btn" id="addPortfolioRowBtn">Add Desk</button>
          </div>

          <div class="table-wrap">
            <table id="portfolioTable">
              <thead>
                <tr>
                  <th>LOB</th>
                  <th>Desk / Portfolio</th>
                  <th>EAD ($Bn)</th>
                  <th>PD %</th>
                  <th>LGD %</th>
                  <th>Criticized %</th>
                  <th>Nonaccrual %</th>
                  <th>1D VaR ($MM)</th>
                  <th>VaR Limit ($MM)</th>
                  <th>NCO ($MM)</th>
                  <th>RWA Density %</th>
                  <th>Priority</th>
                  <th>Owner</th>
                  <th>Action</th>
                  <th>EL ($MM)</th>
                  <th>Risk Score</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="grid-2">
          <div class="section">
            <div class="section-header">
              <h2>Credit Quality Heat by Desk</h2>
              <p class="hint">PD x LGD vs criticized/nonaccrual intensity.</p>
            </div>
            <div id="creditHeatPlot" class="plot small"></div>
          </div>

          <div class="section">
            <div class="section-header">
              <h2>Concentration and Expected Loss</h2>
              <p class="hint">Top expected-loss contributors, ranked for portfolio risk decisions.</p>
            </div>
            <div id="concentrationPlot" class="plot small"></div>
          </div>
        </div>
      </section>

      <section class="tab" id="tab-market">
        <div class="grid-2">
          <div class="section">
            <div class="section-header">
              <h2>Counterparty Risk Map</h2>
              <p class="hint">Bubble size = EAD, X = utilization, Y = wrong-way risk score.</p>
            </div>
            <div id="counterpartyBubble" class="plot"></div>
          </div>

          <div class="section">
            <div class="section-header">
              <h2>Limit Framework and Breaches</h2>
              <p class="hint">Traffic-light thresholds with owner and remediation requirement.</p>
            </div>
            <div class="table-wrap">
              <table id="limitTable">
                <thead>
                  <tr>
                    <th>Metric</th>
                    <th>Current</th>
                    <th>Amber</th>
                    <th>Red</th>
                    <th>Status</th>
                    <th>Owner</th>
                    <th>Commentary</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="grid-2">
          <div class="section">
            <div class="section-header">
              <h2>VaR and sVaR Utilization Trend</h2>
              <p class="hint">Quarterly path under current assumptions.</p>
            </div>
            <div class="canvas-plot"><canvas id="varTrendChart"></canvas></div>
          </div>

          <div class="section">
            <div class="section-header">
              <h2>Counterparty Watchlist</h2>
              <p class="hint">Focused list for Head of CIB Portfolio Risk daily call.</p>
            </div>
            <div class="table-wrap">
              <table id="counterpartyTable">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Type</th>
                    <th>Rating</th>
                    <th>EAD ($MM)</th>
                    <th>PFE95 ($MM)</th>
                    <th>Util %</th>
                    <th>WWR</th>
                    <th>Collateral</th>
                    <th>Flag</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="section">
          <div class="section-header">
            <div>
              <h2>Comprehensive Market Monitor (CIB Risk Focus)</h2>
              <p class="hint">Rates, spreads, vol, FX, equities, commodities, and financial-condition indicators. Filter, sort, and refresh from FRED.</p>
            </div>
            <span class="pill market-status" id="marketRefreshStatus">Snapshot mode</span>
          </div>

          <div class="market-toolbar">
            <input id="marketSearch" type="text" placeholder="Search indicator / category / source" />
            <select id="marketCategoryFilter">
              <option value="all">All categories</option>
            </select>
            <select id="marketSignalFilter">
              <option value="all">All signals</option>
              <option value="stress">Stress</option>
              <option value="watch">Watch</option>
              <option value="neutral">Neutral</option>
            </select>
            <select id="marketSort">
              <option value="severity">Sort: signal severity</option>
              <option value="category">Sort: category</option>
              <option value="name">Sort: indicator name</option>
              <option value="stale">Sort: staleness</option>
            </select>
            <button class="btn" id="refreshMarketBtn" type="button">Refresh FRED</button>
            <button class="btn" id="resetMarketFiltersBtn" type="button">Reset Filters</button>
          </div>

          <div class="market-summary" id="marketSummary"></div>

          <div class="table-wrap">
            <table id="marketMonitorTable">
              <thead>
                <tr>
                  <th>Category</th>
                  <th>Indicator</th>
                  <th>Value</th>
                  <th>As Of</th>
                  <th>Signal</th>
                  <th>Source</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>

      <section class="tab" id="tab-stress">
        <div class="section">
          <div class="section-header">
            <h2>Scenario Engine and Capital Trajectory</h2>
            <p class="hint">Severe adverse anchored to Fed 2026 supervisory parameters; scenario assumptions are editable.</p>
          </div>
          <div class="split">
            <div>
              <div id="capitalTrajectoryPlot" class="plot small"></div>
            </div>
            <div>
              <div id="stressWaterfallPlot" class="plot small"></div>
            </div>
          </div>
        </div>

        <div class="grid-2">
          <div class="section">
            <div class="section-header">
              <h2>Scenario Comparison Matrix</h2>
              <p class="hint">Compare expected loss, capital hit, and headroom by strategy posture.</p>
            </div>
            <div class="table-wrap">
              <table id="scenarioTable">
                <thead>
                  <tr>
                    <th>Scenario</th>
                    <th>Credit Loss ($Bn)</th>
                    <th>Market+CCR Loss ($Bn)</th>
                    <th>Total Pre-Tax Loss ($Bn)</th>
                    <th>Stressed CET1 %</th>
                    <th>Headroom vs 8.5% (bp)</th>
                    <th>Risk Call</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <div class="section">
            <div class="section-header">
              <h2>Monte Carlo Distribution (1,000 Runs)</h2>
              <p class="hint">Assumptions varied Â±20%. Output shows P10 / P50 / P90 net capital impact.</p>
            </div>
            <div id="monteCarloPlot" class="plot small"></div>
            <div class="alert" id="monteCarloSummary"></div>
          </div>
        </div>
      </section>

      <section class="tab" id="tab-functions">
        <div class="grid-2">
          <div class="section">
            <div class="section-header">
              <h2>Risk Function Ownership Map</h2>
              <p class="hint">Operating model map for Head of CIB Risk and direct reports.</p>
            </div>
            <div class="table-wrap">
              <table id="functionMapTable">
                <thead>
                  <tr>
                    <th>Function</th>
                    <th>Primary Owner</th>
                    <th>Core KPI</th>
                    <th>Target</th>
                    <th>Status</th>
                    <th>Cadence</th>
                    <th>Escalation Trigger</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <div class="section">
            <div class="section-header">
              <h2>90-Day Execution Plan</h2>
              <p class="hint">Cross-stripe initiatives with dependencies and accountable executives.</p>
            </div>
            <div id="ganttPlot" class="plot"></div>
          </div>
        </div>

        <div class="section">
          <div class="section-header">
            <h2>Governance and Ethical Risk Notes</h2>
            <p class="hint">Regulatory, legal, and reputational controls to maintain.</p>
          </div>
          <div class="split">
            <div class="alert warn">
              <strong>Regulatory posture:</strong> Major concentration or strategy shifts should be run through SR 11-7 model risk governance, formal limit governance, and documented challenge.
            </div>
            <div class="alert bad">
              <strong>Conduct and fairness risk:</strong> Counterparty decisions and portfolio de-risking actions require consistent criteria and adverse-impact review to avoid unintentional bias or reputation damage.
            </div>
          </div>
        </div>
      </section>

      <section class="tab" id="tab-assumptions">
        <div class="section">
          <div class="section-header">
            <div>
              <h2>Dynamic Risk Assumption Control Lab</h2>
              <p class="hint">Executive-adjustable assumptions feeding VaR, RWA, CET1, funding drag, and capital headroom in real time.</p>
            </div>
          </div>
          <div class="assumption-grid">
            <div class="assumption-card">
              <label>Tax Rate <span id="taxRatePctVal" class="val">24.0%</span></label>
              <input id="taxRatePctInput" type="range" min="10" max="35" step="0.5" />
            </div>
            <div class="assumption-card">
              <label>Funding Shock (bps) <span id="fundingSpreadShockVal" class="val">55</span></label>
              <input id="fundingSpreadShockInput" type="range" min="0" max="150" step="1" />
            </div>
            <div class="assumption-card">
              <label>Management Buffer (bp) <span id="mgmtBufferVal" class="val">120</span></label>
              <input id="mgmtBufferInput" type="range" min="50" max="300" step="5" />
            </div>
            <div class="assumption-card">
              <label>Required CET1 Min % <span id="requiredCet1Val" class="val">8.5%</span></label>
              <input id="requiredCet1Input" type="range" min="6" max="12" step="0.1" />
            </div>
          </div>
          <div class="market-summary" id="assumptionSummary"></div>
        </div>

        <div class="section">
          <div class="section-header">
            <h2>Formula Trace Table (VaR, RWA, CET1, Loss Drivers)</h2>
            <p class="hint">Calculated live from current scenario and portfolio inputs.</p>
          </div>
          <div class="table-wrap">
            <table id="assumptionTraceTable">
              <thead>
                <tr>
                  <th>Metric</th>
                  <th>Formula</th>
                  <th>Inputs (Current)</th>
                  <th>Output</th>
                  <th>Source / Note</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>

      <section class="tab" id="tab-aiworkforce">
        <div class="section">
          <div class="section-header">
            <div>
              <h2>Dynamic AI Workforce Assumption Lab</h2>
              <p class="hint">Role-level automation assumptions and transformation levers for strategic headcount, cost, and governance planning.</p>
            </div>
          </div>
          <div class="assumption-grid">
            <div class="assumption-card">
              <label>AI Adoption <span id="aiAdoptionVal" class="val">65%</span></label>
              <input id="aiAdoptionInput" type="range" min="20" max="100" step="1" />
            </div>
            <div class="assumption-card">
              <label>Model Confidence <span id="aiModelConfidenceVal" class="val">72%</span></label>
              <input id="aiModelConfidenceInput" type="range" min="30" max="100" step="1" />
            </div>
            <div class="assumption-card">
              <label>Data Quality <span id="aiDataQualityVal" class="val">70%</span></label>
              <input id="aiDataQualityInput" type="range" min="30" max="100" step="1" />
            </div>
            <div class="assumption-card">
              <label>Process Standardization <span id="aiProcessMaturityVal" class="val">68%</span></label>
              <input id="aiProcessMaturityInput" type="range" min="30" max="100" step="1" />
            </div>
            <div class="assumption-card">
              <label>Control Retention <span id="aiControlRetentionVal" class="val">48%</span></label>
              <input id="aiControlRetentionInput" type="range" min="20" max="90" step="1" />
            </div>
            <div class="assumption-card">
              <label>Redeploy Share <span id="aiRedeployVal" class="val">35%</span></label>
              <input id="aiRedeployInput" type="range" min="0" max="80" step="1" />
            </div>
            <div class="assumption-card">
              <label>Implementation Success <span id="aiImplementationSuccessVal" class="val">78%</span></label>
              <input id="aiImplementationSuccessInput" type="range" min="30" max="100" step="1" />
            </div>
            <div class="assumption-card">
              <label>Severance Months <span id="aiSeveranceMonthsVal" class="val">5.0</span></label>
              <input id="aiSeveranceMonthsInput" type="range" min="1" max="12" step="0.5" />
            </div>
          </div>
          <div class="market-summary" id="aiWorkforceSummary"></div>
        </div>

        <div class="section">
          <div class="section-header">
            <h2>Role-Level AI Replacement and Tangible Impact Engine</h2>
            <p class="hint">Function-aligned role decomposition with scenario-adjusted reduction/redeployment economics for strategic workforce decisions.</p>
          </div>
          <div id="roleReductionPlot" class="plot small"></div>
          <div class="table-wrap">
            <table id="roleDecompTable">
              <thead>
                <tr>
                  <th>Function</th>
                  <th>Role</th>
                  <th>Owner</th>
                  <th>Baseline FTE</th>
                  <th>Modelable %</th>
                  <th>Pred. Reduction FTE</th>
                  <th>Redeploy FTE</th>
                  <th>Net FTE Reduction</th>
                  <th>Annual Net Benefit ($MM)</th>
                  <th>Implementation + Severance ($MM)</th>
                  <th>3Y NPV ($MM)</th>
                  <th>Target Phase</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="section">
          <div class="section-header">
            <h2>Function-to-Role Bridge and Transition Roadmap</h2>
            <p class="hint">Direct linkage between risk function ownership map and role-level transition plan (who changes, when, and with what guardrails).</p>
          </div>
          <div class="table-wrap">
            <table id="functionRoleBridgeTable">
              <thead>
                <tr>
                  <th>Function</th>
                  <th>Owner</th>
                  <th>Mapped Roles</th>
                  <th>Baseline FTE</th>
                  <th>Net Reduction FTE</th>
                  <th>Redeploy FTE</th>
                  <th>Remaining Critical FTE</th>
                  <th>Annual Net Benefit ($MM)</th>
                  <th>Primary Control Guardrail</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div style="height:8px;"></div>
          <div class="table-wrap">
            <table id="transitionRoadmapTable">
              <thead>
                <tr>
                  <th>Phase</th>
                  <th>Role / Function</th>
                  <th>Action</th>
                  <th>Timeline (Months)</th>
                  <th>Net FTE Impact</th>
                  <th>Owner</th>
                  <th>Dependency</th>
                  <th>Governance Checkpoint</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="section">
          <div class="section-header">
            <h2>Research and Evidence Register</h2>
            <p class="hint">Curated references backing assumptions and AI-workforce planning decisions.</p>
          </div>
          <div class="table-wrap source-table">
            <table id="aiResearchTable">
              <thead>
                <tr>
                  <th>Research</th>
                  <th>Key Point</th>
                  <th>As Of</th>
                  <th>Relevance</th>
                  <th>Source</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>

      <section class="tab" id="tab-board">
        <div class="section">
          <div class="section-header">
            <h2>Executive Narrative Generator</h2>
            <p class="hint">One-click board-ready summary and talking points, tied to current scenario.</p>
          </div>
          <textarea id="boardNarrative"></textarea>
          <div style="display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px;margin-top:8px;">
            <button class="btn" id="regenNarrativeBtn">Regenerate Narrative</button>
            <button class="btn" id="copyNarrativeBtn">Copy Narrative</button>
            <button class="btn" id="downloadBriefBtn">Download .txt Brief</button>
          </div>
        </div>

        <div class="grid-2">
          <div class="section">
            <div class="section-header">
              <h2>Board Q&A Prep</h2>
              <p class="hint">Likely board and regulator questions with suggested responses.</p>
            </div>
            <ul class="list" id="qaList"></ul>
          </div>

          <div class="section">
            <div class="section-header">
              <h2>Source Provenance and Confidence</h2>
              <p class="hint">Traceability for every seeded external number.</p>
            </div>
            <div class="table-wrap source-table">
              <table id="sourceTable">
                <thead>
                  <tr>
                    <th>Data Point</th>
                    <th>Value</th>
                    <th>As Of</th>
                    <th>Confidence</th>
                    <th>Source</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <div id="contextMenu" class="context-menu">
    <button data-action="p1">Set Priority P1</button>
    <button data-action="p2">Set Priority P2</button>
    <button data-action="p3">Set Priority P3</button>
    <button data-action="watch">Toggle Watchlist Flag</button>
    <button data-action="duplicate">Duplicate Desk Row</button>
    <button data-action="delete">Delete Desk Row</button>
  </div>

  <script>
    const STORAGE_KEY = "wf_cib_risk_dashboard_exec_2026_v1";
    const LAYOUT_STORAGE_KEY = `${STORAGE_KEY}_layout_v1`;
    const TODAY = "2026-02-12";

    const DEFAULT_STATE = {
      metadata: {
        institutionName: "Wells-Style CIB (Public Data Seed)",
        dataSnapshotDate: TODAY,
        enterpriseFTE: 216906,
        cibSharePct: 8.7,
        autoScale: true,
        lastScenarioKey: "severe_adverse"
      },
      regulatory: {
        companyCet1RatioPct: 10.6,
        companyRwaBn: 1293.4,
        requiredCet1MinPct: 8.5,
        managementBufferBps: 120,
        lcrPct: 121,
        nsfrPct: 116,
        scbPct: 2.5,
        gsibPct: 1.5,
        asOf: "2025-12-31"
      },
      cibPublics: {
        qtrRevenueBn: 4.616,
        qtrNetIncomeBn: 1.639,
        avgLoansBn: 312.866,
        loansBn: 333.509,
        depositsBn: 224.146,
        tradingAssetsBn: 398.491,
        ncoMm: 450,
        provisionMm: 74,
        aclMm: 4228,
        npaMm: 3973,
        asOf: "2025-12-31"
      },
      assumptions: {
        pdStressMultiplier: 2.4,
        lgdAddPp: 18,
        marketLossMultiplier: 2.8,
        ccrShockMultiplier: 1.8,
        rwaInflationPct: 16,
        fundingSpreadShockBps: 55,
        discountRatePct: 10,
        taxRatePct: 24,
        monteCarloRuns: 1000,
        aiAdoptionPct: 65,
        aiModelConfidencePct: 72,
        aiDataQualityPct: 70,
        aiProcessMaturityPct: 68,
        aiControlRetentionPct: 48,
        aiRedeployPct: 35,
        aiImplementationSuccessPct: 78,
        aiSeveranceMonths: 5
      },
      scenarios: [
        { key: "baseline", name: "Baseline / Current Trend", pdMult: 1.0, lgdAdd: 0, marketMult: 1.0, ccrMult: 1.0, rwaInfl: 2, fundingBps: 15, note: "Soft landing with manageable spread volatility." },
        { key: "adverse", name: "Adverse / Credit Re-Widening", pdMult: 1.6, lgdAdd: 8, marketMult: 1.7, ccrMult: 1.3, rwaInfl: 8, fundingBps: 35, note: "Growth downshift with persistent spread pressure." },
        { key: "severe_adverse", name: "Severe Adverse (Fed 2026-style)", pdMult: 2.4, lgdAdd: 18, marketMult: 2.8, ccrMult: 1.8, rwaInfl: 16, fundingBps: 55, note: "Anchored to Fed severe adverse path (equities -58%, CRE -39%, unemployment shock)." },
        { key: "idiosyncratic", name: "Idiosyncratic Counterparty Event", pdMult: 1.25, lgdAdd: 6, marketMult: 2.1, ccrMult: 3.0, rwaInfl: 6, fundingBps: 40, note: "Large counterparty default + volatility spike without full macro recession." },
        { key: "custom", name: "Custom", pdMult: 2.4, lgdAdd: 18, marketMult: 2.8, ccrMult: 1.8, rwaInfl: 16, fundingBps: 55, note: "Editable live with control sliders." }
      ],
      marketTape: [
        { id: "SOFR", label: "SOFR", category: "Funding", fredId: "SOFR", value: 3.65, unit: "%", asOf: "2026-02-11", signal: "neutral", source: "FRED / NY Fed", bands: { direction: "high", warn: 4.5, bad: 5.25 } },
        { id: "DFF", label: "EFFR (DFF)", category: "Funding", fredId: "DFF", value: 3.64, unit: "%", asOf: "2026-02-10", signal: "neutral", source: "FRED / Fed", bands: { direction: "high", warn: 4.5, bad: 5.25 } },
        { id: "DTB3", label: "UST 3M Bill", category: "Rates", fredId: "DTB3", value: 3.6, unit: "%", asOf: "2026-02-10", signal: "neutral", source: "FRED / Treasury", bands: { direction: "high", warn: 4.8, bad: 5.8 } },
        { id: "DGS2", label: "UST 2Y", category: "Rates", fredId: "DGS2", value: 3.45, unit: "%", asOf: "2026-02-10", signal: "neutral", source: "FRED / Treasury", bands: { direction: "high", warn: 4.8, bad: 5.6 } },
        { id: "DGS5", label: "UST 5Y", category: "Rates", fredId: "DGS5", value: 3.7, unit: "%", asOf: "2026-02-10", signal: "neutral", source: "FRED / Treasury", bands: { direction: "high", warn: 4.7, bad: 5.5 } },
        { id: "DGS10", label: "UST 10Y", category: "Rates", fredId: "DGS10", value: 4.16, unit: "%", asOf: "2026-02-10", signal: "watch", source: "FRED / Treasury", bands: { direction: "high", warn: 4.25, bad: 5.0 } },
        { id: "DGS30", label: "UST 30Y", category: "Rates", fredId: "DGS30", value: 4.78, unit: "%", asOf: "2026-02-10", signal: "watch", source: "FRED / Treasury", bands: { direction: "high", warn: 5.0, bad: 5.75 } },
        { id: "T10Y2Y", label: "2s10s Curve", category: "Rates", fredId: "T10Y2Y", value: 0.66, unit: "%", asOf: "2026-02-11", signal: "neutral", source: "FRED", bands: { direction: "low", warn: 0.0, bad: -0.3 } },
        { id: "T5YIE", label: "5Y Breakeven", category: "Inflation", fredId: "T5YIE", value: 2.49, unit: "%", asOf: "2026-02-11", signal: "neutral", source: "FRED", bands: { direction: "outside", lowWarn: 1.8, lowBad: 1.4, highWarn: 3.0, highBad: 3.5 } },
        { id: "T10YIE", label: "10Y Breakeven", category: "Inflation", fredId: "T10YIE", value: 2.32, unit: "%", asOf: "2026-02-11", signal: "neutral", source: "FRED", bands: { direction: "outside", lowWarn: 1.7, lowBad: 1.3, highWarn: 2.9, highBad: 3.3 } },

        { id: "BAMLC0A0CM", label: "US IG OAS", category: "Credit Spreads", fredId: "BAMLC0A0CM", value: 0.77, unit: "%", asOf: "2026-02-11", signal: "watch", source: "FRED / ICE BofA", bands: { direction: "high", warn: 1.2, bad: 1.8 } },
        { id: "BAMLC0A4CBBB", label: "US BBB OAS", category: "Credit Spreads", fredId: "BAMLC0A4CBBB", value: 0.98, unit: "%", asOf: "2026-02-11", signal: "watch", source: "FRED / ICE BofA", bands: { direction: "high", warn: 1.5, bad: 2.2 } },
        { id: "BAMLH0A0HYM2", label: "US HY OAS", category: "Credit Spreads", fredId: "BAMLH0A0HYM2", value: 2.84, unit: "%", asOf: "2026-02-11", signal: "watch", source: "FRED / ICE BofA", bands: { direction: "high", warn: 4.5, bad: 6.5 } },
        { id: "BAMLH0A3HYC", label: "US CCC OAS", category: "Credit Spreads", fredId: "BAMLH0A3HYC", value: 8.85, unit: "%", asOf: "2026-02-11", signal: "watch", source: "FRED / ICE BofA", bands: { direction: "high", warn: 11.5, bad: 15.0 } },
        { id: "BAA10Y", label: "BAA-10Y Spread", category: "Credit Spreads", fredId: "BAA10Y", value: 1.66, unit: "%", asOf: "2026-02-10", signal: "neutral", source: "FRED", bands: { direction: "high", warn: 2.0, bad: 2.8 } },

        { id: "VIXCLS", label: "VIX", category: "Volatility", fredId: "VIXCLS", value: 17.65, unit: "idx", asOf: "2026-02-11", signal: "watch", source: "FRED / Cboe", bands: { direction: "high", warn: 22, bad: 30 } },
        { id: "GVZCLS", label: "Gold Vol (GVZ)", category: "Volatility", fredId: "GVZCLS", value: 29.38, unit: "idx", asOf: "2026-02-11", signal: "neutral", source: "FRED / Cboe", bands: { direction: "high", warn: 34, bad: 42 } },

        { id: "SP500", label: "S&P 500", category: "Equities", fredId: "SP500", value: 6941.47, unit: "idx", asOf: "2026-02-11", signal: "neutral", source: "FRED", bands: { direction: "low", warn: 6000, bad: 5400 } },
        { id: "NASDAQCOM", label: "NASDAQ Composite", category: "Equities", fredId: "NASDAQCOM", value: 23066.47, unit: "idx", asOf: "2026-02-11", signal: "neutral", source: "FRED", bands: { direction: "low", warn: 20000, bad: 18000 } },
        { id: "NIKKEI225", label: "Nikkei 225", category: "Equities", fredId: "NIKKEI225", value: 57639.84, unit: "idx", asOf: "2026-02-12", signal: "neutral", source: "FRED", bands: { direction: "low", warn: 50000, bad: 45000 } },

        { id: "DTWEXBGS", label: "USD Broad Index", category: "FX", fredId: "DTWEXBGS", value: 118.2407, unit: "idx", asOf: "2026-02-06", signal: "neutral", source: "FRED", bands: { direction: "high", warn: 122, bad: 127 } },
        { id: "DEXUSEU", label: "EUR/USD", category: "FX", fredId: "DEXUSEU", value: 1.1812, unit: "spot", asOf: "2026-02-06", signal: "neutral", source: "FRED", bands: { direction: "low", warn: 1.07, bad: 1.02 } },
        { id: "DEXUSUK", label: "GBP/USD", category: "FX", fredId: "DEXUSUK", value: 1.3606, unit: "spot", asOf: "2026-02-06", signal: "neutral", source: "FRED", bands: { direction: "low", warn: 1.24, bad: 1.18 } },
        { id: "DEXJPUS", label: "USD/JPY", category: "FX", fredId: "DEXJPUS", value: 157.1, unit: "spot", asOf: "2026-02-06", signal: "watch", source: "FRED", bands: { direction: "high", warn: 160, bad: 168 } },
        { id: "DEXCHUS", label: "USD/CNY", category: "FX", fredId: "DEXCHUS", value: 6.9388, unit: "spot", asOf: "2026-02-06", signal: "neutral", source: "FRED", bands: { direction: "high", warn: 7.2, bad: 7.4 } },
        { id: "DEXCAUS", label: "USD/CAD", category: "FX", fredId: "DEXCAUS", value: 1.3644, unit: "spot", asOf: "2026-02-06", signal: "neutral", source: "FRED", bands: { direction: "high", warn: 1.42, bad: 1.5 } },
        { id: "DEXMXUS", label: "USD/MXN", category: "FX", fredId: "DEXMXUS", value: 17.2695, unit: "spot", asOf: "2026-02-06", signal: "neutral", source: "FRED", bands: { direction: "high", warn: 19.0, bad: 20.0 } },
        { id: "DEXBZUS", label: "USD/BRL", category: "FX", fredId: "DEXBZUS", value: 5.2183, unit: "spot", asOf: "2026-02-06", signal: "neutral", source: "FRED", bands: { direction: "high", warn: 5.5, bad: 5.9 } },

        { id: "DCOILWTICO", label: "WTI", category: "Commodities", fredId: "DCOILWTICO", value: 64.53, unit: "$/bbl", asOf: "2026-02-09", signal: "neutral", source: "FRED / EIA", bands: { direction: "outside", lowWarn: 50, lowBad: 40, highWarn: 95, highBad: 110 } },
        { id: "DCOILBRENTEU", label: "Brent", category: "Commodities", fredId: "DCOILBRENTEU", value: 71.19, unit: "$/bbl", asOf: "2026-02-09", signal: "neutral", source: "FRED / EIA", bands: { direction: "outside", lowWarn: 55, lowBad: 45, highWarn: 100, highBad: 115 } },
        { id: "DHHNGSP", label: "Henry Hub NatGas", category: "Commodities", fredId: "DHHNGSP", value: 3.25, unit: "$/MMBtu", asOf: "2026-02-09", signal: "neutral", source: "FRED / EIA", bands: { direction: "outside", lowWarn: 2.2, lowBad: 1.7, highWarn: 5.5, highBad: 7.5 } },

        { id: "NFCI", label: "NFCI", category: "Liquidity", fredId: "NFCI", value: -0.56306, unit: "idx", asOf: "2026-02-06", signal: "neutral", source: "FRED / Chicago Fed", bands: { direction: "high", warn: 0.3, bad: 0.8 } },
        { id: "STLFSI4", label: "St. Louis FSI", category: "Liquidity", fredId: "STLFSI4", value: -0.6558, unit: "idx", asOf: "2026-02-06", signal: "neutral", source: "FRED / St. Louis Fed", bands: { direction: "high", warn: 0.4, bad: 1.0 } },
        { id: "KCFSI", label: "Kansas City FSI", category: "Liquidity", fredId: "KCFSI", value: -0.69, unit: "idx", asOf: "2026-01-01", signal: "neutral", source: "FRED / Kansas City Fed", bands: { direction: "high", warn: 0.2, bad: 0.8 } },
        { id: "MORTGAGE15US", label: "US 15Y Mortgage Rate", category: "Housing/Funding", fredId: "MORTGAGE15US", value: 5.44, unit: "%", asOf: "2026-02-12", signal: "neutral", source: "FRED / Freddie Mac", bands: { direction: "high", warn: 6.6, bad: 7.5 } },
        { id: "MORTGAGE30US", label: "US 30Y Mortgage Rate", category: "Housing/Funding", fredId: "MORTGAGE30US", value: 6.09, unit: "%", asOf: "2026-02-12", signal: "neutral", source: "FRED / Freddie Mac", bands: { direction: "high", warn: 7.0, bad: 8.0 } },
        { id: "USEPUINDXD", label: "US Economic Policy Uncertainty", category: "Macro Risk", fredId: "USEPUINDXD", value: 273.49, unit: "idx", asOf: "2026-02-11", signal: "watch", source: "FRED", bands: { direction: "high", warn: 220, bad: 320 } },

        { id: "DGS1", label: "UST 1Y", category: "Rates", fredId: "DGS1", value: 3.47, unit: "%", asOf: "2026-02-11", signal: "neutral", source: "FRED / Treasury", bands: { direction: "high", warn: 4.7, bad: 5.5 } },
        { id: "DGS3", label: "UST 3Y", category: "Rates", fredId: "DGS3", value: 3.55, unit: "%", asOf: "2026-02-11", signal: "neutral", source: "FRED / Treasury", bands: { direction: "high", warn: 4.7, bad: 5.5 } },
        { id: "DGS7", label: "UST 7Y", category: "Rates", fredId: "DGS7", value: 3.96, unit: "%", asOf: "2026-02-11", signal: "neutral", source: "FRED / Treasury", bands: { direction: "high", warn: 4.8, bad: 5.6 } },
        { id: "DGS20", label: "UST 20Y", category: "Rates", fredId: "DGS20", value: 4.76, unit: "%", asOf: "2026-02-11", signal: "watch", source: "FRED / Treasury", bands: { direction: "high", warn: 5.0, bad: 5.8 } },
        { id: "T10Y3M", label: "10Y-3M Curve", category: "Rates", fredId: "T10Y3M", value: 0.48, unit: "%", asOf: "2026-02-11", signal: "neutral", source: "FRED", bands: { direction: "low", warn: 0.0, bad: -0.4 } },

        { id: "BAMLC0A3CA", label: "US A OAS", category: "Credit Spreads", fredId: "BAMLC0A3CA", value: 0.63, unit: "%", asOf: "2026-02-11", signal: "neutral", source: "FRED / ICE BofA", bands: { direction: "high", warn: 1.0, bad: 1.5 } },
        { id: "BAMLEMCBPIOAS", label: "EM Corporate OAS", category: "Credit Spreads", fredId: "BAMLEMCBPIOAS", value: 1.51, unit: "%", asOf: "2026-02-11", signal: "watch", source: "FRED / ICE BofA", bands: { direction: "high", warn: 2.2, bad: 3.5 } },
        { id: "BAMLH0A1HYBB", label: "US HY BB OAS", category: "Credit Spreads", fredId: "BAMLH0A1HYBB", value: 1.68, unit: "%", asOf: "2026-02-11", signal: "watch", source: "FRED / ICE BofA", bands: { direction: "high", warn: 2.8, bad: 4.0 } },
        { id: "BAMLH0A2HYB", label: "US HY B OAS", category: "Credit Spreads", fredId: "BAMLH0A2HYB", value: 3.09, unit: "%", asOf: "2026-02-11", signal: "watch", source: "FRED / ICE BofA", bands: { direction: "high", warn: 4.5, bad: 6.5 } },
        { id: "BAMLHE00EHYIOAS", label: "Euro HY OAS", category: "Credit Spreads", fredId: "BAMLHE00EHYIOAS", value: 2.62, unit: "%", asOf: "2026-02-11", signal: "watch", source: "FRED / ICE BofA", bands: { direction: "high", warn: 4.0, bad: 5.8 } },

        { id: "VXVCLS", label: "VIX 3M (VXV)", category: "Volatility", fredId: "VXVCLS", value: 20.37, unit: "idx", asOf: "2026-02-11", signal: "watch", source: "FRED / Cboe", bands: { direction: "high", warn: 26, bad: 34 } },
        { id: "OVXCLS", label: "Oil Vol (OVX)", category: "Volatility", fredId: "OVXCLS", value: 44.33, unit: "idx", asOf: "2026-02-11", signal: "neutral", source: "FRED / Cboe", bands: { direction: "high", warn: 55, bad: 70 } },
        { id: "VXEEMCLS", label: "EM Equity Vol (VXEEM)", category: "Volatility", fredId: "VXEEMCLS", value: 21.61, unit: "idx", asOf: "2026-02-11", signal: "neutral", source: "FRED / Cboe", bands: { direction: "high", warn: 30, bad: 40 } },

        { id: "DJIA", label: "Dow Jones Industrial Avg", category: "Equities", fredId: "DJIA", value: 50121.4, unit: "idx", asOf: "2026-02-11", signal: "neutral", source: "FRED", bands: { direction: "low", warn: 44000, bad: 40000 } },

        { id: "DEXUSAL", label: "USD/AUD", category: "FX", fredId: "DEXUSAL", value: 0.7014, unit: "spot", asOf: "2026-02-06", signal: "neutral", source: "FRED", bands: { direction: "low", warn: 0.64, bad: 0.6 } },
        { id: "DEXUSNZ", label: "USD/NZD", category: "FX", fredId: "DEXUSNZ", value: 0.602, unit: "spot", asOf: "2026-02-06", signal: "neutral", source: "FRED", bands: { direction: "low", warn: 0.55, bad: 0.5 } },
        { id: "DEXSFUS", label: "USD/ZAR", category: "FX", fredId: "DEXSFUS", value: 16.015, unit: "spot", asOf: "2026-02-06", signal: "neutral", source: "FRED", bands: { direction: "high", warn: 17.5, bad: 19.0 } },
        { id: "DEXINUS", label: "USD/INR", category: "FX", fredId: "DEXINUS", value: 90.65, unit: "spot", asOf: "2026-02-06", signal: "watch", source: "FRED", bands: { direction: "high", warn: 90.0, bad: 95.0 } },
        { id: "DEXKOUS", label: "USD/KRW", category: "FX", fredId: "DEXKOUS", value: 1462.75, unit: "spot", asOf: "2026-02-06", signal: "watch", source: "FRED", bands: { direction: "high", warn: 1450, bad: 1550 } },
        { id: "DEXTAUS", label: "USD/TWD", category: "FX", fredId: "DEXTAUS", value: 31.67, unit: "spot", asOf: "2026-02-06", signal: "neutral", source: "FRED", bands: { direction: "high", warn: 33, bad: 35 } },
        { id: "DEXSIUS", label: "USD/SGD", category: "FX", fredId: "DEXSIUS", value: 1.2713, unit: "spot", asOf: "2026-02-06", signal: "neutral", source: "FRED", bands: { direction: "high", warn: 1.35, bad: 1.45 } },
        { id: "DEXHKUS", label: "USD/HKD", category: "FX", fredId: "DEXHKUS", value: 7.8134, unit: "spot", asOf: "2026-02-06", signal: "neutral", source: "FRED", bands: { direction: "outside", lowWarn: 7.75, lowBad: 7.7, highWarn: 7.85, highBad: 7.9 } },
        { id: "DEXMAUS", label: "USD/MYR", category: "FX", fredId: "DEXMAUS", value: 3.945, unit: "spot", asOf: "2026-02-06", signal: "neutral", source: "FRED", bands: { direction: "high", warn: 4.3, bad: 4.7 } },
        { id: "DEXNOUS", label: "USD/NOK", category: "FX", fredId: "DEXNOUS", value: 9.6642, unit: "spot", asOf: "2026-02-06", signal: "neutral", source: "FRED", bands: { direction: "high", warn: 11.0, bad: 12.0 } }
      ],
      portfolios: [
        { id: "BK-IGC", lob: "Banking", desk: "Investment Grade Corporate", eadBn: 24.8, pdPct: 0.85, lgdPct: 35, criticizedPct: 4.2, nonaccrualPct: 0.3, var1dMm: 18, varLimitMm: 42, ncoAnnualMm: 22, rwaDensityPct: 58, owner: "Portfolio Risk - Banking", priority: "P1", action: "Re-underwrite lower cushion credits before covenant resets.", flagged: false },
        { id: "BK-LF", lob: "Banking", desk: "Leveraged Finance", eadBn: 18.7, pdPct: 2.8, lgdPct: 47, criticizedPct: 11.4, nonaccrualPct: 1.4, var1dMm: 26, varLimitMm: 45, ncoAnnualMm: 48, rwaDensityPct: 84, owner: "Portfolio Risk - Banking", priority: "P1", action: "Tighten sponsor concentration and second-lien appetite.", flagged: true },
        { id: "BK-SF", lob: "Banking", desk: "Sponsor Finance", eadBn: 15.2, pdPct: 2.4, lgdPct: 45, criticizedPct: 10.1, nonaccrualPct: 1.1, var1dMm: 19, varLimitMm: 37, ncoAnnualMm: 39, rwaDensityPct: 82, owner: "Portfolio Risk - Banking", priority: "P1", action: "Accelerate EBITDA downside recuts and watchlist refresh.", flagged: true },
        { id: "BK-TMT", lob: "Banking", desk: "Technology, Media, Telecom", eadBn: 12.1, pdPct: 1.9, lgdPct: 42, criticizedPct: 8.3, nonaccrualPct: 0.8, var1dMm: 14, varLimitMm: 34, ncoAnnualMm: 25, rwaDensityPct: 76, owner: "Portfolio Risk - Banking", priority: "P2", action: "Reprice cash-burn borrowers and reduce covenant-lite structures.", flagged: false },
        { id: "BK-HC", lob: "Banking", desk: "Healthcare and Pharma", eadBn: 9.4, pdPct: 1.2, lgdPct: 37, criticizedPct: 5.5, nonaccrualPct: 0.5, var1dMm: 11, varLimitMm: 28, ncoAnnualMm: 18, rwaDensityPct: 62, owner: "Portfolio Risk - Banking", priority: "P2", action: "Focus on reimbursement-sensitive and trial-stage exposures.", flagged: false },
        { id: "BK-EN", lob: "Banking", desk: "Energy and Power", eadBn: 8.5, pdPct: 2.1, lgdPct: 44, criticizedPct: 8.9, nonaccrualPct: 1.0, var1dMm: 16, varLimitMm: 30, ncoAnnualMm: 30, rwaDensityPct: 81, owner: "Portfolio Risk - Banking", priority: "P1", action: "Tighten reserve-based lending advance rates.", flagged: true },
        { id: "BK-FIG", lob: "Banking", desk: "Financial Institutions Group", eadBn: 10.2, pdPct: 1.1, lgdPct: 34, criticizedPct: 4.7, nonaccrualPct: 0.4, var1dMm: 13, varLimitMm: 27, ncoAnnualMm: 17, rwaDensityPct: 56, owner: "Portfolio Risk - Banking", priority: "P2", action: "Review non-bank leverage and liquidity waterfall documentation.", flagged: false },
        { id: "BK-ABL", lob: "Banking", desk: "Asset-Based Lending", eadBn: 7.9, pdPct: 1.5, lgdPct: 41, criticizedPct: 7.2, nonaccrualPct: 0.7, var1dMm: 9, varLimitMm: 22, ncoAnnualMm: 16, rwaDensityPct: 69, owner: "Portfolio Risk - Banking", priority: "P2", action: "Strengthen borrowing-base audit cadence.", flagged: false },

        { id: "CRE-OFF", lob: "Commercial Real Estate", desk: "Office", eadBn: 29.4, pdPct: 3.8, lgdPct: 52, criticizedPct: 18.5, nonaccrualPct: 2.7, var1dMm: 22, varLimitMm: 40, ncoAnnualMm: 70, rwaDensityPct: 101, owner: "Portfolio Risk - CRE", priority: "P1", action: "Drive sponsor equity injections and accelerate workout decisions.", flagged: true },
        { id: "CRE-MF", lob: "Commercial Real Estate", desk: "Multifamily", eadBn: 25.3, pdPct: 1.4, lgdPct: 36, criticizedPct: 6.4, nonaccrualPct: 0.6, var1dMm: 12, varLimitMm: 29, ncoAnnualMm: 38, rwaDensityPct: 67, owner: "Portfolio Risk - CRE", priority: "P2", action: "Monitor rent-growth deceleration and refinance cliffs.", flagged: false },
        { id: "CRE-IND", lob: "Commercial Real Estate", desk: "Industrial", eadBn: 18.7, pdPct: 1.0, lgdPct: 33, criticizedPct: 4.1, nonaccrualPct: 0.3, var1dMm: 10, varLimitMm: 24, ncoAnnualMm: 16, rwaDensityPct: 58, owner: "Portfolio Risk - CRE", priority: "P3", action: "Maintain discipline on cap-rate assumptions in lower-liquidity markets.", flagged: false },
        { id: "CRE-RET", lob: "Commercial Real Estate", desk: "Retail", eadBn: 12.6, pdPct: 2.7, lgdPct: 47, criticizedPct: 12.2, nonaccrualPct: 1.4, var1dMm: 9, varLimitMm: 20, ncoAnnualMm: 27, rwaDensityPct: 85, owner: "Portfolio Risk - CRE", priority: "P1", action: "Exit weak secondary-mall exposures and tighten DSCR floors.", flagged: true },
        { id: "CRE-HOT", lob: "Commercial Real Estate", desk: "Hospitality", eadBn: 14.2, pdPct: 3.1, lgdPct: 49, criticizedPct: 14.6, nonaccrualPct: 1.9, var1dMm: 11, varLimitMm: 21, ncoAnnualMm: 32, rwaDensityPct: 92, owner: "Portfolio Risk - CRE", priority: "P1", action: "Reassess convention-market hotel assumptions and sponsor liquidity.", flagged: true },
        { id: "CRE-CON", lob: "Commercial Real Estate", desk: "Construction and Land", eadBn: 10.8, pdPct: 2.9, lgdPct: 50, criticizedPct: 13.5, nonaccrualPct: 1.6, var1dMm: 8, varLimitMm: 17, ncoAnnualMm: 25, rwaDensityPct: 95, owner: "Portfolio Risk - CRE", priority: "P1", action: "Tighten loan-to-cost exceptions and completion guarantees.", flagged: true },
        { id: "CRE-DC", lob: "Commercial Real Estate", desk: "Data Centers & Digital Infra", eadBn: 9.9, pdPct: 1.2, lgdPct: 35, criticizedPct: 5.4, nonaccrualPct: 0.4, var1dMm: 9, varLimitMm: 18, ncoAnnualMm: 9, rwaDensityPct: 61, owner: "Portfolio Risk - CRE", priority: "P2", action: "Monitor power pricing pass-through and tenant concentration.", flagged: false },
        { id: "CRE-OTH", lob: "Commercial Real Estate", desk: "Other CRE", eadBn: 6.5, pdPct: 2.0, lgdPct: 44, criticizedPct: 9.2, nonaccrualPct: 1.1, var1dMm: 6, varLimitMm: 14, ncoAnnualMm: 13, rwaDensityPct: 79, owner: "Portfolio Risk - CRE", priority: "P2", action: "Rebaseline appraisal refresh intervals for stress sectors.", flagged: false },

        { id: "MKT-PB", lob: "Markets", desk: "Prime Brokerage Financing", eadBn: 18.6, pdPct: 1.0, lgdPct: 29, criticizedPct: 3.9, nonaccrualPct: 0.2, var1dMm: 39, varLimitMm: 60, ncoAnnualMm: 2, rwaDensityPct: 41, owner: "Counterparty Risk", priority: "P1", action: "Pre-position IM add-ons for high-beta hedge fund books.", flagged: true },
        { id: "MKT-DRV", lob: "Markets", desk: "Derivatives Receivables", eadBn: 16.4, pdPct: 0.8, lgdPct: 27, criticizedPct: 3.4, nonaccrualPct: 0.1, var1dMm: 35, varLimitMm: 58, ncoAnnualMm: 1, rwaDensityPct: 37, owner: "Counterparty Risk", priority: "P1", action: "Increase wrong-way risk overlay on concentrated sectors.", flagged: true },
        { id: "MKT-REPO", lob: "Markets", desk: "Securities Financing / Repo", eadBn: 22.5, pdPct: 0.5, lgdPct: 19, criticizedPct: 2.1, nonaccrualPct: 0.0, var1dMm: 28, varLimitMm: 65, ncoAnnualMm: 0, rwaDensityPct: 22, owner: "Liquidity + CCR", priority: "P2", action: "Tighten collateral eligibility during event windows.", flagged: false },
        { id: "MKT-SC", lob: "Markets", desk: "Structured Credit Warehousing", eadBn: 11.2, pdPct: 2.2, lgdPct: 46, criticizedPct: 8.8, nonaccrualPct: 0.8, var1dMm: 30, varLimitMm: 43, ncoAnnualMm: 2, rwaDensityPct: 89, owner: "Market Risk", priority: "P1", action: "Reduce lower-liquidity inventory and add jump-risk hedges.", flagged: true },
        { id: "MKT-MAC", lob: "Markets", desk: "Macro Trading Inventory", eadBn: 9.8, pdPct: 0.9, lgdPct: 25, criticizedPct: 3.0, nonaccrualPct: 0.1, var1dMm: 42, varLimitMm: 64, ncoAnnualMm: 0, rwaDensityPct: 31, owner: "Market Risk", priority: "P2", action: "Trim long-end duration and increase optional hedges.", flagged: false },
        { id: "MKT-FX", lob: "Markets", desk: "FX and Rates Inventory", eadBn: 8.7, pdPct: 0.7, lgdPct: 24, criticizedPct: 2.7, nonaccrualPct: 0.1, var1dMm: 37, varLimitMm: 59, ncoAnnualMm: 0, rwaDensityPct: 29, owner: "Market Risk", priority: "P2", action: "Limit event-day USD/JPY risk warehousing.", flagged: false },
        { id: "MKT-EQD", lob: "Markets", desk: "Equity Derivatives Exposures", eadBn: 7.4, pdPct: 1.3, lgdPct: 33, criticizedPct: 5.2, nonaccrualPct: 0.2, var1dMm: 33, varLimitMm: 48, ncoAnnualMm: 2, rwaDensityPct: 45, owner: "Market Risk", priority: "P1", action: "Increase downside convexity coverage and tighten concentration bands.", flagged: true },
        { id: "MKT-MUNI", lob: "Markets", desk: "Municipal / EM Financing", eadBn: 4.7, pdPct: 1.8, lgdPct: 41, criticizedPct: 7.1, nonaccrualPct: 0.5, var1dMm: 14, varLimitMm: 24, ncoAnnualMm: 1, rwaDensityPct: 72, owner: "Portfolio Risk - Markets", priority: "P2", action: "Rebalance stressed-liquidity names and shorten tenor.", flagged: false }
      ],
      counterparties: [
        { id: "CP-001", name: "Global Macro Fund A", type: "Hedge Fund", rating: "BBB", eadMm: 1840, pfe95Mm: 2710, limitMm: 3000, utilizationPct: 90.3, wrongWayScore: 8.2, collateralQuality: 3, watch: true },
        { id: "CP-002", name: "Multi-Strategy Fund B", type: "Hedge Fund", rating: "BBB-", eadMm: 1610, pfe95Mm: 2420, limitMm: 2800, utilizationPct: 86.4, wrongWayScore: 7.6, collateralQuality: 3, watch: true },
        { id: "CP-003", name: "Insurance Group C", type: "Insurance", rating: "A", eadMm: 980, pfe95Mm: 1190, limitMm: 2100, utilizationPct: 46.7, wrongWayScore: 3.8, collateralQuality: 4, watch: false },
        { id: "CP-004", name: "Broker Dealer D", type: "Broker Dealer", rating: "A-", eadMm: 1320, pfe95Mm: 2070, limitMm: 2500, utilizationPct: 71.6, wrongWayScore: 5.7, collateralQuality: 4, watch: false },
        { id: "CP-005", name: "Commodity Trader E", type: "Commodity", rating: "BBB", eadMm: 1160, pfe95Mm: 1980, limitMm: 1900, utilizationPct: 98.4, wrongWayScore: 8.7, collateralQuality: 2, watch: true },
        { id: "CP-006", name: "Private Credit Platform F", type: "Private Credit", rating: "BB+", eadMm: 920, pfe95Mm: 1760, limitMm: 1400, utilizationPct: 95.0, wrongWayScore: 8.9, collateralQuality: 2, watch: true },
        { id: "CP-007", name: "Regional Bank G", type: "Bank", rating: "BBB+", eadMm: 730, pfe95Mm: 1010, limitMm: 1800, utilizationPct: 40.6, wrongWayScore: 4.1, collateralQuality: 4, watch: false },
        { id: "CP-008", name: "Sovereign Wealth H", type: "Sovereign", rating: "AA", eadMm: 860, pfe95Mm: 980, limitMm: 2500, utilizationPct: 34.4, wrongWayScore: 2.3, collateralQuality: 5, watch: false },
        { id: "CP-009", name: "Volatility Fund I", type: "Hedge Fund", rating: "BB", eadMm: 680, pfe95Mm: 1430, limitMm: 900, utilizationPct: 95.6, wrongWayScore: 9.1, collateralQuality: 2, watch: true },
        { id: "CP-010", name: "Pension Pool J", type: "Asset Manager", rating: "A", eadMm: 420, pfe95Mm: 610, limitMm: 1300, utilizationPct: 32.3, wrongWayScore: 2.7, collateralQuality: 5, watch: false },
        { id: "CP-011", name: "Broker Dealer K", type: "Broker Dealer", rating: "A", eadMm: 1040, pfe95Mm: 1620, limitMm: 1900, utilizationPct: 85.3, wrongWayScore: 6.9, collateralQuality: 3, watch: true },
        { id: "CP-012", name: "Family Office L", type: "Family Office", rating: "NR", eadMm: 390, pfe95Mm: 890, limitMm: 700, utilizationPct: 95.7, wrongWayScore: 8.4, collateralQuality: 2, watch: true }
      ],
      functionMap: [
        { func: "Portfolio Credit Risk (Banking)", owner: "Head of CIB Portfolio Risk", kpi: "Criticized asset ratio", target: "< 8.0%", status: "Amber", cadence: "Weekly", trigger: "Any core vertical > 10% criticized" },
        { func: "Portfolio Credit Risk (CRE)", owner: "Head of CIB Portfolio Risk", kpi: "Office CRE nonaccrual ratio", target: "< 2.5%", status: "Red", cadence: "Weekly", trigger: "Office nonaccrual > 3.0%" },
        { func: "Counterparty Credit Risk", owner: "Head of CIB Risk", kpi: "Top-20 net EAD utilization", target: "< 80%", status: "Amber", cadence: "Daily", trigger: "Any top counterparty > 95%" },
        { func: "Market Risk", owner: "Head of CIB Risk", kpi: "Total 1D VaR utilization", target: "< 80%", status: "Amber", cadence: "Daily", trigger: "VaR utilization > 90%" },
        { func: "Liquidity and Funding Risk", owner: "Treasury Risk", kpi: "LCR", target: ">= 110%", status: "Green", cadence: "Daily", trigger: "LCR < 105%" },
        { func: "Model Risk and Validation", owner: "Model Risk Management", kpi: "High-priority findings overdue", target: "0", status: "Amber", cadence: "Monthly", trigger: "Any high finding overdue > 30 days" },
        { func: "Operational and Conduct Risk", owner: "Non-Financial Risk", kpi: "Material control breaks", target: "0", status: "Green", cadence: "Weekly", trigger: "2+ linked breaks in quarter" }
      ],
      aiFunctionMap: [
        { func: "Credit Portfolio Monitoring", owner: "Portfolio Risk - Banking", baselineFte: 145, avgComp: 182000, motion: "augment", automationPct: 42, capturePct: 38, implementationMm: 8.2, guardrail: "Human approval on rating migration and watchlist actions", asOf: "2026-02-12" },
        { func: "CRE Covenant Surveillance", owner: "Portfolio Risk - CRE", baselineFte: 118, avgComp: 176000, motion: "augment", automationPct: 47, capturePct: 36, implementationMm: 7.1, guardrail: "Manual escalation on collateral and appraisal exceptions", asOf: "2026-02-12" },
        { func: "Counterparty Exposure Aggregation", owner: "Counterparty Risk", baselineFte: 96, avgComp: 198000, motion: "automate", automationPct: 54, capturePct: 44, implementationMm: 6.8, guardrail: "No automated limit changes without officer sign-off", asOf: "2026-02-12" },
        { func: "XVA and PFE Analytics Prep", owner: "XVA Risk Analytics", baselineFte: 84, avgComp: 224000, motion: "augment", automationPct: 38, capturePct: 31, implementationMm: 7.9, guardrail: "Model validation gate for all parameter updates", asOf: "2026-02-12" },
        { func: "Market Risk Reporting Production", owner: "Market Risk", baselineFte: 112, avgComp: 190000, motion: "automate", automationPct: 56, capturePct: 43, implementationMm: 9.0, guardrail: "Dual-control sign-off for board and regulator packs", asOf: "2026-02-12" },
        { func: "Regulatory Stress Data Aggregation", owner: "Enterprise Risk Analytics", baselineFte: 132, avgComp: 205000, motion: "automate", automationPct: 51, capturePct: 40, implementationMm: 11.4, guardrail: "Lineage + reconciliation controls mandatory", asOf: "2026-02-12" },
        { func: "RWA and Capital Attribution", owner: "Capital Management", baselineFte: 76, avgComp: 214000, motion: "augment", automationPct: 36, capturePct: 28, implementationMm: 5.7, guardrail: "Finance/Risk joint approval for policy overrides", asOf: "2026-02-12" },
        { func: "Limit Framework Monitoring", owner: "Risk Governance", baselineFte: 68, avgComp: 168000, motion: "automate", automationPct: 49, capturePct: 41, implementationMm: 4.6, guardrail: "Threshold breach escalation remains human-led", asOf: "2026-02-12" },
        { func: "Model Risk Finding Triage", owner: "Model Risk Management", baselineFte: 54, avgComp: 186000, motion: "augment", automationPct: 44, capturePct: 33, implementationMm: 3.8, guardrail: "Final model challenge decisions cannot be automated", asOf: "2026-02-12" },
        { func: "Collateral Dispute Operations", owner: "Collateral Management", baselineFte: 88, avgComp: 154000, motion: "automate", automationPct: 58, capturePct: 45, implementationMm: 5.1, guardrail: "Dispute closure still requires bilateral human confirmation", asOf: "2026-02-12" },
        { func: "Control Testing and QA", owner: "Non-Financial Risk", baselineFte: 102, avgComp: 160000, motion: "augment", automationPct: 41, capturePct: 32, implementationMm: 5.5, guardrail: "Independent assurance sign-off preserved", asOf: "2026-02-12" },
        { func: "Board Pack Narrative Drafting", owner: "Risk COO", baselineFte: 36, avgComp: 172000, motion: "augment", automationPct: 63, capturePct: 50, implementationMm: 2.2, guardrail: "Executive review and fact-check before release", asOf: "2026-02-12" }
      ],
      riskRoleCatalog: [
        { id: "ROLE-MRO", function: "Model Risk and Validation", role: "Model Risk Officer (MRO)", owner: "Model Risk Management", baselineFte: 22, avgComp: 265000, modelablePct: 34, controlRetentionPct: 72, timelineMonths: 18, dependency: "Policy interpretation copilot + governance workflow", governanceGate: "Model committee sign-off" },
        { id: "ROLE-MR-SM", function: "Market Risk", role: "Market Risk Senior Manager", owner: "Head of CIB Risk", baselineFte: 28, avgComp: 310000, modelablePct: 29, controlRetentionPct: 70, timelineMonths: 15, dependency: "Limit monitoring assistant + scenario cockpit", governanceGate: "Risk leadership approval" },
        { id: "ROLE-MR-ANL", function: "Market Risk", role: "Market Risk Analyst", owner: "Market Risk", baselineFte: 86, avgComp: 182000, modelablePct: 58, controlRetentionPct: 52, timelineMonths: 10, dependency: "Automated PnL explain + sensitivity pipelines", governanceGate: "Desk-level control testing" },
        { id: "ROLE-RA-SR", function: "Regulatory Stress Data Aggregation", role: "Risk Analytics Senior Associate", owner: "Enterprise Risk Analytics", baselineFte: 74, avgComp: 201000, modelablePct: 62, controlRetentionPct: 49, timelineMonths: 11, dependency: "Data lineage automation + reconciliation agents", governanceGate: "Data QA attestation" },
        { id: "ROLE-RA-MGR", function: "Regulatory Stress Data Aggregation", role: "Risk Analytics Manager", owner: "Enterprise Risk Analytics", baselineFte: 34, avgComp: 248000, modelablePct: 42, controlRetentionPct: 61, timelineMonths: 13, dependency: "Stress-run orchestration and controls", governanceGate: "Model validation checkpoint" },
        { id: "ROLE-CP-SM", function: "Counterparty Credit Risk", role: "Counterparty Risk Senior Manager", owner: "Counterparty Risk", baselineFte: 24, avgComp: 282000, modelablePct: 33, controlRetentionPct: 68, timelineMonths: 14, dependency: "Exposure concentration cockpit + alerts", governanceGate: "Credit officer sign-off" },
        { id: "ROLE-CP-ANL", function: "Counterparty Credit Risk", role: "Counterparty Risk Analyst", owner: "Counterparty Risk", baselineFte: 92, avgComp: 176000, modelablePct: 57, controlRetentionPct: 51, timelineMonths: 9, dependency: "PFE explainability and collateral AI triage", governanceGate: "Override audit trail enabled" },
        { id: "ROLE-PC-BNK", function: "Portfolio Credit Risk (Banking)", role: "Portfolio Risk Analyst - Banking", owner: "Portfolio Risk - Banking", baselineFte: 96, avgComp: 171000, modelablePct: 54, controlRetentionPct: 53, timelineMonths: 10, dependency: "Credit migration assistant", governanceGate: "Manual challenge rights retained" },
        { id: "ROLE-PC-CRE", function: "Portfolio Credit Risk (CRE)", role: "Portfolio Risk Analyst - CRE", owner: "Portfolio Risk - CRE", baselineFte: 88, avgComp: 168000, modelablePct: 52, controlRetentionPct: 56, timelineMonths: 11, dependency: "Covenant extraction and appraisal AI", governanceGate: "CRE policy committee review" },
        { id: "ROLE-XVA-Q", function: "XVA and PFE Analytics Prep", role: "XVA Quant", owner: "XVA Risk Analytics", baselineFte: 31, avgComp: 340000, modelablePct: 38, controlRetentionPct: 64, timelineMonths: 14, dependency: "Code-assist + scenario generation toolkit", governanceGate: "Independent model validation" },
        { id: "ROLE-XVA-ANL", function: "XVA and PFE Analytics Prep", role: "XVA Analyst", owner: "XVA Risk Analytics", baselineFte: 57, avgComp: 196000, modelablePct: 55, controlRetentionPct: 52, timelineMonths: 10, dependency: "PFE workflow automation", governanceGate: "Limit policy backtesting" },
        { id: "ROLE-CAP-MGR", function: "RWA and Capital Attribution", role: "Capital Attribution Manager", owner: "Capital Management", baselineFte: 26, avgComp: 278000, modelablePct: 35, controlRetentionPct: 66, timelineMonths: 15, dependency: "RWA explain engine", governanceGate: "Finance-Risk joint sign-off" },
        { id: "ROLE-CAP-ANL", function: "RWA and Capital Attribution", role: "Capital Attribution Analyst", owner: "Capital Management", baselineFte: 63, avgComp: 184000, modelablePct: 53, controlRetentionPct: 54, timelineMonths: 11, dependency: "Capital drilldown automation", governanceGate: "Quarterly control testing" },
        { id: "ROLE-COLL-SM", function: "Collateral Dispute Operations", role: "Collateral Operations Senior Manager", owner: "Collateral Management", baselineFte: 17, avgComp: 236000, modelablePct: 31, controlRetentionPct: 69, timelineMonths: 12, dependency: "Dispute workflow engine", governanceGate: "Legal + ops approval" },
        { id: "ROLE-COLL-ANL", function: "Collateral Dispute Operations", role: "Collateral Operations Analyst", owner: "Collateral Management", baselineFte: 71, avgComp: 149000, modelablePct: 64, controlRetentionPct: 48, timelineMonths: 8, dependency: "T+0 exception triage bot", governanceGate: "Dual control for dispute closure" },
        { id: "ROLE-NFR-TEST", function: "Control Testing and QA", role: "Control Testing Specialist", owner: "Non-Financial Risk", baselineFte: 61, avgComp: 154000, modelablePct: 51, controlRetentionPct: 57, timelineMonths: 10, dependency: "Automated test evidence harvesting", governanceGate: "Independent assurance review" },
        { id: "ROLE-NFR-MGR", function: "Control Testing and QA", role: "Operational Risk Manager", owner: "Non-Financial Risk", baselineFte: 21, avgComp: 232000, modelablePct: 33, controlRetentionPct: 69, timelineMonths: 13, dependency: "Issue management copilot", governanceGate: "Committee sign-off" },
        { id: "ROLE-COO-BRD", function: "Board Pack Narrative Drafting", role: "Risk COO Reporting Lead", owner: "Risk COO", baselineFte: 19, avgComp: 214000, modelablePct: 66, controlRetentionPct: 43, timelineMonths: 7, dependency: "Narrative generation + evidence linker", governanceGate: "Executive final review" }
      ],
      aiResearch: [
        { title: "WEF Future of Jobs Report 2025", keyPoint: "Financial services remains one of the most AI-exposed knowledge sectors with strong reskilling requirement.", asOf: "2025-01-07", relevance: "Workforce transition baseline", url: "https://www.weforum.org/publications/the-future-of-jobs-report-2025/" },
        { title: "IMF SDN: GenAI and the Future of Work", keyPoint: "Large share of advanced-economy tasks can be augmented; policy and governance shape realized gains.", asOf: "2024-01-14", relevance: "Macro labor-impact assumptions", url: "https://www.imf.org/en/Publications/SDN/Issues/2024/01/14/GenAI-Artificial-Intelligence-and-the-Future-of-Work-542379" },
        { title: "OpenAI/OpenResearch GPT Exposure Paper", keyPoint: "Task-level exposure in white-collar roles is material; impact depends on process redesign.", asOf: "2023-03-17", relevance: "Task decomposition lens", url: "https://arxiv.org/abs/2303.10130" },
        { title: "McKinsey GenAI Economic Potential", keyPoint: "Banking and capital-markets functions show substantial productivity potential under disciplined implementation.", asOf: "2023-06-14", relevance: "Benefit-range calibration", url: "https://www.mckinsey.com/capabilities/mckinsey-digital/our-insights/the-economic-potential-of-generative-ai-the-next-productivity-frontier" },
        { title: "Federal Reserve 2026 Stress Scenario Parameters", keyPoint: "Severe adverse calibration for capital stress and macro shock consistency.", asOf: "2026-02-04", relevance: "Risk scenario alignment", url: "https://www.federalreserve.gov/newsevents/pressreleases/bcreg20260204a.htm" },
        { title: "Federal Reserve 2025 Stress Test Results", keyPoint: "Firm-level stress resilience outcomes anchor capital interpretation ranges.", asOf: "2025-06-27", relevance: "Capital headroom benchmarking", url: "https://www.federalreserve.gov/newsevents/pressreleases/bcreg20250627a.htm" },
        { title: "US BLS Occupational Outlook Handbook", keyPoint: "Occupational trend baselines for workforce planning and role-transition realism.", asOf: "2025-09-04", relevance: "Role demand trajectory context", url: "https://www.bls.gov/ooh/" },
        { title: "NIST AI Risk Management Framework", keyPoint: "Governance controls for safe, accountable AI deployment in high-impact workflows.", asOf: "2024-02-26", relevance: "Control guardrail design", url: "https://www.nist.gov/itl/ai-risk-management-framework" }
      ],
      initiatives: [
        { id: "INIT-1", name: "Office CRE Remediation Wave 2", owner: "Head of CIB Portfolio Risk", start: "2026-02-15", end: "2026-05-30", phase: "Quick Wins", dependency: "Updated appraisals complete" },
        { id: "INIT-2", name: "Leveraged Finance Underwriting Reset", owner: "Portfolio Risk - Banking", start: "2026-02-20", end: "2026-06-15", phase: "Phase 1", dependency: "Policy committee approval" },
        { id: "INIT-3", name: "Counterparty IM Overlay Program", owner: "Head of CIB Risk", start: "2026-02-18", end: "2026-04-30", phase: "Quick Wins", dependency: "Legal CSA amendment sequence" },
        { id: "INIT-4", name: "Stress Testing Data Lineage Upgrade", owner: "Enterprise Risk Analytics", start: "2026-03-01", end: "2026-08-30", phase: "Phase 1", dependency: "Data engineering resources" },
        { id: "INIT-5", name: "Cross-Stripe Liquidity Stress Drill", owner: "Treasury Risk", start: "2026-02-25", end: "2026-03-31", phase: "Quick Wins", dependency: "Ops runbook sign-off" },
        { id: "INIT-6", name: "Risk Appetite Framework Refresh", owner: "Head of CIB Risk", start: "2026-04-05", end: "2026-07-25", phase: "Phase 2", dependency: "Board Risk Committee calendar" }
      ],
      sources: [
        {
          point: "CIB revenue, loans, deposits, trading assets, NCO, ACL, NPA",
          value: "Q4 2025 supplement set",
          asOf: "2025-12-31",
          confidence: "High",
          url: "https://www.wellsfargo.com/about/investor-relations/quarterly-earnings/"
        },
        {
          point: "CET1 10.6%, RWA 1,293.4Bn",
          value: "Standardized capital metrics",
          asOf: "2025-12-31",
          confidence: "High",
          url: "https://www.wellsfargo.com/about/investor-relations/quarterly-earnings/"
        },
        {
          point: "LCR 121%, SCB 2.50%, G-SIB 1.50% context",
          value: "Regulatory disclosures",
          asOf: "2025-09-30 to 2025-10-01 effective window",
          confidence: "High",
          url: "https://www.wellsfargo.com/about/investor-relations/sec-filings/"
        },
        {
          point: "Fed severe adverse parameters (equities -58%, CRE -39%, unemployment shock)",
          value: "2026 supervisory scenario",
          asOf: "2026-02-04",
          confidence: "High",
          url: "https://www.federalreserve.gov/newsevents/pressreleases/bcreg20260204a.htm"
        },
        {
          point: "Fed 2025 stress test firm-level results",
          value: "Wells min CET1 in Fed exercise",
          asOf: "2025-06-27",
          confidence: "High",
          url: "https://www.federalreserve.gov/newsevents/pressreleases/bcreg20250627a.htm"
        },
        {
          point: "Asset cap removal enforcement action",
          value: "Operational and governance context",
          asOf: "2025-06-03",
          confidence: "High",
          url: "https://www.federalreserve.gov/newsevents/pressreleases/enforcement20250603a.htm"
        },
        {
          point: "Comprehensive market monitor (rates, spreads, vol, FX, equities, commodities, liquidity)",
          value: "FRED series-set with one-click refresh and as-of stamps per indicator",
          asOf: "2026-02-06 to 2026-02-12",
          confidence: "High",
          url: "https://fred.stlouisfed.org"
        },
        {
          point: "Desk-level granular split inside each CIB line",
          value: "Analyst allocation calibrated to public segment totals",
          asOf: "2026-02-12 model build",
          confidence: "Medium",
          url: "https://www.wellsfargo.com/about/investor-relations/quarterly-earnings/"
        }
      ]
    };

    let state = deepClone(DEFAULT_STATE);
    let model = null;
    let undoStack = [];
    let redoStack = [];
    let activeTab = "overview";
    let contextRowId = null;
    let layoutEditMode = false;
    let draggedPanelId = null;
    let defaultLayoutSnapshot = null;
    let layoutPersistTimer = null;
    let panelResizeObserver = null;
    const renderedTabs = new Set();
    const charts = {};
    let latestRoleModel = null;

    function deepClone(obj) {
      return JSON.parse(JSON.stringify(obj));
    }

    function ensureStateCompleteness(target) {
      if (!target || typeof target !== "object") return;
      if (!target.metadata || typeof target.metadata !== "object") {
        target.metadata = deepClone(DEFAULT_STATE.metadata);
      } else {
        target.metadata = { ...deepClone(DEFAULT_STATE.metadata), ...target.metadata };
      }
      if (!target.assumptions || typeof target.assumptions !== "object") {
        target.assumptions = deepClone(DEFAULT_STATE.assumptions);
      } else {
        target.assumptions = { ...deepClone(DEFAULT_STATE.assumptions), ...target.assumptions };
      }
      if (!target.regulatory || typeof target.regulatory !== "object") {
        target.regulatory = deepClone(DEFAULT_STATE.regulatory);
      } else {
        target.regulatory = { ...deepClone(DEFAULT_STATE.regulatory), ...target.regulatory };
      }
      if (!Array.isArray(target.marketTape) || target.marketTape.length < 20) {
        target.marketTape = deepClone(DEFAULT_STATE.marketTape);
      } else {
        const defaultsById = Object.fromEntries(DEFAULT_STATE.marketTape.map((row) => [row.id, row]));
        target.marketTape = target.marketTape.map((row) => {
          const base = defaultsById[row.id];
          return base ? { ...base, ...row } : row;
        });
        Object.keys(defaultsById).forEach((id) => {
          if (!target.marketTape.some((row) => row.id === id)) {
            target.marketTape.push(deepClone(defaultsById[id]));
          }
        });
      }

      if (!Array.isArray(target.aiFunctionMap) || !target.aiFunctionMap.length) {
        target.aiFunctionMap = deepClone(DEFAULT_STATE.aiFunctionMap);
      }
      if (!Array.isArray(target.functionMap) || !target.functionMap.length) {
        target.functionMap = deepClone(DEFAULT_STATE.functionMap);
      }
      if (!Array.isArray(target.riskRoleCatalog) || !target.riskRoleCatalog.length) {
        target.riskRoleCatalog = deepClone(DEFAULT_STATE.riskRoleCatalog);
      } else {
        const defaultsById = Object.fromEntries(DEFAULT_STATE.riskRoleCatalog.map((row) => [row.id, row]));
        target.riskRoleCatalog = target.riskRoleCatalog.map((row) => {
          const base = defaultsById[row.id];
          return base ? { ...base, ...row } : row;
        });
        Object.keys(defaultsById).forEach((id) => {
          if (!target.riskRoleCatalog.some((row) => row.id === id)) {
            target.riskRoleCatalog.push(deepClone(defaultsById[id]));
          }
        });
      }
      if (!Array.isArray(target.aiResearch) || !target.aiResearch.length) {
        target.aiResearch = deepClone(DEFAULT_STATE.aiResearch);
      }
    }

    function pushUndo() {
      undoStack.push(deepClone(state));
      if (undoStack.length > 120) undoStack.shift();
      redoStack = [];
    }

    function applyStateMutation(mutator) {
      pushUndo();
      mutator(state);
      refreshAll();
    }

    function safeNumber(v, fallback = 0) {
      const num = Number(v);
      return Number.isFinite(num) ? num : fallback;
    }

    function formatNum(v, digits = 1) {
      return Number(v || 0).toLocaleString(undefined, { maximumFractionDigits: digits, minimumFractionDigits: digits });
    }

    function formatInt(v) {
      return Number(v || 0).toLocaleString(undefined, { maximumFractionDigits: 0 });
    }

    function formatMoneyBn(v) {
      return `$${formatNum(v, 2)}Bn`;
    }

    function formatMoneyMm(v) {
      return `$${formatNum(v, 1)}MM`;
    }

    function fmtPct(v, d = 1) {
      return `${formatNum(v, d)}%`;
    }

    function toRiskScore(row) {
      const varUtil = row.varLimitMm > 0 ? (row.var1dMm / row.varLimitMm) * 100 : 0;
      return Math.min(100, Math.max(0,
        row.pdPct * 13 +
        row.lgdPct * 0.5 +
        row.criticizedPct * 1.8 +
        row.nonaccrualPct * 8 +
        varUtil * 0.25
      ));
    }

    function lobColor(score) {
      if (score >= 80) return "#e74c3c";
      if (score >= 65) return "#f5a623";
      if (score >= 50) return "#23b7a4";
      return "#00c896";
    }

    function currentScenario() {
      const key = state.metadata.lastScenarioKey;
      const scenario = state.scenarios.find((s) => s.key === key) || state.scenarios[0];
      const custom = state.assumptions;
      if (key === "custom") {
        return {
          ...scenario,
          pdMult: custom.pdStressMultiplier,
          lgdAdd: custom.lgdAddPp,
          marketMult: custom.marketLossMultiplier,
          ccrMult: custom.ccrShockMultiplier,
          rwaInfl: custom.rwaInflationPct,
          fundingBps: custom.fundingSpreadShockBps
        };
      }
      return scenario;
    }

    function recomputeModel() {
      const portfolios = state.portfolios;
      const counterparties = state.counterparties;
      const scen = currentScenario();

      let totalEadBn = 0;
      let totalVarMm = 0;
      let totalVarLimitMm = 0;
      let totalNcoMm = 0;
      let totalExpectedLossMm = 0;
      let totalStressLossMm = 0;
      let totalRiskWeightedScore = 0;

      const byLob = {};

      portfolios.forEach((row) => {
        const eadMm = row.eadBn * 1000;
        const elMm = eadMm * (row.pdPct / 100) * (row.lgdPct / 100);
        const stressPd = row.pdPct * scen.pdMult;
        const stressLgd = row.lgdPct + scen.lgdAdd;
        const stressLossMm = eadMm * (stressPd / 100) * (Math.max(1, stressLgd) / 100);
        const riskScore = toRiskScore(row);

        row._elMm = elMm;
        row._stressLossMm = stressLossMm;
        row._riskScore = riskScore;

        totalEadBn += row.eadBn;
        totalVarMm += row.var1dMm;
        totalVarLimitMm += row.varLimitMm;
        totalNcoMm += row.ncoAnnualMm;
        totalExpectedLossMm += elMm;
        totalStressLossMm += stressLossMm;
        totalRiskWeightedScore += riskScore * row.eadBn;

        if (!byLob[row.lob]) {
          byLob[row.lob] = {
            eadBn: 0,
            elMm: 0,
            stressMm: 0,
            varMm: 0,
            ncoMm: 0,
            weightedRisk: 0
          };
        }
        byLob[row.lob].eadBn += row.eadBn;
        byLob[row.lob].elMm += elMm;
        byLob[row.lob].stressMm += stressLossMm;
        byLob[row.lob].varMm += row.var1dMm;
        byLob[row.lob].ncoMm += row.ncoAnnualMm;
        byLob[row.lob].weightedRisk += riskScore * row.eadBn;
      });

      Object.keys(byLob).forEach((lob) => {
        const item = byLob[lob];
        item.riskScore = item.eadBn > 0 ? item.weightedRisk / item.eadBn : 0;
      });

      const cet1CapitalBnStart = state.regulatory.companyCet1RatioPct / 100 * state.regulatory.companyRwaBn;
      const totalVarShockMm = totalVarMm * scen.marketMult * Math.sqrt(10);
      const stressedCcrMm = counterparties.reduce((acc, cp) => {
        const utilization = cp.limitMm > 0 ? (cp.eadMm / cp.limitMm) * 100 : cp.utilizationPct;
        const breachAddOn = Math.max(0, utilization - 80) * 2.6;
        const wwrAddOn = cp.wrongWayScore * 18;
        return acc + (cp.pfe95Mm * 0.025 * scen.ccrMult + breachAddOn + wwrAddOn);
      }, 0);
      const fundingDragMm = totalEadBn * 1000 * (scen.fundingBps / 10000) * 0.18;

      const creditLossBn = totalStressLossMm / 1000;
      const marketLossBn = totalVarShockMm / 1000;
      const ccrLossBn = stressedCcrMm / 1000;
      const fundingLossBn = fundingDragMm / 1000;
      const totalPreTaxBn = creditLossBn + marketLossBn + ccrLossBn + fundingLossBn;
      const afterTaxBn = totalPreTaxBn * (1 - state.assumptions.taxRatePct / 100);

      const stressedRwaBn = state.regulatory.companyRwaBn * (1 + scen.rwaInfl / 100);
      const stressedCet1CapitalBn = Math.max(0, cet1CapitalBnStart - afterTaxBn);
      const stressedCet1Pct = stressedRwaBn > 0 ? stressedCet1CapitalBn / stressedRwaBn * 100 : 0;
      const requiredPlusBuffer = state.regulatory.requiredCet1MinPct + state.regulatory.managementBufferBps / 100;
      const cet1HeadroomBps = (stressedCet1Pct - requiredPlusBuffer) * 100;

      const cibFTE = Math.round(state.metadata.enterpriseFTE * state.metadata.cibSharePct / 100);
      const fteScale = state.metadata.enterpriseFTE / DEFAULT_STATE.metadata.enterpriseFTE;
      const avgRiskScore = totalEadBn > 0 ? totalRiskWeightedScore / totalEadBn : 0;
      const varUtilPct = totalVarLimitMm > 0 ? totalVarMm / totalVarLimitMm * 100 : 0;

      const topElRows = [...portfolios].sort((a, b) => b._elMm - a._elMm).slice(0, 8);
      const topRiskRows = [...portfolios].sort((a, b) => b._riskScore - a._riskScore).slice(0, 8);
      const topWatchCounterparties = [...counterparties]
        .sort((a, b) => (b.utilizationPct + b.wrongWayScore * 4) - (a.utilizationPct + a.wrongWayScore * 4))
        .slice(0, 8);

      return {
        scen,
        byLob,
        totalEadBn,
        totalVarMm,
        totalVarLimitMm,
        totalNcoMm,
        totalExpectedLossMm,
        totalStressLossMm,
        totalVarShockMm,
        stressedCcrMm,
        fundingDragMm,
        creditLossBn,
        marketLossBn,
        ccrLossBn,
        fundingLossBn,
        totalPreTaxBn,
        afterTaxBn,
        stressedCet1Pct,
        cet1HeadroomBps,
        requiredPlusBuffer,
        stressedRwaBn,
        cet1CapitalBnStart,
        stressedCet1CapitalBn,
        cibFTE,
        fteScale,
        avgRiskScore,
        varUtilPct,
        topElRows,
        topRiskRows,
        topWatchCounterparties
      };
    }

    function statusFromValue(current, amber, red, direction = "high") {
      if (direction === "low") {
        if (current <= red) return "Red";
        if (current <= amber) return "Amber";
        return "Green";
      }
      if (current >= red) return "Red";
      if (current >= amber) return "Amber";
      return "Green";
    }

    function statusClass(status) {
      if (status === "Green") return "good";
      if (status === "Amber") return "warn";
      return "bad";
    }

    function slugify(text) {
      return String(text || "")
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/^-+|-+$/g, "") || "panel";
    }

    function hasSectionChildren(el) {
      return Array.from(el.children || []).some((child) => child.classList && child.classList.contains("section"));
    }

    function panelContainers() {
      return Array.from(document.querySelectorAll(".tab, .tab .grid-2, .tab .split")).filter((el) => hasSectionChildren(el));
    }

    function panelElements() {
      return Array.from(document.querySelectorAll(".tab .section"));
    }

    function ensureLayoutMetadata() {
      const perContainer = {};
      panelContainers().forEach((container) => {
        if (!container.dataset.layoutContainerId) {
          const tabId = container.closest(".tab")?.id || "tab";
          const kind = container.classList.contains("grid-2") ? "grid2" : container.classList.contains("split") ? "split" : "tab";
          perContainer[`${tabId}-${kind}`] = (perContainer[`${tabId}-${kind}`] || 0) + 1;
          container.dataset.layoutContainerId = `${tabId}-${kind}-${perContainer[`${tabId}-${kind}`]}`;
        }
      });

      const seen = {};
      panelElements().forEach((panel, idx) => {
        if (!panel.dataset.panelId) {
          const tabId = panel.closest(".tab")?.id || "tab";
          const heading = panel.querySelector("h2")?.textContent?.trim() || panel.querySelector("h3")?.textContent?.trim() || `panel-${idx + 1}`;
          const base = `${tabId}-${slugify(heading)}`;
          seen[base] = (seen[base] || 0) + 1;
          panel.dataset.panelId = seen[base] === 1 ? base : `${base}-${seen[base]}`;
        }
      });
    }

    function captureLayoutSnapshot() {
      const order = {};
      panelContainers().forEach((container) => {
        order[container.dataset.layoutContainerId] = Array.from(container.children)
          .filter((child) => child.classList && child.classList.contains("section"))
          .map((child) => child.dataset.panelId);
      });

      const sizes = {};
      panelElements().forEach((panel) => {
        sizes[panel.dataset.panelId] = {
          width: panel.style.width || "",
          height: panel.style.height || ""
        };
      });

      return { order, sizes };
    }

    function applyLayoutSnapshot(snapshot) {
      if (!snapshot || typeof snapshot !== "object") return;
      const byId = {};
      panelElements().forEach((panel) => {
        byId[panel.dataset.panelId] = panel;
      });

      panelContainers().forEach((container) => {
        const ids = snapshot.order?.[container.dataset.layoutContainerId];
        if (!Array.isArray(ids) || !ids.length) return;
        ids.forEach((id) => {
          const panel = byId[id];
          if (panel && panel.parentElement === container) {
            container.appendChild(panel);
          }
        });
      });

      panelElements().forEach((panel) => {
        const saved = snapshot.sizes?.[panel.dataset.panelId];
        if (!saved) return;
        panel.style.width = saved.width || "";
        panel.style.height = saved.height || "";
      });
    }

    function saveLayoutSnapshot() {
      try {
        localStorage.setItem(LAYOUT_STORAGE_KEY, JSON.stringify(captureLayoutSnapshot()));
      } catch {
        // Keep app functional even if browser storage is unavailable.
      }
    }

    function queueLayoutSave() {
      clearTimeout(layoutPersistTimer);
      layoutPersistTimer = setTimeout(() => {
        saveLayoutSnapshot();
      }, 180);
    }

    function loadSavedLayoutSnapshot() {
      try {
        const raw = localStorage.getItem(LAYOUT_STORAGE_KEY);
        if (!raw) return null;
        return JSON.parse(raw);
      } catch {
        return null;
      }
    }

    function setLayoutEditMode(enabled) {
      layoutEditMode = !!enabled;
      document.body.classList.toggle("layout-edit", layoutEditMode);
      const btn = document.getElementById("layoutEditBtn");
      if (btn) {
        btn.textContent = `Layout Edit: ${layoutEditMode ? "ON" : "OFF"}`;
      }
      panelElements().forEach((panel) => {
        panel.draggable = layoutEditMode;
      });
      if (!layoutEditMode) {
        queueLayoutSave();
      }
    }

    const PLOT_CFG = {
      displayModeBar: true,
      responsive: true,
      scrollZoom: true,
      doubleClick: "reset+autosize",
      modeBarButtonsToRemove: ["lasso2d", "select2d", "hoverCompareCartesian", "toggleSpikelines"]
    };

    function chartHeight(size = "default", rowCount = 0) {
      const vh = Math.max(740, window.innerHeight || 900);
      if (size === "small") {
        return Math.round(Math.max(250, Math.min(380, vh * 0.36)));
      }
      if (size === "large") {
        const rowDriven = rowCount > 0 ? Math.min(620, 180 + rowCount * 18) : 0;
        return Math.round(Math.max(360, Math.min(620, rowDriven || vh * 0.5)));
      }
      return Math.round(Math.max(300, Math.min(500, vh * 0.44)));
    }

    function constrainPlotContainer(id, size = "default", rowCount = 0) {
      const el = document.getElementById(id);
      if (!el) return 0;
      const height = chartHeight(size, rowCount);
      el.style.height = `${height}px`;
      el.style.maxHeight = `${height}px`;
      el.style.minHeight = `${Math.max(230, Math.round(height * 0.75))}px`;
      el.dataset.plotSize = size;
      el.dataset.plotRows = String(rowCount || 0);
      return height;
    }

    function withPlotLayout(layout, size = "default", rowCount = 0) {
      const height = chartHeight(size, rowCount);
      return {
        ...layout,
        autosize: false,
        dragmode: layout?.dragmode || "zoom",
        hovermode: layout?.hovermode || "closest",
        height
      };
    }

    function plotReact(id, traces, layout, size = "default", rowCount = 0) {
      if (!window.Plotly) return;
      constrainPlotContainer(id, size, rowCount);
      Plotly.react(id, traces, withPlotLayout(layout, size, rowCount), PLOT_CFG);
    }

    function chartZoomOptions(mode = "xy") {
      return {
        pan: {
          enabled: true,
          mode,
          modifierKey: "shift"
        },
        zoom: {
          mode,
          wheel: { enabled: true, speed: 0.08 },
          drag: {
            enabled: true,
            borderColor: "rgba(85,180,255,0.8)",
            backgroundColor: "rgba(85,180,255,0.12)"
          },
          pinch: { enabled: true }
        },
        limits: {
          x: { min: "original", max: "original" },
          y: { min: "original", max: "original" }
        }
      };
    }

    function bindChartReset(canvasId, chartKey) {
      const canvas = document.getElementById(canvasId);
      if (!canvas || canvas.dataset.zoomResetBound === "1") return;
      canvas.dataset.zoomResetBound = "1";
      canvas.addEventListener("dblclick", () => {
        const chart = charts[chartKey];
        if (chart && typeof chart.resetZoom === "function") {
          chart.resetZoom();
        }
      });
    }

    function safePlotResize(id) {
      try {
        const el = document.getElementById(id);
        if (el && window.Plotly) {
          const size = el.dataset.plotSize || "default";
          const rows = safeNumber(el.dataset.plotRows, 0);
          const height = constrainPlotContainer(id, size, rows);
          Plotly.relayout(el, { height });
          Plotly.Plots.resize(el);
        }
      } catch {
        // Keep dashboard stable even if one chart resize fails.
      }
    }

    function resizeActivePlots() {
      if (activeTab === "overview") {
        safePlotResize("treemapPlot");
        if (charts.revLoss && typeof charts.revLoss.resize === "function") charts.revLoss.resize();
      }
      if (activeTab === "portfolio") {
        safePlotResize("creditHeatPlot");
        safePlotResize("concentrationPlot");
      }
      if (activeTab === "market") {
        safePlotResize("counterpartyBubble");
        if (charts.varTrend && typeof charts.varTrend.resize === "function") charts.varTrend.resize();
      }
      if (activeTab === "stress") {
        safePlotResize("capitalTrajectoryPlot");
        safePlotResize("stressWaterfallPlot");
        safePlotResize("monteCarloPlot");
      }
      if (activeTab === "functions") {
        safePlotResize("ganttPlot");
      }
      if (activeTab === "aiworkforce") {
        safePlotResize("roleReductionPlot");
      }
    }

    function renderKpis() {
      const ncoRatioPct = model.totalNcoMm / (state.cibPublics.avgLoansBn * 1000) * 100;
      const aclCoveragePct = state.cibPublics.aclMm / (state.cibPublics.loansBn * 1000) * 100;
      const npaCoverage = state.cibPublics.aclMm / Math.max(1, state.cibPublics.npaMm);

      const cards = [
        { name: "CIB Loans", value: formatMoneyBn(model.totalEadBn), delta: `Public anchor ${formatMoneyBn(state.cibPublics.loansBn)}`, cls: "" },
        { name: "Expected Loss (Annual)", value: formatMoneyMm(model.totalExpectedLossMm), delta: `Stress: ${formatMoneyMm(model.totalStressLossMm)}`, cls: "warn" },
        { name: "NCO Ratio", value: fmtPct(ncoRatioPct, 2), delta: `NCO ${formatMoneyMm(model.totalNcoMm)}`, cls: ncoRatioPct > 0.18 ? "bad" : "good" },
        { name: "1D VaR Utilization", value: fmtPct(model.varUtilPct, 1), delta: `${formatMoneyMm(model.totalVarMm)} / ${formatMoneyMm(model.totalVarLimitMm)}`, cls: model.varUtilPct > 85 ? "bad" : model.varUtilPct > 75 ? "warn" : "good" },
        { name: "Stressed CET1", value: fmtPct(model.stressedCet1Pct, 2), delta: `Headroom ${formatNum(model.cet1HeadroomBps, 0)} bp`, cls: model.cet1HeadroomBps < 0 ? "bad" : model.cet1HeadroomBps < 75 ? "warn" : "good" },
        { name: "RWA (Stressed)", value: formatMoneyBn(model.stressedRwaBn), delta: `Base ${formatMoneyBn(state.regulatory.companyRwaBn)}`, cls: "" },
        { name: "CIB FTE (Scaled)", value: formatInt(model.cibFTE), delta: `Enterprise ${formatInt(state.metadata.enterpriseFTE)}`, cls: "" },
        { name: "ACL / NPA", value: `${formatNum(npaCoverage, 2)}x`, delta: `ACL coverage ${fmtPct(aclCoveragePct, 2)}`, cls: npaCoverage < 1 ? "bad" : npaCoverage < 1.2 ? "warn" : "good" }
      ];

      document.getElementById("kpiGrid").innerHTML = cards.map((card) => `
        <div class="kpi">
          <div class="name">${card.name}</div>
          <div class="value">${card.value}</div>
          <div class="delta ${card.cls || ""}">${card.delta}</div>
        </div>
      `).join("");

      document.getElementById("globalAsOf").textContent = `Data snapshot: ${state.metadata.dataSnapshotDate}`;
      document.getElementById("overviewScaleTag").textContent = `Scale factor ${formatNum(model.fteScale, 2)}x`;
    }

    function renderNav() {
      document.querySelectorAll("#navTabs button").forEach((btn) => {
        btn.classList.toggle("active", btn.dataset.tab === activeTab);
      });
      document.querySelectorAll(".tab").forEach((tab) => {
        tab.classList.toggle("active", tab.id === `tab-${activeTab}`);
      });
    }

    function renderScenarioSelect() {
      const select = document.getElementById("scenarioSelect");
      select.innerHTML = state.scenarios.map((s) => `<option value="${s.key}">${s.name}</option>`).join("");
      select.value = state.metadata.lastScenarioKey;
      document.getElementById("scenarioNameLabel").textContent = currentScenario().name;
    }

    function renderControlValues() {
      const meta = state.metadata;
      const a = state.assumptions;

      const setVal = (id, val) => {
        const el = document.getElementById(id);
        if (el) el.textContent = val;
      };

      const setInput = (id, val) => {
        const el = document.getElementById(id);
        if (el) el.value = val;
      };

      setInput("enterpriseFte", meta.enterpriseFTE);
      setInput("cibSharePct", meta.cibSharePct);
      setInput("pdMultiplier", a.pdStressMultiplier);
      setInput("lgdAdd", a.lgdAddPp);
      setInput("varMult", a.marketLossMultiplier);
      setInput("rwaInflation", a.rwaInflationPct);
      setInput("discountRate", a.discountRatePct);
      setInput("taxRatePctInput", a.taxRatePct);
      setInput("fundingSpreadShockInput", a.fundingSpreadShockBps);
      setInput("mgmtBufferInput", state.regulatory.managementBufferBps);
      setInput("requiredCet1Input", state.regulatory.requiredCet1MinPct);
      setInput("aiAdoptionInput", a.aiAdoptionPct);
      setInput("aiModelConfidenceInput", a.aiModelConfidencePct);
      setInput("aiDataQualityInput", a.aiDataQualityPct);
      setInput("aiProcessMaturityInput", a.aiProcessMaturityPct);
      setInput("aiControlRetentionInput", a.aiControlRetentionPct);
      setInput("aiRedeployInput", a.aiRedeployPct);
      setInput("aiImplementationSuccessInput", a.aiImplementationSuccessPct);
      setInput("aiSeveranceMonthsInput", a.aiSeveranceMonths);
      document.getElementById("autoScale").checked = !!meta.autoScale;

      setVal("enterpriseFteVal", formatInt(meta.enterpriseFTE));
      setVal("cibShareVal", `${formatNum(meta.cibSharePct, 1)}%`);
      setVal("pdMultiplierVal", `${formatNum(a.pdStressMultiplier, 2)}x`);
      setVal("lgdAddVal", `${formatNum(a.lgdAddPp, 0)} pp`);
      setVal("varMultVal", `${formatNum(a.marketLossMultiplier, 2)}x`);
      setVal("rwaInflationVal", `${formatNum(a.rwaInflationPct, 0)}%`);
      setVal("discountRateVal", `${formatNum(a.discountRatePct, 1)}%`);
      setVal("taxRatePctVal", `${formatNum(a.taxRatePct, 1)}%`);
      setVal("fundingSpreadShockVal", `${formatNum(a.fundingSpreadShockBps, 0)}`);
      setVal("mgmtBufferVal", `${formatNum(state.regulatory.managementBufferBps, 0)}`);
      setVal("requiredCet1Val", `${formatNum(state.regulatory.requiredCet1MinPct, 1)}%`);
      setVal("aiAdoptionVal", `${formatNum(a.aiAdoptionPct, 0)}%`);
      setVal("aiModelConfidenceVal", `${formatNum(a.aiModelConfidencePct, 0)}%`);
      setVal("aiDataQualityVal", `${formatNum(a.aiDataQualityPct, 0)}%`);
      setVal("aiProcessMaturityVal", `${formatNum(a.aiProcessMaturityPct, 0)}%`);
      setVal("aiControlRetentionVal", `${formatNum(a.aiControlRetentionPct, 0)}%`);
      setVal("aiRedeployVal", `${formatNum(a.aiRedeployPct, 0)}%`);
      setVal("aiImplementationSuccessVal", `${formatNum(a.aiImplementationSuccessPct, 0)}%`);
      setVal("aiSeveranceMonthsVal", `${formatNum(a.aiSeveranceMonths, 1)}`);
    }

    function renderTreemap() {
      const labels = [state.metadata.institutionName];
      const parents = [""];
      const values = [0];
      const colors = ["#2b3a51"];
      let rootTotal = 0;

      Object.entries(model.byLob).forEach(([lob, agg]) => {
        labels.push(lob);
        parents.push(state.metadata.institutionName);
        values.push(agg.eadBn);
        colors.push(lobColor(agg.riskScore));
        rootTotal += agg.eadBn;

        state.portfolios.filter((r) => r.lob === lob).forEach((row) => {
          labels.push(row.desk);
          parents.push(lob);
          values.push(row.eadBn);
          colors.push(lobColor(row._riskScore));
        });
      });

      values[0] = rootTotal;

      plotReact("treemapPlot", [
        {
          type: "treemap",
          labels,
          parents,
          values,
          marker: { colors },
          textinfo: "label+value",
          branchvalues: "total",
          hovertemplate: "<b>%{label}</b><br>Exposure: %{value:.2f}Bn<extra></extra>"
        }
      ], {
        margin: { t: 10, r: 10, b: 10, l: 10 },
        paper_bgcolor: "rgba(0,0,0,0)",
        plot_bgcolor: "rgba(0,0,0,0)",
        font: { color: "#e0e8f0", family: "DM Sans" }
      }, "large", labels.length);
    }

    function daysSince(dateText) {
      if (!dateText) return Number.POSITIVE_INFINITY;
      const a = new Date(`${dateText}T00:00:00`);
      const b = new Date(`${TODAY}T00:00:00`);
      if (!Number.isFinite(a.getTime()) || !Number.isFinite(b.getTime())) return Number.POSITIVE_INFINITY;
      return Math.max(0, Math.floor((b.getTime() - a.getTime()) / (1000 * 60 * 60 * 24)));
    }

    function deriveMarketSignal(row) {
      const bands = row.bands || {};
      const value = safeNumber(row.value, NaN);
      let signal = row.signal || "neutral";

      if (Number.isFinite(value) && bands.direction) {
        if (bands.direction === "high") {
          if (value >= safeNumber(bands.bad, Number.POSITIVE_INFINITY)) signal = "stress";
          else if (value >= safeNumber(bands.warn, Number.POSITIVE_INFINITY)) signal = "watch";
          else signal = "neutral";
        } else if (bands.direction === "low") {
          if (value <= safeNumber(bands.bad, Number.NEGATIVE_INFINITY)) signal = "stress";
          else if (value <= safeNumber(bands.warn, Number.NEGATIVE_INFINITY)) signal = "watch";
          else signal = "neutral";
        } else if (bands.direction === "outside") {
          if (value <= safeNumber(bands.lowBad, Number.NEGATIVE_INFINITY) || value >= safeNumber(bands.highBad, Number.POSITIVE_INFINITY)) signal = "stress";
          else if (value <= safeNumber(bands.lowWarn, Number.NEGATIVE_INFINITY) || value >= safeNumber(bands.highWarn, Number.POSITIVE_INFINITY)) signal = "watch";
          else signal = "neutral";
        }
      }

      const staleDays = daysSince(row.asOf);
      if (staleDays > 7) signal = "stress";
      else if (staleDays > 3 && signal === "neutral") signal = "watch";
      return signal;
    }

    function marketRows() {
      return state.marketTape.map((row) => {
        const staleDays = daysSince(row.asOf);
        const signal = deriveMarketSignal(row);
        return { ...row, staleDays, signal };
      });
    }

    function marketSeverity(row) {
      const base = row.signal === "stress" ? 2 : row.signal === "watch" ? 1 : 0;
      return base * 10 + Math.min(9, row.staleDays || 0);
    }

    function formatMarketValue(row) {
      const val = safeNumber(row.value, NaN);
      if (!Number.isFinite(val)) return "NA";
      if (row.unit === "spot") return formatNum(val, 4);
      if (row.unit === "idx") return formatNum(val, 2);
      if (row.unit && row.unit.includes("$/")) return formatNum(val, 2);
      if (row.unit === "%") return formatNum(val, 2);
      return formatNum(val, 2);
    }

    function renderMarketTape() {
      const tbody = document.querySelector("#marketTapeTable tbody");
      const rows = marketRows()
        .sort((a, b) => marketSeverity(b) - marketSeverity(a))
        .slice(0, 12);
      tbody.innerHTML = rows.map((m) => {
        const cls = m.signal === "neutral" ? "good" : m.signal === "watch" ? "warn" : "bad";
        return `
          <tr>
            <td>${m.label} <span class="pill">${m.category || "Market"}</span></td>
            <td class="mono">${formatMarketValue(m)} ${m.unit}</td>
            <td class="mono">${m.asOf}</td>
            <td><span class="pill ${cls}">${m.signal.toUpperCase()}</span></td>
            <td>${m.source}</td>
          </tr>
        `;
      }).join("");
    }

    function marketFilterState() {
      return {
        search: (document.getElementById("marketSearch")?.value || "").trim().toLowerCase(),
        category: document.getElementById("marketCategoryFilter")?.value || "all",
        signal: document.getElementById("marketSignalFilter")?.value || "all",
        sort: document.getElementById("marketSort")?.value || "severity"
      };
    }

    function filteredMarketRows() {
      const f = marketFilterState();
      const rows = marketRows().filter((row) => {
        const matchSearch = !f.search || `${row.label} ${row.category} ${row.source}`.toLowerCase().includes(f.search);
        const matchCategory = f.category === "all" || row.category === f.category;
        const matchSignal = f.signal === "all" || row.signal === f.signal;
        return matchSearch && matchCategory && matchSignal;
      });

      const sorter = {
        severity: (a, b) => marketSeverity(b) - marketSeverity(a),
        category: (a, b) => `${a.category}|${a.label}`.localeCompare(`${b.category}|${b.label}`),
        name: (a, b) => a.label.localeCompare(b.label),
        stale: (a, b) => (b.staleDays || 0) - (a.staleDays || 0)
      };
      rows.sort(sorter[f.sort] || sorter.severity);
      return rows;
    }

    function renderMarketMonitor() {
      const categorySelect = document.getElementById("marketCategoryFilter");
      const categories = [...new Set(state.marketTape.map((r) => r.category || "Other"))].sort((a, b) => a.localeCompare(b));
      const currentCat = categorySelect.value || "all";
      categorySelect.innerHTML = `<option value="all">All categories</option>${categories.map((c) => `<option value="${c}">${c}</option>`).join("")}`;
      if (currentCat === "all" || categories.includes(currentCat)) categorySelect.value = currentCat;

      const rows = filteredMarketRows();
      const full = marketRows();
      const stressCount = full.filter((r) => r.signal === "stress").length;
      const watchCount = full.filter((r) => r.signal === "watch").length;
      const staleCount = full.filter((r) => r.staleDays > 3).length;
      const fresherCount = full.length - staleCount;
      const statusEl = document.getElementById("marketRefreshStatus");

      document.getElementById("marketSummary").innerHTML = `
        <div class="market-stat"><span class="k">Indicators</span><span class="v">${full.length}</span></div>
        <div class="market-stat"><span class="k">Stress</span><span class="v">${stressCount}</span></div>
        <div class="market-stat"><span class="k">Watch</span><span class="v">${watchCount}</span></div>
        <div class="market-stat"><span class="k">Fresh (&le;3d)</span><span class="v">${fresherCount}</span></div>
        <div class="market-stat"><span class="k">Stale (&gt;3d)</span><span class="v">${staleCount}</span></div>
        <div class="market-stat"><span class="k">Filtered Rows</span><span class="v">${rows.length}</span></div>
      `;

      const tbody = document.querySelector("#marketMonitorTable tbody");
      tbody.innerHTML = rows.map((m) => {
        const cls = m.signal === "neutral" ? "good" : m.signal === "watch" ? "warn" : "bad";
        return `
          <tr>
            <td>${m.category || "Other"}</td>
            <td>${m.label}</td>
            <td class="mono">${formatMarketValue(m)} ${m.unit}</td>
            <td class="mono">${m.asOf}</td>
            <td><span class="pill ${cls}">${m.signal.toUpperCase()}</span></td>
            <td>${m.source}${m.fredId ? ` <span class="pill mono">${m.fredId}</span>` : ""}</td>
          </tr>
        `;
      }).join("");

      if (statusEl && !statusEl.dataset.busy) {
        statusEl.textContent = `Snapshot: ${fresherCount}/${full.length} fresh | Stress ${stressCount}`;
      }
    }

    async function fetchFredLatest(seriesId) {
      const url = `https://fred.stlouisfed.org/graph/fredgraph.csv?id=${encodeURIComponent(seriesId)}`;
      let txt = "";
      try {
        const res = await fetch(url, { cache: "no-store" });
        if (!res.ok) throw new Error(`FRED ${seriesId} http ${res.status}`);
        txt = await res.text();
      } catch {
        // Local file contexts may block direct cross-origin fetches; proxy fallback keeps refresh usable.
        const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
        const proxyRes = await fetch(proxyUrl, { cache: "no-store" });
        if (!proxyRes.ok) throw new Error(`FRED proxy ${seriesId} http ${proxyRes.status}`);
        txt = await proxyRes.text();
      }
      const lines = txt.trim().split(/\r?\n/).slice(1);
      for (let i = lines.length - 1; i >= 0; i -= 1) {
        const parts = lines[i].split(",");
        const d = parts[0];
        const v = parts[1];
        if (v && v !== "." && Number.isFinite(Number(v))) {
          return { asOf: d, value: Number(v) };
        }
      }
      throw new Error(`No valid observation for ${seriesId}`);
    }

    async function refreshMarketFromFred() {
      const statusEl = document.getElementById("marketRefreshStatus");
      const btn = document.getElementById("refreshMarketBtn");
      if (!btn) return;
      btn.disabled = true;
      if (statusEl) {
        statusEl.dataset.busy = "1";
        statusEl.textContent = "Refreshing...";
      }

      const targets = state.marketTape.filter((row) => row.fredId);
      let ok = 0;
      let failed = 0;

      await Promise.all(targets.map(async (row) => {
        try {
          const latest = await fetchFredLatest(row.fredId);
          row.value = latest.value;
          row.asOf = latest.asOf;
          ok += 1;
        } catch {
          failed += 1;
        }
      }));

      renderMarketTape();
      if (activeTab === "market") renderMarketMonitor();
      btn.disabled = false;
      if (statusEl) {
        statusEl.dataset.busy = "";
        statusEl.textContent = failed ? `Refresh partial: ${ok} updated / ${failed} failed` : `Refresh complete: ${ok} updated`;
      }
    }

    function renderPriorityActions() {
      const list = document.getElementById("priorityActions");
      const ranked = [...state.portfolios]
        .sort((a, b) => (b._riskScore + b.var1dMm / 2) - (a._riskScore + a.var1dMm / 2))
        .slice(0, 6);
      list.innerHTML = ranked.map((row, i) => `
        <li>
          <div class="ttl">${i + 1}. ${row.desk} <span class="pill ${row.priority === "P1" ? "bad" : row.priority === "P2" ? "warn" : "good"}">${row.priority}</span></div>
          <div>${row.action}</div>
          <div class="mono" style="margin-top:4px;color:#9fb0c4;">EL ${formatMoneyMm(row._elMm)} | Risk ${formatNum(row._riskScore, 1)} | Owner ${row.owner}</div>
        </li>
      `).join("");
    }

    function renderRevLossChart() {
      const ctx = document.getElementById("revLossChart");
      const labels = ["Quarterly Revenue", "Quarterly Net Income", "Expected Annual Loss", "Stress Credit Loss", "Stress Market+CCR"];
      const values = [
        state.cibPublics.qtrRevenueBn * 1000,
        state.cibPublics.qtrNetIncomeBn * 1000,
        model.totalExpectedLossMm,
        model.creditLossBn * 1000,
        (model.marketLossBn + model.ccrLossBn) * 1000
      ];

      if (charts.revLoss) charts.revLoss.destroy();
      charts.revLoss = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            data: values,
            backgroundColor: ["#55b4ff", "#00c896", "#f5a623", "#e67e22", "#e74c3c"],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            zoom: chartZoomOptions("xy"),
            tooltip: {
              callbacks: {
                label: (ctx) => `${formatMoneyMm(ctx.raw)}`
              }
            }
          },
          scales: {
            x: {
              ticks: { color: "#cbd9e8", font: { size: 10 } },
              grid: { color: "rgba(255,255,255,0.07)" }
            },
            y: {
              ticks: { color: "#cbd9e8", callback: (v) => `$${v}MM` },
              grid: { color: "rgba(255,255,255,0.07)" }
            }
          }
        }
      });
      bindChartReset("revLossChart", "revLoss");
    }

    function renderRiskPosture() {
      const items = [
        { label: "Weighted risk score", value: formatNum(model.avgRiskScore, 1), status: model.avgRiskScore > 70 ? "bad" : model.avgRiskScore > 58 ? "warn" : "good" },
        { label: "CIB NCO ($MM)", value: formatNum(model.totalNcoMm, 1), status: model.totalNcoMm > 520 ? "bad" : model.totalNcoMm > 420 ? "warn" : "good" },
        { label: "Stress pre-tax loss", value: formatMoneyBn(model.totalPreTaxBn), status: model.totalPreTaxBn > 18 ? "bad" : model.totalPreTaxBn > 12 ? "warn" : "good" },
        { label: "Stressed CET1 headroom", value: `${formatNum(model.cet1HeadroomBps, 0)} bp`, status: model.cet1HeadroomBps < 0 ? "bad" : model.cet1HeadroomBps < 75 ? "warn" : "good" },
        { label: "Top counterparty utilization", value: fmtPct(Math.max(...state.counterparties.map((c) => c.utilizationPct)), 1), status: Math.max(...state.counterparties.map((c) => c.utilizationPct)) > 95 ? "bad" : "warn" },
        { label: "Scenario posture", value: model.scen.name, status: "" }
      ];

      const container = document.getElementById("riskPostureList");
      container.innerHTML = items.map((m) => `
        <div class="metric-row">
          <div class="label">${m.label}</div>
          <div class="val">${m.value} ${m.status ? `<span class="pill ${m.status}">${m.status.toUpperCase()}</span>` : ""}</div>
        </div>
      `).join("");
    }

    function portfolioFilters() {
      return {
        search: document.getElementById("portfolioSearch").value.trim().toLowerCase(),
        lob: document.getElementById("portfolioLobFilter").value,
        priority: document.getElementById("portfolioPriorityFilter").value,
        risk: document.getElementById("portfolioRiskFilter").value
      };
    }

    function riskBucket(score) {
      if (score >= 80) return "critical";
      if (score >= 65) return "high";
      if (score >= 50) return "moderate";
      return "low";
    }

    function filteredPortfolios() {
      const f = portfolioFilters();
      return state.portfolios.filter((row) => {
        const matchesSearch = !f.search || [row.desk, row.owner, row.action, row.lob].join(" ").toLowerCase().includes(f.search);
        const matchesLob = f.lob === "all" || row.lob === f.lob;
        const matchesPriority = f.priority === "all" || row.priority === f.priority;
        const matchesRisk = f.risk === "all" || riskBucket(row._riskScore) === f.risk;
        return matchesSearch && matchesLob && matchesPriority && matchesRisk;
      });
    }

    function renderPortfolioFilters() {
      const lobSelect = document.getElementById("portfolioLobFilter");
      const current = lobSelect.value || "all";
      const lobs = [...new Set(state.portfolios.map((p) => p.lob))];
      lobSelect.innerHTML = `<option value="all">All LOBs</option>${lobs.map((l) => `<option value="${l}">${l}</option>`).join("")}`;
      if (lobs.includes(current) || current === "all") lobSelect.value = current;
    }

    function inputCell(rowId, field, type = "number", min = null, max = null, step = null) {
      const row = state.portfolios.find((r) => r.id === rowId);
      const value = row[field];
      const attrs = [
        `data-rowid="${rowId}"`,
        `data-field="${field}"`,
        `type="${type}"`
      ];
      if (min !== null) attrs.push(`min="${min}"`);
      if (max !== null) attrs.push(`max="${max}"`);
      if (step !== null) attrs.push(`step="${step}"`);
      const val = type === "number" ? safeNumber(value).toString() : String(value ?? "");
      return `<input ${attrs.join(" ")} value="${val.replace(/"/g, "&quot;")}" />`;
    }

    function selectCell(rowId, field, opts) {
      const row = state.portfolios.find((r) => r.id === rowId);
      return `
        <select data-rowid="${rowId}" data-field="${field}">
          ${opts.map((o) => `<option value="${o}" ${row[field] === o ? "selected" : ""}>${o}</option>`).join("")}
        </select>
      `;
    }

    function renderPortfolioTable() {
      const rows = filteredPortfolios();
      const tbody = document.querySelector("#portfolioTable tbody");
      tbody.innerHTML = rows.map((r) => `
        <tr data-rowid="${r.id}">
          <td>${selectCell(r.id, "lob", ["Banking", "Commercial Real Estate", "Markets"])}</td>
          <td>${inputCell(r.id, "desk", "text")}</td>
          <td>${inputCell(r.id, "eadBn", "number", 0, 200, 0.1)}</td>
          <td>${inputCell(r.id, "pdPct", "number", 0, 20, 0.05)}</td>
          <td>${inputCell(r.id, "lgdPct", "number", 0, 100, 0.1)}</td>
          <td>${inputCell(r.id, "criticizedPct", "number", 0, 100, 0.1)}</td>
          <td>${inputCell(r.id, "nonaccrualPct", "number", 0, 50, 0.1)}</td>
          <td>${inputCell(r.id, "var1dMm", "number", 0, 300, 0.1)}</td>
          <td>${inputCell(r.id, "varLimitMm", "number", 1, 400, 0.1)}</td>
          <td>${inputCell(r.id, "ncoAnnualMm", "number", 0, 500, 0.1)}</td>
          <td>${inputCell(r.id, "rwaDensityPct", "number", 0, 200, 0.1)}</td>
          <td>${selectCell(r.id, "priority", ["P1", "P2", "P3"])}</td>
          <td>${inputCell(r.id, "owner", "text")}</td>
          <td>${inputCell(r.id, "action", "text")}</td>
          <td class="mono">${formatNum(r._elMm, 1)}</td>
          <td><span class="pill ${r._riskScore >= 80 ? "bad" : r._riskScore >= 65 ? "warn" : "good"}">${formatNum(r._riskScore, 1)}</span></td>
        </tr>
      `).join("");

      document.getElementById("portfolioRowCount").textContent = `${rows.length} desks shown`;
    }

    function renderPortfolioCharts() {
      const rows = filteredPortfolios();
      const x = rows.map((r) => r.pdPct);
      const y = rows.map((r) => r.lgdPct);
      const sizes = rows.map((r) => Math.max(10, r.eadBn * 1.6));
      const colors = rows.map((r) => lobColor(r._riskScore));

      plotReact("creditHeatPlot", [{
        type: "scatter",
        mode: "markers",
        x,
        y,
        text: rows.map((r) => `${r.desk}<br>Criticized ${fmtPct(r.criticizedPct, 1)}<br>Nonaccrual ${fmtPct(r.nonaccrualPct, 1)}`),
        marker: { size: sizes, color: colors, opacity: 0.85, line: { color: "#0b1320", width: 1 } },
        hovertemplate: "%{text}<br>PD %{x:.2f}% | LGD %{y:.1f}%<extra></extra>"
      }], {
        margin: { l: 45, r: 12, t: 10, b: 40 },
        xaxis: { title: "PD %", color: "#dbe7f3", gridcolor: "rgba(255,255,255,0.08)" },
        yaxis: { title: "LGD %", color: "#dbe7f3", gridcolor: "rgba(255,255,255,0.08)" },
        paper_bgcolor: "rgba(0,0,0,0)",
        plot_bgcolor: "rgba(0,0,0,0)",
        font: { color: "#dbe7f3", family: "DM Sans" }
      }, "small");

      const top = [...rows].sort((a, b) => b._elMm - a._elMm).slice(0, 10).reverse();
      plotReact("concentrationPlot", [{
        type: "bar",
        orientation: "h",
        y: top.map((r) => r.desk),
        x: top.map((r) => r._elMm),
        marker: { color: top.map((r) => lobColor(r._riskScore)) },
        hovertemplate: "%{y}<br>Expected loss: %{x:.1f}MM<extra></extra>"
      }], {
        margin: { l: 190, r: 16, t: 10, b: 30 },
        xaxis: { title: "Expected Loss ($MM)", color: "#dbe7f3", gridcolor: "rgba(255,255,255,0.08)" },
        yaxis: { color: "#dbe7f3" },
        paper_bgcolor: "rgba(0,0,0,0)",
        plot_bgcolor: "rgba(0,0,0,0)",
        font: { color: "#dbe7f3", family: "DM Sans" }
      }, "small");
    }

    function buildLimitRows() {
      const office = state.portfolios.find((p) => p.id === "CRE-OFF") || { eadBn: 0, nonaccrualPct: 0 };
      const cet1CapitalBn = model.cet1CapitalBnStart;
      const top10ExposureBn = [...state.portfolios].sort((a, b) => b.eadBn - a.eadBn).slice(0, 10).reduce((acc, p) => acc + p.eadBn, 0);
      const topCounterpartyUtil = Math.max(...state.counterparties.map((c) => c.utilizationPct));
      const avgWrongWay = state.counterparties.reduce((acc, c) => acc + c.wrongWayScore, 0) / state.counterparties.length;

      return [
        {
          metric: "Total 1D VaR Utilization",
          current: model.varUtilPct,
          amber: 80,
          red: 95,
          owner: "Head of CIB Risk",
          commentary: "Keep aggregated utilization below 80% outside event windows."
        },
        {
          metric: "Top-10 Portfolio EAD / CET1 Capital",
          current: top10ExposureBn / Math.max(1, cet1CapitalBn) * 100,
          amber: 145,
          red: 170,
          owner: "Head of CIB Portfolio Risk",
          commentary: "Concentration trigger for portfolio de-risking sequence."
        },
        {
          metric: "Office CRE EAD / CET1 Capital",
          current: office.eadBn / Math.max(1, cet1CapitalBn) * 100,
          amber: 20,
          red: 25,
          owner: "Portfolio Risk - CRE",
          commentary: "Escalate remediation if above 25% equivalent concentration."
        },
        {
          metric: "Office CRE Nonaccrual Ratio",
          current: office.nonaccrualPct,
          amber: 2.5,
          red: 3.2,
          owner: "Portfolio Risk - CRE",
          commentary: "Track migration speed in refinance-heavy assets."
        },
        {
          metric: "Top Counterparty Utilization",
          current: topCounterpartyUtil,
          amber: 90,
          red: 97,
          owner: "Counterparty Credit Risk",
          commentary: "Mechanical IM and tenor actions above 95%."
        },
        {
          metric: "Average Wrong-Way Score",
          current: avgWrongWay,
          amber: 6.5,
          red: 7.5,
          owner: "Counterparty Credit Risk",
          commentary: "WWR overlay required where score breaches threshold."
        },
        {
          metric: "LCR",
          current: state.regulatory.lcrPct,
          amber: 110,
          red: 105,
          direction: "low",
          owner: "Treasury Risk",
          commentary: "Publicly disclosed ratio, monitored daily internally."
        }
      ];
    }

    function renderLimitTable() {
      const rows = buildLimitRows();
      const tbody = document.querySelector("#limitTable tbody");
      tbody.innerHTML = rows.map((r) => {
        const status = statusFromValue(r.current, r.amber, r.red, r.direction || "high");
        return `
          <tr>
            <td>${r.metric}</td>
            <td class="mono">${formatNum(r.current, 1)}</td>
            <td class="mono">${formatNum(r.amber, 1)}</td>
            <td class="mono">${formatNum(r.red, 1)}</td>
            <td><span class="pill ${statusClass(status)}">${status}</span></td>
            <td>${r.owner}</td>
            <td>${r.commentary}</td>
          </tr>
        `;
      }).join("");
    }

    function renderCounterpartyBubble() {
      const cps = state.counterparties;
      plotReact("counterpartyBubble", [{
        type: "scatter",
        mode: "markers+text",
        x: cps.map((c) => c.utilizationPct),
        y: cps.map((c) => c.wrongWayScore),
        text: cps.map((c) => c.name),
        textposition: "top center",
        marker: {
          size: cps.map((c) => Math.max(14, c.eadMm / 90)),
          color: cps.map((c) => c.watch ? "#e74c3c" : "#55b4ff"),
          opacity: 0.8,
          line: { color: "rgba(255,255,255,0.4)", width: 1 }
        },
        hovertemplate: "%{text}<br>Util %{x:.1f}%<br>WWR %{y:.1f}<br>EAD %{marker.size:.1f} scaled<extra></extra>"
      }], {
        margin: { l: 50, r: 10, t: 10, b: 40 },
        xaxis: { title: "Utilization %", gridcolor: "rgba(255,255,255,0.08)", color: "#dbe7f3" },
        yaxis: { title: "Wrong-Way Risk Score", gridcolor: "rgba(255,255,255,0.08)", color: "#dbe7f3" },
        shapes: [
          { type: "line", x0: 90, x1: 90, y0: 0, y1: 10, line: { color: "#f5a623", dash: "dot" } },
          { type: "line", x0: 97, x1: 97, y0: 0, y1: 10, line: { color: "#e74c3c", dash: "dot" } },
          { type: "line", x0: 0, x1: 110, y0: 7.5, y1: 7.5, line: { color: "#e74c3c", dash: "dot" } }
        ],
        paper_bgcolor: "rgba(0,0,0,0)",
        plot_bgcolor: "rgba(0,0,0,0)",
        font: { color: "#dbe7f3", family: "DM Sans" }
      }, "default");
    }

    function renderCounterpartyTable() {
      const tbody = document.querySelector("#counterpartyTable tbody");
      const rows = [...state.counterparties].sort((a, b) => b.utilizationPct - a.utilizationPct);
      tbody.innerHTML = rows.map((cp) => {
        const status = cp.utilizationPct >= 97 || cp.wrongWayScore >= 8.5 ? "Red" : cp.utilizationPct >= 90 || cp.wrongWayScore >= 7 ? "Amber" : "Green";
        return `
          <tr>
            <td>${cp.name}</td>
            <td>${cp.type}</td>
            <td>${cp.rating}</td>
            <td class="mono">${formatNum(cp.eadMm, 0)}</td>
            <td class="mono">${formatNum(cp.pfe95Mm, 0)}</td>
            <td class="mono">${formatNum(cp.utilizationPct, 1)}%</td>
            <td class="mono">${formatNum(cp.wrongWayScore, 1)}</td>
            <td>${cp.collateralQuality}/5</td>
            <td><span class="pill ${statusClass(status)}">${cp.watch ? "WATCH" : status}</span></td>
          </tr>
        `;
      }).join("");
    }

    function renderVarTrendChart() {
      const ctx = document.getElementById("varTrendChart");
      const baseUtil = model.varUtilPct;
      const labels = ["Q1", "Q2", "Q3", "Q4", "Q5", "Q6", "Q7", "Q8"];
      const scen = model.scen;
      const varPath = labels.map((_, i) => baseUtil * (1 + (scen.marketMult - 1) * (0.12 + i * 0.06)));
      const svarPath = labels.map((_, i) => Math.min(130, baseUtil * 1.2 * (1 + (scen.marketMult - 1) * (0.18 + i * 0.07))));

      if (charts.varTrend) charts.varTrend.destroy();
      charts.varTrend = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [
            { label: "VaR utilization", data: varPath, borderColor: "#55b4ff", backgroundColor: "rgba(85,180,255,0.1)", tension: 0.25 },
            { label: "sVaR utilization", data: svarPath, borderColor: "#f5a623", backgroundColor: "rgba(245,166,35,0.1)", tension: 0.25 }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { labels: { color: "#dbe7f3" } },
            zoom: chartZoomOptions("x")
          },
          scales: {
            x: { ticks: { color: "#dbe7f3" }, grid: { color: "rgba(255,255,255,0.08)" } },
            y: {
              ticks: { color: "#dbe7f3", callback: (v) => `${v}%` },
              grid: { color: "rgba(255,255,255,0.08)" }
            }
          }
        }
      });
      bindChartReset("varTrendChart", "varTrend");
    }

    function buildCapitalTrajectory() {
      const quarters = Array.from({ length: 12 }, (_, i) => `Q${i + 1}`);
      const scen = model.scen;
      const startCet1 = state.regulatory.companyCet1RatioPct;
      const targetCet1 = model.stressedCet1Pct;
      const path = quarters.map((_, i) => {
        const t = i / (quarters.length - 1);
        const frontLoad = Math.pow(t, 0.72);
        return startCet1 - (startCet1 - targetCet1) * frontLoad;
      });

      const cumulativeLoss = quarters.map((_, i) => {
        const t = (i + 1) / quarters.length;
        return model.totalPreTaxBn * Math.pow(t, 0.78);
      });

      return { quarters, path, cumulativeLoss, scen };
    }

    function renderCapitalTrajectory() {
      const d = buildCapitalTrajectory();
      plotReact("capitalTrajectoryPlot", [
        {
          type: "scatter",
          mode: "lines+markers",
          x: d.quarters,
          y: d.path,
          name: "Projected CET1",
          line: { color: "#55b4ff", width: 3 }
        },
        {
          type: "scatter",
          mode: "lines",
          x: d.quarters,
          y: d.quarters.map(() => state.regulatory.requiredCet1MinPct + state.regulatory.managementBufferBps / 100),
          name: "Requirement + Mgmt Buffer",
          line: { color: "#f5a623", dash: "dot", width: 2 }
        }
      ], {
        margin: { l: 50, r: 12, t: 10, b: 34 },
        xaxis: { color: "#dbe7f3" },
        yaxis: { title: "CET1 %", color: "#dbe7f3", gridcolor: "rgba(255,255,255,0.08)" },
        paper_bgcolor: "rgba(0,0,0,0)",
        plot_bgcolor: "rgba(0,0,0,0)",
        font: { color: "#dbe7f3", family: "DM Sans" },
        legend: { orientation: "h", y: 1.1 }
      }, "small");
    }

    function renderStressWaterfall() {
      const vals = [
        model.creditLossBn,
        model.marketLossBn,
        model.ccrLossBn,
        model.fundingLossBn,
        -model.totalPreTaxBn
      ];
      plotReact("stressWaterfallPlot", [{
        type: "waterfall",
        x: ["Credit", "Market", "Counterparty", "Funding", "Net pre-tax impact"],
        y: vals,
        measure: ["relative", "relative", "relative", "relative", "total"],
        increasing: { marker: { color: "#e74c3c" } },
        decreasing: { marker: { color: "#00c896" } },
        totals: { marker: { color: "#55b4ff" } },
        textposition: "outside",
        hovertemplate: "%{x}: %{y:.2f}Bn<extra></extra>"
      }], {
        margin: { l: 20, r: 20, t: 20, b: 60 },
        yaxis: { title: "$Bn", color: "#dbe7f3", gridcolor: "rgba(255,255,255,0.08)" },
        xaxis: { color: "#dbe7f3" },
        paper_bgcolor: "rgba(0,0,0,0)",
        plot_bgcolor: "rgba(0,0,0,0)",
        font: { color: "#dbe7f3", family: "DM Sans" }
      }, "small");
    }

    function runScenarioCalc(s) {
      const creditLossBn = model.totalStressLossMm / 1000 * (s.pdMult / model.scen.pdMult) * ((100 + s.lgdAdd) / (100 + model.scen.lgdAdd));
      const marketLossBn = model.totalVarShockMm / 1000 * (s.marketMult / model.scen.marketMult);
      const ccrLossBn = model.stressedCcrMm / 1000 * (s.ccrMult / model.scen.ccrMult);
      const fundingLossBn = model.fundingDragMm / 1000 * (s.fundingBps / Math.max(1, model.scen.fundingBps));
      const total = creditLossBn + marketLossBn + ccrLossBn + fundingLossBn;
      const afterTax = total * (1 - state.assumptions.taxRatePct / 100);
      const startCap = model.cet1CapitalBnStart;
      const rwa = state.regulatory.companyRwaBn * (1 + s.rwaInfl / 100);
      const stressedCet1 = Math.max(0, startCap - afterTax) / rwa * 100;
      const headroom = (stressedCet1 - state.regulatory.requiredCet1MinPct) * 100;
      return { creditLossBn, marketLossBn, ccrLossBn, fundingLossBn, total, stressedCet1, headroom };
    }

    function renderScenarioTable() {
      const tbody = document.querySelector("#scenarioTable tbody");
      tbody.innerHTML = state.scenarios.map((s) => {
        const r = runScenarioCalc(s.key === "custom" ? currentScenario() : s);
        const call = r.headroom < 0 ? "Capital action likely required" : r.headroom < 120 ? "Buffer compression" : "Manageable";
        const status = r.headroom < 0 ? "Red" : r.headroom < 120 ? "Amber" : "Green";
        return `
          <tr>
            <td>${s.name}</td>
            <td class="mono">${formatNum(r.creditLossBn, 2)}</td>
            <td class="mono">${formatNum(r.marketLossBn + r.ccrLossBn, 2)}</td>
            <td class="mono">${formatNum(r.total, 2)}</td>
            <td class="mono">${formatNum(r.stressedCet1, 2)}%</td>
            <td class="mono">${formatNum((r.stressedCet1 - state.regulatory.requiredCet1MinPct) * 100, 0)}</td>
            <td><span class="pill ${statusClass(status)}">${call}</span></td>
          </tr>
        `;
      }).join("");
    }

    function boxMuller() {
      let u = 0, v = 0;
      while (u === 0) u = Math.random();
      while (v === 0) v = Math.random();
      return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
    }

    function runMonteCarlo() {
      const runs = state.assumptions.monteCarloRuns;
      const scen = currentScenario();
      const outcomes = [];

      for (let i = 0; i < runs; i += 1) {
        const pdM = Math.max(0.6, scen.pdMult * (1 + boxMuller() * 0.12));
        const lgdA = Math.max(0, scen.lgdAdd * (1 + boxMuller() * 0.15));
        const mktM = Math.max(0.8, scen.marketMult * (1 + boxMuller() * 0.14));
        const ccrM = Math.max(0.7, scen.ccrMult * (1 + boxMuller() * 0.15));
        const rwaI = Math.max(0, scen.rwaInfl * (1 + boxMuller() * 0.11));
        const fndB = Math.max(0, scen.fundingBps * (1 + boxMuller() * 0.13));

        const temp = runScenarioCalc({ ...scen, pdMult: pdM, lgdAdd: lgdA, marketMult: mktM, ccrMult: ccrM, rwaInfl: rwaI, fundingBps: fndB });
        outcomes.push(temp.total);
      }

      outcomes.sort((a, b) => a - b);
      const p10 = outcomes[Math.floor(0.1 * outcomes.length)];
      const p50 = outcomes[Math.floor(0.5 * outcomes.length)];
      const p90 = outcomes[Math.floor(0.9 * outcomes.length)];

      plotReact("monteCarloPlot", [{
        type: "histogram",
        x: outcomes,
        nbinsx: 35,
        marker: { color: "rgba(85,180,255,0.75)" },
        hovertemplate: "Loss bucket: %{x:.2f}Bn<br>Count: %{y}<extra></extra>"
      }], {
        margin: { l: 45, r: 10, t: 10, b: 35 },
        xaxis: { title: "Pre-tax loss ($Bn)", color: "#dbe7f3", gridcolor: "rgba(255,255,255,0.08)" },
        yaxis: { title: "Frequency", color: "#dbe7f3", gridcolor: "rgba(255,255,255,0.08)" },
        paper_bgcolor: "rgba(0,0,0,0)",
        plot_bgcolor: "rgba(0,0,0,0)",
        font: { color: "#dbe7f3", family: "DM Sans" },
        shapes: [
          { type: "line", x0: p10, x1: p10, y0: 0, y1: 1, yref: "paper", line: { color: "#f5a623", dash: "dot" } },
          { type: "line", x0: p50, x1: p50, y0: 0, y1: 1, yref: "paper", line: { color: "#55b4ff", dash: "dot" } },
          { type: "line", x0: p90, x1: p90, y0: 0, y1: 1, yref: "paper", line: { color: "#e74c3c", dash: "dot" } }
        ]
      }, "small");

      document.getElementById("monteCarloSummary").innerHTML = `
        <strong>Distribution range:</strong> P10 <span class="mono">${formatMoneyBn(p10)}</span>,
        P50 <span class="mono">${formatMoneyBn(p50)}</span>,
        P90 <span class="mono">${formatMoneyBn(p90)}</span> pre-tax loss.
        80% central band: <span class="mono">${formatMoneyBn(p10)} to ${formatMoneyBn(p90)}</span>.
      `;
    }

    function renderFunctionMap() {
      const tbody = document.querySelector("#functionMapTable tbody");
      tbody.innerHTML = state.functionMap.map((f) => `
        <tr>
          <td>${f.func}</td>
          <td>${f.owner}</td>
          <td>${f.kpi}</td>
          <td>${f.target}</td>
          <td><span class="pill ${statusClass(f.status)}">${f.status}</span></td>
          <td>${f.cadence}</td>
          <td>${f.trigger}</td>
        </tr>
      `).join("");
    }

    function renderGantt() {
      const data = state.initiatives.map((i) => ({
        Task: i.name,
        Start: i.start,
        Finish: i.end,
        Resource: i.phase,
        Owner: i.owner,
        Dependency: i.dependency
      }));

      const phases = [...new Set(data.map((d) => d.Resource))];
      const colors = {
        "Quick Wins": "#00c896",
        "Phase 1": "#55b4ff",
        "Phase 2": "#f5a623",
        "Phase 3": "#e74c3c"
      };

      const traces = phases.map((phase) => {
        const rows = data.filter((d) => d.Resource === phase);
        return {
          type: "bar",
          orientation: "h",
          name: phase,
          y: rows.map((r) => r.Task),
          x: rows.map((r) => (new Date(r.Finish) - new Date(r.Start))),
          base: rows.map((r) => r.Start),
          marker: { color: colors[phase] || "#55b4ff" },
          customdata: rows.map((r) => {
            const dur = Math.round((new Date(r.Finish) - new Date(r.Start)) / (1000 * 60 * 60 * 24));
            return [r.Owner, r.Dependency, dur];
          }),
          hovertemplate: "%{y}<br>Owner: %{customdata[0]}<br>Dependency: %{customdata[1]}<br>Duration: %{customdata[2]} days<extra></extra>"
        };
      });

      plotReact("ganttPlot", traces, {
        barmode: "stack",
        margin: { l: 220, r: 16, t: 16, b: 36 },
        xaxis: { type: "date", color: "#dbe7f3", gridcolor: "rgba(255,255,255,0.08)" },
        yaxis: { color: "#dbe7f3", autorange: "reversed" },
        paper_bgcolor: "rgba(0,0,0,0)",
        plot_bgcolor: "rgba(0,0,0,0)",
        font: { color: "#dbe7f3", family: "DM Sans" },
        legend: { orientation: "h", y: 1.15 }
      }, "large", traces.reduce((acc, t) => acc + (t.y ? t.y.length : 0), 0));
    }

    function buildNarrative() {
      const topRisk = model.topRiskRows.slice(0, 3).map((r) => `${r.desk} (${formatNum(r._riskScore, 1)})`).join(", ");
      const topEl = model.topElRows.slice(0, 3).map((r) => `${r.desk} ${formatMoneyMm(r._elMm)}`).join("; ");
      const watchNames = model.topWatchCounterparties.slice(0, 4).map((c) => c.name).join(", ");
      const scen = model.scen;
      const workforce = computeRoleTransformationModel();

      return [
        `Situation (${TODAY}): CIB exposure is ${formatMoneyBn(model.totalEadBn)} with quarterly revenue ${formatMoneyBn(state.cibPublics.qtrRevenueBn)} and quarterly net income ${formatMoneyBn(state.cibPublics.qtrNetIncomeBn)}. Current 1D VaR utilization is ${fmtPct(model.varUtilPct, 1)} and weighted portfolio risk score is ${formatNum(model.avgRiskScore, 1)}.`,
        `Risk signal: Highest desk-level risk concentrations are ${topRisk}. Top expected-loss contributors are ${topEl}. Counterparty watchlist concentration is highest in ${watchNames}.`,
        `Scenario (${scen.name}): Modeled pre-tax loss is ${formatMoneyBn(model.totalPreTaxBn)} with stressed CET1 at ${fmtPct(model.stressedCet1Pct, 2)} versus internal requirement-plus-buffer of ${fmtPct(model.requiredPlusBuffer, 2)}. Headroom is ${formatNum(model.cet1HeadroomBps, 0)} bp.`,
        `Workforce transformation lens: Role-level model indicates ${formatNum(workforce.totals.predReductionFte, 1)} gross reducible FTE and ${formatNum(workforce.totals.netReductionFte, 1)} net reduction FTE (${formatNum(workforce.totals.netReductionPct, 1)}%) with annual net benefit ${formatMoneyMm(workforce.totals.annualNetBenefitMm)}, 3Y NPV ${formatMoneyMm(workforce.totals.npv3Mm)}, and readiness score ${formatNum(workforce.executionReadiness * 100, 0)}%.`,
        `Recommendation: Execute a 90-day package led by Head of CIB Risk and Head of CIB Portfolio Risk: (1) Office CRE remediation acceleration, (2) leveraged/sponsor underwriting reset, (3) mechanical IM overlays for top counterparty concentrations, (4) cross-stripe liquidity + collateral drill, (5) risk appetite framework refresh for board sign-off.`,
        `Financial impact view: Expected annual credit loss is ${formatMoneyMm(model.totalExpectedLossMm)}; severe-stress credit loss is ${formatMoneyBn(model.creditLossBn)} with additional market+CCR impact of ${formatMoneyBn(model.marketLossBn + model.ccrLossBn)}.`,
        `Governance: Maintain formal challenge documentation, model limitations disclosure, and threshold-based escalation triggers for any utilization above amber in VaR, concentration, or counterparty metrics.`
      ].join("\n\n");
    }

    function renderBoardNarrative() {
      document.getElementById("boardNarrative").value = buildNarrative();
      const qa = [
        {
          q: "How close are we to capital pressure under severe adverse?",
          a: `Modeled stressed CET1 is ${fmtPct(model.stressedCet1Pct, 2)} with ${formatNum(model.cet1HeadroomBps, 0)} bp headroom vs requirement + management buffer.`
        },
        {
          q: "Where is the largest incremental downside risk?",
          a: `${model.topRiskRows[0].desk} and ${model.topRiskRows[1].desk} are currently the largest risk-intensity contributors with elevated criticized/nonaccrual and utilization metrics.`
        },
        {
          q: "What should we do in the next 30 days?",
          a: "Prioritize Office CRE remediation, tighten leveraged finance underwriting, and apply automatic IM/limit actions to top watchlist counterparties above 95% utilization."
        },
        {
          q: "How reliable are these numbers?",
          a: "Segment totals are anchored to public disclosures with high confidence; desk-level splits are calibrated allocation models and should be replaced by internal system-of-record feeds for final decisions."
        },
        {
          q: "What is the regulator-facing message?",
          a: "We are maintaining buffers, running severe scenarios aligned to Fed parameters, and executing pre-defined, threshold-triggered actions with documented governance."
        }
      ];
      document.getElementById("qaList").innerHTML = qa.map((item) => `
        <li>
          <div class="ttl">Q: ${item.q}</div>
          <div>A: ${item.a}</div>
        </li>
      `).join("");
    }

    function renderSourceTable() {
      const tbody = document.querySelector("#sourceTable tbody");
      tbody.innerHTML = state.sources.map((s) => {
        const cls = s.confidence === "High" ? "good" : s.confidence === "Medium" ? "warn" : "bad";
        return `
          <tr>
            <td>${s.point}</td>
            <td>${s.value}</td>
            <td class="mono">${s.asOf}</td>
            <td><span class="pill ${cls}">${s.confidence}</span></td>
            <td><a href="${s.url}" target="_blank" rel="noopener">${s.url}</a></td>
          </tr>
        `;
      }).join("");
    }

    function renderOverviewTab() {
      renderTreemap();
      renderMarketTape();
      renderPriorityActions();
      renderRevLossChart();
      renderRiskPosture();
    }

    function renderPortfolioTab() {
      renderPortfolioFilters();
      renderPortfolioTable();
      renderPortfolioCharts();
    }

    function renderMarketTab() {
      renderCounterpartyBubble();
      renderLimitTable();
      renderCounterpartyTable();
      renderVarTrendChart();
      renderMarketMonitor();
    }

    function renderStressTab() {
      renderCapitalTrajectory();
      renderStressWaterfall();
      renderScenarioTable();
      runMonteCarlo();
    }

    function renderFunctionsTab() {
      renderFunctionMap();
      renderGantt();
    }

    function assumptionTraceRows() {
      const scen = currentScenario();
      const taxRate = state.assumptions.taxRatePct / 100;
      const afterTaxLossBn = model.totalPreTaxBn * (1 - taxRate);
      const stressedRwaBn = state.regulatory.companyRwaBn * (1 + scen.rwaInfl / 100);
      const stressedCet1CapitalBn = Math.max(0, model.cet1CapitalBnStart - afterTaxLossBn);
      const requiredPct = state.regulatory.requiredCet1MinPct + state.regulatory.managementBufferBps / 100;
      const cibLoansBn = state.cibPublics.avgLoansBn;

      return [
        {
          metric: "Total 1D VaR",
          formula: "SUM(desk_var_1d_mm)",
          inputs: `${state.portfolios.length} desks`,
          output: formatMoneyMm(model.totalVarMm),
          source: "Portfolio table inputs"
        },
        {
          metric: "VaR Utilization",
          formula: "(Total 1D VaR / Total VaR Limit) x 100",
          inputs: `VaR ${formatMoneyMm(model.totalVarMm)} / Limit ${formatMoneyMm(model.totalVarLimitMm)}`,
          output: fmtPct(model.varUtilPct, 1),
          source: "Market risk limits"
        },
        {
          metric: "Expected Annual Credit Loss",
          formula: "SUM(EAD x PD x LGD)",
          inputs: `EAD ${formatMoneyBn(model.totalEadBn)}, stressed scenario ${scen.name}`,
          output: formatMoneyMm(model.totalExpectedLossMm),
          source: "Desk-level PD/LGD"
        },
        {
          metric: "Stress Credit Loss",
          formula: "SUM(EAD x (PD x PD_mult) x (LGD + LGD_add))",
          inputs: `PD mult ${formatNum(scen.pdMult, 2)}x, LGD add ${formatNum(scen.lgdAdd, 0)}pp`,
          output: formatMoneyBn(model.creditLossBn),
          source: "Scenario assumption layer"
        },
        {
          metric: "Stress Market Loss",
          formula: "Total VaR Shock x market_mult",
          inputs: `Market mult ${formatNum(scen.marketMult, 2)}x`,
          output: formatMoneyBn(model.marketLossBn),
          source: "Market stress module"
        },
        {
          metric: "Stress Counterparty Loss",
          formula: "Stressed CCR x ccr_mult",
          inputs: `CCR mult ${formatNum(scen.ccrMult, 2)}x`,
          output: formatMoneyBn(model.ccrLossBn),
          source: "Counterparty stress module"
        },
        {
          metric: "Funding / Liquidity Drag",
          formula: "EAD x funding_shock_bps x liquidity_factor",
          inputs: `Funding shock ${formatNum(scen.fundingBps, 0)} bps`,
          output: formatMoneyBn(model.fundingLossBn),
          source: "Treasury funding stress assumption"
        },
        {
          metric: "After-Tax Stress Loss",
          formula: "Pre-tax stress loss x (1 - tax_rate)",
          inputs: `Pre-tax ${formatMoneyBn(model.totalPreTaxBn)}, tax ${formatNum(state.assumptions.taxRatePct, 1)}%`,
          output: formatMoneyBn(afterTaxLossBn),
          source: "Tax-adjusted capital bridge"
        },
        {
          metric: "Stressed RWA",
          formula: "Base RWA x (1 + rwa_inflation%)",
          inputs: `Base RWA ${formatMoneyBn(state.regulatory.companyRwaBn)}, infl ${formatNum(scen.rwaInfl, 1)}%`,
          output: formatMoneyBn(stressedRwaBn),
          source: "Regulatory capital assumption"
        },
        {
          metric: "Stressed CET1 Capital",
          formula: "Start CET1 capital - after-tax stress loss",
          inputs: `Start ${formatMoneyBn(model.cet1CapitalBnStart)}, after-tax loss ${formatMoneyBn(afterTaxLossBn)}`,
          output: formatMoneyBn(stressedCet1CapitalBn),
          source: "Capital bridge"
        },
        {
          metric: "Stressed CET1 Ratio",
          formula: "(Stressed CET1 capital / stressed RWA) x 100",
          inputs: `Capital ${formatMoneyBn(stressedCet1CapitalBn)}, RWA ${formatMoneyBn(stressedRwaBn)}`,
          output: fmtPct(model.stressedCet1Pct, 2),
          source: "Regulatory CET1 formula"
        },
        {
          metric: "CET1 Headroom vs Requirement",
          formula: "(Stressed CET1% - required+buffer%) x 100bp",
          inputs: `Required+buffer ${fmtPct(requiredPct, 2)}`,
          output: `${formatNum(model.cet1HeadroomBps, 0)} bp`,
          source: "Capital policy threshold"
        },
        {
          metric: "NCO Ratio",
          formula: "(Annual NCO / avg CIB loans) x 100",
          inputs: `NCO ${formatMoneyMm(model.totalNcoMm)}, loans ${formatMoneyBn(cibLoansBn)}`,
          output: fmtPct((model.totalNcoMm / Math.max(1, cibLoansBn * 1000)) * 100, 2),
          source: "Public CIB financials"
        }
      ];
    }

    function rolePhase(months) {
      if (months <= 8) return "Quick Wins";
      if (months <= 12) return "Phase 1";
      if (months <= 16) return "Phase 2";
      return "Phase 3";
    }

    function rolePhaseClass(phase) {
      if (phase === "Quick Wins") return "good";
      if (phase === "Phase 1") return "warn";
      if (phase === "Phase 2") return "warn";
      return "bad";
    }

    function computeRoleTransformationModel() {
      const assumptions = state.assumptions || {};
      const functionMeta = Object.fromEntries((state.functionMap || []).map((row) => [row.func, row]));
      const roles = (state.riskRoleCatalog && state.riskRoleCatalog.length)
        ? state.riskRoleCatalog
        : (state.aiFunctionMap || []).map((row, idx) => ({
          id: `LEGACY-${idx + 1}`,
          function: row.func,
          role: `${row.func} Analyst`,
          owner: row.owner,
          baselineFte: row.baselineFte,
          avgComp: row.avgComp,
          modelablePct: row.automationPct,
          controlRetentionPct: 55,
          timelineMonths: 12,
          dependency: row.guardrail,
          governanceGate: row.guardrail
        }));

      const adoption = safeNumber(assumptions.aiAdoptionPct, 65) / 100;
      const modelConfidence = safeNumber(assumptions.aiModelConfidencePct, 70) / 100;
      const dataQuality = safeNumber(assumptions.aiDataQualityPct, 70) / 100;
      const processMaturity = safeNumber(assumptions.aiProcessMaturityPct, 68) / 100;
      const globalControlRetention = safeNumber(assumptions.aiControlRetentionPct, 48) / 100;
      const redeployShare = safeNumber(assumptions.aiRedeployPct, 35) / 100;
      const implementationSuccess = safeNumber(assumptions.aiImplementationSuccessPct, 78) / 100;
      const severanceMonths = safeNumber(assumptions.aiSeveranceMonths, 5);
      const discountRate = Math.max(0.01, safeNumber(assumptions.discountRatePct, 10) / 100);

      const executionReadiness = Math.max(0.15, adoption * (0.4 * modelConfidence + 0.3 * dataQuality + 0.3 * processMaturity));

      const roleRows = roles.map((row) => {
        const baselineFte = safeNumber(row.baselineFte, 0);
        const avgComp = safeNumber(row.avgComp, 0);
        const modelablePct = safeNumber(row.modelablePct, 0);
        const modelable = modelablePct / 100;
        const controlRetentionPct = Math.max(safeNumber(row.controlRetentionPct, 50) / 100, globalControlRetention);
        const timelineMonths = Math.max(3, safeNumber(row.timelineMonths, 12));
        const effectiveReductionRate = Math.max(0, modelable * executionReadiness * implementationSuccess * (1 - controlRetentionPct));
        const predReductionFte = baselineFte * effectiveReductionRate;
        const redeployFte = predReductionFte * redeployShare;
        const netReductionFte = Math.max(0, predReductionFte - redeployFte);
        const remainingCriticalFte = Math.max(0, baselineFte - predReductionFte);

        const directSavingMm = netReductionFte * avgComp / 1e6;
        const redeployValueMm = redeployFte * avgComp * 0.22 / 1e6;
        const annualNetBenefitMm = directSavingMm + redeployValueMm;

        const toolingMm = Math.max(0.18, baselineFte * modelable * 0.02);
        const severanceMm = netReductionFte * avgComp * (severanceMonths / 12) / 1e6;
        const implementationMm = toolingMm + severanceMm;

        const ramp = Math.min(1, Math.max(0.2, (18 - timelineMonths) / 12));
        const year1 = annualNetBenefitMm * ramp;
        const year2 = annualNetBenefitMm * (0.9 + executionReadiness * 0.2);
        const year3 = annualNetBenefitMm * (0.95 + implementationSuccess * 0.2);
        const npv3Mm =
          (-implementationMm) +
          (year1 / Math.pow(1 + discountRate, 1)) +
          (year2 / Math.pow(1 + discountRate, 2)) +
          (year3 / Math.pow(1 + discountRate, 3));

        const phase = rolePhase(timelineMonths);
        const action = netReductionFte >= 8
          ? "Automate production tasks and redesign control coverage."
          : netReductionFte >= 3
            ? "Augment workflow and redeploy staff to challenge/exceptions."
            : "Copilot only; preserve human-first decisions.";

        return {
          ...row,
          baselineFte,
          avgComp,
          modelablePct,
          timelineMonths,
          phase,
          action,
          predReductionFte,
          redeployFte,
          netReductionFte,
          remainingCriticalFte,
          annualNetBenefitMm,
          implementationMm,
          npv3Mm,
          controlRetentionPctUsed: controlRetentionPct * 100
        };
      }).sort((a, b) => b.netReductionFte - a.netReductionFte);

      const totals = roleRows.reduce((acc, row) => {
        acc.baselineFte += row.baselineFte;
        acc.predReductionFte += row.predReductionFte;
        acc.redeployFte += row.redeployFte;
        acc.netReductionFte += row.netReductionFte;
        acc.remainingCriticalFte += row.remainingCriticalFte;
        acc.annualNetBenefitMm += row.annualNetBenefitMm;
        acc.implementationMm += row.implementationMm;
        acc.npv3Mm += row.npv3Mm;
        return acc;
      }, {
        baselineFte: 0,
        predReductionFte: 0,
        redeployFte: 0,
        netReductionFte: 0,
        remainingCriticalFte: 0,
        annualNetBenefitMm: 0,
        implementationMm: 0,
        npv3Mm: 0
      });
      totals.grossReductionPct = totals.baselineFte > 0 ? totals.predReductionFte / totals.baselineFte * 100 : 0;
      totals.netReductionPct = totals.baselineFte > 0 ? totals.netReductionFte / totals.baselineFte * 100 : 0;
      totals.paybackMonths = totals.annualNetBenefitMm > 0 ? totals.implementationMm / (totals.annualNetBenefitMm / 12) : 0;

      const byFunction = {};
      roleRows.forEach((row) => {
        if (!byFunction[row.function]) {
          const fn = functionMeta[row.function];
          byFunction[row.function] = {
            function: row.function,
            owner: fn?.owner || row.owner || "Risk Leadership",
            mappedRoles: [],
            baselineFte: 0,
            netReductionFte: 0,
            redeployFte: 0,
            remainingCriticalFte: 0,
            annualNetBenefitMm: 0,
            primaryGuardrail: fn?.trigger || row.governanceGate || "Role-level governance sign-off"
          };
        }
        const agg = byFunction[row.function];
        agg.mappedRoles.push(row.role);
        agg.baselineFte += row.baselineFte;
        agg.netReductionFte += row.netReductionFte;
        agg.redeployFte += row.redeployFte;
        agg.remainingCriticalFte += row.remainingCriticalFte;
        agg.annualNetBenefitMm += row.annualNetBenefitMm;
      });

      const functionRows = Object.values(byFunction).map((row) => ({
        ...row,
        mappedRoleText: row.mappedRoles.length > 2
          ? `${row.mappedRoles.length} roles (${row.mappedRoles.slice(0, 2).join(", ")}, +${row.mappedRoles.length - 2} more)`
          : `${row.mappedRoles.length} roles (${row.mappedRoles.join(", ")})`
      })).sort((a, b) => b.netReductionFte - a.netReductionFte);

      const roadmapRows = [...roleRows]
        .sort((a, b) => (a.timelineMonths - b.timelineMonths) || (b.netReductionFte - a.netReductionFte))
        .map((row) => ({
          phase: row.phase,
          roleFunction: `${row.role} / ${row.function}`,
          action: row.action,
          timelineMonths: row.timelineMonths,
          netFteImpact: row.netReductionFte,
          owner: row.owner || "Risk Leadership",
          dependency: row.dependency || "Data + workflow integration",
          governanceCheckpoint: row.governanceGate || "Control validation"
        }));

      return {
        executionReadiness,
        redeployShare,
        roleRows,
        functionRows,
        roadmapRows,
        totals
      };
    }

    function renderAssumptionsTab() {
      const scen = currentScenario();
      const requiredPlusBuffer = state.regulatory.requiredCet1MinPct + state.regulatory.managementBufferBps / 100;
      const afterTaxLossBn = model.totalPreTaxBn * (1 - state.assumptions.taxRatePct / 100);

      document.getElementById("assumptionSummary").innerHTML = `
        <div class="market-stat"><span class="k">Scenario</span><span class="v">${scen.name}</span></div>
        <div class="market-stat"><span class="k">PD / LGD Shock</span><span class="v">${formatNum(scen.pdMult, 2)}x / +${formatNum(scen.lgdAdd, 0)}pp</span></div>
        <div class="market-stat"><span class="k">Market / CCR Shock</span><span class="v">${formatNum(scen.marketMult, 2)}x / ${formatNum(scen.ccrMult, 2)}x</span></div>
        <div class="market-stat"><span class="k">Funding Shock</span><span class="v">${formatNum(scen.fundingBps, 0)} bps</span></div>
        <div class="market-stat"><span class="k">Tax Rate</span><span class="v">${formatNum(state.assumptions.taxRatePct, 1)}%</span></div>
        <div class="market-stat"><span class="k">Req + Buffer</span><span class="v">${fmtPct(requiredPlusBuffer, 2)}</span></div>
        <div class="market-stat"><span class="k">Stressed CET1</span><span class="v">${fmtPct(model.stressedCet1Pct, 2)}</span></div>
        <div class="market-stat"><span class="k">Headroom</span><span class="v">${formatNum(model.cet1HeadroomBps, 0)} bp</span></div>
        <div class="market-stat"><span class="k">Stressed RWA</span><span class="v">${formatMoneyBn(model.stressedRwaBn)}</span></div>
        <div class="market-stat"><span class="k">Pre-Tax Stress Loss</span><span class="v">${formatMoneyBn(model.totalPreTaxBn)}</span></div>
        <div class="market-stat"><span class="k">After-Tax Stress Loss</span><span class="v">${formatMoneyBn(afterTaxLossBn)}</span></div>
        <div class="market-stat"><span class="k">1D VaR Utilization</span><span class="v">${fmtPct(model.varUtilPct, 1)}</span></div>
      `;

      const traceBody = document.querySelector("#assumptionTraceTable tbody");
      traceBody.innerHTML = assumptionTraceRows().map((row) => `
        <tr>
          <td>${row.metric}</td>
          <td class="mono">${row.formula}</td>
          <td>${row.inputs}</td>
          <td class="mono">${row.output}</td>
          <td>${row.source}</td>
        </tr>
      `).join("");
    }

    function renderAiWorkforceTab() {
      const scen = currentScenario();
      const workforce = computeRoleTransformationModel();
      latestRoleModel = workforce;

      const summaryEl = document.getElementById("aiWorkforceSummary");
      if (summaryEl) {
        summaryEl.innerHTML = `
          <div class="market-stat"><span class="k">Scenario Context</span><span class="v">${scen.name}</span></div>
          <div class="market-stat"><span class="k">Execution Readiness</span><span class="v">${formatNum(workforce.executionReadiness * 100, 0)}%</span></div>
          <div class="market-stat"><span class="k">Role Baseline FTE</span><span class="v">${formatInt(workforce.totals.baselineFte)}</span></div>
          <div class="market-stat"><span class="k">Gross Reducible FTE</span><span class="v">${formatNum(workforce.totals.predReductionFte, 1)} (${formatNum(workforce.totals.grossReductionPct, 1)}%)</span></div>
          <div class="market-stat"><span class="k">Net Reduction FTE</span><span class="v">${formatNum(workforce.totals.netReductionFte, 1)} (${formatNum(workforce.totals.netReductionPct, 1)}%)</span></div>
          <div class="market-stat"><span class="k">Redeployed FTE</span><span class="v">${formatNum(workforce.totals.redeployFte, 1)}</span></div>
          <div class="market-stat"><span class="k">Annual Net Benefit</span><span class="v">${formatMoneyMm(workforce.totals.annualNetBenefitMm)}</span></div>
          <div class="market-stat"><span class="k">Implementation Cost</span><span class="v">${formatMoneyMm(workforce.totals.implementationMm)}</span></div>
          <div class="market-stat"><span class="k">3Y NPV</span><span class="v">${formatMoneyMm(workforce.totals.npv3Mm)}</span></div>
          <div class="market-stat"><span class="k">Payback</span><span class="v">${formatNum(workforce.totals.paybackMonths, 1)} mo</span></div>
          <div class="market-stat"><span class="k">Top Function Shift</span><span class="v">${workforce.functionRows[0] ? workforce.functionRows[0].function : "N/A"}</span></div>
          <div class="market-stat"><span class="k">Research Items</span><span class="v">${(state.aiResearch || []).length}</span></div>
        `;
      }

      const functionRows = workforce.functionRows;
      if (functionRows.length && window.Plotly) {
        plotReact("roleReductionPlot", [
          {
            type: "bar",
            orientation: "h",
            name: "Net FTE Reduction",
            y: functionRows.map((row) => row.function),
            x: functionRows.map((row) => row.netReductionFte),
            marker: { color: "rgba(231,76,60,0.9)" },
            hovertemplate: "%{y}<br>Net reduction: %{x:.1f} FTE<extra></extra>"
          },
          {
            type: "bar",
            orientation: "h",
            name: "Redeploy FTE",
            y: functionRows.map((row) => row.function),
            x: functionRows.map((row) => row.redeployFte),
            marker: { color: "rgba(85,180,255,0.9)" },
            hovertemplate: "%{y}<br>Redeploy: %{x:.1f} FTE<extra></extra>"
          },
          {
            type: "bar",
            orientation: "h",
            name: "Remaining Critical FTE",
            y: functionRows.map((row) => row.function),
            x: functionRows.map((row) => row.remainingCriticalFte),
            marker: { color: "rgba(159,176,196,0.55)" },
            hovertemplate: "%{y}<br>Remaining critical: %{x:.1f} FTE<extra></extra>"
          }
        ], {
          barmode: "stack",
          margin: { l: 320, r: 16, t: 26, b: 28 },
          paper_bgcolor: "rgba(0,0,0,0)",
          plot_bgcolor: "rgba(0,0,0,0)",
          font: { color: "#dbe7f3", family: "DM Sans" },
          xaxis: { title: "FTE", color: "#dbe7f3", gridcolor: "rgba(255,255,255,0.09)" },
          yaxis: { automargin: true, color: "#dbe7f3", autorange: "reversed" },
          legend: { orientation: "h", y: 1.12 }
        }, "large", functionRows.length);
      } else {
        const el = document.getElementById("roleReductionPlot");
        if (el) el.innerHTML = `<div class="alert warn">Plotly is unavailable. Table outputs remain fully operational.</div>`;
      }

      const roleBody = document.querySelector("#roleDecompTable tbody");
      roleBody.innerHTML = workforce.roleRows.map((row) => `
        <tr data-role-id="${row.id}" title="Double-click for role detail">
          <td>${row.function}</td>
          <td>${row.role}</td>
          <td>${row.owner || "Risk Leadership"}</td>
          <td class="mono">${formatNum(row.baselineFte, 1)}</td>
          <td class="mono">${formatNum(row.modelablePct, 0)}%</td>
          <td class="mono">${formatNum(row.predReductionFte, 1)}</td>
          <td class="mono">${formatNum(row.redeployFte, 1)}</td>
          <td class="mono">${formatNum(row.netReductionFte, 1)}</td>
          <td class="mono">${formatMoneyMm(row.annualNetBenefitMm)}</td>
          <td class="mono">${formatMoneyMm(row.implementationMm)}</td>
          <td class="mono">${formatMoneyMm(row.npv3Mm)}</td>
          <td><span class="pill ${rolePhaseClass(row.phase)}">${row.phase}</span></td>
        </tr>
      `).join("");

      const bridgeBody = document.querySelector("#functionRoleBridgeTable tbody");
      bridgeBody.innerHTML = functionRows.map((row) => `
        <tr data-function="${row.function}" title="Double-click for function detail">
          <td>${row.function}</td>
          <td>${row.owner}</td>
          <td>${row.mappedRoleText}</td>
          <td class="mono">${formatNum(row.baselineFte, 1)}</td>
          <td class="mono">${formatNum(row.netReductionFte, 1)}</td>
          <td class="mono">${formatNum(row.redeployFte, 1)}</td>
          <td class="mono">${formatNum(row.remainingCriticalFte, 1)}</td>
          <td class="mono">${formatMoneyMm(row.annualNetBenefitMm)}</td>
          <td>${row.primaryGuardrail}</td>
        </tr>
      `).join("");

      const roadmapBody = document.querySelector("#transitionRoadmapTable tbody");
      roadmapBody.innerHTML = workforce.roadmapRows.map((row) => `
        <tr>
          <td><span class="pill ${rolePhaseClass(row.phase)}">${row.phase}</span></td>
          <td>${row.roleFunction}</td>
          <td>${row.action}</td>
          <td class="mono">${formatNum(row.timelineMonths, 0)}</td>
          <td class="mono">${formatNum(row.netFteImpact, 1)}</td>
          <td>${row.owner}</td>
          <td>${row.dependency}</td>
          <td>${row.governanceCheckpoint}</td>
        </tr>
      `).join("");

      const researchBody = document.querySelector("#aiResearchTable tbody");
      researchBody.innerHTML = (state.aiResearch || []).map((row) => `
        <tr>
          <td>${row.title}</td>
          <td>${row.keyPoint}</td>
          <td class="mono">${row.asOf}</td>
          <td>${row.relevance}</td>
          <td><a href="${row.url}" target="_blank" rel="noopener">${row.url}</a></td>
        </tr>
      `).join("");
    }

    function renderBoardTab() {
      renderBoardNarrative();
      renderSourceTable();
    }

    function renderActiveTab(force = false) {
      if (!force && renderedTabs.has(activeTab)) return;
      if (activeTab === "overview") renderOverviewTab();
      if (activeTab === "portfolio") renderPortfolioTab();
      if (activeTab === "market") renderMarketTab();
      if (activeTab === "stress") renderStressTab();
      if (activeTab === "functions") renderFunctionsTab();
      if (activeTab === "assumptions") renderAssumptionsTab();
      if (activeTab === "aiworkforce") renderAiWorkforceTab();
      if (activeTab === "board") renderBoardTab();
      renderedTabs.add(activeTab);
    }

    function refreshAll(forceTabRender = true) {
      model = recomputeModel();
      renderKpis();
      renderControlValues();
      renderScenarioSelect();
      if (forceTabRender) {
        renderedTabs.delete(activeTab);
      }
      renderActiveTab(true);
      requestAnimationFrame(() => resizeActivePlots());
    }

    function bindNav() {
      document.getElementById("navTabs").addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-tab]");
        if (!btn) return;
        activeTab = btn.dataset.tab;
        renderNav();
        renderActiveTab();
        const mainEl = document.getElementById("mainContent");
        if (mainEl) mainEl.scrollTop = 0;
        requestAnimationFrame(() => resizeActivePlots());
      });
    }

    function bindControls() {
      document.getElementById("scenarioSelect").addEventListener("change", (e) => {
        applyStateMutation((draft) => {
          draft.metadata.lastScenarioKey = e.target.value;
          const fromTemplate = draft.scenarios.find((s) => s.key === e.target.value);
          if (fromTemplate && fromTemplate.key !== "custom") {
            draft.assumptions.pdStressMultiplier = fromTemplate.pdMult;
            draft.assumptions.lgdAddPp = fromTemplate.lgdAdd;
            draft.assumptions.marketLossMultiplier = fromTemplate.marketMult;
            draft.assumptions.ccrShockMultiplier = fromTemplate.ccrMult;
            draft.assumptions.rwaInflationPct = fromTemplate.rwaInfl;
            draft.assumptions.fundingSpreadShockBps = fromTemplate.fundingBps;
          }
        });
      });
      document.getElementById("enterpriseFte").addEventListener("input", (e) => {
        const val = Number(e.target.value);
        applyStateMutation((draft) => {
          const old = draft.metadata.enterpriseFTE;
          if (draft.metadata.autoScale && old > 0) {
            const ratio = val / old;
            draft.portfolios.forEach((p) => {
              p.eadBn *= ratio;
              p.ncoAnnualMm *= ratio;
              p.var1dMm *= Math.sqrt(ratio);
              p.varLimitMm *= Math.sqrt(ratio);
            });
            draft.counterparties.forEach((c) => {
              c.eadMm *= ratio;
              c.pfe95Mm *= ratio;
              c.limitMm *= ratio;
              c.utilizationPct = c.limitMm > 0 ? (c.eadMm / c.limitMm) * 100 : c.utilizationPct;
            });
            draft.cibPublics.loansBn *= ratio;
            draft.cibPublics.avgLoansBn *= ratio;
            draft.cibPublics.depositsBn *= ratio;
            draft.cibPublics.tradingAssetsBn *= ratio;
          }
          draft.metadata.enterpriseFTE = val;
        });
      });

      document.getElementById("cibSharePct").addEventListener("input", (e) => {
        const val = Number(e.target.value);
        applyStateMutation((draft) => {
          draft.metadata.cibSharePct = val;
        });
      });

      document.getElementById("pdMultiplier").addEventListener("input", (e) => {
        const val = Number(e.target.value);
        applyStateMutation((draft) => {
          draft.assumptions.pdStressMultiplier = val;
          draft.metadata.lastScenarioKey = "custom";
        });
      });

      document.getElementById("lgdAdd").addEventListener("input", (e) => {
        const val = Number(e.target.value);
        applyStateMutation((draft) => {
          draft.assumptions.lgdAddPp = val;
          draft.metadata.lastScenarioKey = "custom";
        });
      });

      document.getElementById("varMult").addEventListener("input", (e) => {
        const val = Number(e.target.value);
        applyStateMutation((draft) => {
          draft.assumptions.marketLossMultiplier = val;
          draft.metadata.lastScenarioKey = "custom";
        });
      });

      document.getElementById("rwaInflation").addEventListener("input", (e) => {
        const val = Number(e.target.value);
        applyStateMutation((draft) => {
          draft.assumptions.rwaInflationPct = val;
          draft.metadata.lastScenarioKey = "custom";
        });
      });

      document.getElementById("discountRate").addEventListener("input", (e) => {
        const val = Number(e.target.value);
        applyStateMutation((draft) => {
          draft.assumptions.discountRatePct = val;
        });
      });

      document.getElementById("autoScale").addEventListener("change", (e) => {
        applyStateMutation((draft) => {
          draft.metadata.autoScale = e.target.checked;
        });
      });

      const bindRangeMutation = (id, mutate) => {
        const input = document.getElementById(id);
        if (!input) return;
        input.addEventListener("input", (e) => {
          const val = safeNumber(e.target.value, safeNumber(input.value, 0));
          applyStateMutation((draft) => {
            mutate(draft, val);
          });
        });
      };

      bindRangeMutation("taxRatePctInput", (draft, val) => {
        draft.assumptions.taxRatePct = val;
      });
      bindRangeMutation("fundingSpreadShockInput", (draft, val) => {
        draft.assumptions.fundingSpreadShockBps = val;
        draft.metadata.lastScenarioKey = "custom";
      });
      bindRangeMutation("mgmtBufferInput", (draft, val) => {
        draft.regulatory.managementBufferBps = val;
      });
      bindRangeMutation("requiredCet1Input", (draft, val) => {
        draft.regulatory.requiredCet1MinPct = val;
      });
      bindRangeMutation("aiAdoptionInput", (draft, val) => {
        draft.assumptions.aiAdoptionPct = val;
      });
      bindRangeMutation("aiModelConfidenceInput", (draft, val) => {
        draft.assumptions.aiModelConfidencePct = val;
      });
      bindRangeMutation("aiDataQualityInput", (draft, val) => {
        draft.assumptions.aiDataQualityPct = val;
      });
      bindRangeMutation("aiProcessMaturityInput", (draft, val) => {
        draft.assumptions.aiProcessMaturityPct = val;
      });
      bindRangeMutation("aiControlRetentionInput", (draft, val) => {
        draft.assumptions.aiControlRetentionPct = val;
      });
      bindRangeMutation("aiRedeployInput", (draft, val) => {
        draft.assumptions.aiRedeployPct = val;
      });
      bindRangeMutation("aiImplementationSuccessInput", (draft, val) => {
        draft.assumptions.aiImplementationSuccessPct = val;
      });
      bindRangeMutation("aiSeveranceMonthsInput", (draft, val) => {
        draft.assumptions.aiSeveranceMonths = val;
      });
    }

    function bindAssumptionDrilldowns() {
      const roleBody = document.querySelector("#roleDecompTable tbody");
      if (roleBody && roleBody.dataset.dblbound !== "1") {
        roleBody.dataset.dblbound = "1";
        roleBody.addEventListener("dblclick", (e) => {
          const rowEl = e.target.closest("tr[data-role-id]");
          if (!rowEl || !latestRoleModel) return;
          const roleRow = (latestRoleModel.roleRows || []).find((row) => row.id === rowEl.dataset.roleId);
          if (!roleRow) return;
          const lines = [
            `${roleRow.role} | ${roleRow.function}`,
            `Owner: ${roleRow.owner || "Risk Leadership"}`,
            `Baseline FTE: ${formatNum(roleRow.baselineFte, 1)}`,
            `Predicted reduction FTE: ${formatNum(roleRow.predReductionFte, 1)}`,
            `Net reduction FTE: ${formatNum(roleRow.netReductionFte, 1)} | Redeploy: ${formatNum(roleRow.redeployFte, 1)}`,
            `Annual net benefit: ${formatMoneyMm(roleRow.annualNetBenefitMm)} | 3Y NPV: ${formatMoneyMm(roleRow.npv3Mm)}`,
            `Timeline: ${formatNum(roleRow.timelineMonths, 0)} months (${roleRow.phase})`,
            `Dependency: ${roleRow.dependency || "Data + workflow integration"}`,
            `Governance gate: ${roleRow.governanceGate || "Control validation"}`
          ];
          alert(lines.join("\n"));
        });
      }

      const functionBody = document.querySelector("#functionRoleBridgeTable tbody");
      if (functionBody && functionBody.dataset.dblbound !== "1") {
        functionBody.dataset.dblbound = "1";
        functionBody.addEventListener("dblclick", (e) => {
          const rowEl = e.target.closest("tr[data-function]");
          if (!rowEl || !latestRoleModel) return;
          const functionRow = (latestRoleModel.functionRows || []).find((row) => row.function === rowEl.dataset.function);
          if (!functionRow) return;
          const lines = [
            `${functionRow.function}`,
            `Owner: ${functionRow.owner}`,
            `Mapped roles: ${functionRow.mappedRoleText}`,
            `Baseline FTE: ${formatNum(functionRow.baselineFte, 1)}`,
            `Net reduction FTE: ${formatNum(functionRow.netReductionFte, 1)} | Redeploy: ${formatNum(functionRow.redeployFte, 1)}`,
            `Remaining critical FTE: ${formatNum(functionRow.remainingCriticalFte, 1)}`,
            `Annual net benefit: ${formatMoneyMm(functionRow.annualNetBenefitMm)}`,
            `Primary guardrail: ${functionRow.primaryGuardrail}`
          ];
          alert(lines.join("\n"));
        });
      }
    }

    function bindPortfolioTable() {
      document.querySelector("#portfolioTable tbody").addEventListener("change", (e) => {
        const target = e.target;
        if (!(target instanceof HTMLInputElement) && !(target instanceof HTMLSelectElement)) return;
        const rowId = target.dataset.rowid;
        const field = target.dataset.field;
        if (!rowId || !field) return;

        applyStateMutation((draft) => {
          const row = draft.portfolios.find((r) => r.id === rowId);
          if (!row) return;
          if (target.type === "number") {
            row[field] = safeNumber(target.value, row[field]);
          } else {
            row[field] = target.value;
          }
        });
      });

      document.getElementById("portfolioSearch").addEventListener("input", () => {
        renderedTabs.delete("portfolio");
        if (activeTab === "portfolio") renderPortfolioTab();
      });
      document.getElementById("portfolioLobFilter").addEventListener("change", () => {
        renderedTabs.delete("portfolio");
        if (activeTab === "portfolio") renderPortfolioTab();
      });
      document.getElementById("portfolioPriorityFilter").addEventListener("change", () => {
        renderedTabs.delete("portfolio");
        if (activeTab === "portfolio") renderPortfolioTab();
      });
      document.getElementById("portfolioRiskFilter").addEventListener("change", () => {
        renderedTabs.delete("portfolio");
        if (activeTab === "portfolio") renderPortfolioTab();
      });

      document.getElementById("addPortfolioRowBtn").addEventListener("click", () => {
        applyStateMutation((draft) => {
          const id = `NEW-${Date.now()}`;
          draft.portfolios.push({
            id,
            lob: "Banking",
            desk: "New Desk",
            eadBn: 1.0,
            pdPct: 1.0,
            lgdPct: 35,
            criticizedPct: 4,
            nonaccrualPct: 0.3,
            var1dMm: 3,
            varLimitMm: 8,
            ncoAnnualMm: 2,
            rwaDensityPct: 50,
            owner: "Portfolio Risk",
            priority: "P2",
            action: "Define risk action",
            flagged: false
          });
        });
      });
    }

    function bindContextMenu() {
      const menu = document.getElementById("contextMenu");

      document.querySelector("#portfolioTable tbody").addEventListener("contextmenu", (e) => {
        const tr = e.target.closest("tr[data-rowid]");
        if (!tr) return;
        e.preventDefault();
        contextRowId = tr.dataset.rowid;
        menu.style.display = "block";
        menu.style.left = `${e.clientX}px`;
        menu.style.top = `${e.clientY}px`;
      });

      document.addEventListener("click", () => {
        menu.style.display = "none";
      });

      menu.addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-action]");
        if (!btn || !contextRowId) return;
        const action = btn.dataset.action;

        applyStateMutation((draft) => {
          const row = draft.portfolios.find((r) => r.id === contextRowId);
          if (!row) return;

          if (action === "p1") row.priority = "P1";
          if (action === "p2") row.priority = "P2";
          if (action === "p3") row.priority = "P3";
          if (action === "watch") row.flagged = !row.flagged;
          if (action === "duplicate") {
            const clone = deepClone(row);
            clone.id = `${row.id}-COPY-${Date.now().toString().slice(-4)}`;
            clone.desk = `${row.desk} (Copy)`;
            draft.portfolios.push(clone);
          }
          if (action === "delete") {
            const idx = draft.portfolios.findIndex((r) => r.id === contextRowId);
            if (idx >= 0 && draft.portfolios.length > 1) draft.portfolios.splice(idx, 1);
          }
        });
      });
    }

    function bindLayoutDesigner() {
      const layoutBtn = document.getElementById("layoutEditBtn");
      const resetBtn = document.getElementById("resetLayoutBtn");
      const main = document.getElementById("mainContent");

      layoutBtn.addEventListener("click", () => {
        setLayoutEditMode(!layoutEditMode);
      });

      resetBtn.addEventListener("click", () => {
        if (!defaultLayoutSnapshot) return;
        localStorage.removeItem(LAYOUT_STORAGE_KEY);
        applyLayoutSnapshot(defaultLayoutSnapshot);
        panelElements().forEach((panel) => {
          panel.style.width = "";
          panel.style.height = "";
        });
        setLayoutEditMode(false);
        queueLayoutSave();
        renderedTabs.delete(activeTab);
        renderActiveTab(true);
        resizeActivePlots();
      });

      main.addEventListener("dragstart", (e) => {
        if (!layoutEditMode) {
          e.preventDefault();
          return;
        }
        const panel = e.target.closest(".section");
        if (!panel || !e.target.closest(".section-header")) {
          e.preventDefault();
          return;
        }
        draggedPanelId = panel.dataset.panelId;
        panel.classList.add("dragging");
        if (e.dataTransfer) {
          e.dataTransfer.effectAllowed = "move";
          e.dataTransfer.setData("text/plain", draggedPanelId);
        }
      });

      main.addEventListener("dragover", (e) => {
        if (!layoutEditMode || !draggedPanelId) return;
        const target = e.target.closest(".section");
        if (!target || target.dataset.panelId === draggedPanelId) return;
        const source = document.querySelector(`.section[data-panel-id="${draggedPanelId}"]`);
        if (!source) return;
        const sameTab = source.closest(".tab") === target.closest(".tab");
        if (!sameTab) return;
        e.preventDefault();
        target.classList.add("drop-target");
      });

      main.addEventListener("dragleave", (e) => {
        const target = e.target.closest(".section");
        if (target) target.classList.remove("drop-target");
      });

      main.addEventListener("drop", (e) => {
        if (!layoutEditMode || !draggedPanelId) return;
        const target = e.target.closest(".section");
        if (!target || target.dataset.panelId === draggedPanelId) return;
        const source = document.querySelector(`.section[data-panel-id="${draggedPanelId}"]`);
        if (!source || !target.parentElement) return;
        const sameTab = source.closest(".tab") === target.closest(".tab");
        if (!sameTab) return;
        e.preventDefault();
        const rect = target.getBoundingClientRect();
        const horizontal = target.parentElement.classList.contains("grid-2") || target.parentElement.classList.contains("split");
        const insertAfter = horizontal ? e.clientX > rect.left + rect.width / 2 : e.clientY > rect.top + rect.height / 2;
        target.parentElement.insertBefore(source, insertAfter ? target.nextSibling : target);
        target.classList.remove("drop-target");
        queueLayoutSave();
        requestAnimationFrame(() => {
          resizeActivePlots();
        });
      });

      main.addEventListener("dragend", () => {
        panelElements().forEach((panel) => {
          panel.classList.remove("dragging", "drop-target");
        });
        draggedPanelId = null;
      });

      if (window.ResizeObserver) {
        panelResizeObserver = new ResizeObserver(() => {
          if (!layoutEditMode) return;
          queueLayoutSave();
          requestAnimationFrame(() => resizeActivePlots());
        });
        panelElements().forEach((panel) => panelResizeObserver.observe(panel));
      }
    }

    function saveLocal() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function loadLocal() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return false;
      try {
        state = JSON.parse(raw);
        ensureStateCompleteness(state);
        return true;
      } catch {
        return false;
      }
    }

    function bindPersistenceButtons() {
      document.getElementById("saveStateBtn").addEventListener("click", () => {
        saveLocal();
        alert("Dashboard state saved to localStorage.");
      });

      document.getElementById("loadStateBtn").addEventListener("click", () => {
        if (loadLocal()) {
          undoStack = [];
          redoStack = [];
          renderedTabs.clear();
          refreshAll();
          alert("Saved state loaded.");
        } else {
          alert("No valid saved state found.");
        }
      });

      document.getElementById("resetBtn").addEventListener("click", () => {
        if (!confirm("Reset dashboard to baseline defaults?")) return;
        state = deepClone(DEFAULT_STATE);
        undoStack = [];
        redoStack = [];
        renderedTabs.clear();
        refreshAll();
      });

      document.getElementById("undoBtn").addEventListener("click", () => {
        if (!undoStack.length) return;
        redoStack.push(deepClone(state));
        state = undoStack.pop();
        renderedTabs.clear();
        refreshAll();
      });

      document.getElementById("redoBtn").addEventListener("click", () => {
        if (!redoStack.length) return;
        undoStack.push(deepClone(state));
        state = redoStack.pop();
        renderedTabs.clear();
        refreshAll();
      });
    }

    function bindKeyboardShortcuts() {
      document.addEventListener("keydown", (e) => {
        const isCtrl = e.ctrlKey || e.metaKey;
        if (!isCtrl) return;

        if (e.key.toLowerCase() === "z") {
          e.preventDefault();
          document.getElementById("undoBtn").click();
        }

        if (e.key.toLowerCase() === "y") {
          e.preventDefault();
          document.getElementById("redoBtn").click();
        }

        if (e.key === "Escape") {
          document.getElementById("contextMenu").style.display = "none";
        }
      });
    }

    function bindImportExport() {
      const fileInput = document.getElementById("csvFileInput");
      document.getElementById("importPortfolioBtn").addEventListener("click", () => fileInput.click());

      fileInput.addEventListener("change", (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        Papa.parse(file, {
          header: true,
          dynamicTyping: true,
          skipEmptyLines: true,
          complete: (result) => {
            const rows = result.data;
            if (!rows.length) {
              alert("CSV parsed but no rows found.");
              return;
            }

            const mapped = rows.map((r, idx) => ({
              id: r.id || `IMP-${Date.now()}-${idx}`,
              lob: r.lob || r.LOB || "Banking",
              desk: r.desk || r.Desk || r["Role"] || `Desk ${idx + 1}`,
              eadBn: safeNumber(r.eadBn ?? r.EAD_Bn ?? r.EAD ?? 0),
              pdPct: safeNumber(r.pdPct ?? r.PD ?? 1),
              lgdPct: safeNumber(r.lgdPct ?? r.LGD ?? 35),
              criticizedPct: safeNumber(r.criticizedPct ?? r.CriticizedPct ?? 5),
              nonaccrualPct: safeNumber(r.nonaccrualPct ?? r.NonaccrualPct ?? 0.3),
              var1dMm: safeNumber(r.var1dMm ?? r.VaR1dMm ?? 5),
              varLimitMm: Math.max(1, safeNumber(r.varLimitMm ?? r.VaRLimitMm ?? 10)),
              ncoAnnualMm: safeNumber(r.ncoAnnualMm ?? r.NCOAnnualMm ?? 2),
              rwaDensityPct: safeNumber(r.rwaDensityPct ?? r.RWADensityPct ?? 55),
              owner: r.owner || r.Owner || "Portfolio Risk",
              priority: r.priority || r.Priority || "P2",
              action: r.action || r.Action || "Set action",
              flagged: Boolean(r.flagged || r.Flagged)
            }));

            applyStateMutation((draft) => {
              draft.portfolios = mapped;
            });

            alert(`Imported ${mapped.length} portfolio rows.`);
          }
        });
      });

      document.getElementById("exportPortfolioBtn").addEventListener("click", () => {
        const csv = Papa.unparse(state.portfolios);
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `cib_portfolio_export_${TODAY}.csv`;
        a.click();
        URL.revokeObjectURL(url);
      });
    }

    async function exportPng() {
      const tab = document.querySelector(`#tab-${activeTab}`);
      const canvas = await html2canvas(tab, { scale: 2, backgroundColor: "#0a1628" });
      const a = document.createElement("a");
      a.href = canvas.toDataURL("image/png");
      a.download = `cib-risk-${activeTab}-${TODAY}.png`;
      a.click();
    }

    async function exportPdf() {
      const { jsPDF } = window.jspdf;
      const tab = document.querySelector(`#tab-${activeTab}`);
      const canvas = await html2canvas(tab, { scale: 2, backgroundColor: "#0a1628" });
      const imgData = canvas.toDataURL("image/png");
      const pdf = new jsPDF("l", "mm", "a4");
      const w = pdf.internal.pageSize.getWidth();
      const h = pdf.internal.pageSize.getHeight();
      pdf.addImage(imgData, "PNG", 6, 6, w - 12, h - 12);
      pdf.save(`cib-risk-${activeTab}-${TODAY}.pdf`);
    }

    function bindExportButtons() {
      document.getElementById("exportPngBtn").addEventListener("click", () => {
        exportPng().catch(() => alert("PNG export failed."));
      });
      document.getElementById("exportPdfBtn").addEventListener("click", () => {
        exportPdf().catch(() => alert("PDF export failed."));
      });
      document.getElementById("printBtn").addEventListener("click", () => window.print());
    }

    function bindBoardButtons() {
      document.getElementById("regenNarrativeBtn").addEventListener("click", () => {
        document.getElementById("boardNarrative").value = buildNarrative();
      });
      document.getElementById("copyNarrativeBtn").addEventListener("click", async () => {
        const text = document.getElementById("boardNarrative").value;
        try {
          await navigator.clipboard.writeText(text);
          alert("Narrative copied.");
        } catch {
          alert("Clipboard copy failed.");
        }
      });
      document.getElementById("downloadBriefBtn").addEventListener("click", () => {
        const text = document.getElementById("boardNarrative").value;
        const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `cib-risk-board-brief-${TODAY}.txt`;
        a.click();
        URL.revokeObjectURL(url);
      });
    }

    function bindTabInvalidators() {
      ["portfolioSearch", "portfolioLobFilter", "portfolioPriorityFilter", "portfolioRiskFilter"].forEach((id) => {
        const el = document.getElementById(id);
        if (!el) return;
        el.addEventListener("input", () => {
          renderedTabs.delete("portfolio");
          if (activeTab === "portfolio") renderPortfolioTab();
        });
      });
    }

    function bindMarketMonitorControls() {
      ["marketSearch", "marketCategoryFilter", "marketSignalFilter", "marketSort"].forEach((id) => {
        const el = document.getElementById(id);
        if (!el) return;
        const evt = id === "marketSearch" ? "input" : "change";
        el.addEventListener(evt, () => {
          if (activeTab === "market") {
            renderMarketMonitor();
          }
        });
      });

      const refreshBtn = document.getElementById("refreshMarketBtn");
      if (refreshBtn) {
        refreshBtn.addEventListener("click", () => {
          refreshMarketFromFred().catch(() => {
            const statusEl = document.getElementById("marketRefreshStatus");
            if (statusEl) statusEl.textContent = "Refresh failed (browser/network restriction)";
            refreshBtn.disabled = false;
          });
        });
      }

      const resetBtn = document.getElementById("resetMarketFiltersBtn");
      if (resetBtn) {
        resetBtn.addEventListener("click", () => {
          document.getElementById("marketSearch").value = "";
          document.getElementById("marketCategoryFilter").value = "all";
          document.getElementById("marketSignalFilter").value = "all";
          document.getElementById("marketSort").value = "severity";
          if (activeTab === "market") renderMarketMonitor();
        });
      }
    }

    function boot() {
      ensureStateCompleteness(state);
      ensureLayoutMetadata();
      defaultLayoutSnapshot = captureLayoutSnapshot();
      const savedLayout = loadSavedLayoutSnapshot();
      if (savedLayout) {
        applyLayoutSnapshot(savedLayout);
      }
      setLayoutEditMode(false);

      model = recomputeModel();
      renderNav();
      renderScenarioSelect();
      renderControlValues();
      renderKpis();
      renderActiveTab(true);

      bindNav();
      bindControls();
      bindAssumptionDrilldowns();
      bindPortfolioTable();
      bindContextMenu();
      bindLayoutDesigner();
      bindPersistenceButtons();
      bindKeyboardShortcuts();
      bindImportExport();
      bindExportButtons();
      bindBoardButtons();
      bindTabInvalidators();
      bindMarketMonitorControls();

      window.addEventListener("resize", () => {
        resizeActivePlots();
      });
    }

    boot();
  </script>
</body>
</html>
